<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-26 周三 10:03 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Doom3 Engine</title>
<meta name="generator" content="Org mode" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
         <meta name="viewport" content="width=device-width, initial-scale=1" />
         <link rel="stylesheet" title="Standard" href="https://wolfand11.gitee.io/res/css/worg.css" type="text/css" />
         <link rel="alternate stylesheet" title="Zenburn" href="https://wolfand11.gitee.io/res/css/worg-zenburn.css" type="text/css" />
         <link rel="alternate stylesheet" title="Classic" href="https://wolfand11.gitee.io/res/css/worg-classic.css" type="text/css" />
         <link rel="icon" href="https://wolfand11.gitee.io/res/favicon.ico" type="image/ico" />
         <script type="text/javascript" src="https://wolfand11.gitee.io/res/blog-tools.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="https://wolfand11.gitee.io"> HOME </a>
</div><div id="content">
<h1 class="title">Doom3 Engine</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgef361af">Doom3</a>
<ul>
<li><a href="#org0f663e5">Introduction</a>
<ul>
<li><a href="#org89c5ce0">Architecture</a></li>
<li><a href="#orga98c678">Main Loop</a></li>
</ul>
</li>
<li><a href="#org73cdbe4">DMap</a></li>
<li><a href="#orgbecb4e7">Renderer</a></li>
<li><a href="#orgd6c5128"></a></li>
</ul>
</li>
<li><a href="#org1a41268">Doom3BFG</a>
<ul>
<li><a href="#org868428b">Introduction</a>
<ul>
<li><a href="#org9fd2831">Architecture</a></li>
</ul>
</li>
<li><a href="#orgbee6658">Threading</a>
<ul>
<li><a href="#org624450f">Doom 3 BFG Threading Model</a></li>
<li><a href="#orgb37ab67">Core idea</a></li>
<li><a href="#org5ecb5cc">Building blocks</a>
<ul>
<li><a href="#org1f3230e">Jobs</a></li>
<li><a href="#org242fa54">Workers</a></li>
<li><a href="#org721c9f1">Synchronization</a></li>
</ul>
</li>
<li><a href="#org063ba97">Architecture</a></li>
<li><a href="#orgf797e2c">Usage</a></li>
<li><a href="#org22bc779">How a Worker works</a></li>
</ul>
</li>
<li><a href="#org5475015">Rendering</a></li>
</ul>
</li>
<li><a href="#org3252352">参考资料</a></li>
</ul>
</div>
</div>
<p>
Doom3 Engine note.<br />
</p>
<div class="HTML" id="orgb3e792b">
<p>
&lt;!&#x2013; more &#x2013;&gt;<br />
</p>

</div>

<div id="outline-container-orgef361af" class="outline-2">
<h2 id="orgef361af">Doom3</h2>
<div class="outline-text-2" id="text-orgef361af">
</div>
<div id="outline-container-org0f663e5" class="outline-3">
<h3 id="org0f663e5">Introduction</h3>
<div class="outline-text-3" id="text-org0f663e5">
</div>
<div id="outline-container-org89c5ce0" class="outline-4">
<h4 id="org89c5ce0">Architecture</h4>
<div class="outline-text-4" id="text-org89c5ce0">
<p>
Solution structure 如下:<br />
</p>

<!-- This HTML table template is generated by emacs 27.2 -->
<table border="1">
  <tr>
    <td align="left" valign="top">
      &nbsp;Projects&nbsp;&nbsp;&nbsp;
    </td>
    <td colspan="2" align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Builds&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Observations&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Windows&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;MacO&nbsp;SX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;Game&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;gamex86.dll&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;gamex86.so&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Doom3&nbsp;gameplay&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;Game-d3xp&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;gamex86.dll&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;gamex86.so&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Doom3&nbsp;eXPension(Ressurecton)&nbsp;gameplay&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;Doom3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Doom3.exe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Doom3.app&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Doom&nbsp;3&nbsp;Engine&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;MayaImport&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;MayaImport.dll&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;部分资源创作工具链：在运行时加载该&nbsp;dll，为了打开&nbsp;Maya&nbsp;文件并导入&nbsp;monsters,&nbsp;camera&nbsp;路径以及地图&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;TypeInfo&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;TypeInfo.exe&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;内部的运行时类型识别（RTTI）helper:&nbsp;生成&nbsp;GameTypeInfo.h,&nbsp;其为&nbsp;Doom3&nbsp;中所有类型和每个成员内存大小的字典。通过&nbsp;TypeInfo&nbsp;类可以进行内存调试&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;CurlLib&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;CurlLib.lib&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;HTTP&nbsp;客户端，用于下载文件。静态连接到&nbsp;gamex86.dll&nbsp;和&nbsp;doom3.exe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;idLib&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;idLib.lib&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;idLib.a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;id&nbsp;software&nbsp;库。包含&nbsp;parser,lexer,dictionary&nbsp;等。静态连接到&nbsp;gamex86.dll&nbsp;和&nbsp;doom3.exe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
</table>

<p>
架构图如下：<br />
<img src="./doom3/doom3_diagram2.png" alt="doom3_diagram2.png" /><br />
</p>

<p>
当 Doom3.exe 启动以后，其会执行如下三个操作：<br />
</p>
<ol class="org-ol">
<li>通过 LoadLibrary 加载 gamex86.dll 到其进程的内存空间中<br /></li>
<li>使用 win32 API GetProcAddress 来获得 dll 中 GetGameAPI 的地址<br /></li>
<li>调用 GetGameAPI<br /></li>
</ol>

<p>
最后，Doom3.exe 会由一个指向 idGame 对象的指针，game.dll 会由一个指向 gameImport<sub>t</sub> 对象的指针，gameImport<sub>t</sub> 对象中包含了所有缺失的子系统的引用(如：idFileSystem)<br />
</p>

<p>
Doom3.exe 中所看到的 gamex86 为：<br />
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span>
{
    <span style="color: #ce537a; font-weight: bold;">int</span>                         <span style="color: #7590db;">version</span>;               <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">API version</span>
    <span style="color: #ce537a; font-weight: bold;">idSys</span> *                     <span style="color: #7590db;">sys</span>;                   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">non-portable system services</span>
    <span style="color: #ce537a; font-weight: bold;">idCommon</span> *                  <span style="color: #7590db;">common</span>;                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">common</span>
    idCmdSystem *               cmdSystem              <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">console command system</span>
    idCVarSystem *              cvarSystem;            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">console variable system</span>
    <span style="color: #ce537a; font-weight: bold;">idFileSystem</span> *              <span style="color: #7590db;">fileSystem</span>;            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">file system</span>
    <span style="color: #ce537a; font-weight: bold;">idNetworkSystem</span> *           <span style="color: #7590db;">networkSystem</span>;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">network system</span>
    <span style="color: #ce537a; font-weight: bold;">idRenderSystem</span> *            <span style="color: #7590db;">renderSystem</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">render system</span>
    <span style="color: #ce537a; font-weight: bold;">idSoundSystem</span> *             <span style="color: #7590db;">soundSystem</span>;           <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">sound system</span>
    <span style="color: #ce537a; font-weight: bold;">idRenderModelManager</span> *      <span style="color: #7590db;">renderModelManager</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">render model manager</span>
    <span style="color: #ce537a; font-weight: bold;">idUserInterfaceManager</span> *    <span style="color: #7590db;">uiManager</span>;             <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">user interface manager</span>
    <span style="color: #ce537a; font-weight: bold;">idDeclManager</span> *             <span style="color: #7590db;">declManager</span>;           <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">declaration manager</span>
    <span style="color: #ce537a; font-weight: bold;">idAASFileManager</span> *          <span style="color: #7590db;">AASFileManager</span>;        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">AAS file manager</span>
    <span style="color: #ce537a; font-weight: bold;">idCollisionModelManager</span> *   <span style="color: #7590db;">collisionModelManager</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">collision model manager</span>
} <span style="color: #ce537a; font-weight: bold;">gameImport_t</span>;
</pre>
</div>

<p>
gamex86 中所看到的 Doom3 为：<br />
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span>
{
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">version</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">API version</span>
    <span style="color: #ce537a; font-weight: bold;">idGame</span> *       <span style="color: #7590db;">game</span>;        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">interface to run the game</span>
    <span style="color: #ce537a; font-weight: bold;">idGameEdit</span> *   <span style="color: #7590db;">gameEdit</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">interface for in-game editing</span>
} <span style="color: #ce537a; font-weight: bold;">gameExport_t</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orga98c678" class="outline-4">
<h4 id="orga98c678">Main Loop</h4>
<div class="outline-text-4" id="text-orga98c678">
<p>
下面是展开的主循环代码, 其中只包含了引擎相关的重要的部分：<br />
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #ce537a; font-weight: bold;">idCommonLocal</span>    <span style="color: #7590db;">commonLocal</span>;                   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">OS Specialized object</span>
<span style="color: #ce537a; font-weight: bold;">idCommon</span> *       <span style="color: #7590db;">common</span> = &amp;commonLocal;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Interface pointer (since Init is OS dependent it is an abstract method</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">WINAPI</span> WinMain( <span style="color: #ce537a; font-weight: bold;">HINSTANCE</span> <span style="color: #7590db;">hInstance</span>, <span style="color: #ce537a; font-weight: bold;">HINSTANCE</span> <span style="color: #7590db;">hPrevInstance</span>, <span style="color: #ce537a; font-weight: bold;">LPSTR</span> <span style="color: #7590db;">lpCmdLine</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">nCmdShow</span> )
{
    Sys_SetPhysicalWorkMemory( 192 &lt;&lt; 20, 1024 &lt;&lt; 20 );   <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">Min = 201,326,592  Max = 1,073,741,824</span>
    Sys_CreateConsole();

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Since the engine is multi-threaded mutexes are initialized here: One mutex per "critical" (concurrent execution) section of code.</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> (<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span> = 0; i &lt; MAX_CRITICAL_SECTIONS; i++ ) {
        InitializeCriticalSection( &amp;win32.criticalSections[i] );
    }

    common-&gt;Init( 0, <span style="color: #a45bad;">NULL</span>, lpCmdLine );              <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Assess how much VRAM is available (not done via OpenGL but OS call)</span>

    Sys_StartAsyncThread(){                          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">The next look runs is a separate thread.</span>
        <span style="color: #4f97d7; font-weight: bold;">while</span> ( 1 ){
            usleep( 16666 );                         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Run at 60Hz</span>
            common-&gt;Async();                         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Do the job</span>
            Sys_TriggerEvent( TRIGGER_EVENT_ONE );   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Unlock other thread waiting for inputs</span>
            pthread_testcancel();                    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Check if we have been cancelled by the main thread (on shutdown).</span>
        }
    }

    Sys_ShowConsole(1, <span style="color: #a45bad;">true</span>);                        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Show or hide the console</span>
    
    <span style="color: #4f97d7; font-weight: bold;">while</span>( 1 ) {
        Win_Frame();
        common-&gt;Frame(){
            session-&gt;Frame()                         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Game logic</span>
            {
                <span style="color: #4f97d7; font-weight: bold;">for</span> (<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span> = 0 ; i &lt; gameTicsToRun ; i++ )
                    RunGameTic(){
                        game-&gt;RunFrame( &amp;cmd );      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">From this point execution jumps in the GameX86.dll address space.</span>
                        <span style="color: #4f97d7; font-weight: bold;">for</span>( ent = activeEntities.Next(); ent != <span style="color: #a45bad;">NULL</span>; ent = ent-&gt;activeNode.Next() )
                            ent-&gt;GetPhysics()-&gt;UpdateTime( time );  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">let entities think</span>
                    }
            }

            session-&gt;UpdateScreen( <span style="color: #a45bad;">false</span> );      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">normal, in-sequence screen update</span>
            {
                renderSystem-&gt;BeginFrame();
                {
                    <span style="color: #a45bad;">idGame</span>::Draw();              <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Renderer front-end. Doesn't actually communicate with the GPU !!</span>
                }
                renderSystem-&gt;EndFrame();
                {
                    R_IssueRenderCommands();     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Renderer back-end. Issue GPU optimized commands to the GPU.</span>
                }
            }
        }
    }
}
</pre>
</div>
<p>
完整的主循环展开如下：<br />
</p>
<ul class="org-ul">
<li><a href="https://fabiensanglard.net/doom3/doom3_unrolled.php">https://fabiensanglard.net/doom3/doom3_unrolled.php</a><br /></li>
</ul>

<p>
从 Sys<sub>StartAsyncThread</sub> 函数可以看出，Doom3 是基于多线程的。该线程的目的是为了处理时间敏感的函数，为了不让这些函数的调用频率受到帧率限制。<br />
</p>

<p>
冷知识：<br />
</p>
<ol class="org-ol">
<li><p>
idTech4 高层对象都属于包含虚函数的抽象类。这通常会影响性能，因为每个虚函数调用都会导致虚函数表的查询。如下面代码所示，所有对象都进行静态实例化，可以避免这样的性能消耗。因为对象是静态分配到数据段的，其类型是已知的，编译器可以将虚表查询优化掉。<br />
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #ce537a; font-weight: bold;">idCommonLocal</span>    <span style="color: #7590db;">commonLocal</span>;                   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Implementation</span>
<span style="color: #ce537a; font-weight: bold;">idCommon</span> *       <span style="color: #7590db;">common</span> = &amp;commonLocal;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Pointer for gamex86.dll</span>
</pre>
</div>
<p>
在 handshake 阶段会使用接口指针，因此 doom3.exe 可以和 gamex86.dll 交换对象引用, 此时虚表查询的消耗是无法被优化掉。<br />
</p></li>
<li>很多代码从 idTech1 开始就一直没有变过。如用于获取鼠标和摇杆输入的函数依然叫 IN<sub>frame</sub>(). （IN 表示 input）<br /></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org73cdbe4" class="outline-3">
<h3 id="org73cdbe4">DMap</h3>
</div>
<div id="outline-container-orgbecb4e7" class="outline-3">
<h3 id="orgbecb4e7">Renderer</h3>
</div>
<div id="outline-container-orgd6c5128" class="outline-3">
<h3 id="orgd6c5128"></h3>
<div class="outline-text-3" id="text-orgd6c5128">
<p>
<a href="https://github.com/dhewm/iddevnet">https://github.com/dhewm/iddevnet</a><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org1a41268" class="outline-2">
<h2 id="org1a41268">Doom3BFG</h2>
<div class="outline-text-2" id="text-org1a41268">
</div>
<div id="outline-container-org868428b" class="outline-3">
<h3 id="org868428b">Introduction</h3>
<div class="outline-text-3" id="text-org868428b">
</div>
<div id="outline-container-org9fd2831" class="outline-4">
<h4 id="org9fd2831">Architecture</h4>
<div class="outline-text-4" id="text-org9fd2831">
<p>
Solution structure 如下:<br />
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Projects</th>
<th scope="col" class="org-left">Builds</th>
<th scope="col" class="org-left">Observations</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Doom3BFG</td>
<td class="org-left">Doom3BFG.exe</td>
<td class="org-left">Doom3 BFG 引擎</td>
</tr>

<tr>
<td class="org-left">doomclassic</td>
<td class="org-left">doomclassic.lib</td>
<td class="org-left">Doom1/2 游戏引擎的重构</td>
</tr>

<tr>
<td class="org-left">external</td>
<td class="org-left">external.lib</td>
<td class="org-left">jpeg-6 zlib 源码</td>
</tr>

<tr>
<td class="org-left">Game-d3xp</td>
<td class="org-left">Game-d3xp.lib</td>
<td class="org-left">通用的游戏库，提供了原创+扩展+新创造的管卡。以静态库形式代替之前的 DLL</td>
</tr>

<tr>
<td class="org-left">idLib</td>
<td class="org-left">idLib.lib</td>
<td class="org-left">id software 工具库，提供了 filesystem, threading, containers.</td>
</tr>

<tr>
<td class="org-left">Amplitude</td>
<td class="org-left">Amplitude.lib</td>
<td class="org-left">Doom Classic 所使用的工具：用于调整 WAV 的振幅</td>
</tr>

<tr>
<td class="org-left">timidity</td>
<td class="org-left">timidity.lib</td>
<td class="org-left">Doom Classic 所使用的工具：将 MIDI 输入转化为 WAV 格式</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


<div id="outline-container-orgbee6658" class="outline-3">
<h3 id="orgbee6658">Threading</h3>
<div class="outline-text-3" id="text-orgbee6658">
</div>
<div id="outline-container-org624450f" class="outline-4">
<h4 id="org624450f">Doom 3 BFG Threading Model</h4>
<div class="outline-text-4" id="text-org624450f">
<p>
doom3 bfg 所用游戏引擎被称为 idTech4, 由 John Carmack 设计。该引擎是基于多线程设计的，其在 PC 平台开始时会启动如下 3 个线程：<br />
</p>
<ol class="org-ol">
<li>专用于渲染器后端的线程（该线程发送绘制命令给 GPU）<br /></li>
<li>专用于渲染器前端和游戏逻辑的线程(该线程生成绘制命令) idGameThread<br /></li>
<li>专用于高频率(250HZ)控制摇杆采样的线程<br /></li>
</ol>
<p>
除此以外，还会生成两个工作线程。他们作为上面 3 个主要线程的助理。他们由内部调度器所管理。<br />
</p>


<div id="org893dd67" class="figure">
<p><img src="./doom3/doom3BFG_threading_model.png" alt="doom3BFG_threading_model.png" /><br />
</p>
</div>

<p>
TODO 线程同步<br />
</p>
</div>
</div>

<div id="outline-container-orgb37ab67" class="outline-4">
<h4 id="orgb37ab67">Core idea</h4>
<div class="outline-text-4" id="text-orgb37ab67">
<p>
对于 CPU 多核化的发展趋势，id software 在 2009 年的 siggraph 演讲中提出了他们的解决方案，其中主要的核心概念有两点：<br />
</p>
<ul class="org-ul">
<li>分解需要处理的任务为 jobs, 由多个工作线程来执行这些 jobs<br /></li>
<li>不要将同步代理给操作系统完成：自己通过原子操作来完成同步<br /></li>
</ul>
</div>
</div>

<div id="outline-container-org5ecb5cc" class="outline-4">
<h4 id="org5ecb5cc">Building blocks</h4>
<div class="outline-text-4" id="text-org5ecb5cc">
<p>
该系统以来三种元素：Jobs, Workers, Synchronization<br />
</p>
</div>
<div id="outline-container-org1f3230e" class="outline-5">
<h5 id="org1f3230e">Jobs</h5>
<div class="outline-text-5" id="text-org1f3230e">
<p>
一个 "Job" 包含了具体需要做的事情。其对应的代码如下：<br />
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job_t</span>
{
    <span style="color: #ce537a; font-weight: bold;">void</span>  (* <span style="color: #bc6ec5; font-weight: bold;">function</span> )(<span style="color: #ce537a; font-weight: bold;">void</span> *);   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Job instructions</span>
    <span style="color: #ce537a; font-weight: bold;">void</span>   * <span style="color: #7590db;">data</span>;                 <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Job parameters</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #7590db;">executed</span>;               <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Job end marker...Not used.</span>
};
</pre>
</div>
<p>
一个 job 应该至少需要消耗几千个时钟周期，从而才能超过任何作业切换导致的开销。 另一方面，一个 job 的消耗不应超过 100,000 个时钟周期，从而在多个处理单元上保持良好的负载平衡。<br />
</p>
</div>
</div>
<div id="outline-container-org242fa54" class="outline-5">
<h5 id="org242fa54">Workers</h5>
<div class="outline-text-5" id="text-org242fa54">
<p>
一个 Worker 就是一个线程，其会保持空闲等待。当它醒来时，它会尝试从 JobList 获取一个 job，此时其通过使用原子操作来避免同步。<br />
</p>
</div>
</div>

<div id="outline-container-org721c9f1" class="outline-5">
<h5 id="org721c9f1">Synchronization</h5>
<div class="outline-text-5" id="text-org721c9f1">
<p>
通过 3 个元素来实现同步：Signals，Mutexes 以及 Atomic operations。原子操作允许引擎保持 CPU 执行权，因此更受青睐。<br />
</p>
</div>
</div>
</div>

<div id="outline-container-org063ba97" class="outline-4">
<h4 id="org063ba97">Architecture</h4>
<div class="outline-text-4" id="text-org063ba97">
<p>
ParalleleJobManager 是该多线程系统的大脑，由其生成工作线程并创建队列来存储 jobs。这种方式可以避免同步：将引擎的 job 发布系统划分为多个 sections（多个队列），仅由一个线程来访问，因此不需要同步。在 idTech4 引擎中，队列对应的类为 idParallelJobList。<br />
ParalleleJobManager 结构图如下：<br />
<img src="./doom3/doom3_idParallelJobManager.png" alt="doom3_idParallelJobManager.png" /><br />
</p>

<p>
在 Doom III BFG 中 job 发布系统只有三个部分：<br />
</p>
<ul class="org-ul">
<li>Renderer FrontEnd<br /></li>
<li>Renderer BackEnd<br /></li>
<li>Utilities<br /></li>
</ul>

<p>
按照 id software 在 2009 年的 siggraph 演讲中的介绍，idTech5 把 job 发布系统划分出了更多部分：<br />
</p>
<ul class="org-ul">
<li>Collision detection<br /></li>
<li>Animation blend<br /></li>
<li>Obstacle avoidance<br /></li>
<li>Virtual texturing<br /></li>
<li>Transparency processing (foliage, particles)<br /></li>
<li>Cloth simulation<br /></li>
<li>Water surface simulation<br /></li>
<li>Detail model generation (rocks, pebbles etc.)<br /></li>
</ul>

<p>
Tips: 在 2009 年的 ppt 中，还提到了延迟一帧的概念，在 Doom III BFG 的源代码中没有该实现。<br />
</p>

<p>
在 PC 平台，开始时会创建两个工作线程，在 XBox360 和 PS3 平台上会创建更多的工作线程。工作线程会不断运行并尝试获取一个 job。该过程不需要 mutexes 或 monitors，一个原子整型变量就可以实现不重复地发布 jobs。如下所示：<br />
<img src="./doom3/worker_atomic_sync.png" alt="worker_atomic_sync.png" /><br />
</p>
</div>
</div>

<div id="outline-container-orgf797e2c" class="outline-4">
<h4 id="orgf797e2c">Usage</h4>
<div class="outline-text-4" id="text-orgf797e2c">
<p>
jobs 被隔离到多个 sections 中，这些 sections 只能被一个线程访问，因此，添加一个 job 时不需要同步。但是，提交一个 job 给 worker 系统时，确实涉及到互斥。下面代码是一个使用实例，该实例中渲染器尝试找到哪些光照和 view frustum 产生了相交:<br />
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">tr.frontEndJobList is a idParallelJobList object.</span>

<span style="color: #4f97d7; font-weight: bold;">for</span> ( <span style="color: #ce537a; font-weight: bold;">viewLight_t</span> * <span style="color: #7590db;">vLight</span> = tr.viewDef-&gt;viewLights; vLight != <span style="color: #a45bad;">NULL</span>; vLight = vLight-&gt;next )
{
    tr.frontEndJobList-&gt;AddJob( (<span style="color: #ce537a; font-weight: bold;">jobRun_t</span>)R_AddSingleLight, vLight );
}
    
tr.frontEndJobList-&gt;Submit();
tr.frontEndJobList-&gt;Wait();
</pre>
</div>

<p>
使用 job system 需要如下三步：<br />
</p>
<ul class="org-ul">
<li>AddJob : 不需要同步，job 被添加到一个列表中<br /></li>
<li>Submit : 互斥锁同步，每个工作线程将 JobList 添加到自己本地的环形缓冲区列表中（环形缓冲区列表中每个 item 存储一个 JobList）<br /></li>
<li>Wait   : 信号同步(代理给 OS 来实现同步)，等待工作线程完成工作。<br /></li>
</ul>

<p>
下图展示了第一步和第二步：<br />
<img src="./doom3/add_submit.png" alt="add_submit.png" /><br />
</p>
</div>
</div>
<div id="outline-container-org22bc779" class="outline-4">
<h4 id="org22bc779">How a Worker works</h4>
</div>
</div>

<div id="outline-container-org5475015" class="outline-3">
<h3 id="org5475015">Rendering</h3>
</div>
</div>
<div id="outline-container-org3252352" class="outline-2">
<h2 id="org3252352">参考资料</h2>
<div class="outline-text-2" id="text-org3252352">
<ul class="org-ul">
<li>DOOM3 源码 <a href="https://github.com/id-Software/DOOM-3">https://github.com/id-Software/DOOM-3</a><br /></li>
<li>DOOM3 BFG 源码 <a href="https://github.com/id-Software/DOOM-3-BFG">https://github.com/id-Software/DOOM-3-BFG</a><br /></li>
<li>Doom3 source code review <a href="https://fabiensanglard.net/doom3/index.php">https://fabiensanglard.net/doom3/index.php</a><br /></li>
<li>DOOM3 BFG source code review <a href="https://fabiensanglard.net/doom3_bfg/index.php">https://fabiensanglard.net/doom3_bfg/index.php</a><br /></li>
</ul>
</div>
</div>
</div>
</body>
</html>
