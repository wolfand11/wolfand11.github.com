<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-09-07 Wed 11:16 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UnderstandingTheGFunction</title>
<meta name="generator" content="Org mode" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
         <meta name="viewport" content="width=device-width, initial-scale=1" />
         <link rel="stylesheet" title="Standard" href="https://wolfand11.gitee.io/res/worg_theme/css/worg.css" type="text/css" />
         <link rel="alternate stylesheet" title="Zenburn" href="https://wolfand11.gitee.io/res/worg_theme/css/worg-zenburn.css" type="text/css" />
         <link rel="alternate stylesheet" title="Classic" href="https://wolfand11.gitee.io/res/worg_theme/css/worg-classic.css" type="text/css" />
         <link rel="icon" href="https://wolfand11.gitee.io/res/favicon.ico" type="image/ico" />
         <script type="text/javascript" src="https://wolfand11.gitee.io/res/blog-tools.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="https://wolfand11.gitee.io"> HOME </a>
</div><div id="content">
<h1 class="title">UnderstandingTheGFunction</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org818b75c">UnderstandingTheGFunction</a>
<ul>
<li><a href="#org60b66ff">Derivation of the Masking Function</a>
<ul>
<li><a href="#orgc1c6cea">Measuring Radiance on a Surface</a></li>
<li><a href="#org8ba5aaf">Microfacet Statistics</a>
<ul>
<li><a href="#org718823c">The Distribution of Normals</a></li>
<li><a href="#org4bfb94a">Spatial and Statistical Equations</a></li>
<li><a href="#org77fd0d1">Statistical Functions</a></li>
</ul>
</li>
<li><a href="#org03a9a10">Microfact Projections</a></li>
<li><a href="#orgc79be0e">A Constraint on the Masking Function</a></li>
</ul>
</li>
<li><a href="#orgd452221">Microfacet-Based BRDFs</a>
<ul>
<li><a href="#org74c2d6a">Distribution of Visible Normals</a></li>
<li><a href="#orgc37bbe0">Construction of the BRDF</a></li>
<li><a href="#orga4ad188">Construction of the BRDF with specular microfacets</a></li>
<li><a href="#org0646df7">Construction of the BRDF with diffuse microfacets</a></li>
<li><a href="#org3ac271e">The BRDF Normalization Test</a>
<ul>
<li><a href="#org7f0adab">The White Furnace Test</a></li>
<li><a href="#org15258c2">The Weak White Furnace Test</a></li>
<li><a href="#org013d5f3">Summary</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga411aba">Common Physically Based and Non-Physically Based Masking Functions</a>
<ul>
<li><a href="#org95ce506">The Smith Microsurface Profile</a>
<ul>
<li><a href="#orgf6a0c04">Normal/Masking Independence</a></li>
<li><a href="#org53b9969">Derivation of the Masking Function</a></li>
<li><a href="#orgef00b41">The Smith Masking Function</a></li>
<li><a href="#org22b3874">Properties</a></li>
</ul>
</li>
<li><a href="#org32f294f">The V-Cavity Microsurface Profile</a>
<ul>
<li><a href="#org15021b2">Validation</a></li>
<li><a href="#orgaa07e94">Properties</a></li>
</ul>
</li>
<li><a href="#orgab80930">Non-Physically Based Masking Functions</a>
<ul>
<li><a href="#orgb7e8524">Definition</a>
<ul>
<li><a href="#org17680d6">The Implicit Masking Function</a></li>
<li><a href="#org90f6ec0">The Schilick-Smith Masking Function</a></li>
<li><a href="#orgf32e9b2">The Kelemen Masking Function</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org2b6e2c7">Stetch Invariance of the Masking Function</a>
<ul>
<li><a href="#org210c1af">Masking Probability Invariance</a></li>
<li><a href="#orgb1809a5">The Distribution of Slopes</a></li>
<li><a href="#org4d911af">Isotropic Shape-Invariant Distributions of Slopes</a>
<ul>
<li><a href="#org110b291">Shape Invariance</a></li>
<li><a href="#org308cd14">Beckmann Distribution</a></li>
<li><a href="#org732f344">GGX Distribution</a></li>
<li><a href="#org89eee80">Shape-variant distributions</a></li>
</ul>
</li>
<li><a href="#org4888636">Anisotropic Shape-Invariant Distributions of Slopes</a>
<ul>
<li><a href="#orge5a740d">Shape Invariance</a></li>
<li><a href="#org1c604a4">Derivation of the Masking Function</a></li>
<li><a href="#org560928d">Anisotropic Beckmann Distribution</a></li>
<li><a href="#orgb1615e2">Anisotropic GGX Distribution</a></li>
</ul>
</li>
<li><a href="#orgeeda482">More Generalization</a>
<ul>
<li><a href="#orge6431c8">Arbitrary Shape-Invariant Distributions</a></li>
<li><a href="#org7369835">Non Axis-Aligned Stretching</a></li>
<li><a href="#org7c2458b">Vertical Shearing and Non-Centered Distributions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org1b7dcf6">The Smith Joint Masking-Shadowing Function</a>
<ul>
<li>
<ul>
<li><a href="#orgd933ca3">Separable Masking and Shadowing</a></li>
<li><a href="#org2b68889">Height-Correlated Masking and Shadowing</a></li>
<li><a href="#org4d0006e">Direction-Correlated Masking and Shadowing</a></li>
<li><a href="#orgc194bc8">Height-Direction-Correlated Masking and Shadowing</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org21c6edc">Discussion and Future Work</a>
<ul>
<li><a href="#org3e23847">Deriving the Smith Masking Function for Other Commonly Used Models</a></li>
<li><a href="#orga01059f">Correlation of Masking-Shadowing</a></li>
<li><a href="#org27a7f3f">Multiple Scattering</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
UnderstandingTheGFunction note.<br />
</p>
<div class="HTML" id="org0386839">
<p>
&lt;!&#x2013; more &#x2013;&gt;<br />
</p>

</div>

<ul class="org-ul">
<li><a href="http://jcgt.org/published/0003/02/03/paper.pdf">http://jcgt.org/published/0003/02/03/paper.pdf</a><br /></li>
</ul>

<div id="outline-container-org818b75c" class="outline-2">
<h2 id="org818b75c">UnderstandingTheGFunction</h2>
<div class="outline-text-2" id="text-org818b75c">

<div id="orgeed93c6" class="figure">
<p><img src="./UnderstandingTheGFunction/notation_table.jpg" alt="notation_table.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-org60b66ff" class="outline-3">
<h3 id="org60b66ff">Derivation of the Masking Function</h3>
<div class="outline-text-3" id="text-org60b66ff">
</div>
<div id="outline-container-orgc1c6cea" class="outline-4">
<h4 id="orgc1c6cea">Measuring Radiance on a Surface</h4>
<div class="outline-text-4" id="text-orgc1c6cea">
<p>
辐射率是从某个单位立体角经过某个单位区域的能量密度。给定微观表面 M 在 wo 方向出射的辐射率为 M 上每小片对应的辐射率乘 wo 方向上投影面积权重再求和。<br />
<img src="./UnderstandingTheGFunction/outgoing_radiance_M.jpg" alt="outgoing_radiance_M.jpg" /><br />
表面上每个点投影到出射方向的面积是依赖于出射方向的权重因子。 \(\int projArea(p_m)dp_m\) 是投影面积分数的归一化系数，该归一化系数使得上面公式整体为辐射率单位，没有归一化系数就会缺少公式中分母部分，就无法保证能量守恒。<br />
</p>
</div>
</div>
<div id="outline-container-org8ba5aaf" class="outline-4">
<h4 id="org8ba5aaf">Microfacet Statistics</h4>
<div class="outline-text-4" id="text-org8ba5aaf">
<p>
我们考虑一个平面区域，通常我们称其为几何表面 G，为了方便起见假设该区域的面积为 1 平方米。微表面模型假设真实表面是由一组偏离几何表面的微表面组合而成的。<br />
<img src="./UnderstandingTheGFunction/macrocfact_surface.jpg" alt="macrocfact_surface.jpg" /><br />
</p>

<p>
G     为宏观表面<br />
\(w_g\) 为宏观表面的法线<br />
M     为微表面<br />
\(p_m\) 为微表面 M 上的点<br />
\(w_m\) 为微表面 M 上 \(p_m\) 点对应的法线<br />
</p>

<p>
微表面理论是散射属性的统计模型，统计数字是定义在法线空间上的(即 球空间Ω上的)。<br />
</p>
</div>
<div id="outline-container-org718823c" class="outline-5">
<h5 id="org718823c">The Distribution of Normals</h5>
<div class="outline-text-5" id="text-org718823c">
<p>
为了将微表面上的积分和球上的积分关联起来，定义了法线分布函数 D(m)。D(m)为每平方米几何表面的微观法线分布，其单位为平方米每球面度( \(m^2/sr\) )而不是(1/sr)，其表示微观法线对应的微观表面面积。<br />
<img src="./UnderstandingTheGFunction/distributionOfNormals.jpg" alt="distributionOfNormals.jpg" /><br />
狄克拉δ分布函数的单位为其输入参数单位的倒数，上面公式中为 1/sr。<br />
</p>
</div>
</div>
<div id="outline-container-org4bfb94a" class="outline-5">
<h5 id="org4bfb94a">Spatial and Statistical Equations</h5>
<div class="outline-text-5" id="text-org4bfb94a">
<p>
有了法线分布函数，就可以将表面空间的积分转化为统计空间(球空间)的积分。<br />
<img src="./UnderstandingTheGFunction/spatial-integral2statistical-integral.jpg" alt="spatial-integral2statistical-integral.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-org77fd0d1" class="outline-5">
<h5 id="org77fd0d1">Statistical Functions</h5>
<div class="outline-text-5" id="text-org77fd0d1">
<p>
如果 \(g(p_m)\) 为定义在表面空间上的函数，我们可以按照下面方式将其转化为定义在统计空间的函数 \(g(w_m)\) ：<br />
<img src="./UnderstandingTheGFunction/spatial-func2statistical-func.jpg" alt="spatial-func2statistical-func.jpg" /><br />
统计空间积分和表面空间积分的关系满足：<br />
<img src="./UnderstandingTheGFunction/spatial-integral2statistical-integral_01.jpg" alt="spatial-integral2statistical-integral_01.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org03a9a10" class="outline-4">
<h4 id="org03a9a10">Microfact Projections</h4>
<div class="outline-text-4" id="text-org03a9a10">
<p>
<img src="./UnderstandingTheGFunction/macrocfact_proj.jpg" alt="macrocfact_proj.jpg" /><br />
<img src="./UnderstandingTheGFunction/wo_visible_microfacet_area.jpg" alt="wo_visible_microfacet_area.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-orgc79be0e" class="outline-4">
<h4 id="orgc79be0e">A Constraint on the Masking Function</h4>
<div class="outline-text-4" id="text-orgc79be0e">
<p>
G1 函数需要遵守下面的约束条件，其表示 wo 方向可见微表面投影面积应该和宏观几何表面在该方向的投影面积相等：<br />
<img src="./UnderstandingTheGFunction/G1Func_constraint01.jpg" alt="G1Func_constraint01.jpg" /><br />
基于物理的 G1 函数必须满足上面的约束，但是该约束无法确定唯一的 G1 函数，有无限多个 G1 函数满足该约束。为了确定唯一的 G1 函数，我们引入第二个约束，即选择一个特定的 microsurface profile。可以对此进行直观的理解，法线分布就像一个直方图，其描述的是每个微表面法线所占的比例，其并没有提供这些微表面法线是如何组织在一起的。microsurface profile 可以提供微表面的组织情况。从下图可以看出，microsurface profile 的选择对 BRDF 的结果造成很大影响。<br />
<img src="./UnderstandingTheGFunction/microsurface_profile01.jpg" alt="microsurface_profile01.jpg" /><br />
选定 microsurface profile 后，G1 函数就可以完全确定。<br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgd452221" class="outline-3">
<h3 id="orgd452221">Microfacet-Based BRDFs</h3>
<div class="outline-text-3" id="text-orgd452221">
</div>
<div id="outline-container-org74c2d6a" class="outline-4">
<h4 id="org74c2d6a">Distribution of Visible Normals</h4>
<div class="outline-text-4" id="text-org74c2d6a">
<p>
<img src="./UnderstandingTheGFunction/visible_normal_distribution.jpg" alt="visible_normal_distribution.jpg" /><br />
distribution of visible normals 的归一化非常重要，因为我们使用其作为权重函数来得到平均的辐射率，按照 <a href="#orgc1c6cea">Measuring Radiance on a Surface</a> 的描述，只有归一化才能保证辐射率单位正确，保证能量守恒。<br />
</p>
</div>
</div>
<div id="outline-container-orgc37bbe0" class="outline-4">
<h4 id="orgc37bbe0">Construction of the BRDF</h4>
<div class="outline-text-4" id="text-orgc37bbe0">
<p>
<img src="./UnderstandingTheGFunction/single-bounce-brdf.jpg" alt="single-bounce-brdf.jpg" /><br />
上图中公式 25，只模拟了射线第一次弹射后被反射的情况。但是，BRDF 模型应该描述射线离开表面后的分布。射线第一次被反射后的分布和最终离开表面的分布并不相同，因为一些反射的射线会再次碰到微表面，而后被反射到其他方向，如下图所示。因为，此处推导出的 BRDF 只计算一次弹射，需要将多次弹射的射线从该模型中移除，我们通过引入 shadowing 函数来移除多次弹射。实践上我们使用 masking-shadowing 函数 G2 来代替 masking-function 函数 G1。<br />
<img src="./UnderstandingTheGFunction/multi_scattering.jpg" alt="multi_scattering.jpg" /><br />
下图为推导出的只计算一次弹射的 BRDF ，多次弹射通过 G2 函数移除掉了：<br />
<img src="./UnderstandingTheGFunction/brdf_001.jpg" alt="brdf_001.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-orga4ad188" class="outline-4">
<h4 id="orga4ad188">Construction of the BRDF with specular microfacets</h4>
<div class="outline-text-4" id="text-orga4ad188">

<div id="org747a54f" class="figure">
<p><img src="./UnderstandingTheGFunction/brdf_002.jpg" alt="brdf_002.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org0646df7" class="outline-4">
<h4 id="org0646df7">Construction of the BRDF with diffuse microfacets</h4>
<div class="outline-text-4" id="text-org0646df7">

<div id="orgcf6090a" class="figure">
<p><img src="./UnderstandingTheGFunction/brdf_003.jpg" alt="brdf_003.jpg" /><br />
</p>
</div>

<p>
上面推导出来的表面 brdf 没有解析解。Oren 和 Nayar 假定法线分布为球面高斯分布，并且 G2 为 V 字凹槽对应的 masking-shadowing function 时，推导出了一个函数，其满足上面方程。<br />
</p>
</div>
</div>
<div id="outline-container-org3ac271e" class="outline-4">
<h4 id="org3ac271e">The BRDF Normalization Test</h4>
<div class="outline-text-4" id="text-org3ac271e">
</div>
<div id="outline-container-org7f0adab" class="outline-5">
<h5 id="org7f0adab">The White Furnace Test</h5>
<div class="outline-text-5" id="text-org7f0adab">
<p>
双向散射分布函数是双向反射分布函数和双向透射分布函数的和。当表面不吸收辐射率时，散射射线的分布遵守下面的约束：<br />
<img src="./UnderstandingTheGFunction/scatter_constrain.jpg" alt="scatter_constrain.jpg" /><br />
当 Fresnel 项始终为 1 时，光线就不会透射，此时 BTDF 为 0，散射模型中只包含反射。这种情况下，brdf 的分布遵守下面的约束，其就是 White Furnace Test 方程：<br />
<img src="./UnderstandingTheGFunction/brdf_constrain_001.jpg" alt="brdf_constrain_001.jpg" /><br />
直观上来看，其表达了下面事实，从出射方向发射的射线将会被散射一次或多次并最终完全离开表面。但是，通常解析形式的 BRDF 模型并不会对微表面上的多次散射进行建模，其使用 shadowing 函数将多次散射移除掉了。因此，通常的 BRDF 不满足 White Furnace Test 方程。<br />
</p>
</div>
</div>
<div id="outline-container-org15258c2" class="outline-5">
<h5 id="org15258c2">The Weak White Furnace Test</h5>
<div class="outline-text-5" id="text-org15258c2">
<p>
通过将 masking-shadowing 函数 G2 换为 masking 函数 G1，我们可以得到如下 Weak White Furnace Test 方程，忽略掉多次散射的 brdf 也遵守下面的约束：<br />
<img src="./UnderstandingTheGFunction/brdf_constrain_002.jpg" alt="brdf_constrain_002.jpg" /><br />
</p>
</div>
</div>

<div id="outline-container-org013d5f3" class="outline-5">
<h5 id="org013d5f3">Summary</h5>
<div class="outline-text-5" id="text-org013d5f3">
<p>
下图总结了 BRDF Normaliztion：<br />
<img src="./UnderstandingTheGFunction/brdf_normalization.jpg" alt="brdf_normalization.jpg" /><br />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orga411aba" class="outline-3">
<h3 id="orga411aba">Common Physically Based and Non-Physically Based Masking Functions</h3>
<div class="outline-text-3" id="text-orga411aba">
</div>
<div id="outline-container-org95ce506" class="outline-4">
<h4 id="org95ce506">The Smith Microsurface Profile</h4>
<div class="outline-text-4" id="text-org95ce506">
</div>
<div id="outline-container-orgf6a0c04" class="outline-5">
<h5 id="orgf6a0c04">Normal/Masking Independence</h5>
<div class="outline-text-5" id="text-orgf6a0c04">
<p>
Smith Microsurface Profile 假定微表面是非自我相关的，即某点的法线(或高度)和邻近点的法线(或高度)无关，如下图中右边图示。<br />
<img src="./UnderstandingTheGFunction/smith_microsurface_profile.jpg" alt="smith_microsurface_profile.jpg" /><br />
从该模型可以得出 G1 函数独立于法线分布。直观上讲，法线是微表面的局部属性，而微表面上的遮挡则可能发生在微表面的任何地方，其为微表面的距离属性(尽管该距离依然是微观尺度上)。因为，微表面是非自我相关的，局部属性独立于距离属性，因此 masking 函数可以被分解为如下形式：<br />
<img src="./UnderstandingTheGFunction/G1Func_separate.jpg" alt="G1Func_separate.jpg" /><br />
</p>
</div>
</div>

<div id="outline-container-org53b9969" class="outline-5">
<h5 id="org53b9969">Derivation of the Masking Function</h5>
<div class="outline-text-5" id="text-org53b9969">

<div id="org3ad0d4b" class="figure">
<p><img src="./UnderstandingTheGFunction/G1Func_derive.jpg" alt="G1Func_derive.jpg" /><br />
</p>
</div>
</div>
</div>

<div id="outline-container-orgef00b41" class="outline-5">
<h5 id="orgef00b41">The Smith Masking Function</h5>
<div class="outline-text-5" id="text-orgef00b41">

<div id="org1672455" class="figure">
<p><img src="./UnderstandingTheGFunction/smith-masking-func.jpg" alt="smith-masking-func.jpg" /><br />
</p>
</div>
</div>
</div>

<div id="outline-container-org22b3874" class="outline-5">
<h5 id="org22b3874">Properties</h5>
<div class="outline-text-5" id="text-org22b3874">
<p>
如果我们将推导出的解析函数和测量数据进行比较，将会发现模型预测的结果有一定的正确性，但是不是完全正确。模型是精确推导出来的，但是其只是近似拟合测量数据。<br />
</p>
</div>
</div>
</div>
<div id="outline-container-org32f294f" class="outline-4">
<h4 id="org32f294f">The V-Cavity Microsurface Profile</h4>
<div class="outline-text-4" id="text-org32f294f">
<p>
下图为 The V-Cavity Microsurface Profile<br />
<img src="./UnderstandingTheGFunction/v-cavity_microsurface_profile.jpg" alt="v-cavity_microsurface_profile.jpg" /><br />
下图为基于 The V-Cavity Microsurface Profile 推导 G1 函数的过程：<br />
<img src="./UnderstandingTheGFunction/G1Func_derive_v-cavity.jpg" alt="G1Func_derive_v-cavity.jpg" /><br />
</p>
</div>

<div id="outline-container-org15021b2" class="outline-5">
<h5 id="org15021b2">Validation</h5>
<div class="outline-text-5" id="text-org15021b2">
<p>
V-Cavity Microsurface Profile 下推导出的 visible normal distribution 如下：<br />
<img src="./UnderstandingTheGFunction/visible-normal-dist-v-cavity001.jpg" alt="visible-normal-dist-v-cavity001.jpg" /><br />
</p>

<p>
下图展示了 v-cavity 模型下，masking 函数的两种取值情况：<br />
<img src="./UnderstandingTheGFunction/masking-func-v-cavity-illustrate.jpg" alt="masking-func-v-cavity-illustrate.jpg" /><br />
</p>

<p>
上面的形式由于 min(1, -)项的存在，研究起来比较复杂。但是，V-cavity 模型和 Smith 模型的主要差别在掠射角的情况下。此时上面的 visible normal distribution 函数为下面形式：<br />
<img src="./UnderstandingTheGFunction/visible-normal-dist-v-cavity002.jpg" alt="visible-normal-dist-v-cavity002.jpg" /><br />
</p>

<p>
下面公式推导了掠射角情况下，V-cavity 模型对应的 visible normal distribution 的归一性：<br />
<img src="./UnderstandingTheGFunction/visible-normal-dist-v-cavity-normalize001.jpg" alt="visible-normal-dist-v-cavity-normalize001.jpg" /><br />
</p>
</div>
</div>

<div id="outline-container-orgaa07e94" class="outline-5">
<h5 id="orgaa07e94">Properties</h5>
<div class="outline-text-5" id="text-orgaa07e94">
<p>
V-cavities 模型下的 visible normal distribution 符合归一化约束，但是其并不是物理正确的，掠射角情况下，其模拟的 surface profile 是不真实的。该模型更像一个 normal map 而不是 displacement map,如下图所示：<br />
<img src="./UnderstandingTheGFunction/v-cavity-like-normal-map.jpg" alt="v-cavity-like-normal-map.jpg" /><br />
</p>

<p>
对于单个微表面，normal 可见性越高则其所占的投影面积越大。但是，在 V-cavities 模型中，不同的 normal 被分开模拟，并且由法线分布来确定其权重，该权重中不包含视角相关的因子（除了背面法线的丢弃）。因此 V-cavity 模型缺少可见性效果，最终模拟的效果更像 normal map。<br />
</p>

<p>
下图展示了使用各项同性的 Beckmann 分布构造的 BRDF。从左到右，Beckmann 分布分别使用了 V-cavity 和 Smith Masking-Shadowing function。从图中可以看出，随着粗糙度增大，Smith 分布向出射方向偏移。对于非常高的粗糙度值，BRDF 甚至主要为后向散射。这样的效果在测量数据中出现了，但是，V-cavity model 没有再现这种效果。<br />
<img src="./UnderstandingTheGFunction/v-cavity-vs-smith.jpg" alt="v-cavity-vs-smith.jpg" /><br />
</p>
</div>
</div>
</div>

<div id="outline-container-orgab80930" class="outline-4">
<h4 id="orgab80930">Non-Physically Based Masking Functions</h4>
<div class="outline-text-4" id="text-orgab80930">
</div>
<div id="outline-container-orgb7e8524" class="outline-5">
<h5 id="orgb7e8524">Definition</h5>
<div class="outline-text-5" id="text-orgb7e8524">
<p>
基于物理的 Masking Function 是从微表面模型推导，或者是在物理微表面上测量得到的。基于物理的 Masking Function 遵守下面这些约束，非基于物理的 G1 函数则不满足这些约束：<br />
<img src="./UnderstandingTheGFunction/physical-masking-func-constrain.jpg" alt="physical-masking-func-constrain.jpg" /><br />
</p>
</div>

<div id="outline-container-org17680d6" class="outline-6">
<h6 id="org17680d6">The Implicit Masking Function</h6>
<div class="outline-text-6" id="text-org17680d6">
<p>
<img src="./UnderstandingTheGFunction/implicit-G1Func.jpg" alt="implicit-G1Func.jpg" /><br />
Implicit G2 函数假定 G2 中的 |wo.wg||wi.wg| 与 brdf 中分母中的归一化因子约去了。<br />
</p>
</div>
</div>
<div id="outline-container-org90f6ec0" class="outline-6">
<h6 id="org90f6ec0">The Schilick-Smith Masking Function</h6>
<div class="outline-text-6" id="text-org90f6ec0">
<p>
Schilick 1994 年提出近似 Smith G1 函数的 G1 函数，该 G1 函数被称为 Schilick-Smith G1 函数，Schilick-Smith G1 有三个问题：<br />
</p>
<ol class="org-ol">
<li>roughness 参数 m 在论文中使用不一致，有的地方 m 表示微表面斜率的均方根（求其均值，再开平方，就得到均方根值）。有的地方 m 则表示粗糙度参数，来自 Beckmann 分布中 \(m = α = sqrt(2)σ\) ，其表示对斜率均方根缩放根号 2。这导致，G1 函数和 D 分布中使用的粗糙度不一致。<br /></li>
<li>其使用的 Smith Masking 函数是错误的。Schilick 使用了 1991 年 He Torrance 提供的变形公式，该公式中漏掉了Λ的指数项。<br /></li>
<li>Schilick 使用了 Smith-Masking 函数的 height-and-normal-averaged 版本，该版本适用于波动光学。几何光学应该使用 height-averaged 版本。<br /></li>
</ol>

<p>
译者书： 不敢相信，尽然这么多错误。<br />
</p>
</div>
</div>
<div id="outline-container-orgf32e9b2" class="outline-6">
<h6 id="orgf32e9b2">The Kelemen Masking Function</h6>
<div class="outline-text-6" id="text-orgf32e9b2">
<p>
Keleman 2001 年提出了一种 V-cavity 模型 G2 函数的廉价替代方案，如下：<br />
<img src="./UnderstandingTheGFunction/kelemen-G1Func.jpg" alt="kelemen-G1Func.jpg" /><br />
</p>

<p>
上面的 G1 函数和 V-cavity 的 G1 函数很接近：|wo.wg|为几何表面的投影面积，也为正对 wo 方向可见微表面的投影面积，|wo.wh|为正对 wo 方向微表面的投影面积。|wo.wg|/|wo.wh|就是 wo 方向上可见微表面的概率。<br />
Keleman G1 函数不能保证遵守前面的公式 14。尽管其可以很好近似 V-cavity G1 函数，但是其不是基于物理的。<br />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org2b6e2c7" class="outline-3">
<h3 id="org2b6e2c7">Stetch Invariance of the Masking Function</h3>
<div class="outline-text-3" id="text-org2b6e2c7">
</div>
<div id="outline-container-org210c1af" class="outline-4">
<h4 id="org210c1af">Masking Probability Invariance</h4>
<div class="outline-text-4" id="text-org210c1af">
<p>
<img src="./UnderstandingTheGFunction/masking_probability_invariance_illustrate.jpg" alt="masking_probability_invariance_illustrate.jpg" /><br />
上图展示了，对于给定的出射方向，拉伸一维结构对微表面 masking 产生的影响。拉伸结构类似于拉伸图片，该操作不会影响结构的拓扑：拉伸后，被遮挡射线依然被遮挡，没被遮挡的射线依然没被遮挡。遮挡概率的重要属性就是结构拉伸的不变性。包括微表面斜率和出射方向斜率，都被按照拉伸因子的倒数进行缩放。<br />
</p>
</div>
</div>
<div id="outline-container-orgb1809a5" class="outline-4">
<h4 id="orgb1809a5">The Distribution of Slopes</h4>
<div class="outline-text-4" id="text-orgb1809a5">

<div id="orgcee9cd5" class="figure">
<p><img src="./UnderstandingTheGFunction/slope_distribution.jpg" alt="slope_distribution.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org4d911af" class="outline-4">
<h4 id="org4d911af">Isotropic Shape-Invariant Distributions of Slopes</h4>
<div class="outline-text-4" id="text-org4d911af">
</div>
<div id="outline-container-org110b291" class="outline-5">
<h5 id="org110b291">Shape Invariance</h5>
<div class="outline-text-5" id="text-org110b291">
<p>
当斜率分布只依赖于 \(tan(θ_m)/α\) 时，斜率分布 \(P^{22}\) 为：<br />
<img src="./UnderstandingTheGFunction/isotropic-shape-invariant-dist-of-slopes.jpg" alt="isotropic-shape-invariant-dist-of-slopes.jpg" /><br />
</p>

<ul class="org-ul">
<li>\(tan(θ_m)\) 夹角为 \(θ_m\) 的法线对应的斜率<br /></li>
<li>α 粗糙度参数<br /></li>
</ul>
<p>
上面的斜率分布是形状不变的，因为分布的形状始终为 f 的形状，并且形状只会随粗糙度参数 α 缩放。<br />
</p>

<p>
各项同性的形状不变的斜率分布对结构进行拉伸等价于使用相同的缩放因子缩放粗糙度参数α和出射方向向量的斜率。这隐含说明了 masking 函数只依赖于 \(1/αtan(θ_o)\) , \(1/tan(θ_o)\) 为出射方向的斜率。Beckmann 和 GGX 分布都为形状不变的。<br />
</p>
</div>
</div>
<div id="outline-container-org308cd14" class="outline-5">
<h5 id="org308cd14">Beckmann Distribution</h5>
<div class="outline-text-5" id="text-org308cd14">

<div id="orgf9131f6" class="figure">
<p><img src="./UnderstandingTheGFunction/beckmann-dist01.jpg" alt="beckmann-dist01.jpg" /><br />
</p>
</div>

<p>
Λ函数的意义可以参考下图：<br />
<img src="./PhysicallyBasedRendering/2020_06_24_g_distribution_func.jpg" alt="2020_06_24_g_distribution_func.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-org732f344" class="outline-5">
<h5 id="org732f344">GGX Distribution</h5>
<div class="outline-text-5" id="text-org732f344">

<div id="orgc145d75" class="figure">
<p><img src="./UnderstandingTheGFunction/ggx-dist.jpg" alt="ggx-dist.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org89eee80" class="outline-5">
<h5 id="org89eee80">Shape-variant distributions</h5>
<div class="outline-text-5" id="text-org89eee80">
<p>
需要注意的是并不是所有分布都是形状不变的，Phong 分布就是形状变化的分布。<br />
</p>
</div>
</div>
</div>
<div id="outline-container-org4888636" class="outline-4">
<h4 id="org4888636">Anisotropic Shape-Invariant Distributions of Slopes</h4>
<div class="outline-text-4" id="text-org4888636">
</div>
<div id="outline-container-orge5a740d" class="outline-5">
<h5 id="orge5a740d">Shape Invariance</h5>
<div class="outline-text-5" id="text-orge5a740d">
<p>
如果使用依赖于方位角的因子缩放形状，则形状不变的分布可以为各项异性的。斜率的权重因子被分配到每个方向上，此时对应的斜率分布为：<br />
<img src="./UnderstandingTheGFunction/anisotropic-slope_distribution.jpg" alt="anisotropic-slope_distribution.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-org1c604a4" class="outline-5">
<h5 id="org1c604a4">Derivation of the Masking Function</h5>
<div class="outline-text-5" id="text-org1c604a4">
<p>
<img src="./UnderstandingTheGFunction/isotropic-slope-dist2anisotropic-slope-dist-illustrate.jpg" alt="isotropic-slope-dist2anisotropic-slope-dist-illustrate.jpg" /><br />
上图展示了，通过拉伸表面将各项同性的形状不变分布转化为各项异性的分布。相反地，任何一个各项异性分布的结构可以转变为一个各项同性分布的结构。我们利用该属性来推导出 masking 函数。<br />
<img src="./UnderstandingTheGFunction/derivate_anisotropic_g1.jpg" alt="derivate_anisotropic_g1.jpg" /><br />
从上面的推导可以得出，各向异性形状不变的斜率分布对应的 masking 函数与该斜率分布对应的各项同性分布的 masking 函数相同。唯一的差别是，需要将各项异性表面的粗糙度投影到出射方向上来进行参数化。利用该属性可以推导出各项异性的 Beckmann 和 GGX 分布。<br />
</p>
</div>
</div>
<div id="outline-container-org560928d" class="outline-5">
<h5 id="org560928d">Anisotropic Beckmann Distribution</h5>
<div class="outline-text-5" id="text-org560928d">

<div id="orgb5163da" class="figure">
<p><img src="./UnderstandingTheGFunction/anisotropic-beckmann-dist01.jpg" alt="anisotropic-beckmann-dist01.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgb1615e2" class="outline-5">
<h5 id="orgb1615e2">Anisotropic GGX Distribution</h5>
<div class="outline-text-5" id="text-orgb1615e2">

<div id="orgf2999a2" class="figure">
<p><img src="./UnderstandingTheGFunction/anisotropic-ggx-dist.jpg" alt="anisotropic-ggx-dist.jpg" /><br />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgeeda482" class="outline-4">
<h4 id="orgeeda482">More Generalization</h4>
<div class="outline-text-4" id="text-orgeeda482">
</div>
<div id="outline-container-orge6431c8" class="outline-5">
<h5 id="orge6431c8">Arbitrary Shape-Invariant Distributions</h5>
<div class="outline-text-5" id="text-orge6431c8">
<p>
形状不变的分布的重要属性是，对于任意粗糙度或任意各向异性的结构，求解 masking 函数的所需的所有信息在 1 维的 Λ 函数中都包含了。因此，Λ确定后，可以使用Λ来构造任意粗糙度和任意各项异性的参数化分布。选择任意一个一维的函数 f，可以按照下面方式构造对于的各项异性法线分布：<br />
<img src="./UnderstandingTheGFunction/anisotropic-normal-dist.jpg" alt="anisotropic-normal-dist.jpg" /><br />
上面公式中的 c 为该分布的归一化常量系数。关联的一维 \(Λ(\frac(1,α_o*tanθ_o))\) 函数，可以通过合理的多项式拟合出来。<br />
</p>
</div>
</div>
<div id="outline-container-org7369835" class="outline-5">
<h5 id="org7369835">Non Axis-Aligned Stretching</h5>
<div class="outline-text-5" id="text-org7369835">

<div id="org5c93403" class="figure">
<p><img src="./UnderstandingTheGFunction/non-axis-aligned-shape-invariance.jpg" alt="non-axis-aligned-shape-invariance.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org7c2458b" class="outline-5">
<h5 id="org7c2458b">Vertical Shearing and Non-Centered Distributions</h5>
<div class="outline-text-5" id="text-org7c2458b">
<p>
<img src="./UnderstandingTheGFunction/v-shearing-illustrate.jpg" alt="v-shearing-illustrate.jpg" /><br />
上图展示了在竖直方向上对结构进行切变，masking 函数依然保持不变。在竖直方向上对结构侵袭切变等价于将结构的所有斜率偏移一个固定的常量。统一其包含了对所有微表面斜率和斜率关联的出射方向进行了偏移。<br />
</p>

<p>
需要注意的是，竖直方向的切变不会影响投影的粗糙度 \(α_o\) 以及分布的归一化因子。从法线向量映射为斜率时不会将向量的旋转映射为斜率值的偏移，因此切变不变并不表示旋转法线也不变。<br />
通常，斜率分布中心在 0 附近，这意味着平均表面和几何表面对齐。但是，当宏观表面被某个高频参数放大时，该假设是错误的。bump 贴图，normal 贴图或 displacement 贴图的目的就是通过扰乱宏观 normal 来生成中间法线（mesonormal)。切变不变性表示 non-centered 微表面的 masking 函数和 centered 微表面的 masking 函数相同。<br />
对于 non-centered 分布，另一个需要注意的是，需要使用中间表面（mesosurface）来计算可见投影面积。BRDF 中的 \(cosθ_o\) 应该使用中间表面（mesosurface）的投影面积来代替。<br />
</p>


<div id="org59b2e09" class="figure">
<p><img src="./UnderstandingTheGFunction/v-shearing-derivate.jpg" alt="v-shearing-derivate.jpg" /><br />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org1b7dcf6" class="outline-3">
<h3 id="org1b7dcf6">The Smith Joint Masking-Shadowing Function</h3>
<div class="outline-text-3" id="text-org1b7dcf6">
</div>
<div id="outline-container-orgd933ca3" class="outline-5">
<h5 id="orgd933ca3">Separable Masking and Shadowing</h5>
<div class="outline-text-5" id="text-orgd933ca3">
<p>
<img src="./UnderstandingTheGFunction/separable-G2.jpg" alt="separable-G2.jpg" /><br />
该模型假设 masking 和 shadowing 互相独立。该模型过度估算了 shadowing，因为 masking 和 shadowing 总存在一定的相关性。<br />
</p>
</div>
</div>
<div id="outline-container-org2b68889" class="outline-5">
<h5 id="org2b68889">Height-Correlated Masking and Shadowing</h5>
<div class="outline-text-5" id="text-org2b68889">
<p>
直观来讲，微表面越高，在出射方向上其可见可能性越大，在入射方向上可见可能性也同样增大。因此，masking 和 shadowing 通过微表面的海拔相关联。考虑这种关联性可以得到如下的 G2 函数：<br />
<img src="./UnderstandingTheGFunction/height-corelated-G2.jpg" alt="height-corelated-G2.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-org4d0006e" class="outline-5">
<h5 id="org4d0006e">Direction-Correlated Masking and Shadowing</h5>
<div class="outline-text-5" id="text-org4d0006e">
<p>
当入射方向和出射方向靠近时，Masking 和 Shadowing 会有很强的相关性。特定情况下，当入射方向和出射方向相同时，从出射方向可见的微表面，从入射方向也可见。此时，应该将 shadowing 函数从 BRDF 中移除，因为 shadowed 的微表面从入射方向和出射方向都不可见。这被称为热点效应：视线和光方向平行时，阴影消失。考虑这种关联性可以得到如下的 G2 函数：<br />
<img src="./UnderstandingTheGFunction/dir-corelated-G2.jpg" alt="dir-corelated-G2.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-orgc194bc8" class="outline-5">
<h5 id="orgc194bc8">Height-Direction-Correlated Masking and Shadowing</h5>
<div class="outline-text-5" id="text-orgc194bc8">

<div id="orgea28ee1" class="figure">
<p><img src="./UnderstandingTheGFunction/dir-height-corelated-G2.jpg" alt="dir-height-corelated-G2.jpg" /><br />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org21c6edc" class="outline-3">
<h3 id="org21c6edc">Discussion and Future Work</h3>
<div class="outline-text-3" id="text-org21c6edc">
</div>
<div id="outline-container-org3e23847" class="outline-4">
<h4 id="org3e23847">Deriving the Smith Masking Function for Other Commonly Used Models</h4>
<div class="outline-text-4" id="text-org3e23847">
<p>
前面以及描述了为 Beckmann 和 GGX 分布推导出来的解析形式的 masking 函数。但是，对于其他常用的法线分布，masking 函数并不总是可以按照解析方式积分的。分布的形状不变性，使得其对应的 masking 函数只依赖于斜率和粗糙度的比值。因此，masking 函数中的Λ函数可以被编码为一个一维函数。形状变化的分布，其 masking 函数很难确定。<br />
</p>
</div>
</div>
<div id="outline-container-orga01059f" class="outline-4">
<h4 id="orga01059f">Correlation of Masking-Shadowing</h4>
<div class="outline-text-4" id="text-orga01059f">
<p>
任意分布对应的关联的 Masking-Shadowing 函数的推导，目前依然是一个开放性问题。<br />
</p>
</div>
</div>
<div id="outline-container-org27a7f3f" class="outline-4">
<h4 id="org27a7f3f">Multiple Scattering</h4>
<div class="outline-text-4" id="text-org27a7f3f">
<p>
模拟多次散射是改进当前通用 BRDF 模型表现效果的一种可行方式。Phong Beckmann GGX 和实际测量的材质相比较，都有过短的 tails。人们尝试保持标准的 BRDF 形式不变，微调法线分布。但是，通常这样做会让模型失去物理意义。<br />
不要再去开发更复杂的参数模型了，我们应该问问自己，是否测量数据中的特定效果从模型中消失了，然后，扩展模型来代替当前模型。模拟多次散射看上去是一个不错的候选方案，事实上其已经从物理学中被开发出来了。但是，这些模型太复杂了，物理学的目的是精确性而不是易于实现性。<br />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id="vssue"></div>
        <link rel="stylesheet" href="https://unpkg.com/vssue/dist/vssue.min.css">
        <script src="https://unpkg.com/vue@2.7.10/dist/vue.runtime.min.js"></script>
        <script src="https://unpkg.com/vssue/dist/vssue.github.min.js"></script>
        <script>
          new Vue({
            el: '#vssue',
            render: h => h('Vssue', {
              props: {
                // 在这里设置当前页面对应的 Issue 标题
                title: 'UnderstandingTheGFunction',

                // 在这里设置你使用的平台的 OAuth App 配置
                options: {
                    owner: 'wolfand11',
                    repo: 'blog_comments',
                    clientId: 'a02b49185d85859cb92c',
                    clientSecret: '6f123085c6f1ce339e2517d24e5b099fa1dc9c85', // 只有在使用某些平台时需要
                },
              }
            })
          })
        </script>
</div>
</body>
</html>
