<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-06-27 Tue 22:36 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Programming in Lua</title>
<meta name="generator" content="Org Mode" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
         <meta name="viewport" content="width=device-width, initial-scale=1" />
         <link rel="stylesheet" title="Standard" href="https://wolfand11.github.io/res/worg_theme/css/worg.css" type="text/css" />
         <link rel="alternate stylesheet" title="Zenburn" href="https://wolfand11.github.io/res/worg_theme/css/worg-zenburn.css" type="text/css" />
         <link rel="alternate stylesheet" title="Classic" href="https://wolfand11.github.io/res/worg_theme/css/worg-classic.css" type="text/css" />
         <link rel="icon" href="https://wolfand11.github.io/res/favicon.ico" type="image/ico" />
         <script type="text/javascript" src="https://wolfand11.github.io/res/blog-tools.js"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="https://wolfand11.github.io"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">Programming in Lua</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgab9822c">Programming in Lua</a></li>
<li><a href="#orgb0f1c34">Lua Reference Manual</a>
<ul>
<li><a href="#orgdcac3e3">Basic Concpts</a>
<ul>
<li><a href="#orgc489f0d">Type and Values</a>
<ul>
<li><a href="#orgc88aa9b">bool</a></li>
</ul>
</li>
<li><a href="#org3d85b1f">Metatable and Metamethod</a>
<ul>
<li><a href="#orgfa88afa">metatable-metamethod 实现支持继承的 class</a>
<ul>
<li><a href="#org21c8951">实现 class 关键要实现以下几点：</a></li>
<li><a href="#orgad1077b">Tips:</a></li>
<li><a href="#org662f152">具体实现</a></li>
<li><a href="#org6ee05bf">Tips:</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc2c9b03">The Language</a></li>
<li><a href="#orgc057648">The Application Program Interface</a></li>
<li><a href="#org88dafac">The Auxiliary Library</a></li>
<li><a href="#org40905dc">The Standard Libraries</a>
<ul>
<li><a href="#org5472307">String Manipulation</a>
<ul>
<li><a href="#org1d0067f">format</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgdecbe88">Lua Standalone</a></li>
<li><a href="#orge52bac8">Incompatibilities with the Previous Version</a></li>
<li><a href="#org0fdcbbc">The Complete Syntax of Lua</a></li>
</ul>
</li>
<li><a href="#org0ac45a9">Usage</a>
<ul>
<li><a href="#orgae9b68b">开发环境</a>
<ul>
<li><a href="#orgbf33e5d">lua</a></li>
<li><a href="#org16308cd">luarocks 包管理</a>
<ul>
<li><a href="#org7acedb5">ERROR</a></li>
</ul>
</li>
<li><a href="#org42b9109">IDE</a>
<ul>
<li><a href="#orgd6eddc1">VSCode</a></li>
<li><a href="#org3530fcb">ZeroBrane</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org538d7bd">Basic</a>
<ul>
<li><a href="#org504c540">打印代码和对应的执行结果</a></li>
<li><a href="#orgad911db">打印代码执行时间的方法</a></li>
</ul>
</li>
<li><a href="#org7779116">Lpeg</a>
<ul>
<li><a href="#org17d7320">lpeg</a>
<ul>
<li><a href="#org3555a7f">Introduction</a></li>
<li><a href="#org9a1cdda">Functions</a></li>
<li><a href="#orgdcbec78">Basic Constructions</a>
<ul>
<li><a href="#orgc475a05">lpeg.P(value)</a></li>
<li><a href="#org106ad82">lpeg.B(patt)</a></li>
<li><a href="#org3b67d0b">lpeg.R({range})</a></li>
<li><a href="#orgaf2bb81">lpeg.S(string)</a></li>
<li><a href="#org9aee42c">lpeg.V(v)</a></li>
<li><a href="#org5ab55a5">lpeg.locale([table])</a></li>
<li><a href="#org7552e58">patt1+patt2</a></li>
<li><a href="#orgc5bb4a4">patt1-patt2</a></li>
<li><a href="#org330fc73">-patt</a></li>
<li><a href="#org751581e">#patt</a></li>
<li><a href="#org3f3cbe0">patt1*patt2</a></li>
<li><a href="#org46b8958">patt^n</a></li>
</ul>
</li>
<li><a href="#org8ebb532">Grammars</a></li>
<li><a href="#org5be8495">Captures</a>
<ul>
<li><a href="#orgdc86dd3">lpeg.C (patt)</a></li>
<li><a href="#org038fb7c">lpeg.Carg (n)</a></li>
<li><a href="#org37a77a2">lpeg.Cb (name)</a></li>
<li><a href="#orgc81d328">lpeg.Cc ([value, &#x2026;])</a></li>
<li><a href="#org4b07e60">lpeg.Cf (patt, func)</a></li>
<li><a href="#orgc60f1aa">lpeg.Cg (patt [, name])</a></li>
<li><a href="#org152bf5d">lpeg.Cp ()</a></li>
<li><a href="#org24a0e11">lpeg.Cs (patt)</a></li>
<li><a href="#orgb6f33f1">lpeg.Ct (patt)</a></li>
<li><a href="#orgd7adc3c">patt / string</a></li>
<li><a href="#org5d7749f">patt / number</a></li>
<li><a href="#org2bc0cbd">patt / table</a></li>
<li><a href="#org1ff2509">patt / function</a></li>
<li><a href="#org1c8f3d0">lpeg.Cmt(patt, function)</a></li>
</ul>
</li>
<li><a href="#org11a7372">Some Examples</a>
<ul>
<li><a href="#orgdfbae4b">使用 Pattern</a></li>
<li><a href="#org6edbb27">匹配换行</a></li>
<li><a href="#org9537b69">匹配末尾</a></li>
<li><a href="#org3d0e326">匹配数字</a></li>
<li><a href="#orgfcdfdfc">匹配浮点数</a></li>
</ul>
</li>
<li><a href="#org0fb7051">参考资料</a></li>
</ul>
</li>
<li><a href="#org53bfe5f">Simple mathematical expression parser and evaluator in Lua with LPEG</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org9afb2c4">参考资料</a></li>
</ul>
</div>
</div>
<p>
lua note.<br />
</p>
<div class="HTML" id="org3c0769b">
<p>
&lt;!&#x2013; more &#x2013;&gt;<br />
</p>

</div>
<div id="outline-container-orgab9822c" class="outline-2">
<h2 id="orgab9822c">Programming in Lua</h2>
</div>
<div id="outline-container-orgb0f1c34" class="outline-2">
<h2 id="orgb0f1c34">Lua Reference Manual</h2>
<div class="outline-text-2" id="text-orgb0f1c34">
</div>
<div id="outline-container-orgdcac3e3" class="outline-3">
<h3 id="orgdcac3e3">Basic Concpts</h3>
<div class="outline-text-3" id="text-orgdcac3e3">
</div>
<div id="outline-container-orgc489f0d" class="outline-4">
<h4 id="orgc489f0d">Type and Values</h4>
<div class="outline-text-4" id="text-orgc489f0d">
</div>
<div id="outline-container-orgc88aa9b" class="outline-5">
<h5 id="orgc88aa9b">bool</h5>
<div class="outline-text-5" id="text-orgc88aa9b">
<p>
lua 在进行条件测试中，nil 和 false 为 false，任何其他值都为 true。<br />
</p>
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">PrintBoolCheck</span>(<span style="color: #7590db;">var</span>)
    <span style="color: #4f97d7; font-weight: bold;">if</span> var <span style="color: #4f97d7; font-weight: bold;">then</span>
        <span style="color: #4f97d7;">print</span>(<span style="color: #4f97d7;">tostring</span>(var) .. <span style="color: #2d9574;">" is true"</span>)
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        <span style="color: #4f97d7;">print</span>(<span style="color: #4f97d7;">tostring</span>(var) .. <span style="color: #2d9574;">" is false"</span>)
    <span style="color: #4f97d7; font-weight: bold;">end</span>
<span style="color: #4f97d7; font-weight: bold;">end</span>

PrintBoolCheck(<span style="color: #a45bad;">nil</span>)
PrintBoolCheck(<span style="color: #a45bad;">false</span>)
PrintBoolCheck({})
<span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">output</span>
<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">nil is false</span>
<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">false is false</span>
<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">table: 0xed7f00 is true</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3d85b1f" class="outline-4">
<h4 id="org3d85b1f">Metatable and Metamethod</h4>
<div class="outline-text-4" id="text-org3d85b1f">
<p>
metatable 是 lua 中修改 table 默认行为的一种机制。通过给一个 table 指定 metatable，并给该 metatable 添加一些特定的方法，就可以改变 table 的行为。<br />
例如：<br />
给 metatable 添加__index 元方法，可以改变索引 table 不存在字段时的行为。<br />
给 metatable 添加__newindex 元方法，可以改变为 table 不存在字段赋值时的行为。<br />
</p>
</div>
<div id="outline-container-orgfa88afa" class="outline-5">
<h5 id="orgfa88afa">metatable-metamethod 实现支持继承的 class</h5>
<div class="outline-text-5" id="text-orgfa88afa">
</div>
<div id="outline-container-org21c8951" class="outline-6">
<h6 id="org21c8951">实现 class 关键要实现以下几点：</h6>
<div class="outline-text-6" id="text-org21c8951">
<ul class="org-ul">
<li>类支持构造对象，构造出的对象共用类的方法<br />
可以 new 对象，new 对象时调用类的构造函数<br /></li>
<li>子类对象可以访问父类的方法<br /></li>
<li>构造对象时，先调用父类构造函数，后调用子类构造函数<br />
通常父类的构造函数调用不封装在 class 的实现中，而是放在定义类的时候，这样可以让上层控制，父类构造函数的调用顺序，以及是否调用。<br /></li>
<li>子类对象拥有父类对象的属性<br /></li>
</ul>
</div>
</div>
<div id="outline-container-orgad1077b" class="outline-6">
<h6 id="orgad1077b">Tips:</h6>
<div class="outline-text-6" id="text-orgad1077b">
<p>
在元方法__index 中取属性时，需要使用 rawget,否则会自己调用自己陷入死循环<br />
</p>
</div>
</div>
<div id="outline-container-org662f152" class="outline-6">
<h6 id="org662f152">具体实现</h6>
<div class="outline-text-6" id="text-org662f152">
<p>
在该实现中，我将父类的构造函数调用也封装到 class 实现中了。<br />
</p>
<div class="org-src-container">
<pre class="src src-lua">  <span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">class</span>(<span style="color: #7590db;">clsName</span>, <span style="color: #7590db;">super</span>)
      <span style="color: #4f97d7; font-weight: bold;">if</span> clsName==<span style="color: #a45bad;">nil</span> <span style="color: #4f97d7; font-weight: bold;">then</span>
          <span style="color: #4f97d7;">print</span>(<span style="color: #2d9574;">"Error: className is nil"</span>)
      <span style="color: #4f97d7; font-weight: bold;">end</span>
      <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">_G</span>[clsName] <span style="color: #4f97d7; font-weight: bold;">then</span>
          <span style="color: #4f97d7;">print</span>(<span style="color: #2d9574;">"Error: class eixst. className = "</span> .. clsName)
      <span style="color: #4f97d7; font-weight: bold;">end</span>

      <span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">invoke_ctor</span>(<span style="color: #7590db;">class</span>, <span style="color: #7590db;">obj</span>, ...)
          <span style="color: #4f97d7; font-weight: bold;">if</span> class~=<span style="color: #a45bad;">nil</span> <span style="color: #4f97d7; font-weight: bold;">then</span>
              invoke_ctor(<span style="color: #4f97d7;">rawget</span>(class,<span style="color: #2d9574;">"super"</span>), obj, ...)
              <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">type</span>(<span style="color: #4f97d7;">rawget</span>(class,<span style="color: #2d9574;">"ctor"</span>))==<span style="color: #2d9574;">"function"</span> <span style="color: #4f97d7; font-weight: bold;">then</span>
                  class.ctor(obj, ...)
              <span style="color: #4f97d7; font-weight: bold;">end</span>
          <span style="color: #4f97d7; font-weight: bold;">end</span>
      <span style="color: #4f97d7; font-weight: bold;">end</span>
      <span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">get_func</span>(<span style="color: #7590db;">class</span>, <span style="color: #7590db;">key</span>)
          <span style="color: #4f97d7; font-weight: bold;">if</span> class~=<span style="color: #a45bad;">nil</span> <span style="color: #4f97d7; font-weight: bold;">then</span>
              <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">type</span>(<span style="color: #4f97d7;">rawget</span>(class,key))==<span style="color: #2d9574;">"function"</span> <span style="color: #4f97d7; font-weight: bold;">then</span>
                  <span style="color: #4f97d7; font-weight: bold;">return</span> class[key]
              <span style="color: #4f97d7; font-weight: bold;">else</span>
                  <span style="color: #4f97d7; font-weight: bold;">return</span> get_func(<span style="color: #4f97d7;">rawget</span>(class,<span style="color: #2d9574;">"super"</span>), key)
              <span style="color: #4f97d7; font-weight: bold;">end</span>
          <span style="color: #4f97d7; font-weight: bold;">end</span>
          <span style="color: #4f97d7;">print</span>(<span style="color: #2d9574;">"Error: not exist member func -&gt; "</span> .. key)
          <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">nil</span>
      <span style="color: #4f97d7; font-weight: bold;">end</span>

      <span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">cls</span> = {}
      cls.super = super
      <span style="color: #bc6ec5; font-weight: bold;">cls.__index</span> = <span style="color: #4f97d7; font-weight: bold;">function</span> (<span style="color: #7590db;">tbl</span>, <span style="color: #7590db;">key</span>)
          <span style="color: #4f97d7; font-weight: bold;">return</span> get_func(cls, key)
      <span style="color: #4f97d7; font-weight: bold;">end</span>
      <span style="color: #4f97d7;">setmetatable</span>(cls,cls)
      <span style="color: #bc6ec5; font-weight: bold;">cls.new</span> = <span style="color: #4f97d7; font-weight: bold;">function</span> (...)
          <span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">obj</span> = {}
          <span style="color: #4f97d7;">setmetatable</span>(obj, cls)
          invoke_ctor(cls, obj, ...)
          <span style="color: #4f97d7; font-weight: bold;">return</span> obj
      <span style="color: #4f97d7; font-weight: bold;">end</span>
      <span style="color: #4f97d7; font-weight: bold;">return</span> cls
  <span style="color: #4f97d7; font-weight: bold;">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6ee05bf" class="outline-6">
<h6 id="org6ee05bf">Tips:</h6>
<div class="outline-text-6" id="text-org6ee05bf">
<ul class="org-ul">
<li>pairs 不会列出元表中__index 的字段<br /></li>
<li>判断 tabel 是否含有某个字段<br /></li>
</ul>
<div class="org-src-container">
<pre class="src src-lua">  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#38169;&#35823;&#30340;&#20889;&#27861;&#65306;</span>
  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#24403; svrData.IsLeader == false &#32780; role.data.IsLeader == true &#26102;&#65292;&#19979;&#38754;&#30340;&#20195;&#30721;&#19981;&#20250;&#26356;&#26032; role.data.IsLeader &#30340;&#20540;&#20026; false</span>
  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">rawget</span>(svrData,<span style="color: #2d9574;">"IsLeader"</span>) <span style="color: #4f97d7; font-weight: bold;">then</span>
      role.data.IsLeader = svrData.IsLeader
  <span style="color: #4f97d7; font-weight: bold;">end</span>
  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#27491;&#30830;&#30340;&#20889;&#27861;&#65306;</span>
  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">rawget</span>(svrData,<span style="color: #2d9574;">"IsLeader"</span>)~=<span style="color: #a45bad;">nil</span> <span style="color: #4f97d7; font-weight: bold;">then</span>
      role.data.IsLeader = svrData.IsLeader
  <span style="color: #4f97d7; font-weight: bold;">end</span>
  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#26368;&#22909;&#30340;&#20889;&#27861;&#65306;</span>
  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#36825;&#26679;&#21363;&#20351; svrData[k] == nil &#20063;&#21487;&#20197;&#23545; role.data[k]&#36827;&#34892;&#36171;&#20540;</span>
  <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #7590db;">k</span>,<span style="color: #7590db;">v</span> <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">pairs</span>(svrData) <span style="color: #4f97d7; font-weight: bold;">do</span>
      role.data[k] = v
  <span style="color: #4f97d7; font-weight: bold;">end</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc2c9b03" class="outline-3">
<h3 id="orgc2c9b03">The Language</h3>
</div>
<div id="outline-container-orgc057648" class="outline-3">
<h3 id="orgc057648">The Application Program Interface</h3>
</div>
<div id="outline-container-org88dafac" class="outline-3">
<h3 id="org88dafac">The Auxiliary Library</h3>
</div>
<div id="outline-container-org40905dc" class="outline-3">
<h3 id="org40905dc">The Standard Libraries</h3>
<div class="outline-text-3" id="text-org40905dc">
</div>
<div id="outline-container-org5472307" class="outline-4">
<h4 id="org5472307">String Manipulation</h4>
<div class="outline-text-4" id="text-org5472307">
</div>
<div id="outline-container-org1d0067f" class="outline-5">
<h5 id="org1d0067f">format</h5>
<div class="outline-text-5" id="text-org1d0067f">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#21069;/&#21518;&#22635;&#20805;</span>
<span style="color: #4f97d7;">string</span>.<span style="color: #4f97d7;">format</span>(%10s, str)  <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">&#19981;&#22815; 10 &#20010;&#23383;&#31526;&#21069;&#38754;&#22635;&#20805;&#30456;&#24212;&#31354;&#26684;</span>
<span style="color: #4f97d7;">string</span>.<span style="color: #4f97d7;">format</span>(%-10s, str) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">&#19981;&#22815; 10 &#20010;&#23383;&#31526;&#21518;&#38754;&#22635;&#20805;&#30456;&#24212;&#31354;&#26684;</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgdecbe88" class="outline-3">
<h3 id="orgdecbe88">Lua Standalone</h3>
</div>
<div id="outline-container-orge52bac8" class="outline-3">
<h3 id="orge52bac8">Incompatibilities with the Previous Version</h3>
</div>
<div id="outline-container-org0fdcbbc" class="outline-3">
<h3 id="org0fdcbbc">The Complete Syntax of Lua</h3>
</div>
</div>
<div id="outline-container-org0ac45a9" class="outline-2">
<h2 id="org0ac45a9">Usage</h2>
<div class="outline-text-2" id="text-org0ac45a9">
</div>
<div id="outline-container-orgae9b68b" class="outline-3">
<h3 id="orgae9b68b">开发环境</h3>
<div class="outline-text-3" id="text-orgae9b68b">
</div>
<div id="outline-container-orgbf33e5d" class="outline-4">
<h4 id="orgbf33e5d">lua</h4>
<div class="outline-text-4" id="text-orgbf33e5d">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">windows</span>
pacman -S mingw-w64-x86_64-lua
</pre>
</div>
</div>
</div>
<div id="outline-container-org16308cd" class="outline-4">
<h4 id="org16308cd">luarocks 包管理</h4>
<div class="outline-text-4" id="text-org16308cd">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#23433;&#35013; luarocks</span>
pacman -S mingw-w64-x86_64-lua-luarocks

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#22312;D:\Applications\msys64\mingw64\bin\ &#30446;&#24405;&#19979;&#21019;&#24314; luarocks.bat &#25991;&#20214;&#65292;&#23558;&#19979;&#38754;&#20869;&#23481;&#22635;&#20805;&#36827;&#21435;:</span>
@echo off
<span style="color: #4f97d7;">echo</span> input parameters are: %*
lua D:\Applications\msys64\mingw64\bin\luarocks %*
pause

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#19979;&#38754;&#21629;&#20196;&#22312; PowerShell&#20013;&#25191;&#34892;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#26597;&#30475;luarocks &#29615;&#22659;, &#20250;&#26174;&#31034; Options Commands Variables Configuration &#36825;&#20960;&#20010;&#26041;&#38754;&#30340;&#20449;&#24687;</span>
luarocks.bat

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#37197;&#32622; lua dir (&#40664;&#35748;&#37197;&#32622;&#24212;&#35813;&#26159;&#27491;&#30830;&#30340;&#65292;&#36825;&#19968;&#27493;&#21487;&#20197;&#30465;&#30053;)</span>
luarocks.bat config lua_dir D:\Applications\msys64\mingw64\bin

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#37197;&#32622; lua include dir</span>
luarocks.bat config variables.LUA_INCDIR D:\Applications\msys64\mingw64\include

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#37197;&#32622; lua lib dir</span>
luarocks.bat config variables.LUA_LIBDIR D:\Applications\msys64\mingw64\lib

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">luarocks &#21019;&#24314;&#24037;&#31243;</span>
cd-test
luarocks.bat init lua_test_proj

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">install lpeg (TODO &#24403;&#21069;&#36824;&#27809;&#26377;&#25104;&#21151;, &#25152;&#20197;&#36824;&#26159;&#30452;&#25509;&#20351;&#29992; ZeroBrane &#31639;&#20102;)</span>
luarocks.bat install lpeg
</pre>
</div>

<ul class="org-ul">
<li><a href="https://luarocks.org/">https://luarocks.org/</a><br /></li>
</ul>
</div>
<div id="outline-container-org7acedb5" class="outline-5">
<h5 id="org7acedb5">ERROR</h5>
</div>
</div>

<div id="outline-container-org42b9109" class="outline-4">
<h4 id="org42b9109">IDE</h4>
<div class="outline-text-4" id="text-org42b9109">
</div>
<div id="outline-container-orgd6eddc1" class="outline-5">
<h5 id="orgd6eddc1">VSCode</h5>
<div class="outline-text-5" id="text-orgd6eddc1">
<p>
安装如下插件<br />
</p>
<ul class="org-ul">
<li>Code Runner <a href="https://github.com/formulahendry/vscode-code-runner">https://github.com/formulahendry/vscode-code-runner</a><br /></li>
<li>LuaHelper <a href="https://github.com/Tencent/LuaHelper">https://github.com/Tencent/LuaHelper</a><br /></li>
</ul>
</div>
</div>
<div id="outline-container-org3530fcb" class="outline-5">
<h5 id="org3530fcb">ZeroBrane</h5>
<div class="outline-text-5" id="text-org3530fcb">
<p>
ZeroBrane 自带 lua 环境，不需要额外配置。<br />
</p>

<ul class="org-ul">
<li>ZeroBrane <a href="https://studio.zerobrane.com/">https://studio.zerobrane.com/</a><br /></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org538d7bd" class="outline-3">
<h3 id="org538d7bd">Basic</h3>
<div class="outline-text-3" id="text-org538d7bd">
</div>
<div id="outline-container-org504c540" class="outline-4">
<h4 id="org504c540">打印代码和对应的执行结果</h4>
<div class="outline-text-4" id="text-org504c540">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">locals</span>(<span style="color: #7590db;">env_pos</span>)
    env_pos = env_pos <span style="color: #4f97d7; font-weight: bold;">or</span> 3
    <span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">variables</span> = {}
    <span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">idx</span> = 1
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #a45bad;">true</span> <span style="color: #4f97d7; font-weight: bold;">do</span>
        <span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">ln</span>, <span style="color: #7590db;">lv</span> = <span style="color: #4f97d7;">debug</span>.<span style="color: #4f97d7;">getlocal</span>(env_pos, idx)
        <span style="color: #4f97d7; font-weight: bold;">if</span> ln ~= <span style="color: #a45bad;">nil</span> <span style="color: #4f97d7; font-weight: bold;">then</span>
            variables[ln] = lv
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            <span style="color: #4f97d7; font-weight: bold;">break</span>
        <span style="color: #4f97d7; font-weight: bold;">end</span>
        idx = 1 + idx
    <span style="color: #4f97d7; font-weight: bold;">end</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> variables
<span style="color: #4f97d7; font-weight: bold;">end</span>

<span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">eval</span>(<span style="color: #7590db;">equation</span>, <span style="color: #7590db;">variables</span>, <span style="color: #7590db;">env_pos</span>)
    <span style="color: #4f97d7; font-weight: bold;">if</span>(<span style="color: #4f97d7;">type</span>(equation) == <span style="color: #2d9574;">"string"</span>) <span style="color: #4f97d7; font-weight: bold;">then</span>
        <span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">eval</span> = <span style="color: #4f97d7;">loadstring</span>(<span style="color: #2d9574;">"return "</span>..equation);
        <span style="color: #4f97d7; font-weight: bold;">if</span>(<span style="color: #4f97d7;">type</span>(eval) == <span style="color: #2d9574;">"function"</span>) <span style="color: #4f97d7; font-weight: bold;">then</span>
            variables = variables <span style="color: #4f97d7; font-weight: bold;">or</span> locals(env_pos)
            <span style="color: #4f97d7;">setfenv</span>(eval, variables)
            <span style="color: #4f97d7; font-weight: bold;">return</span> eval();
        <span style="color: #4f97d7; font-weight: bold;">end</span>
    <span style="color: #4f97d7; font-weight: bold;">end</span>
<span style="color: #4f97d7; font-weight: bold;">end</span>

<span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">log_exp</span>(<span style="color: #7590db;">exp</span>, <span style="color: #7590db;">str_fmt_count</span>, <span style="color: #7590db;">env_pos</span>)
    str_fmt_count = str_fmt_count <span style="color: #4f97d7; font-weight: bold;">or</span> 20
    env_pos = env_pos <span style="color: #4f97d7; font-weight: bold;">or</span> 4
    <span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">result</span> = eval(exp, <span style="color: #a45bad;">nil</span>, env_pos)
    <span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">fmt_str</span> = <span style="color: #2d9574;">'%-'</span> .. <span style="color: #4f97d7;">tostring</span>(str_fmt_count) .. <span style="color: #2d9574;">'s'</span>
      <span style="color: #4f97d7;">print</span>(<span style="color: #4f97d7;">string</span>.<span style="color: #4f97d7;">format</span>(fmt_str, exp), <span style="color: #2d9574;">" -- "</span>, result)
<span style="color: #4f97d7; font-weight: bold;">end</span>

log_exp(<span style="color: #2d9574;">"hi"</span>)

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">lpeg</span> = <span style="color: #4f97d7;">require</span> <span style="color: #2d9574;">"lpeg"</span>
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">C</span>, <span style="color: #7590db;">P</span>, <span style="color: #7590db;">R</span>, <span style="color: #7590db;">S</span>, <span style="color: #7590db;">V</span> = lpeg.C, lpeg.P, lpeg.R, lpeg.S, lpeg.V
log_exp(<span style="color: #2d9574;">"lpeg.match(P'a', 'abc')"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgad911db" class="outline-4">
<h4 id="orgad911db">打印代码执行时间的方法</h4>
<div class="outline-text-4" id="text-orgad911db">
<p>
下面打印出的时间单位为秒<br />
</p>
<div class="org-src-container">
<pre class="src src-lua">  <span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">codeTimer</span> = <span style="color: #4f97d7;">os</span>.<span style="color: #4f97d7;">clock</span>()
  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">... &#27492;&#22788;&#30465;&#30053;&#33509;&#24178;&#19978;&#24093;&#20195;&#30721;</span>
  <span style="color: #4f97d7;">print</span>(<span style="color: #2d9574;">"delta time = "</span> .. <span style="color: #4f97d7;">tostring</span>(<span style="color: #4f97d7;">os</span>.<span style="color: #4f97d7;">clock</span>()-codeTimer))
  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">delta time = 4.928</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7779116" class="outline-3">
<h3 id="org7779116">Lpeg</h3>
<div class="outline-text-3" id="text-org7779116">
</div>
<div id="outline-container-org17d7320" class="outline-4">
<h4 id="org17d7320">lpeg</h4>
<div class="outline-text-4" id="text-org17d7320">
</div>
<div id="outline-container-org3555a7f" class="outline-5">
<h5 id="org3555a7f">Introduction</h5>
<div class="outline-text-5" id="text-org3555a7f">
<p>
下表列出了创建 patterns 的基础操作：<br />
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Operator</td>
<td class="org-left">Description</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">lpeg.P(string)</td>
<td class="org-left">Matches string literally</td>
<td class="org-left">匹配字符串</td>
</tr>

<tr>
<td class="org-left">lpeg.P(n)</td>
<td class="org-left">Matches exactly n characters</td>
<td class="org-left">准确匹配 n 个字符</td>
</tr>

<tr>
<td class="org-left">lpeg.S(string)</td>
<td class="org-left">Matches any character in string (Set)</td>
<td class="org-left">匹配字符串中的任何字符</td>
</tr>

<tr>
<td class="org-left">lpeg.R("xy")</td>
<td class="org-left">Matches any character between x and y (Range)</td>
<td class="org-left">匹配 x 和 y 之间的任何字符（范围）</td>
</tr>

<tr>
<td class="org-left">patt^n</td>
<td class="org-left">Matches at least n repetitions of patt</td>
<td class="org-left">匹配至少 n 个重复的 patt</td>
</tr>

<tr>
<td class="org-left">patt^-n</td>
<td class="org-left">Matches at most n repetitions of patt</td>
<td class="org-left">匹配至多 n 个重复的 patt</td>
</tr>

<tr>
<td class="org-left">patt1 * patt2</td>
<td class="org-left">Matches patt1 followed by patt2</td>
<td class="org-left">匹配 patt1 紧跟着 patt2</td>
</tr>

<tr>
<td class="org-left">patt1 + patt2</td>
<td class="org-left">Matches patt1 or patt2 (ordered choice)</td>
<td class="org-left">匹配 patt1 或 patt2</td>
</tr>

<tr>
<td class="org-left">patt1 - patt2</td>
<td class="org-left">Matches patt1 if patt2 does not match</td>
<td class="org-left">不匹配 patt2，匹配 patt1</td>
</tr>

<tr>
<td class="org-left">-patt</td>
<td class="org-left">Equivalent to ("" - patt)</td>
<td class="org-left">等价于 "" - patt, 即：匹配 patt 失败则匹配""</td>
</tr>

<tr>
<td class="org-left">#patt</td>
<td class="org-left">Matches patt but consumes no input</td>
<td class="org-left">匹配 patt，但不消耗任何输入</td>
</tr>

<tr>
<td class="org-left">lpeg.B(patt)</td>
<td class="org-left">Matches patt behind the current position, consuming no input</td>
<td class="org-left">匹配当前位置后的 patt，不消耗任何输入</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-lua"><span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#19979;&#38754;&#20363;&#23376;&#20013;&#65292;&#37117;&#38656;&#35201;&#21253;&#21547;&#36825;&#37324;&#30340; &#21253;&#24341;&#20837; &#21644; &#21517;&#31216;&#23450;&#20041;</span>
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">lpeg</span> = <span style="color: #4f97d7;">require</span> <span style="color: #2d9574;">"lpeg"</span>

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">C</span>, <span style="color: #7590db;">P</span>, <span style="color: #7590db;">R</span>, <span style="color: #7590db;">S</span>, <span style="color: #7590db;">V</span> = lpeg.C, lpeg.P, lpeg.R, lpeg.S, lpeg.V
</pre>
</div>
</div>
</div>
<div id="outline-container-org9a1cdda" class="outline-5">
<h5 id="org9a1cdda">Functions</h5>
<div class="outline-text-5" id="text-org9a1cdda">
<p>
lpeg.match(pattern, subject, [,init])<br />
</p>

<p>
匹配函数。它试图将给定的模式与目标字符串进行匹配。如果匹配成功，返回匹配后第一个字符在目标字符串中的索引，或者捕获的值（如果模式捕获了任何值）。<br />
init 为可选的整数型参数，用于设定进行匹配的开始位置。像 Lua 库中的惯例一样，负值表示从末尾开始计算。<br />
</p>

<p>
与典型的模式匹配函数不同，match 只在 anchored 模式下工作；也就是说，它试图将模式与给定目标字符串的前缀（从 init 位置开始）相匹配，而不是与目标字符串的任意子串相匹配。因此，如果我们想在一个字符串的任何地方找到一个模式，我们必须在 Lua 中写一个循环，或者写一个可以在任何地方匹配的模式。第二种方法更简单，高效。<br />
</p>

<p>
lpeg.type(value)<br />
如果给定的 value 是一个 pattern，则返回字符串 "pattern"，否则返回 nil<br />
</p>

<p>
lpeg.version()<br />
返回 LPeg 的版本号字符串<br />
</p>

<p>
lpeg.setmaxstack(max)<br />
设置 backtrack stack 的尺寸，LPeg 会使用 backtrack stack 更正调用和选择。默认值为 400<br />
</p>
</div>
</div>
<div id="outline-container-orgdcbec78" class="outline-5">
<h5 id="orgdcbec78">Basic Constructions</h5>
<div class="outline-text-5" id="text-orgdcbec78">
</div>
<div id="outline-container-orgc475a05" class="outline-6">
<h6 id="orgc475a05">lpeg.P(value)</h6>
<div class="outline-text-6" id="text-orgc475a05">
<p>
用下面的规则将一个给定的值转换成一个合适的 pattern：<br />
如果参数是一个 pattern，则返回参数 pattern。<br />
如果参数是一个 string，则返回匹配这个字符串的 pattern。<br />
如果参数是一个非负整数 n, 则返回一个匹配正好是 n 个字符的字符串的 pattern。<br />
如果参数是一个负整数 -n, 则只有在输入的字符串还剩下不到 n 个字符才会成。 lpeg.P(-n) 等同于 -lpeg.P(n) (see the unary minus operation).<br />
如果参数是一个 boolean, value 为 true 返回总是匹配成功的 pattern，value 为 false 返回总是匹配失败的 pattern，不消耗任何输入。<br />
如果参数是一个 table, 则被解读为一个 grammar (see <a href="#org8ebb532">Grammars</a>)。<br />
如果参数是一个 function, 则返回一个 pattern，等价于一个 match-time capture 用一个空字符串匹配.<br />
</p>

<div class="org-src-container">
<pre class="src src-lua"><span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">lpeg</span> = <span style="color: #4f97d7;">require</span> <span style="color: #2d9574;">"lpeg"</span>

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">C</span>, <span style="color: #7590db;">P</span>, <span style="color: #7590db;">R</span>, <span style="color: #7590db;">S</span>, <span style="color: #7590db;">V</span> = lpeg.C, lpeg.P, lpeg.R, lpeg.S, lpeg.V

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">P&#21305;&#37197;&#23383;&#31526;&#20018; &#20174;&#22836;&#24320;&#22987;&#25214;,&#36820;&#22238;&#31532;&#19968;&#27425;&#25214;&#21040;&#30340;&#20301;&#32622;+1</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'a'</span>, <span style="color: #2d9574;">'abc'</span>))    <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">2</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'b'</span>, <span style="color: #2d9574;">'abc'</span>))    <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'ab'</span>, <span style="color: #2d9574;">'abc'</span>))   <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">3</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'a'</span>, <span style="color: #2d9574;">'aaa'</span>))    <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">2</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'ab'</span>, <span style="color: #2d9574;">'abab'</span>))  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">3</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org106ad82" class="outline-6">
<h6 id="org106ad82">lpeg.B(patt)</h6>
</div>
<div id="outline-container-org3b67d0b" class="outline-6">
<h6 id="org3b67d0b">lpeg.R({range})</h6>
<div class="outline-text-6" id="text-org3b67d0b">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">lpeg</span> = <span style="color: #4f97d7;">require</span> <span style="color: #2d9574;">"lpeg"</span>

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">C</span>, <span style="color: #7590db;">P</span>, <span style="color: #7590db;">R</span>, <span style="color: #7590db;">S</span>, <span style="color: #7590db;">V</span> = lpeg.C, lpeg.P, lpeg.R, lpeg.S, lpeg.V

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">R&#21305;&#37197;&#33539;&#22260;,09&#20195;&#34920;0~9,AZ&#21516;&#29702;,&#20063;&#26159;&#20174;&#22836;&#24320;&#22987;&#25214;</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(R<span style="color: #2d9574;">'az'</span>, <span style="color: #2d9574;">'abc'</span>))  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">2</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(R<span style="color: #2d9574;">'aZ'</span>, <span style="color: #2d9574;">'abc'</span>))  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(R<span style="color: #2d9574;">'AZ'</span>, <span style="color: #2d9574;">'abc'</span>))  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(R<span style="color: #2d9574;">'Az'</span>, <span style="color: #2d9574;">'abc'</span>))  <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">2</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(R<span style="color: #2d9574;">'az'</span>, <span style="color: #2d9574;">'0abc'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgaf2bb81" class="outline-6">
<h6 id="orgaf2bb81">lpeg.S(string)</h6>
<div class="outline-text-6" id="text-orgaf2bb81">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">lpeg</span> = <span style="color: #4f97d7;">require</span> <span style="color: #2d9574;">"lpeg"</span>

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">C</span>, <span style="color: #7590db;">P</span>, <span style="color: #7590db;">R</span>, <span style="color: #7590db;">S</span>, <span style="color: #7590db;">V</span> = lpeg.C, lpeg.P, lpeg.R, lpeg.S, lpeg.V

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">S&#38598;&#21512;&#21305;&#37197; &#20174;&#22836;&#24320;&#22987; &#33509;&#23383;&#31526;&#20018;&#21253;&#21547;&#38598;&#21512;&#20869;&#20803;&#32032;,&#21305;&#37197;&#25104;&#21151;(ps:&#37027;&#23682;&#19981;&#26159;&#21305;&#37197;&#25104;&#21151;&#23601;&#19968;&#23450;&#26159;2,&#21518;&#38754;&#20877;&#30475;)</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(S<span style="color: #2d9574;">'abc'</span>, <span style="color: #2d9574;">'abc'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">2</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(S<span style="color: #2d9574;">'bc'</span>,  <span style="color: #2d9574;">'abc'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(S<span style="color: #2d9574;">'1a'</span>,  <span style="color: #2d9574;">'abc'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">2</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9aee42c" class="outline-6">
<h6 id="org9aee42c">lpeg.V(v)</h6>
<div class="outline-text-6" id="text-org9aee42c">
<p>
该操作为 grammar 创建一个非终结变量。非终结变量指的是在闭包语法中由 v 所索引的规则。<br />
This operation creates a non-terminal (a variable) for a grammar. The created non-terminal refers to the rule indexed by v in the enclosing grammar.<br />
</p>
</div>
</div>
<div id="outline-container-org5ab55a5" class="outline-6">
<h6 id="org5ab55a5">lpeg.locale([table])</h6>
<div class="outline-text-6" id="text-org5ab55a5">
<p>
返回一个表格，其中包含匹配各类字符的模式，这些模式会考虑当前语言环境。该 table 有如下字段 alnum, alpha, cntrl, digit, graph, lower, print, punct, space, upper, 和 xdigit ，每个字段都包含一个相应的模式。每个模式都匹配属于其类别的任何单个字符。<br />
</p>

<p>
如果调用时有一个参数 table，那么它就在给定的 table 内创建这些字段，并返回该 table。<br />
</p>
</div>
</div>
<div id="outline-container-org7552e58" class="outline-6">
<h6 id="org7552e58">patt1+patt2</h6>
<div class="outline-text-6" id="text-org7552e58">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">lpeg</span> = <span style="color: #4f97d7;">require</span> <span style="color: #2d9574;">"lpeg"</span>

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">C</span>, <span style="color: #7590db;">P</span>, <span style="color: #7590db;">R</span>, <span style="color: #7590db;">S</span>, <span style="color: #7590db;">V</span> = lpeg.C, lpeg.P, lpeg.R, lpeg.S, lpeg.V

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">+&#20195;&#34920;or(&#25110;)</span>
<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">P'a' + P'b'^1 &#20195;&#34920;&#24320;&#22836;&#26159;a &#25110; &#24320;&#22836;&#33267;&#23569;1&#20010;b</span>
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">a_1b</span> = P<span style="color: #2d9574;">'a'</span> + P<span style="color: #2d9574;">'b'</span>^1
<span style="color: #4f97d7;">print</span>(match(a_1b, <span style="color: #2d9574;">'ab'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">2</span>
<span style="color: #4f97d7;">print</span>(match(a_1b, <span style="color: #2d9574;">'bb'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">3</span>
<span style="color: #4f97d7;">print</span>(match(a_1b, <span style="color: #2d9574;">'bc'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">2</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc5bb4a4" class="outline-6">
<h6 id="orgc5bb4a4">patt1-patt2</h6>
<div class="outline-text-6" id="text-orgc5bb4a4">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#19981;&#21305;&#37197;patt2&#65292;&#21305;&#37197;patt1</span>
lpeg.match(S<span style="color: #2d9574;">'abcd'</span>-S<span style="color: #2d9574;">'ab'</span>,  <span style="color: #2d9574;">'cd'</span>) <span style="color: #2aa1ae; background-color: #292e34;">--     </span><span style="color: #2aa1ae; background-color: #292e34;">2</span>
lpeg.match(S<span style="color: #2d9574;">'abcd'</span>-S<span style="color: #2d9574;">'ab'</span>,  <span style="color: #2d9574;">'ab'</span>) <span style="color: #2aa1ae; background-color: #292e34;">--     </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org330fc73" class="outline-6">
<h6 id="org330fc73">-patt</h6>
<div class="outline-text-6" id="text-org330fc73">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#31561;&#20215;&#20110; "" - patt</span>
lpeg.match(-S<span style="color: #2d9574;">'ab'</span>,  <span style="color: #2d9574;">'ab'</span>) <span style="color: #2aa1ae; background-color: #292e34;">--    </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
lpeg.match(-S<span style="color: #2d9574;">'ab'</span>,  <span style="color: #2d9574;">'cd'</span>) <span style="color: #2aa1ae; background-color: #292e34;">--    </span><span style="color: #2aa1ae; background-color: #292e34;">1</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org751581e" class="outline-6">
<h6 id="org751581e">#patt</h6>
<div class="outline-text-6" id="text-org751581e">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#21305;&#37197;patt&#65292;&#21305;&#37197;&#25104;&#21151;&#19981;&#28040;&#32791;&#36755;&#20837;</span>
lpeg.match(#P<span style="color: #2d9574;">'ab'</span>,  <span style="color: #2d9574;">'ab'</span>) <span style="color: #2aa1ae; background-color: #292e34;">--    </span><span style="color: #2aa1ae; background-color: #292e34;">1</span>
lpeg.match(#P<span style="color: #2d9574;">'ab'</span>,  <span style="color: #2d9574;">'cd'</span>) <span style="color: #2aa1ae; background-color: #292e34;">--    </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3f3cbe0" class="outline-6">
<h6 id="org3f3cbe0">patt1*patt2</h6>
<div class="outline-text-6" id="text-org3f3cbe0">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">lpeg</span> = <span style="color: #4f97d7;">require</span> <span style="color: #2d9574;">"lpeg"</span>

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">C</span>, <span style="color: #7590db;">P</span>, <span style="color: #7590db;">R</span>, <span style="color: #7590db;">S</span>, <span style="color: #7590db;">V</span> = lpeg.C, lpeg.P, lpeg.R, lpeg.S, lpeg.V

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">*&#20195;&#34920; &#36830;&#25509;</span>
<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">P'a'*P'b'^0&#20195;&#34920;&#24320;&#22836;&#26159;a&#19988;&#21518;&#38754;&#36319;&#33267;&#23569;0&#20010;b</span>
<span style="color: #4f97d7;">print</span>(match(P<span style="color: #2d9574;">'a'</span>*P<span style="color: #2d9574;">'b'</span>^0, <span style="color: #2d9574;">'aab'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">2</span>
<span style="color: #4f97d7;">print</span>(match(P<span style="color: #2d9574;">'a'</span>*P<span style="color: #2d9574;">'b'</span>^1, <span style="color: #2d9574;">'aab'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
<span style="color: #4f97d7;">print</span>(match(P<span style="color: #2d9574;">'a'</span>*P<span style="color: #2d9574;">'b'</span>^1, <span style="color: #2d9574;">'abab'</span>))<span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">3</span>
<span style="color: #4f97d7;">print</span>(match(P<span style="color: #2d9574;">'a'</span>^0*P<span style="color: #2d9574;">'b'</span>, <span style="color: #2d9574;">'aab'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">4</span>
<span style="color: #4f97d7;">print</span>(match(P<span style="color: #2d9574;">'a'</span>^1*P<span style="color: #2d9574;">'b'</span>, <span style="color: #2d9574;">'aab'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">4</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org46b8958" class="outline-6">
<h6 id="org46b8958">patt^n</h6>
<div class="outline-text-6" id="text-org46b8958">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">lpeg</span> = <span style="color: #4f97d7;">require</span> <span style="color: #2d9574;">"lpeg"</span>

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">C</span>, <span style="color: #7590db;">P</span>, <span style="color: #7590db;">R</span>, <span style="color: #7590db;">S</span>, <span style="color: #7590db;">V</span> = lpeg.C, lpeg.P, lpeg.R, lpeg.S, lpeg.V

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">^n&#20195;&#34920;&#33267;&#23569;&#21305;&#37197;n&#27425; ^-n&#20195;&#34920;&#33267;&#22810;&#21305;&#37197;n&#27425;</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'a'</span>^1,   <span style="color: #2d9574;">'aaaa'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">5</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'a'</span>^4,   <span style="color: #2d9574;">'aaaa'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">5</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'a'</span>^5,   <span style="color: #2d9574;">'aaaa'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'aa'</span>^2,  <span style="color: #2d9574;">'aaaa'</span>)) <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">5</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'ab'</span>^2,  <span style="color: #2d9574;">'ababc'</span>))    <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">5</span>
<span style="color: #4f97d7;">print</span>(lpeg.match(P<span style="color: #2d9574;">'ab'</span>^-1, <span style="color: #2d9574;">'ababc'</span>))   <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">3</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8ebb532" class="outline-5">
<h5 id="org8ebb532">Grammars</h5>
<div class="outline-text-5" id="text-org8ebb532">
<p>
通过使用 Lua 变量，可以逐步定义模式，每个新模式都使用以前定义的模式。然而，这种技术并不允许定义递归模式。对于递归模式，我们需要真正的语法。<br />
</p>

<p>
LPeg 用表格表示语法，每个条目都是一个规则。<br />
</p>

<p>
调用 lpeg.V(v)可以创建一个模式，用来表示语法中索引为 v 的非终结符（或变量）。当这个函数被求解时，语法还不存在，所以返回的是一个对该规则的开放引用(open reference)。<br />
</p>

<p>
当一个表被转换为一个模式时（通过调用 lpeg.P 或者需要模式的地方使用该表），它就被固定了。然后由 lpeg.V(v)创建的每一个开放引用都被纠正为指向规则，该规则在表中由 v 索引。<br />
</p>

<p>
当一个表被固定时，其结果是一个符合其初始规则的模式。表中索引为 1 的条目定义了其初始规则。如果该条目是一个字符串，则假定它是初始规则的名称。否则，LPeg 假定条目 1 本身就是初始规则。<br />
</p>

<p>
例如，下面的语法匹配具有相同数量的 a 和 b 的字符串：<br />
</p>
<div class="org-src-container">
<pre class="src src-lua">equalcount = lpeg.P{
  <span style="color: #2d9574;">"S"</span>;   <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">initial rule name</span>
  S = <span style="color: #2d9574;">"a"</span> * lpeg.V<span style="color: #2d9574;">"B"</span> + <span style="color: #2d9574;">"b"</span> * lpeg.V<span style="color: #2d9574;">"A"</span> + <span style="color: #2d9574;">""</span>,
  A = <span style="color: #2d9574;">"a"</span> * lpeg.V<span style="color: #2d9574;">"S"</span> + <span style="color: #2d9574;">"b"</span> * lpeg.V<span style="color: #2d9574;">"A"</span> * lpeg.V<span style="color: #2d9574;">"A"</span>,
  B = <span style="color: #2d9574;">"b"</span> * lpeg.V<span style="color: #2d9574;">"S"</span> + <span style="color: #2d9574;">"a"</span> * lpeg.V<span style="color: #2d9574;">"B"</span> * lpeg.V<span style="color: #2d9574;">"B"</span>,
} * -1
</pre>
</div>
</div>
</div>
<div id="outline-container-org5be8495" class="outline-5">
<h5 id="org5be8495">Captures</h5>
<div class="outline-text-5" id="text-org5be8495">
<p>
Cature 是一个 pattern，capture 可以依据其匹配的内容生成值()。<br />
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Operation</td>
<td class="org-left">What it Produces</td>
</tr>

<tr>
<td class="org-left">lpeg.C(patt)</td>
<td class="org-left">the match for patt plus all captures made by patt</td>
</tr>

<tr>
<td class="org-left">lpeg.Carg(n)</td>
<td class="org-left">the value of the nth extra argument to lpeg.match (matches the empty string)</td>
</tr>

<tr>
<td class="org-left">lpeg.Cb(name)</td>
<td class="org-left">the values produced by the previous group capture named name (matches the empty string)</td>
</tr>

<tr>
<td class="org-left">lpeg.Cc(values)</td>
<td class="org-left">the given values (matches the empty string)</td>
</tr>

<tr>
<td class="org-left">lpeg.Cf(patt, func)</td>
<td class="org-left">a folding of the captures from patt</td>
</tr>

<tr>
<td class="org-left">lpeg.Cg(patt [, name])</td>
<td class="org-left">the values produced by patt, optionally tagged with name</td>
</tr>

<tr>
<td class="org-left">lpeg.Cp()</td>
<td class="org-left">the current position (matches the empty string)</td>
</tr>

<tr>
<td class="org-left">lpeg.Cs(patt)</td>
<td class="org-left">the match for patt with the values from nested captures replacing their matches</td>
</tr>

<tr>
<td class="org-left">lpeg.Ct(patt)</td>
<td class="org-left">a table with all captures from patt</td>
</tr>

<tr>
<td class="org-left">patt / string</td>
<td class="org-left">string, with some marks replaced by captures of patt</td>
</tr>

<tr>
<td class="org-left">patt / number</td>
<td class="org-left">the n-th value captured by patt, or no value when number is zero.</td>
</tr>

<tr>
<td class="org-left">patt / table</td>
<td class="org-left">table[c], where c is the (first) capture of patt</td>
</tr>

<tr>
<td class="org-left">patt / function</td>
<td class="org-left">the returns of function applied to the captures of patt</td>
</tr>

<tr>
<td class="org-left">lpeg.Cmt(patt, function)</td>
<td class="org-left">the returns of function applied to the captures of patt; the application is done at match time</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-orgdc86dd3" class="outline-6">
<h6 id="orgdc86dd3">lpeg.C (patt)</h6>
</div>
<div id="outline-container-org038fb7c" class="outline-6">
<h6 id="org038fb7c">lpeg.Carg (n)</h6>
</div>
<div id="outline-container-org37a77a2" class="outline-6">
<h6 id="org37a77a2">lpeg.Cb (name)</h6>
</div>
<div id="outline-container-orgc81d328" class="outline-6">
<h6 id="orgc81d328">lpeg.Cc ([value, &#x2026;])</h6>
</div>
<div id="outline-container-org4b07e60" class="outline-6">
<h6 id="org4b07e60">lpeg.Cf (patt, func)</h6>
</div>
<div id="outline-container-orgc60f1aa" class="outline-6">
<h6 id="orgc60f1aa">lpeg.Cg (patt [, name])</h6>
</div>
<div id="outline-container-org152bf5d" class="outline-6">
<h6 id="org152bf5d">lpeg.Cp ()</h6>
</div>
<div id="outline-container-org24a0e11" class="outline-6">
<h6 id="org24a0e11">lpeg.Cs (patt)</h6>
</div>
<div id="outline-container-orgb6f33f1" class="outline-6">
<h6 id="orgb6f33f1">lpeg.Ct (patt)</h6>
</div>
<div id="outline-container-orgd7adc3c" class="outline-6">
<h6 id="orgd7adc3c">patt / string</h6>
</div>
<div id="outline-container-org5d7749f" class="outline-6">
<h6 id="org5d7749f">patt / number</h6>
</div>
<div id="outline-container-org2bc0cbd" class="outline-6">
<h6 id="org2bc0cbd">patt / table</h6>
</div>
<div id="outline-container-org1ff2509" class="outline-6">
<h6 id="org1ff2509">patt / function</h6>
</div>
<div id="outline-container-org1c8f3d0" class="outline-6">
<h6 id="org1c8f3d0">lpeg.Cmt(patt, function)</h6>
</div>
</div>
<div id="outline-container-org11a7372" class="outline-5">
<h5 id="org11a7372">Some Examples</h5>
<div class="outline-text-5" id="text-org11a7372">
</div>
<div id="outline-container-orgdfbae4b" class="outline-6">
<h6 id="orgdfbae4b">使用 Pattern</h6>
<div class="outline-text-6" id="text-orgdfbae4b">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">lpeg</span> = <span style="color: #4f97d7;">require</span> <span style="color: #2d9574;">"lpeg"</span>

lpeg.match(R<span style="color: #2d9574;">'az'</span>^1 * -1,  <span style="color: #2d9574;">'hello '</span>)    <span style="color: #2aa1ae; background-color: #292e34;">--   </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
lpeg.match(R<span style="color: #2d9574;">'az'</span>^1 * -1,  <span style="color: #2d9574;">'hello'</span>)     <span style="color: #2aa1ae; background-color: #292e34;">--   </span><span style="color: #2aa1ae; background-color: #292e34;">6</span>
lpeg.match(R<span style="color: #2d9574;">'az'</span>^1 * -P(1),  <span style="color: #2d9574;">'hello'</span>)  <span style="color: #2aa1ae; background-color: #292e34;">--   </span><span style="color: #2aa1ae; background-color: #292e34;">6</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6edbb27" class="outline-6">
<h6 id="org6edbb27">匹配换行</h6>
<div class="outline-text-6" id="text-org6edbb27">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">&#24320;&#22836;&#26159;\r\n &#25110; \r &#25110; \n</span>
P<span style="color: #2d9574;">'\r\n'</span> + S<span style="color: #2d9574;">'\r\n'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9537b69" class="outline-6">
<h6 id="org9537b69">匹配末尾</h6>
<div class="outline-text-6" id="text-org9537b69">
<div class="org-src-container">
<pre class="src src-lua">lpeg.match(S<span style="color: #2d9574;">'helloworld'</span>^1 * -1,  <span style="color: #2d9574;">'hello'</span>))          <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">6</span>
lpeg.match(S<span style="color: #2d9574;">'helloworld'</span>^1 * -1,  <span style="color: #2d9574;">'helloX'</span>))         <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
lpeg.match(S<span style="color: #2d9574;">'helloworld'</span>^1 * -P(1),  <span style="color: #2d9574;">'Xhello'</span>))    <span style="color: #2aa1ae; background-color: #292e34;">--   </span><span style="color: #2aa1ae; background-color: #292e34;">nil</span>
lpeg.match(S<span style="color: #2d9574;">'helloworld'</span>^1 * -P(1),  <span style="color: #2d9574;">'Xhello'</span>, 2)) <span style="color: #2aa1ae; background-color: #292e34;">--   </span><span style="color: #2aa1ae; background-color: #292e34;">7</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3d0e326" class="outline-6">
<h6 id="org3d0e326">匹配数字</h6>
<div class="outline-text-6" id="text-org3d0e326">
<div class="org-src-container">
<pre class="src src-lua">digit = R<span style="color: #2d9574;">'09'</span> <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#19968;&#20010;&#25968;&#23383;</span>
digits = digit^1 <span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#20219;&#24847;&#25972;&#25968;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfcdfdfc" class="outline-6">
<h6 id="orgfcdfdfc">匹配浮点数</h6>
<div class="outline-text-6" id="text-orgfcdfdfc">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">maybe(p)  &#21487;&#33021;&#26377;p</span>
<span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">maybe</span>(<span style="color: #7590db;">p</span>) <span style="color: #4f97d7; font-weight: bold;">return</span> p^-1 <span style="color: #4f97d7; font-weight: bold;">end</span>

digits = R<span style="color: #2d9574;">'09'</span>^1
sign = maybe(S<span style="color: #2d9574;">'+-'</span>)
dot = <span style="color: #2d9574;">'.'</span>
exp = S<span style="color: #2d9574;">'eE'</span>
<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#28014;&#28857;&#25968; = &#27491;&#36127;&#21495; + &#25972;&#25968; + &#23567;&#25968; + &#31185;&#23398;&#35745;&#25968;&#27861;</span>
float = sign * digits * maybe(dot*digits) * maybe(exp*mpm*digits)

<span style="color: #4f97d7;">print</span>(match(C(float),<span style="color: #2d9574;">'3.1415926'</span>))  <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">3.1415926</span>
<span style="color: #4f97d7;">print</span>(match(C(float),<span style="color: #2d9574;">'3.14.15'</span>))    <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">3.14</span>
<span style="color: #4f97d7;">print</span>(match(C(float),<span style="color: #2d9574;">'3.14e-3'</span>))    <span style="color: #2aa1ae; background-color: #292e34;">--</span><span style="color: #2aa1ae; background-color: #292e34;">3.14e-3</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0fb7051" class="outline-5">
<h5 id="org0fb7051">参考资料</h5>
<div class="outline-text-5" id="text-org0fb7051">
<ul class="org-ul">
<li><a href="http://www.inf.puc-rio.br/~roberto/lpeg/lpeg.html">http://www.inf.puc-rio.br/~roberto/lpeg/lpeg.html</a><br /></li>
<li><a href="https://leafo.net/guides/parsing-expression-grammars.html">https://leafo.net/guides/parsing-expression-grammars.html</a><br /></li>
<li><a href="http://lua-users.org/wiki/LpegRecipes">http://lua-users.org/wiki/LpegRecipes</a><br /></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org53bfe5f" class="outline-4">
<h4 id="org53bfe5f">Simple mathematical expression parser and evaluator in Lua with LPEG</h4>
<div class="outline-text-4" id="text-org53bfe5f">
<div class="org-src-container">
<pre class="src src-lua"><span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">lpeg</span> = <span style="color: #4f97d7;">require</span><span style="color: #2d9574;">"lpeg"</span>
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">C</span>, <span style="color: #7590db;">P</span>, <span style="color: #7590db;">R</span>, <span style="color: #7590db;">S</span>, <span style="color: #7590db;">V</span> = lpeg.C, lpeg.P, lpeg.R, lpeg.S, lpeg.V

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">white</span> = S(<span style="color: #2d9574;">" \t"</span>) ^ 0

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">integer</span> = white * C(R(<span style="color: #2d9574;">"09"</span>) ^ 1) * white / <span style="color: #4f97d7;">tonumber</span>
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">power</span>   = white * C(P(<span style="color: #2d9574;">"^"</span>)) * white
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">muldiv</span>  = white * C(S(<span style="color: #2d9574;">"/*%"</span>)) * white
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">addsub</span>  = white * C(S(<span style="color: #2d9574;">"+-"</span>)) * white
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">open</span>    = white * P(<span style="color: #2d9574;">"("</span>) * white
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">close</span>   = white * P(<span style="color: #2d9574;">")"</span>) * white

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">bfunc</span> = {
    [<span style="color: #2d9574;">"+"</span>] = <span style="color: #4f97d7; font-weight: bold;">function</span>(<span style="color: #7590db;">a</span>,<span style="color: #7590db;">b</span>) <span style="color: #4f97d7; font-weight: bold;">return</span> a + b <span style="color: #4f97d7; font-weight: bold;">end</span>,
    [<span style="color: #2d9574;">"-"</span>] = <span style="color: #4f97d7; font-weight: bold;">function</span>(<span style="color: #7590db;">a</span>,<span style="color: #7590db;">b</span>) <span style="color: #4f97d7; font-weight: bold;">return</span> a - b <span style="color: #4f97d7; font-weight: bold;">end</span>,
    [<span style="color: #2d9574;">"*"</span>] = <span style="color: #4f97d7; font-weight: bold;">function</span>(<span style="color: #7590db;">a</span>,<span style="color: #7590db;">b</span>) <span style="color: #4f97d7; font-weight: bold;">return</span> a * b <span style="color: #4f97d7; font-weight: bold;">end</span>,
    [<span style="color: #2d9574;">"/"</span>] = <span style="color: #4f97d7; font-weight: bold;">function</span>(<span style="color: #7590db;">a</span>,<span style="color: #7590db;">b</span>) <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #4f97d7;">math</span>.<span style="color: #4f97d7;">floor</span>(a / b) <span style="color: #4f97d7; font-weight: bold;">end</span>,
    [<span style="color: #2d9574;">"%"</span>] = <span style="color: #4f97d7; font-weight: bold;">function</span>(<span style="color: #7590db;">a</span>,<span style="color: #7590db;">b</span>) <span style="color: #4f97d7; font-weight: bold;">return</span> a % b <span style="color: #4f97d7; font-weight: bold;">end</span>,
    [<span style="color: #2d9574;">"^"</span>] = <span style="color: #4f97d7; font-weight: bold;">function</span>(<span style="color: #7590db;">a</span>,<span style="color: #7590db;">b</span>) <span style="color: #4f97d7; font-weight: bold;">return</span> a ^ b <span style="color: #4f97d7; font-weight: bold;">end</span>
}

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">Insert binary node into AST</span>
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">binary</span>(<span style="color: #7590db;">rule</span>)
    <span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">recurse</span>(<span style="color: #7590db;">left</span>,<span style="color: #7590db;">op</span>,<span style="color: #7590db;">right</span>,...)
        <span style="color: #4f97d7; font-weight: bold;">if</span> op <span style="color: #4f97d7; font-weight: bold;">then</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> recurse(bfunc[op](left,right),...)
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            <span style="color: #4f97d7; font-weight: bold;">return</span> left
        <span style="color: #4f97d7; font-weight: bold;">end</span>
    <span style="color: #4f97d7; font-weight: bold;">end</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> rule / recurse
<span style="color: #4f97d7; font-weight: bold;">end</span>

<span style="color: #2aa1ae; background-color: #292e34;">-- </span><span style="color: #2aa1ae; background-color: #292e34;">Insert unary node into AST</span>
<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">unary</span>(<span style="color: #7590db;">rule</span>)
    <span style="color: #4f97d7; font-weight: bold;">return</span> rule / <span style="color: #4f97d7; font-weight: bold;">function</span>(<span style="color: #7590db;">op</span>,<span style="color: #7590db;">right</span>)
        <span style="color: #4f97d7; font-weight: bold;">return</span> bfunc[op](0,right)
    <span style="color: #4f97d7; font-weight: bold;">end</span>
<span style="color: #4f97d7; font-weight: bold;">end</span>

<span style="color: #4f97d7; font-weight: bold;">local</span> <span style="color: #7590db;">grammar</span> = P({
        <span style="color: #2d9574;">"input"</span>,
        input      = V(<span style="color: #2d9574;">"expression"</span>) * -1,
        expression = binary( V(<span style="color: #2d9574;">"term"</span>) * ( addsub * V(<span style="color: #2d9574;">"term"</span>) )^0 ),
        term       = binary( V(<span style="color: #2d9574;">"factor"</span>) * ( muldiv * V(<span style="color: #2d9574;">"factor"</span>))^0 ),
        factor     = binary( V(<span style="color: #2d9574;">"primary"</span>) * ( power * V(<span style="color: #2d9574;">"factor"</span>))^0 ),
        primary    = integer
            + open * V(<span style="color: #2d9574;">"expression"</span>) * close
            + unary( addsub * V(<span style="color: #2d9574;">"primary"</span>) )
})

<span style="color: #4f97d7;">print</span>(grammar:match(<span style="color: #2d9574;">"6%4"</span>), 6%4)
<span style="color: #4f97d7;">print</span>(grammar:match(<span style="color: #2d9574;">"3*(5-7^8)"</span>), 3*(5-7^8))
<span style="color: #4f97d7;">print</span>(grammar:match(<span style="color: #2d9574;">"5 + 2*3 - 1 + 7 * 8"</span>), 5 + 2*3 - 1 + 7 * 8)
<span style="color: #4f97d7;">print</span>(grammar:match(<span style="color: #2d9574;">"67 + 2 * 3 - 67 + 2/1 - 7"</span>), 67 + 2 * 3 - 67 + 2/1 - 7)
<span style="color: #4f97d7;">print</span>(grammar:match(<span style="color: #2d9574;">"(5*7/5) + (23) - 5 * (98-4)/(6*7-42)"</span>), (5*7/5) + (23) - 5 * (98-4)/(6*7-42))
<span style="color: #4f97d7;">print</span>(grammar:match(<span style="color: #2d9574;">"(2) + (17*2-30) * (5)+2 - (8/2)*4"</span>), (2) + (17*2-30) * (5)+2 - (8/2)*4)
<span style="color: #4f97d7;">print</span>(grammar:match(<span style="color: #2d9574;">"2*3*4/8 -   5/2*4 +  6 + 0/3"</span>), <span style="color: #4f97d7;">math</span>.<span style="color: #4f97d7;">floor</span>(2*3*4/8) - <span style="color: #4f97d7;">math</span>.<span style="color: #4f97d7;">floor</span>(5/2)*4 +  6 + 0/3)
<span style="color: #4f97d7;">print</span>(grammar:match(<span style="color: #2d9574;">"2*3 - 4*5 + 6/3"</span>), 2*3 - 4*5 + 6/3)
</pre>
</div>

<ul class="org-ul">
<li><a href="https://gist.github.com/hmenke/0a4a1174eaf7250aea39093d4785fcfb">https://gist.github.com/hmenke/0a4a1174eaf7250aea39093d4785fcfb</a><br /></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org9afb2c4" class="outline-2">
<h2 id="org9afb2c4">参考资料</h2>
<div class="outline-text-2" id="text-org9afb2c4">
<ul class="org-ul">
<li>lua manual <a href="https://www.lua.org/manual/5.4/">https://www.lua.org/manual/5.4/</a><br /></li>
<li>lua online <a href="https://www.lua.org/cgi-bin/demo">https://www.lua.org/cgi-bin/demo</a><br /></li>
<li>LPEG and regular expressions - comparison and tutorial <a href="http://www.gammon.com.au/lpeg">http://www.gammon.com.au/lpeg</a><br /></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id="vssue"></div>
        <link rel="stylesheet" href="https://unpkg.com/vssue/dist/vssue.min.css">
        <script src="https://unpkg.com/vue@2.7.10/dist/vue.runtime.min.js"></script>
        <script src="https://unpkg.com/vssue/dist/vssue.github.min.js"></script>
        <script>
          new Vue({
            el: '#vssue',
            render: h => h('Vssue', {
              props: {
                // 在这里设置当前页面对应的 Issue 标题
                title: 'Programming in Lua',

                // 在这里设置你使用的平台的 OAuth App 配置
                options: {
                    owner: 'wolfand11',
                    repo: 'blog_comments',
                    clientId: 'a02b49185d85859cb92c',
                    clientSecret: '6f123085c6f1ce339e2517d24e5b099fa1dc9c85', // 只有在使用某些平台时需要
                },
              }
            })
          })
        </script>
</div>
</body>
</html>