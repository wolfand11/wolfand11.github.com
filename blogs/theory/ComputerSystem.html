<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-09-13 Fri 22:28 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Computer System</title>
<meta name="generator" content="Org Mode" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
         <meta name="viewport" content="width=device-width, initial-scale=1" />
         <link rel="stylesheet" title="Standard" href="https://wolfand11.github.io/res/worg_theme/css/worg.css" type="text/css" />
         <link rel="alternate stylesheet" title="Zenburn" href="https://wolfand11.github.io/res/worg_theme/css/worg-zenburn.css" type="text/css" />
         <link rel="alternate stylesheet" title="Classic" href="https://wolfand11.github.io/res/worg_theme/css/worg-classic.css" type="text/css" />
         <link rel="icon" href="https://wolfand11.github.io/res/favicon.ico" type="image/ico" />
         <script type="text/javascript" src="https://wolfand11.github.io/res/blog-tools.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="https://wolfand11.github.io"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">Computer System</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org00929da">Computer Systems: A Programmer's Perspective</a>
<ul>
<li><a href="#orge8d1630">第一部分程序结构和执行</a>
<ul>
<li><a href="#org40c933f">2 信息的表示和处理</a>
<ul>
<li><a href="#org93992e8">整数</a>
<ul>
<li><a href="#orgdcbe313">整数的表示</a></li>
<li><a href="#org28fd21c">有符号数和无符号数之间的转换</a></li>
<li><a href="#org61517b7">移位运算</a></li>
<li><a href="#org23a2a4c">整数的运算</a></li>
</ul>
</li>
<li><a href="#org0acd2bd">浮点数</a>
<ul>
<li><a href="#org79511c1">浮点数表示</a></li>
<li><a href="#org36ff57f">舍入</a></li>
<li><a href="#orgc99f1a3">浮点数运算</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org7362b45">3 程序的机器级表示</a>
<ul>
<li><a href="#orgf69f14c">程序编码</a>
<ul>
<li><a href="#org8364643">机器级代码</a></li>
<li><a href="#org5abc635">Code Example</a></li>
</ul>
</li>
<li><a href="#orgaf38c1e">数据格式</a></li>
<li><a href="#org46ab511">访问信息</a>
<ul>
<li><a href="#org63d15a6">操作数指示符</a></li>
<li><a href="#orgd4e47e5">数据传送指令</a></li>
<li><a href="#org872c026">压入和弹出栈数据</a></li>
</ul>
</li>
<li><a href="#org0d72123">算数和逻辑操作</a>
<ul>
<li><a href="#orgab9ae42">leaq</a></li>
<li><a href="#orgafba5be">特殊的算术操作</a></li>
</ul>
</li>
<li><a href="#org8b40a3c">控制</a></li>
<li><a href="#org8053dc1">过程</a>
<ul>
<li><a href="#orgd54262d">运行时栈</a></li>
<li><a href="#org7356a10">转移控制</a></li>
<li><a href="#org069446d">数据传送</a></li>
<li><a href="#org295d616">栈上的局部存储</a></li>
<li><a href="#org3c7f354">寄存器中的局部存储空间</a></li>
<li><a href="#org9bde6f7">递归过程</a></li>
</ul>
</li>
<li><a href="#org0a5f964">数组分配和访问</a>
<ul>
<li><a href="#org24d39ea">指针运算</a></li>
<li><a href="#orga5dc82c">嵌套数组</a></li>
<li><a href="#orge7f4af8">定长数组</a></li>
<li><a href="#orgd718a24">变长数组</a></li>
</ul>
</li>
<li><a href="#org93ff0d1">异质的数据结构</a>
<ul>
<li><a href="#org68669f0">结构体</a></li>
<li><a href="#org32ad623">Union</a></li>
<li><a href="#org890b384">数据对齐</a></li>
</ul>
</li>
<li><a href="#org9a22283">在机器级程序中将控制与数据结合起来</a>
<ul>
<li><a href="#org79e0c56">理解指针</a></li>
<li><a href="#orgbdcc904">内存越界引用和缓冲器溢出</a></li>
<li><a href="#org1c9a753">对抗缓冲区溢出攻击</a></li>
<li><a href="#org2f6d7f5">支持变长栈帧</a></li>
</ul>
</li>
<li><a href="#orgeec5d0e">浮点代码</a>
<ul>
<li><a href="#org0f37099">浮点传送和转换操作</a></li>
<li><a href="#org7163019">过程中的浮点代码</a></li>
<li><a href="#org12334fb">浮点运算操作</a></li>
<li><a href="#org8f8b359">定义和使用浮点常数</a></li>
<li><a href="#org116b146">在浮点代码中使用位级操作</a></li>
<li><a href="#orgc6faae2">浮点比较操作</a></li>
<li><a href="#orgfb09c9d">对浮点代码的观察结论</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org072eac1">4 处理器体系结构</a>
<ul>
<li><a href="#org27cbed5">Y86-64 指令集体系结构</a>
<ul>
<li><a href="#org3c2d012">程序员可见的状态</a></li>
<li><a href="#org99fbac1">Y86-64 指令</a></li>
<li><a href="#orgc4d5079">指令编码</a></li>
<li><a href="#org5c60e87">Y86-64 异常</a></li>
<li><a href="#orgce30439">Y86-64 程序</a></li>
<li><a href="#orgbe7e63f">一些 Y86-64 指令的详情</a></li>
</ul>
</li>
<li><a href="#org38bf909">逻辑设计和硬件控制语言 HCL</a></li>
<li><a href="#org0befc51">Y86-64 的顺序实现</a></li>
<li><a href="#org8cebf01">流水线的通用原理</a>
<ul>
<li><a href="#org34f0dae">计算流水线</a></li>
<li><a href="#org8f5b548">流水线操作的详细说明</a></li>
<li><a href="#orgb7bec93">流水线的局限性</a></li>
<li><a href="#org06bf81a">带反馈的流水线系统</a></li>
</ul>
</li>
<li><a href="#orga64c51c">Y86-64 的流水线实现</a></li>
</ul>
</li>
<li><a href="#orgd9a9413">5 优化程序性能</a></li>
<li><a href="#org371abfb">6 存储器层次结构</a></li>
</ul>
</li>
<li><a href="#orgb9a14e3">第二部分在系统上运行程序</a>
<ul>
<li><a href="#orgb9eb389">7 链接</a>
<ul>
<li><a href="#orgdb2309d">编译器驱动程序</a></li>
<li><a href="#org0887fc2">静态链接</a></li>
<li><a href="#org59fb143">目标文件</a></li>
<li><a href="#orga19efa9">可重定位目标文件</a></li>
<li><a href="#org873f6a7">ELF 头</a></li>
<li><a href="#org8c19609">符号和符号表</a></li>
<li><a href="#orgcfc2813">符号解析</a>
<ul>
<li><a href="#orgfc7eb4b">链接器如何解析多重定义的全局符号</a></li>
<li><a href="#orgead9b51">与静态库链接</a></li>
<li><a href="#org09378b1">链接器如何使用静态库来解析引用</a></li>
</ul>
</li>
<li><a href="#orgee23d4e">重定位</a>
<ul>
<li><a href="#org58979a5">重定位条目</a></li>
<li><a href="#org6cf6c5e">重定位符号引用</a></li>
</ul>
</li>
<li><a href="#org44616f7">可执行目标文件</a></li>
<li><a href="#orgd3c7394">加载可执行目标文件</a></li>
<li><a href="#org8e3634f">动态链接共享库</a></li>
<li><a href="#orge85c92b">从应用程序中加载和链接共享库</a></li>
<li><a href="#org9e1b7d5">位置无关代码</a></li>
<li><a href="#orgbb91b41">库打桩机制</a></li>
<li><a href="#org55c9bf9">处理目标文件的工具</a></li>
</ul>
</li>
<li><a href="#org9560402">8 异常控制流</a></li>
<li><a href="#orge228030">9 虚拟内存</a>
<ul>
<li><a href="#org1ce11b7">内存映射</a>
<ul>
<li><a href="#org9a972de">再看 execve 函数</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgfafd5f1">第三部分程序间的交流和通信</a>
<ul>
<li><a href="#org523c783">10 系统级 I/O</a></li>
<li><a href="#org8d66ddc">11 网络编程</a></li>
<li><a href="#orgac06162">11 并发编程</a></li>
</ul>
</li>
<li><a href="#org65fab7c">参考资料</a></li>
</ul>
</li>
<li><a href="#org12a0f03">Misc</a>
<ul>
<li><a href="#orgaf83d37">Q&amp;A</a>
<ul>
<li>
<ul>
<li><a href="#org121e91a">带宽的计算</a></li>
<li><a href="#orgd0d8303">数据传输率</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
Computer System note.<br />
</p>
<div class="HTML" id="org09c87a7">
<p>
&lt;!&#x2013; more &#x2013;&gt;<br />
</p>

</div>

<div id="outline-container-org00929da" class="outline-2">
<h2 id="org00929da">Computer Systems: A Programmer's Perspective</h2>
<div class="outline-text-2" id="text-org00929da">
</div>
<div id="outline-container-orge8d1630" class="outline-3">
<h3 id="orge8d1630">第一部分程序结构和执行</h3>
<div class="outline-text-3" id="text-orge8d1630">
</div>
<div id="outline-container-org40c933f" class="outline-4">
<h4 id="org40c933f">2 信息的表示和处理</h4>
<div class="outline-text-4" id="text-org40c933f">
</div>
<div id="outline-container-org93992e8" class="outline-5">
<h5 id="org93992e8">整数</h5>
<div class="outline-text-5" id="text-org93992e8">
<p>
该部分用到的一些记号说明如下：<br />
<img src="./ComputerSystem/2020_05_24_int_uint_notation.jpg" alt="2020_05_24_int_uint_notation.jpg" /><br />
</p>
</div>

<div id="outline-container-orgdcbe313" class="outline-6">
<h6 id="orgdcbe313">整数的表示</h6>
<div class="outline-text-6" id="text-orgdcbe313">

<div id="orgee24951" class="figure">
<p><img src="./ComputerSystem/2020_05_24_int_uint_exp.jpg" alt="2020_05_24_int_uint_exp.jpg" /><br />
</p>
</div>

<p>
上图展示了以下内容：<br />
</p>
<ul class="org-ul">
<li>无符号数的编码<br /></li>
<li>补码编码<br /></li>
<li>反码、原码编码<br /></li>
</ul>
</div>

<ul class="org-ul">
<li><a id="org72c58c5"></a><span class="todo TODO">TODO</span> 为什么要用补码表示有符号整数？<br /></li>
</ul>
</div>

<div id="outline-container-org28fd21c" class="outline-6">
<h6 id="org28fd21c">有符号数和无符号数之间的转换</h6>
<div class="outline-text-6" id="text-org28fd21c">

<div id="org1a5667f" class="figure">
<p><img src="./ComputerSystem/2020_05_24_int_uint_convert.jpg" alt="2020_05_24_int_uint_convert.jpg" /><br />
</p>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#26377;&#31526;&#21495;&#25968;&#21644;&#26080;&#31526;&#21495;&#25968;&#20043;&#38388;&#30340;&#36716;&#25442;</span>
<span style="color: #2aa1ae; background-color: #292e34;">//// </span><span style="color: #2aa1ae; background-color: #292e34;">&#24378;&#21046;&#31867;&#22411;&#36716;&#25442;&#30340;&#32467;&#26524;&#20445;&#25345;&#20301;&#20540;&#19981;&#21464;&#65292;&#21482;&#26159;&#25913;&#21464;&#20102;&#35299;&#37322;&#36825;&#20123;&#20301;&#30340;&#26041;&#24335;&#12290;</span>
<span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v</span>=-12345;
<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">uv</span> = (<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">short</span>) v;
printf(<span style="color: #2d9574;">"v = %d, uv = %u\n"</span>, v, uv);

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">v = -12345, uv = 53191;</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#25193;&#23637;&#19968;&#20010;&#25968;&#23383;</span>
<span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">sx</span> = -12345;           <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">-12345</span>
<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">usx</span> = sx;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">53191</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">x</span> = sx;                  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">-12345</span>
<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #7590db;">ux</span> = usx;           <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">53191</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#25130;&#26029;&#25968;&#23383;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">x</span> = 53191;
<span style="color: #ce537a; font-weight: bold;">short</span> <span style="color: #7590db;">sx</span> = (<span style="color: #ce537a; font-weight: bold;">short</span>) x; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">-12345</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">y</span> = sx;           <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">-12345</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org61517b7" class="outline-6">
<h6 id="org61517b7">移位运算</h6>
<div class="outline-text-6" id="text-org61517b7">
<p>
对于一个位表示为[X(w-1), X(w-2), ···, X(0)]的操作数 x：<br />
左移操作：C 语言表达式 x&lt;&lt;k 会生成一个值，其位表示为[X(w-k-1), X(w-k-2), ···, X(0), 0, ···, 0]<br />
逻辑右移操作：逻辑右移在左端补 k 个 0，结果为[X(w-k-1), X(w-k-2), ···, X(0), 0, ···, 0]<br />
算术右移操作：算术右移在左端补 k 个最高有效位的值，结果为[X(w-1), X(w-1), ···, X(w-1),  X(w-2), ···, X(k)]<br />
</p>


<div id="org97bdd64" class="figure">
<p><img src="./ComputerSystem/2020_05_24_bitwize_shift.jpg" alt="2020_05_24_bitwize_shift.jpg" /><br />
</p>
</div>
</div>
</div>

<div id="outline-container-org23a2a4c" class="outline-6">
<h6 id="org23a2a4c">整数的运算</h6>
<div class="outline-text-6" id="text-org23a2a4c">
<p>
<img src="./ComputerSystem/2020_05_24_int_add_minus.jpg" alt="2020_05_24_int_add_minus.jpg" /><br />
<img src="./ComputerSystem/2020_05_24_int_add_minus_overflow.jpg" alt="2020_05_24_int_add_minus_overflow.jpg" /><br />
上图展示了加减运算，即加减运算产生的溢出<br />
</p>

<p>
<img src="./ComputerSystem/2020_05_24_int_uint_mul.jpg" alt="2020_05_24_int_uint_mul.jpg" /><br />
上图展示了乘法运算<br />
</p>

<p>
<img src="./ComputerSystem/2020_05_24_int_uint_divide.jpg" alt="2020_05_24_int_uint_divide.jpg" /><br />
上图展示了除法运算<br />
</p>

<p>
加法、减法、位级运算和移位只需要 1 个时钟周期<br />
乘法指令在比较老的 CPU 上需要 10 个或者更多时钟周期(Intel Core i7 Haswell 上需要 3 个时钟周期)<br />
除法指令在比较老的 CPU 上需要 30 个或者更多时钟周期.<br />
</p>

<p>
可以将乘法转化为加法、减法、移位的组合，例如：<br />
14 = 2^3 + 2^2 + 2^1 所以 x*14=(x&lt;&lt;3)+(x&lt;&lt;2)+(x&lt;&lt;1)<br />
14 = 2^4 - 2^1 所以 x*14=(x&lt;&lt;4)-(x&lt;&lt;1)<br />
任何一个整数都可以表示为 2 的幂次之和，所以乘法都可以转化为位移和加法操作。但是只有当乘法转化为少量的移位、加法和减法时，编译器才会执行这种转化，从而优化性能。<br />
当一个整数为 2 的幂次时，可以将除该整数转化为位移操作。而整数不为 2 的幂次时，则无法像乘法那样转化为位移操作了。<br />
</p>
</div>
</div>
</div>
<div id="outline-container-org0acd2bd" class="outline-5">
<h5 id="org0acd2bd">浮点数</h5>
<div class="outline-text-5" id="text-org0acd2bd">
</div>
<div id="outline-container-org79511c1" class="outline-6">
<h6 id="org79511c1">浮点数表示</h6>
<div class="outline-text-6" id="text-org79511c1">
<p>
<a id="org488a0eb"></a><br />
</p>

<p>
下图展示了 IEEE 浮点数表示的规则：<br />
<img src="./ComputerSystem/2020_05_22_float_number_rule.jpg" alt="2020_05_22_float_number_rule.jpg" /><br />
</p>

<p>
下图展示了 8 位浮点数表示的示例：<br />
<img src="./ComputerSystem/2020_05_22_float_number_rule_example.jpg" alt="2020_05_22_float_number_rule_example.jpg" /><br />
</p>

<p>
下图展示了 32 位浮点数表示的示例：<br />
<img src="./ComputerSystem/2020_05_22_float_number_rule_example_32.jpg" alt="2020_05_22_float_number_rule_example_32.jpg" /><br />
</p>

<p>
浮点数表示的连续性，可以将浮点数的表示有一种更直观的理解：<br />
e 间隔 1 的数落在 \([2^E, 2^{E+1})\) 范围内，并且这个范围内，两个相邻的浮点数的间隔为 \(2^{E-23}\)  (以 float 为例)<br />
<img src="./ComputerSystem/float_E_M_explain.jpg" alt="float_E_M_explain.jpg" /><br />
</p>

<p>
浮点数精度值以指数变化，E越大精度越小，E越小精度越大(精度值为相邻浮点数之间的间隔)。e全 0 时，E最小（此时 float 类型对应的 E 为 1-126=-126），此时精度最大（此时 float 类型对应的精度为 \(2^{-126-23}=2^{-149}\) ）：<br />
<img src="./ComputerSystem/float_precision_illustrate.jpg" alt="float_precision_illustrate.jpg" /><br />
<a href="./ComputerSystem/float_precision_illustrate.ggb">./ComputerSystem/float_precision_illustrate.ggb</a><br />
</p>

<ul class="org-ul">
<li>浮点数象形表示法 <a href="https://zhuanlan.zhihu.com/p/138845520">https://zhuanlan.zhihu.com/p/138845520</a><br /></li>
<li>Floating Point Visually Explained <a href="https://fabiensanglard.net/floating_point_visually_explained/index.html">https://fabiensanglard.net/floating_point_visually_explained/index.html</a><br /></li>
<li>浮点数内存表示工具 <a href="https://www.h-schmidt.net/FloatConverter/IEEE754.html">https://www.h-schmidt.net/FloatConverter/IEEE754.html</a><br /></li>
</ul>
</div>
</div>
<div id="outline-container-org36ff57f" class="outline-6">
<h6 id="org36ff57f">舍入</h6>
<div class="outline-text-6" id="text-org36ff57f">
<p>
舍入的一个关键问题是在两个可能值的中间如何确定舍入方向。IEEE 浮点格式定义了四种不同的舍入方式。<br />
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方式</th>
<th scope="col" class="org-right">1.40 美元</th>
<th scope="col" class="org-right">1.60 美元</th>
<th scope="col" class="org-right">1.50 美元</th>
<th scope="col" class="org-right">2.50 美元</th>
<th scope="col" class="org-right">-1.50 美元</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">向偶数舍入</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">-2</td>
</tr>

<tr>
<td class="org-left">向零舍入</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">-1</td>
</tr>

<tr>
<td class="org-left">向下舍入</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">-2</td>
</tr>

<tr>
<td class="org-left">向上舍入</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">-1</td>
</tr>
</tbody>
</table>

<p>
向偶数舍入也被称为向最接近的值舍入，其为默认的方式。给定值为两个可能值的中间值时，向偶数舍入将数字向上或者向下舍入，使得结果的最低有效数字为偶数。（例如：上面向偶数舍入将 1.5 和 2.5 都舍入为 2）<br />
</p>

<p>
向偶数舍入应用于二进制数时，最低有效位的值为 0 认为是偶数，值为 1 认为是奇数。只有对于形如 XX···X.YY···Y100···0 的二进制位模式的数，这种舍入方式才有效（此时的值是精度范围内两个值的中间值，如 1.5 是 2 和 1 的中间值），其中 X 和 Y 表示任意位值，最右边 Y 是要被舍入的位置(精度截止到最右边的 Y)。例如：<br />
</p>


<div id="org7f328d2" class="figure">
<p><img src="./ComputerSystem/02_04_float_round.jpg" alt="02_04_float_round.jpg" /><br />
</p>
</div>
</div>

<ul class="org-ul">
<li><a id="org01f5cec"></a>为什么要采用偶数舍入，而不是始终将位于两个可表示的值中间的值都向上舍入呢？<br />
<div class="outline-text-7" id="text-org01f5cec">
<p>
将位于两个可表示的值中间的值都向上舍入，这种方法舍入一组数值，会在计算这些值的平均数中引入统计偏差，其结果比本身略高。相反，将位于两个可表示的值中间的值都向下舍入，其结果比本身略低。使用偶数舍入可以在大多数情况中避免这种统计偏差，在 50%时间里其向上舍入，而在 50%的时间里其向下舍入。<br />
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgc99f1a3" class="outline-6">
<h6 id="orgc99f1a3">浮点数运算</h6>
<div class="outline-text-6" id="text-orgc99f1a3">
</div>
<ul class="org-ul">
<li><a id="orga9626f3"></a>浮点数算术运算<br />
<div class="outline-text-7" id="text-orga9626f3">

<div id="org9d05693" class="figure">
<p><img src="./ComputerSystem/2020_05_24_float_algrithem.jpg" alt="2020_05_24_float_algrithem.jpg" /><br />
</p>
</div>

<p>
下图展示了，浮点数加法运算时，舍入所导致的误差范围：<br />
<img src="./ComputerSystem/2020_05_24_float_round_err.jpg" alt="2020_05_24_float_round_err.jpg" /><br />
</p>

<p>
下图展示了，从浮点运算导出的一些结论：<br />
<img src="./ComputerSystem/2020_05_24_float_calc_rule.jpg" alt="2020_05_24_float_calc_rule.jpg" /><br />
</p>
</div>
</li>

<li><a id="org8d2d349"></a>Error Propagation<br />
<div class="outline-text-7" id="text-org8d2d349">
<p>
下图展示了 Forward Error Analysis 和 Backword Error Analysis:<br />
<img src="./ComputerSystem/2020_05_25_forward_backward_error.jpg" alt="2020_05_25_forward_backward_error.jpg" /><br />
下图展示了对浮点计算误差的分析和定界：<br />
<img src="./ComputerSystem/2020_05_25_error_propagation.jpg" alt="2020_05_25_error_propagation.jpg" /><br />
</p>

<ul class="org-ul">
<li><a href="http://www.mathcs.emory.edu/~nagy/courses/fall12/515/Conditioning_and_FLOPS.pdf">http://www.mathcs.emory.edu/~nagy/courses/fall12/515/Conditioning_and_FLOPS.pdf</a><br /></li>
<li><a href="https://baike.baidu.com/item/%E5%8C%BA%E9%97%B4/1273117#viewPageContent">https://baike.baidu.com/item/%E5%8C%BA%E9%97%B4/1273117#viewPageContent</a><br /></li>
</ul>
</div>
</li>
<li><a id="orge1b3820"></a>Running Error Analysis<br />
<div class="outline-text-7" id="text-orge1b3820">
<p>
除了通过代数的方法来得出误差范围，也可以让计算机为我们做这项工作，这种方式被称为 running error analysis.其背后的理念是，每次执行浮点运算时，同时计算累积到当前计算的误差范围。<br />
</p>

<p>
具体的实现参考 <a href="../graphics/PhysicallyBasedRendering.html#org1f4006f">../graphics/PhysicallyBasedRendering.html#org1f4006f</a><br />
</p>
</div>
</li>
<li><a id="org1aff13d"></a>Misc<br />
<div class="outline-text-7" id="text-org1aff13d">
<p>
v&gt;0 v/0 = Infinity<br />
v&lt;0 v/0 = -Infinity<br />
v&gt;0 v*Infinity = Infinity<br />
v&lt;0 v*Infinity = -Infinity<br />
</p>

<p>
0*infinity = NaN<br />
Infinity - Infinity = NaN<br />
Infinity + Infinity = Infinity<br />
NaN + v = NaN<br />
NaN 和任意数字的比较都为 false<br />
</p>

<ul class="org-ul">
<li>浮点数加法是可交换的。<br /></li>
<li>浮点数加法不具有结合性（因为舍入或溢出）。<br />
(3.14+1e10)-1e10 = 0<br />
3.14+(1e10-1e10) = 3.14<br />
1e10 是 C/C++规定的浮点数的科学计数写法,意思是 1.0x10 的 10 次方<br /></li>
<li>浮点数加法满足单调性属性：如果 a&gt;=b,那么对于任何 a、b 以及 x 的值，除了 NaN，都有 x+a&gt;=x+b。<br /></li>

<li>浮点数乘法是可交换的。<br /></li>
<li>浮点数乘法不具有结合性（因为舍入或溢出）。<br />
(1e20*1e20)*1e-20 为无穷大<br />
1e20*(1e20*1e-20) 为 1e20<br /></li>
<li>浮点乘法在加法上不具备分配性。<br />
1e20*(1e20-1e20) = 0<br />
1e20*1e-20-1e20*1e-20 = NaN<br /></li>
<li>浮点乘法满足下列单调性：对于任何 a、b、c,并且 a、b、c 都不为 NaN,浮点乘法满足<br />
a&gt;=b 且 c&gt;=0 则 a*c&gt;=b*c<br />
a&gt;=b 且 c&lt;=0 则 a*c&lt;=b*c<br />
无符号或补码的乘法没有这些单调性属性，因为溢出时会取模。<br /></li>
</ul>
</div>
</li>

<li><a id="org54e7162"></a>Tips<br />
<div class="outline-text-7" id="text-org54e7162">
<p>
本节内容部分来自 Physically Based Rendering_v3_en 3.9 节 Managing Rounding Error.<br />
</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org7362b45" class="outline-4">
<h4 id="org7362b45">3 程序的机器级表示</h4>
<div class="outline-text-4" id="text-org7362b45">
</div>
<div id="outline-container-orgf69f14c" class="outline-5">
<h5 id="orgf69f14c">程序编码</h5>
<div class="outline-text-5" id="text-orgf69f14c">
</div>
<div id="outline-container-org8364643" class="outline-6">
<h6 id="org8364643">机器级代码</h6>
<div class="outline-text-6" id="text-org8364643">
<p>
机器级编码使用了两种抽象：<br />
</p>
<ol class="org-ol">
<li>由指令集体系结构或指令集架构（Instruction Set Architecture, ISA）来定义机器级程序的格式和行为，它定义了处理器状态、指令的格式，以及每条指令对状态的影响。大多数 ISA 将程序的行为描述成好像每条指令都是按顺序执行的，一条指令结束后，下一条再开始。处理器硬件远比描述的精细复杂，它们并发执行许多指令，但是采取措施保证整体行为与 ISA 指定的顺序执行的行为完全一致。<br /></li>
<li>机器级程序使用的内存地址是虚拟地址，提供的内存模型看上去是一个非常大的字节数组。存储器系统的实际实现是将多个硬件存储器和操作系统软件组合起来。<br /></li>
</ol>

<p>
x86-64 的机器代码和原始 C 代码差别非常大。一些通常对 C 语言程序员隐藏的处理器状态都是可见的：<br />
</p>
<ul class="org-ul">
<li>程序计数器（通常称为“PC”，在 x86-64 中用%rip 表示） 其给出将要执行的下一条指令在内存中的地址<br /></li>
<li>整数寄存器文件  其包含 16 个命名的位置，分别存储 64 位的值。这些寄存器可以存储地址（对应于 C 语言的指针）或整数数据。有的寄存器被用来记录某些重要的程序状态，而其他的寄存器用来保持临时数据，例如过程的参数和局部变量，以及函数的返回值。<br /></li>
<li>条件码寄存器    其保存着最近执行的算术或逻辑指令的状态信息。他们用来实现控制或数据流中的条件变化，比如说用来实现 if 和 while 语句。<br /></li>
<li>一组向量寄存器  其可以存放一个或多个整数或浮点数值。<br /></li>
</ul>

<p>
<a href="../language/ASM.html#orgb92fd2b">寄存器说明</a><br />
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">-Og &#25351;&#31034;&#32534;&#35793;&#22120;&#29983;&#25104;&#31526;&#21512;&#21407;&#22987;C&#20195;&#30721;&#25972;&#20307;&#32467;&#26500;&#30340;&#26426;&#22120;&#20195;&#30721;&#65292; &#20351;&#29992;&#36739;&#39640;&#32423;&#21035;&#20248;&#21270;&#20135;&#29983;&#30340;&#20195;&#30721;&#20250;&#20005;&#37325;&#21464;&#24418;&#65292;&#20197;&#33267;&#20110;&#26426;&#22120;&#20195;&#30721;&#21644;&#28304;&#20195;&#30721;&#20043;&#38388;&#30340;&#20851;&#31995;&#38750;&#24120;&#38590;&#20197;&#29702;&#35299;</span>
gcc -Og main.c -o prog
</pre>
</div>
</div>
</div>
<div id="outline-container-org5abc635" class="outline-6">
<h6 id="org5abc635">Code Example</h6>
<div class="outline-text-6" id="text-org5abc635">
</div>
<ul class="org-ul">
<li><a id="org4e3b775"></a>Example 1<br />
<div class="outline-text-7" id="text-org4e3b775">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">append_val</span> = 10;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span>()
{
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">val</span> = 1;
    val = val + append_val;
    val = val + 2;
    <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">my_s_1</span> = <span style="color: #2d9574;">"0123456789abcdefg-hello world "</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">my_s_2</span> = <span style="color: #2d9574;">"0123456789abcdefg-ABCDEFG"</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span> = my_s_1[val] + my_s_2[val];
    <span style="color: #4f97d7; font-weight: bold;">return</span> c;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#25191;&#34892;&#19979;&#38754;&#21629;&#20196;&#23545;&#31243;&#24207;&#36827;&#34892;&#32534;&#35793;&#29983;&#25104; test_local.s&#27719;&#32534;&#20195;&#30721;</span>
gcc -S test_local.c -o test_local.s
</pre>
</div>

<div class="org-src-container">
<pre class="src src-asm">##                                                           <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#27573;&#23450;&#20041;&#21644;&#29256;&#26412;&#20449;&#24687;</span>
<span style="color: #4f97d7; font-weight: bold;">.section</span>    __TEXT,__text,regular,pure_instructions          <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23450;&#20041;&#20102;&#20195;&#30721;&#27573;&#65292;&#20854;&#20013;`.text`&#27573;&#36890;&#24120;&#21253;&#21547;&#31243;&#24207;&#30340;&#21487;&#25191;&#34892;&#20195;&#30721;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">.macosx_version_min</span> 10, 12                               <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#25351;&#23450;&#30446;&#26631;&#25805;&#20316;&#31995;&#32479;&#20026; macOS 10.12 &#25110;&#26356;&#39640;&#29256;&#26412;&#12290;</span>
                                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#20989;&#25968;&#22768;&#26126;</span>
    <span style="color: #4f97d7; font-weight: bold;">.globl</span>  _main                                            <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#22768;&#26126;`_main`&#20989;&#25968;&#20026;&#20840;&#23616;&#65292;&#20351;&#24471;&#20854;&#20182;&#22320;&#26041;&#21487;&#20197;&#35843;&#29992;&#23427;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">.p2align</span>    4, 0x90                                      <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#30830;&#20445;&#25509;&#19979;&#26469;&#30340;&#25351;&#20196;&#23545;&#40784;&#21040; 16 &#23383;&#33410;&#36793;&#30028;&#65292;&#25552;&#39640;&#25191;&#34892;&#25928;&#29575;&#12290;</span>
                                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#20989;&#25968;`_main`</span>
<span style="color: #bc6ec5; font-weight: bold;">_main</span>:                                  ## @main             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     main&#20989;&#25968;&#24320;&#22987;&#26631;&#31614;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">.cfi_startproc</span>                                           <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     +++ .cfi_xxx &#37117;&#26159;&#29992;&#20110;&#35843;&#35797;&#30340;&#20449;&#24687;</span>
## BB#0:
    <span style="color: #4f97d7; font-weight: bold;">pushq</span>   <span style="color: #7590db;">%rbp</span>                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#20445;&#23384;&#35843;&#29992;&#32773;&#30340;&#22522;&#22336;&#25351;&#38024;&#65288;RBP&#65289;&#21040;&#26632;&#19978;&#12290;</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi0</span>:                                                       <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     +++</span>
    <span style="color: #4f97d7; font-weight: bold;">.cfi_def_cfa_offset</span> 16                                   <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     +++</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi1</span>:                                                       <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     +++</span>
    <span style="color: #4f97d7; font-weight: bold;">.cfi_offset</span> <span style="color: #7590db;">%rbp</span>, -16                                    <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     +++ </span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rbp</span>                                       <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558;&#26632;&#39030;&#25351;&#38024;&#65288;RSP&#65289;&#30340;&#20540;&#22797;&#21046;&#21040; RBP&#65292;&#24314;&#31435;&#26032;&#30340;&#26632;&#24103;&#12290;</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi2</span>:
    <span style="color: #4f97d7; font-weight: bold;">.cfi_def_cfa_register</span> <span style="color: #7590db;">%rbp</span>                               <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     +++ </span>
                                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#25968;&#25454;&#21152;&#36733;&#19982;&#23616;&#37096;&#21464;&#37327;&#21021;&#22987;&#21270;</span>
    <span style="color: #4f97d7; font-weight: bold;">leaq</span>    L_.str.1(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%rax</span>                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#21152;&#36733;&#23383;&#31526;&#20018;"L_.str.1"&#30340;&#22320;&#22336;&#21040; RAX &#23492;&#23384;&#22120;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">leaq</span>    L_.str(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%rcx</span>                               <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#21152;&#36733;&#23383;&#31526;&#20018;"L_.str"&#30340;&#22320;&#22336;&#21040; RCX &#23492;&#23384;&#22120;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $0, -4(<span style="color: #7590db;">%rbp</span>)                                     <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#22312;&#26632;&#19978;&#20998;&#37197; 4 &#23383;&#33410;&#30340;&#31354;&#38388;&#65292;&#24182;&#23384;&#20648; 0&#65292;&#20316;&#20026;&#23616;&#37096;&#21464;&#37327;&#21021;&#22987;&#21270;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $1, -8(<span style="color: #7590db;">%rbp</span>)                                     <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#22312;&#26632;&#19978;&#20998;&#37197; 4 &#23383;&#33410;&#31354;&#38388;&#65292;&#23384;&#20648; 1&#65292;&#36825;&#26159;&#21478;&#19968;&#20010;&#23616;&#37096;&#21464;&#37327;&#12290;</span>
                                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#35745;&#31639;&#36923;&#36753;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    -8(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%ecx</span>                                   <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558;&#23616;&#37096;&#21464;&#37327;&#65288;&#20540;&#20026; 1&#65289;&#21152;&#36733;&#21040; ECX &#23492;&#23384;&#22120;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">addl</span>    _append_val(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%ecx</span>                          <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558; ECX &#23492;&#23384;&#22120;&#20013;&#30340;&#20540;&#19982;&#20840;&#23616;&#21464;&#37327;`_append_val`&#30456;&#21152;&#12290;&#36825;&#37324;&#20351;&#29992;&#20102; RIP &#30456;&#23545;&#23547;&#22336;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%ecx</span>, -8(<span style="color: #7590db;">%rbp</span>)                                   <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558;&#32467;&#26524;&#65288;11&#65289;&#23384;&#22238;&#23616;&#37096;&#21464;&#37327;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    -8(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%ecx</span>                                   <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558;&#23616;&#37096;&#21464;&#37327;&#65288;&#20540;&#20026; 11&#65289;&#21152;&#36733;&#21040; ECX &#23492;&#23384;&#22120;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">addl</span>    $2, <span style="color: #7590db;">%ecx</span>                                         <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558; ECX &#23492;&#23384;&#22120;&#20013;&#30340;&#20540;&#19982; 2 &#30456;&#21152;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%ecx</span>, -8(<span style="color: #7590db;">%rbp</span>)                                   <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558;&#32467;&#26524;&#65288;13&#65289;&#23384;&#22238;&#23616;&#37096;&#21464;&#37327;&#12290;</span>
                                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#23383;&#31526;&#35775;&#38382; </span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rcx</span>, -16(<span style="color: #7590db;">%rbp</span>)                                  <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558;&#23383;&#31526;&#20018;0&#22320;&#22336;&#20445;&#23384;&#21040;&#26632;&#19978;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rax</span>, -24(<span style="color: #7590db;">%rbp</span>)                                  <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558;&#23383;&#31526;&#20018;1&#22320;&#22336;&#20445;&#23384;&#21040;&#26632;&#19978;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -16(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>                                  <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#37325;&#26032;&#21152;&#36733;&#23383;&#31526;&#20018; 0&#22320;&#22336;&#21040; RAX&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movslq</span>  -8(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rcx</span>                                   <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#25193;&#23637;&#23616;&#37096;&#21464;&#37327;&#30340;&#20540;&#65288;13&#65289;&#21040; RCX &#23492;&#23384;&#22120;&#65288;64 &#20301;&#65289;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movsbl</span>  (<span style="color: #7590db;">%rax</span>,<span style="color: #7590db;">%rcx</span>), <span style="color: #7590db;">%edx</span>                                <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#26681;&#25454;&#35745;&#31639;&#30340;&#32034;&#24341;&#20174;&#23383;&#31526;&#20018;&#20013;&#33719;&#21462;&#23383;&#31526;&#24182;&#36716;&#25442;&#20026;&#26377;&#31526;&#21495;&#23383;&#33410;&#23384;&#20648;&#21040; EDX &#23492;&#23384;&#22120;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -24(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>                                  <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#37325;&#26032;&#21152;&#36733;&#23383;&#31526;&#20018; 1 &#22320;&#22336;&#21040; RAX&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movslq</span>  -8(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rcx</span>                                   <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#25193;&#23637;&#23616;&#37096;&#21464;&#37327;&#30340;&#20540;&#65288;13&#65289;&#21040; RCX &#23492;&#23384;&#22120;&#65288;64 &#20301;&#65289;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movsbl</span>  (<span style="color: #7590db;">%rax</span>,<span style="color: #7590db;">%rcx</span>), <span style="color: #7590db;">%esi</span>                                <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#26681;&#25454;&#35745;&#31639;&#30340;&#32034;&#24341;&#20174;&#23383;&#31526;&#20018;&#20013;&#33719;&#21462;&#23383;&#31526;&#24182;&#36716;&#25442;&#20026;&#26377;&#31526;&#21495;&#23383;&#33410;&#23384;&#20648;&#21040; ESI &#23492;&#23384;&#22120;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">addl</span>    <span style="color: #7590db;">%esi</span>, <span style="color: #7590db;">%edx</span>                                       <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558;&#20174;&#20004;&#20010;&#23383;&#31526;&#20018;&#20013;&#33719;&#21462;&#30340;&#23383;&#31526;&#30340; ASCII &#20540;&#30456;&#21152;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%edx</span>, -28(<span style="color: #7590db;">%rbp</span>)                                  <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#32467;&#26524;&#23384;&#20837;&#26632;&#19978;&#20301;&#32622;-28(%rbp)</span>
                                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#20989;&#25968;&#32467;&#26463;</span>
    <span style="color: #4f97d7; font-weight: bold;">movsbl</span>  -28(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%eax</span>                                  <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23558;&#26368;&#32456;&#32467;&#26524;&#21152;&#36733;&#21040; EAX &#23492;&#23384;&#22120;&#65292;EAX &#36890;&#24120;&#29992;&#20110;&#23384;&#25918;&#20989;&#25968;&#36820;&#22238;&#20540;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">popq</span>    <span style="color: #7590db;">%rbp</span>                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#24674;&#22797;&#35843;&#29992;&#32773;&#30340;&#22522;&#22336;&#25351;&#38024;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">retq</span>                                                     <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#20174;&#20989;&#25968;&#36820;&#22238;&#65292;&#20351;&#29992; EAX &#20013;&#30340;&#20540;&#20316;&#20026;&#36820;&#22238;&#20540;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">.cfi_endproc</span>                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##</span>
                                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#20840;&#23616;&#21464;&#37327;`_append_val`</span>
    <span style="color: #4f97d7; font-weight: bold;">.section</span>    __DATA,__data                                <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23450;&#20041;&#25968;&#25454;&#27573;&#65292;&#36890;&#24120;&#23384;&#20648;&#20840;&#23616;&#21464;&#37327;&#21644;&#38745;&#24577;&#21464;&#37327;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">.globl</span>  _append_val             ## @append_val           <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#22768;&#26126;&#20840;&#23616;&#21464;&#37327;`_append_val`&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">.p2align</span>    2                                            <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23545;&#40784;&#21040; 4 &#23383;&#33410;&#36793;&#30028;&#12290;</span>
<span style="color: #bc6ec5; font-weight: bold;">_append_val</span>:                                                 <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#21464;&#37327;&#26631;&#31614;</span>
    <span style="color: #4f97d7; font-weight: bold;">.long</span>   10                      ## 0xa                   <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#20998;&#37197; 4 &#23383;&#33410;&#31354;&#38388;&#65292;&#23384;&#20648;&#21313;&#36827;&#21046;&#25968; 10&#65288;&#21313;&#20845;&#36827;&#21046;&#20026; 0xa&#65289;&#12290;</span>
                                                             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#23383;&#31526;&#20018;&#24120;&#37327;</span>
    <span style="color: #4f97d7; font-weight: bold;">.section</span>    __TEXT,__cstring,cstring_literals            <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23450;&#20041;&#24120;&#37327;&#23383;&#31526;&#20018;&#27573;&#12290;</span>
<span style="color: #bc6ec5; font-weight: bold;">L</span>_.str:                                 ## @.str             <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23383;&#31526;&#20018;&#24120;&#37327;0</span>
    <span style="color: #4f97d7; font-weight: bold;">.asciz</span>  <span style="color: #2d9574;">"0123456789abcdefg-hello world "</span>
<span style="color: #bc6ec5; font-weight: bold;">L</span>_.str.1:                               ## @.str.1           <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">##     &#23383;&#31526;&#20018;&#24120;&#37327;1</span>
    <span style="color: #4f97d7; font-weight: bold;">.asciz</span>  <span style="color: #2d9574;">"0123456789abcdefg-ABCDEFG"</span>

<span style="color: #4f97d7; font-weight: bold;">.subsections_via_symbols</span>                                     <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#25351;&#31034;&#38142;&#25509;&#22120;&#36890;&#36807;&#31526;&#21495;&#26469;&#20915;&#23450;&#22914;&#20309;&#21010;&#20998;&#23376;&#33410;&#21306;&#27573;&#65292;&#36825;&#26159;&#19968;&#20010;&#38142;&#25509;&#22120;&#25351;&#20196;&#12290;</span>
</pre>
</div>
</div>
</li>
<li><a id="orgc7d5586"></a>Example 2<br />
<div class="outline-text-7" id="text-orgc7d5586">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">mstore.c</span>
<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">mult2</span>(<span style="color: #ce537a; font-weight: bold;">long</span>, <span style="color: #ce537a; font-weight: bold;">long</span>);
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">multstore</span>(<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">a</span>, <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">b</span>, <span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #7590db;">c</span>)
{
  <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">t</span> = mult2(a,b);
  *c = t;
}

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">main.c</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">multstore</span>(<span style="color: #ce537a; font-weight: bold;">long</span>, <span style="color: #ce537a; font-weight: bold;">long</span>, <span style="color: #ce537a; font-weight: bold;">long</span> *);
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span>()
{
  <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">d</span>;
  multstore(2,3,&amp;d);
  <span style="color: #4f97d7; font-weight: bold;">return</span> 0;
}

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">mult2</span>(<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">a</span>, <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">b</span>)
{
  <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">c</span> = a*b;
  <span style="color: #4f97d7; font-weight: bold;">return</span> c;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#25191;&#34892;&#19979;&#38754;&#21629;&#20196;&#23545;&#31243;&#24207;&#36827;&#34892;&#32534;&#35793;&#29983;&#25104; prog.exe&#31243;&#24207;</span>
gcc -Og -o prog.exe main.c mstore.c
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#25191;&#34892;&#19979;&#38754;&#21629;&#20196;&#65292;&#23558;&#20108;&#36827;&#21046;&#26426;&#22120;&#30721;prog.exe&#36716;&#21270;&#20026;&#23383;&#31526;&#34920;&#31034;&#30340;&#26426;&#22120;&#30721;</span>
objdump -d prog.exe &gt; asm-code.txt
</pre>
</div>

<div class="org-src-container">
<pre class="src src-asm">  <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">0000000000401550 &lt;main&gt;:</span>
    <span style="color: #4f97d7; font-weight: bold;">401550</span>: 48 83 ec 38             sub    $0x38,<span style="color: #7590db;">%rsp</span>
    <span style="color: #4f97d7; font-weight: bold;">401554</span>: e8 f7 00 00 00          callq  401650 &lt;__main&gt;
    <span style="color: #4f97d7; font-weight: bold;">401559</span>: 4c 8d 44 24 2c          lea    0x2c(<span style="color: #7590db;">%rsp</span>),<span style="color: #7590db;">%r8</span>
    <span style="color: #4f97d7; font-weight: bold;">40155e</span>: ba 03 00 00 00          mov    $0x3,<span style="color: #7590db;">%edx</span>
    <span style="color: #4f97d7; font-weight: bold;">401563</span>: b9 02 00 00 00          mov    $0x2,<span style="color: #7590db;">%ecx</span>
    <span style="color: #4f97d7; font-weight: bold;">401568</span>: e8 13 00 00 00          callq  401580 &lt;multstore&gt;
    <span style="color: #4f97d7; font-weight: bold;">40156d</span>: b8 00 00 00 00          mov    $0x0,<span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">401572</span>: 48 83 c4 38             add    $0x38,<span style="color: #7590db;">%rsp</span>
    <span style="color: #4f97d7; font-weight: bold;">401576</span>: c3                      retq   

  <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">0000000000401577 &lt;mult2&gt;:</span>
    <span style="color: #4f97d7; font-weight: bold;">401577</span>: 89 c8                   mov    <span style="color: #7590db;">%ecx</span>,<span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">401579</span>: 0f af c2                imul   <span style="color: #7590db;">%edx</span>,<span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">40157c</span>: c3                      retq   
    <span style="color: #4f97d7; font-weight: bold;">40157d</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">40157e</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">40157f</span>: 90                      nop

  <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">0000000000401580 &lt;multstore&gt;:</span>
    <span style="color: #4f97d7; font-weight: bold;">401580</span>: 53                      push   <span style="color: #7590db;">%rbx</span>               <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">save %rbx</span>
    <span style="color: #4f97d7; font-weight: bold;">401581</span>: 48 83 ec 20             sub    $0x20,<span style="color: #7590db;">%rsp</span>         <span style="color: #2aa1ae; background-color: #292e34;">//</span>
    <span style="color: #4f97d7; font-weight: bold;">401585</span>: 4c 89 c3                mov    <span style="color: #7590db;">%r8</span>,<span style="color: #7590db;">%rbx</span>           <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">copy dest to %rbx</span>
    <span style="color: #4f97d7; font-weight: bold;">401588</span>: e8 ea ff ff ff          callq  401577 &lt;mult2&gt;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">call mult2</span>
    <span style="color: #4f97d7; font-weight: bold;">40158d</span>: 89 03                   mov    <span style="color: #7590db;">%eax</span>,(<span style="color: #7590db;">%rbx</span>)        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">store result at *dest</span>
    <span style="color: #4f97d7; font-weight: bold;">40158f</span>: 48 83 c4 20             add    $0x20,<span style="color: #7590db;">%rsp</span>         <span style="color: #2aa1ae; background-color: #292e34;">// </span>
    <span style="color: #4f97d7; font-weight: bold;">401593</span>: 5b                      pop    <span style="color: #7590db;">%rbx</span>               <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">restore %rbx</span>
    <span style="color: #4f97d7; font-weight: bold;">401594</span>: c3                      retq                      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return</span>
    <span style="color: #4f97d7; font-weight: bold;">401595</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">401596</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">401597</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">401598</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">401599</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">40159a</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">40159b</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">40159c</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">40159d</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">40159e</span>: 90                      nop
    <span style="color: #4f97d7; font-weight: bold;">40159f</span>: 90                      nop
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgaf38c1e" class="outline-5">
<h5 id="orgaf38c1e">数据格式</h5>
<div class="outline-text-5" id="text-orgaf38c1e">
<p>
一开始的 CPU 是 16 位的，因此把 16 位称为字，后来，32 位称为双字，64 位称为 4 字。<br />
</p>

<p>
下面为 c 语言数据类型在 x86-64 中的大小：<br />
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">c</th>
<th scope="col" class="org-left">Intel 数据类型</th>
<th scope="col" class="org-left">汇编代码后缀</th>
<th scope="col" class="org-right">字节大小</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">char</td>
<td class="org-left">字节</td>
<td class="org-left">b</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">short</td>
<td class="org-left">字</td>
<td class="org-left">w</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">int</td>
<td class="org-left">双字</td>
<td class="org-left">l</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">long</td>
<td class="org-left">四字</td>
<td class="org-left">q</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-left">char*</td>
<td class="org-left">四字</td>
<td class="org-left">q</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-left">float</td>
<td class="org-left">单精度</td>
<td class="org-left">s</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">double</td>
<td class="org-left">双精度</td>
<td class="org-left">l</td>
<td class="org-right">8</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org46ab511" class="outline-5">
<h5 id="org46ab511">访问信息</h5>
<div class="outline-text-5" id="text-org46ab511">
<p>
下图展示 x86-64 架构 CPU 的寄存器：<br />
<img src="./ComputerSystem/x86_register.jpg" alt="x86_register.jpg" /><br />
</p>
</div>
<div id="outline-container-org63d15a6" class="outline-6">
<h6 id="org63d15a6">操作数指示符</h6>
<div class="outline-text-6" id="text-org63d15a6">
<p>
下表展示了操作数格式<br />
<img src="./ComputerSystem/x86_operand_forms.jpg" alt="x86_operand_forms.jpg" /><br />
</p>

<p>
3.1 练习题答案：<br />
<img src="./ComputerSystem/operand-specifiers-problem-3.1.jpg" alt="operand-specifiers-problem-3.1.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-orgd4e47e5" class="outline-6">
<h6 id="orgd4e47e5">数据传送指令</h6>
<div class="outline-text-6" id="text-orgd4e47e5">
<p>
简单形式的数据传送指令：<br />
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">指令</th>
<th scope="col" class="org-left">英文</th>
<th scope="col" class="org-left">效果</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">movq S, D</td>
<td class="org-left">move</td>
<td class="org-left">D&lt;-S</td>
<td class="org-left">传送 4 字节</td>
</tr>

<tr>
<td class="org-left">leaq S, D</td>
<td class="org-left">load effective address</td>
<td class="org-left">D&lt;-&amp;S</td>
<td class="org-left">加载有效地址</td>
</tr>
</tbody>
</table>

<p>
<img src="./ComputerSystem/mov-op-01.jpg" alt="mov-op-01.jpg" /><br />
x86-64 不允许两个操作数都指向内存位置。<br />
</p>

<p>
将较小的源值复制到较大的目的寄存器时使用的数据传送指令：<br />
<img src="./ComputerSystem/mov-op-02.jpg" alt="mov-op-02.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-org872c026" class="outline-6">
<h6 id="org872c026">压入和弹出栈数据</h6>
<div class="outline-text-6" id="text-org872c026">

<div id="org1d8b369" class="figure">
<p><img src="./ComputerSystem/stack-op.jpg" alt="stack-op.jpg" /><br />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org0d72123" class="outline-5">
<h5 id="org0d72123">算数和逻辑操作</h5>
<div class="outline-text-5" id="text-org0d72123">

<div id="orgd6bc82d" class="figure">
<p><img src="./ComputerSystem/alg-logic-opt.jpg" alt="alg-logic-opt.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-orgab9ae42" class="outline-6">
<h6 id="orgab9ae42">leaq</h6>
<div class="outline-text-6" id="text-orgab9ae42">
<p>
leaq 可以加载效地址。另外，配合操作数指示符还可以使用 leaq 简洁地描述普通的算术操作。<br />
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">## &#20551;&#22914;&#23492;&#23384;&#22120;%rdx &#30340;&#20540;&#20026; x&#65292;%rax &#30340;&#20540;&#20026; 7+5x</span>
<span style="color: #bc6ec5; font-weight: bold;">leaq</span> <span style="color: #4f97d7; font-weight: bold;">7</span>(<span style="color: #7590db;">%rdx</span>, <span style="color: #7590db;">%rdx</span>, 4), <span style="color: #7590db;">%rax</span>    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">7 + x + 4x = 7 + 5x</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgafba5be" class="outline-6">
<h6 id="orgafba5be">特殊的算术操作</h6>
<div class="outline-text-6" id="text-orgafba5be">

<div id="org893f464" class="figure">
<p><img src="./ComputerSystem/spec-alg-op.jpg" alt="spec-alg-op.jpg" /><br />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org8b40a3c" class="outline-5">
<h5 id="org8b40a3c">控制</h5>
</div>
<div id="outline-container-org8053dc1" class="outline-5">
<h5 id="org8053dc1">过程</h5>
<div class="outline-text-5" id="text-org8053dc1">
<p>
过程是软件中一种很重要的抽象，它提供了一种封装代码的方式。不同编程语言中，过程的形式多样：函数(function)、方法(method)、子例程(subroutine)、处理函数(handler)等等。<br />
</p>
</div>
<div id="outline-container-orgd54262d" class="outline-6">
<h6 id="orgd54262d">运行时栈</h6>
<div class="outline-text-6" id="text-orgd54262d">
<p>
<img src="./ComputerSystem/stack-frame.jpg" alt="stack-frame.jpg" /><br />
上图给出了运行时栈的通用结构，栈被划分为多个栈帧。当前正在执行的过程的帧总是在栈顶。当过程 P 调用过程 Q 时，会把返回地址压入栈中，指明当 Q 返回时，要从 P 程序的哪个位置继续执行。我们把这个返回地址当作 P 的栈帧的一部分，因为它存放的是与 P 相关的状态。Q的代码会扩展当前栈的边界，分配它的栈帧所需要的空间。在这个空间中，它可以保存寄存器的值，分配局部变量空间，为它调用的过程设置参数。大多数过程的栈帧都是定长的，在过程的开始就分配好了。但是有些过程需要变长的帧（如：TODO）。通过寄存器，过程 P 可以传递最多 6 个整数值，但是如果 Q 需要更多的参数，P可以在调用 Q 之前在自己的栈帧里存储好这些参数。<br />
许多函数根本不需要栈帧。当所有的局部变量都可以保存在寄存器中，而且该函数不会调用任何其他函数时，就可以这样处理。<br />
</p>
</div>
</div>
<div id="outline-container-org7356a10" class="outline-6">
<h6 id="org7356a10">转移控制</h6>
<div class="outline-text-6" id="text-org7356a10">

<div id="org4731938" class="figure">
<p><img src="./ComputerSystem/call-ret-opt.jpg" alt="call-ret-opt.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org069446d" class="outline-6">
<h6 id="org069446d">数据传送</h6>
<div class="outline-text-6" id="text-org069446d">
<p>
<img src="./ComputerSystem/call-func-param-transfer01.jpg" alt="call-func-param-transfer01.jpg" /><br />
如果函数参数大于 6 个整型参数，超出 6 个的部分就要通过栈来传递。假设过程 P 调用过程 Q，有 n 个整型参数，且 n&gt;6。P 的代码分配的栈帧必须要能容纳 7 到 n 号参数的存储空间。要把 1-6 复制到对应的寄存器，把参数 7-n 放到栈上，而参数 7 位于栈顶。通过栈传递参数时，所有数据大小都要向 8 的倍数对齐。<br />
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">func</span>(<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v0</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v1</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v2</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v3</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v4</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v5</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v6</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v7</span>)
{
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v</span> = 10;
    v = v + v0  + v1  + v2  + v3  + v4  + v5  + v6  + v7;
    <span style="color: #4f97d7; font-weight: bold;">return</span> v;
}

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span>()
{
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v</span> = -10;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v0</span> = 0;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v1</span> = 1;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v2</span> = 2;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v3</span> = 3;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v4</span> = 4;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v5</span> = 5;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v6</span> = 6;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v7</span> = 7;
    v += func(v0  , v1  , v2  , v3  , v4  , v5  , v6  , v7);
    <span style="color: #4f97d7; font-weight: bold;">return</span> v;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #bc6ec5; font-weight: bold;">_func</span>:
<span style="color: #bc6ec5; font-weight: bold;">100000f60</span>:  <span style="color: #4f97d7; font-weight: bold;">55</span>  pushq   <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f61</span>:  <span style="color: #4f97d7; font-weight: bold;">48</span> 89 e5    movq    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f64</span>:  <span style="color: #4f97d7; font-weight: bold;">8b</span> 45 18    movl    24(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%eax</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f67</span>:  <span style="color: #4f97d7; font-weight: bold;">01</span> f7   addl    <span style="color: #7590db;">%esi</span>, <span style="color: #7590db;">%edi</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f69</span>:  <span style="color: #4f97d7; font-weight: bold;">01</span> d7   addl    <span style="color: #7590db;">%edx</span>, <span style="color: #7590db;">%edi</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f6b</span>:  <span style="color: #4f97d7; font-weight: bold;">01</span> cf   addl    <span style="color: #7590db;">%ecx</span>, <span style="color: #7590db;">%edi</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f6d</span>:  <span style="color: #4f97d7; font-weight: bold;">44</span> 01 c7    addl    <span style="color: #7590db;">%r8d</span>, <span style="color: #7590db;">%edi</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f70</span>:  <span style="color: #4f97d7; font-weight: bold;">44</span> 01 cf    addl    <span style="color: #7590db;">%r9d</span>, <span style="color: #7590db;">%edi</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f73</span>:  <span style="color: #4f97d7; font-weight: bold;">03</span> 7d 10    addl    16(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%edi</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f76</span>:  <span style="color: #4f97d7; font-weight: bold;">8d</span> 44 38 0a     leal    10(<span style="color: #7590db;">%rax</span>,<span style="color: #7590db;">%rdi</span>), <span style="color: #7590db;">%eax</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f7a</span>:  <span style="color: #4f97d7; font-weight: bold;">5d</span>  popq    <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f7b</span>:  <span style="color: #4f97d7; font-weight: bold;">c3</span>  retq
<span style="color: #bc6ec5; font-weight: bold;">100000f7c</span>:  <span style="color: #4f97d7; font-weight: bold;">0f</span> 1f 40 00     nopl    (<span style="color: #7590db;">%rax</span>)

<span style="color: #bc6ec5; font-weight: bold;">_main</span>:
<span style="color: #bc6ec5; font-weight: bold;">100000f80</span>:  <span style="color: #4f97d7; font-weight: bold;">55</span>  pushq   <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f81</span>:  <span style="color: #4f97d7; font-weight: bold;">48</span> 89 e5    movq    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">100000f84</span>:  <span style="color: #4f97d7; font-weight: bold;">bf</span> 00 00 00 00  movl    $0, <span style="color: #7590db;">%edi</span>                         ## &#21442;&#25968; v0 &#21033;&#29992;&#23492;&#23384;&#22120;&#20256;&#36882;
<span style="color: #bc6ec5; font-weight: bold;">100000f89</span>:  <span style="color: #4f97d7; font-weight: bold;">be</span> 01 00 00 00  movl    $1, <span style="color: #7590db;">%esi</span>                         ## &#21442;&#25968; v1 &#21033;&#29992;&#23492;&#23384;&#22120;&#20256;&#36882;
<span style="color: #bc6ec5; font-weight: bold;">100000f8e</span>:  <span style="color: #4f97d7; font-weight: bold;">ba</span> 02 00 00 00  movl    $2, <span style="color: #7590db;">%edx</span>                         ## &#21442;&#25968; v2 &#21033;&#29992;&#23492;&#23384;&#22120;&#20256;&#36882;
<span style="color: #bc6ec5; font-weight: bold;">100000f93</span>:  <span style="color: #4f97d7; font-weight: bold;">b9</span> 03 00 00 00  movl    $3, <span style="color: #7590db;">%ecx</span>                         ## &#21442;&#25968; v3 &#21033;&#29992;&#23492;&#23384;&#22120;&#20256;&#36882;
<span style="color: #bc6ec5; font-weight: bold;">100000f98</span>:  <span style="color: #4f97d7; font-weight: bold;">41</span> b8 04 00 00 00   movl    $4, <span style="color: #7590db;">%r8d</span>                     ## &#21442;&#25968; v4 &#21033;&#29992;&#23492;&#23384;&#22120;&#20256;&#36882;
<span style="color: #bc6ec5; font-weight: bold;">100000f9e</span>:  <span style="color: #4f97d7; font-weight: bold;">41</span> b9 05 00 00 00   movl    $5, <span style="color: #7590db;">%r9d</span>                     ## &#21442;&#25968; v5 &#21033;&#29992;&#23492;&#23384;&#22120;&#20256;&#36882;
<span style="color: #bc6ec5; font-weight: bold;">100000fa4</span>:  <span style="color: #4f97d7; font-weight: bold;">6a</span> 07   pushq   $7                                       ## &#21442;&#25968; v7 &#25918;&#20837;&#26632;&#20013;
<span style="color: #bc6ec5; font-weight: bold;">100000fa6</span>:  <span style="color: #4f97d7; font-weight: bold;">6a</span> 06   pushq   $6                                       ## &#21442;&#25968; v6 &#25918;&#20837;&#26632;&#20013;, &#22312;&#26632;&#39030;
<span style="color: #bc6ec5; font-weight: bold;">100000fa8</span>:  <span style="color: #4f97d7; font-weight: bold;">e8</span> b3 ff ff ff  callq   -77 &lt;_func&gt;
<span style="color: #bc6ec5; font-weight: bold;">100000fad</span>:  <span style="color: #4f97d7; font-weight: bold;">48</span> 83 c4 10     addq    $16, <span style="color: #7590db;">%rsp</span>
<span style="color: #bc6ec5; font-weight: bold;">100000fb1</span>:  <span style="color: #4f97d7; font-weight: bold;">83</span> c0 f6    addl    $-10, <span style="color: #7590db;">%eax</span>
<span style="color: #bc6ec5; font-weight: bold;">100000fb4</span>:  <span style="color: #4f97d7; font-weight: bold;">5d</span>  popq    <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">100000fb5</span>:  <span style="color: #4f97d7; font-weight: bold;">c3</span>  retq
</pre>
</div>
</div>
</div>
<div id="outline-container-org295d616" class="outline-6">
<h6 id="org295d616">栈上的局部存储</h6>
<div class="outline-text-6" id="text-org295d616">
<p>
大多数简单的过程都不需要超出寄存器大小的本地存储区域。不过有些时候，局部数据必须存放在内存中，常见的情况包括：<br />
</p>
<ul class="org-ul">
<li>寄存器不足够存放所有的本地数据<br /></li>
<li>对一个局部变量使用地址运算符号‘&amp;’， 因此必须能够为它产生一个地址<br /></li>
<li>某些局部变量是数组或结构，因此必须能够通过数组或结构引用被访问到<br /></li>
</ul>

<p>
过程通过减小栈指针在栈上分配空间。<br />
</p>
</div>
</div>
<div id="outline-container-org3c7f354" class="outline-6">
<h6 id="org3c7f354">寄存器中的局部存储空间</h6>
<div class="outline-text-6" id="text-org3c7f354">
<p>
寄存器组是唯一被所有过程共享的资源。虽然在给定时刻只有一个过程时活动的，我们仍然必须确保当一个过程（调用者）调用另一个过程（被调用者）时，被调用者不会覆盖调用者稍后会使用的寄存器值。为此，x86-64 采用了一组统一的寄存器使用惯例，所有的过程都必须遵循。<br />
</p>

<p>
寄存器 %rbx、%rbp 和 %r12~%r15 被划分为被调用者保存寄存器。当过程 P 调用过程 Q 时，Q 必须保存这些寄存器的值，保证他们的值在 Q 返回到 P 时与 Q 被调用时是一样的。过程 Q 保存一个寄存器的值不变，要么就是根本不去改变它，要么就是把原始值压入栈中，改变寄存器的值，然后在返回前从栈中弹出旧值。压入寄存器的值会在栈帧中创建标号为“保存的寄存器”的一部分。<br />
</p>

<p>
所有其他的寄存器，除了栈指针%rsp, 都分类为调用者保存寄存器。这就意味着任何函数都能修改它们。<br />
</p>


<div id="orgc1b77a2" class="figure">
<p><img src="./ComputerSystem/call-func-register.jpg" alt="call-func-register.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org9bde6f7" class="outline-6">
<h6 id="org9bde6f7">递归过程</h6>
<div class="outline-text-6" id="text-org9bde6f7">
<p>
递归调用一个函数与调用其他函数是一样的。每次函数调用都有它自己私有的状态信息(保存的返回位置和被调用者保存寄存器的值)存储空间。如果需要，它还可以提供局部变量的存储。栈分配和释放的规则很自然地就与函数调用和返回的顺序匹配。这种实现函数调用和返回的方法甚至对更复制的情况也适用，包括相互递归调用（例如：过程 P 调用 Q，Q 再调用 P）<br />
<img src="./ComputerSystem/call-func-recursion.jpg" alt="call-func-recursion.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org0a5f964" class="outline-5">
<h5 id="org0a5f964">数组分配和访问</h5>
<div class="outline-text-5" id="text-org0a5f964">
</div>
<div id="outline-container-org24d39ea" class="outline-6">
<h6 id="org24d39ea">指针运算</h6>
<div class="outline-text-6" id="text-org24d39ea">
<p>
假设整型数组 E 的起始地址和整数索引 i 分别存放在寄存器 %rdx 和 %rcx 中，对数组操作的 c 代码，以及对应汇编代码如下：<br />
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">c</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">值</th>
<th scope="col" class="org-left">汇编代码</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">E</td>
<td class="org-left">int*</td>
<td class="org-left">xe</td>
<td class="org-left">movq %rdx,%rax</td>
</tr>

<tr>
<td class="org-left">E[0]</td>
<td class="org-left">int</td>
<td class="org-left">M[xe]</td>
<td class="org-left">movl (%rdx),%rax</td>
</tr>

<tr>
<td class="org-left">E[i]</td>
<td class="org-left">int</td>
<td class="org-left">M[xe+4i]</td>
<td class="org-left">movl (%rdx,%rcx,4),%eax</td>
</tr>

<tr>
<td class="org-left">&amp;E[2]</td>
<td class="org-left">int*</td>
<td class="org-left">xe+8</td>
<td class="org-left">leaq 8(%rdx),%rax</td>
</tr>

<tr>
<td class="org-left">E+i-1</td>
<td class="org-left">int*</td>
<td class="org-left">xe+4i-4</td>
<td class="org-left">leaq -4(%edx,%ecx,4),%eax</td>
</tr>

<tr>
<td class="org-left">*(E+i-3)</td>
<td class="org-left">int*</td>
<td class="org-left">M[xe+4i-12]</td>
<td class="org-left">movl -12(%3dx,%ecx,4),%eax</td>
</tr>

<tr>
<td class="org-left">&amp;E[i]-E</td>
<td class="org-left">int</td>
<td class="org-left">i</td>
<td class="org-left">movl %ecx,%eax</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orga5dc82c" class="outline-6">
<h6 id="orga5dc82c">嵌套数组</h6>
<div class="outline-text-6" id="text-orga5dc82c">

<div id="org33a6597" class="figure">
<p><img src="./ComputerSystem/multi-dim-array.jpg" alt="multi-dim-array.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-orge7f4af8" class="outline-6">
<h6 id="orge7f4af8">定长数组</h6>
<div class="outline-text-6" id="text-orge7f4af8">
<p>
C 语言编译器能够优化定长多维数组上的操作代码。<br />
</p>


<div id="org796cf92" class="figure">
<p><img src="./ComputerSystem/multi-dim-array-optimize.jpg" alt="multi-dim-array-optimize.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgd718a24" class="outline-6">
<h6 id="orgd718a24">变长数组</h6>
<div class="outline-text-6" id="text-orgd718a24">

<div id="orge35b29a" class="figure">
<p><img src="./ComputerSystem/multi-dim-array01.jpg" alt="multi-dim-array01.jpg" /><br />
</p>
</div>

<p>
代码中计算元素 i, j 的地址为 xA + 4(n*i) + 4j。这个地址的计算类似于定长数组的地址计算，不同点在于：<br />
</p>
<ol class="org-ol">
<li>由于增加了参数 n，寄存器的使用变化了；<br /></li>
<li>用了乘法指令来计算 n*i (上图汇编代码第 2 行)，而不能用 leaq 指令来计算。动态的版本必须用乘法指令对 i 伸缩 n 倍，而不能用一些列的移位和加法。<br /></li>
</ol>

<p>
Tips: 在一些处理器中，乘法会招致严重的性能处罚，但是在这种情况中无可避免。<br />
</p>
</div>
</div>
</div>
<div id="outline-container-org93ff0d1" class="outline-5">
<h5 id="org93ff0d1">异质的数据结构</h5>
<div class="outline-text-5" id="text-org93ff0d1">
</div>
<div id="outline-container-org68669f0" class="outline-6">
<h6 id="org68669f0">结构体</h6>
<div class="outline-text-6" id="text-org68669f0">

<div id="org2d9f479" class="figure">
<p><img src="./ComputerSystem/struct-asm.jpg" alt="struct-asm.jpg" /><br />
</p>
</div>

<p>
结构的各个字段的选取完全是在编译时处理的。机器代码不包含关于字段声明或字段名字的信息。<br />
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rec</span>{
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">j</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">a</span>[2];
    <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">p</span>;
};

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rec</span> <span style="color: #7590db;">my_s0</span> = {1,2,{3,4},0};
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rec</span> <span style="color: #7590db;">my_s1</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span>()
{
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rec</span> <span style="color: #7590db;">my_s2</span> = {6,7,8};
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rec</span> <span style="color: #7590db;">my_s3</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">v</span> = my_s0.i + my_s1.j + my_s2.j + my_s3.j;
    my_s2 = (<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rec</span>){1,2,3,4,0};
    v += my_s2.i;
    <span style="color: #4f97d7; font-weight: bold;">return</span> v;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #4f97d7; font-weight: bold;">.section</span>    __TEXT,__text,regular,pure_instructions
    <span style="color: #4f97d7; font-weight: bold;">.macosx_version_min</span> 10, 12
    <span style="color: #4f97d7; font-weight: bold;">.globl</span>  _main
    <span style="color: #4f97d7; font-weight: bold;">.p2align</span>    4, 0x90
<span style="color: #bc6ec5; font-weight: bold;">_main</span>:                                  ## @main
    <span style="color: #4f97d7; font-weight: bold;">pushq</span>   <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi0</span>:
<span style="color: #bc6ec5; font-weight: bold;">Lcfi1</span>:
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi2</span>:                                         <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">### &#25968;&#25454;&#35775;&#38382;&#19982;&#35745;&#31639;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    _my_s1@GOTPCREL(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%rax</span>          <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#20174;&#20840;&#23616;&#20559;&#31227;&#34920;&#65288;GOT&#65289;&#21152;&#36733;`_my_s1`&#30340;&#22320;&#22336;&#21040;&#23492;&#23384;&#22120;`%rax`</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $0, -4(<span style="color: #7590db;">%rbp</span>)                         <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#21021;&#22987;&#21270;&#26632;&#19978;&#30340;&#23616;&#37096;&#21464;&#37327;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    l_main.my_s2(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%rcx</span>             <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#20174;l_main.my_s2 &#21152;&#36733;&#19968;&#20010; 64 &#20301;&#30340;&#20540;&#65292;&#28982;&#21518;&#23558;&#36825;&#20010;&#20540;&#23384;&#20837;&#23492;&#23384;&#22120;%rcx&#20013;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rcx</span>, -32(<span style="color: #7590db;">%rbp</span>)                      <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#21021;&#22987;&#21270;&#26632;&#19978;&#30340;&#23616;&#37096;&#21464;&#37327;&#65288;`my_s2.i &#21644; my_s2.j`&#65289;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    l_main.my_s2+8(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%rcx</span>           <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#20174; l_main.my_s2 &#20301;&#32622;&#20043;&#21518;&#30340; 8 &#23383;&#33410;&#22788;&#21152;&#36733;&#19968;&#20010;64&#20301;&#30340;&#20540;&#65292;&#28982;&#21518;&#23558;&#36825;&#20010;&#20540;&#23384;&#20837;&#23492;&#23384;&#22120;%rcx&#20013;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rcx</span>, -24(<span style="color: #7590db;">%rbp</span>)                      <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#21021;&#22987;&#21270;&#26632;&#19978;&#30340;&#23616;&#37096;&#21464;&#37327;&#65288;`my_s2.a`&#65289;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    l_main.my_s2+16(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%rcx</span>          <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#20174; l_main.my_s2 &#20301;&#32622;&#20043;&#21518;&#30340; 16 &#23383;&#33410;&#22788;&#21152;&#36733;&#19968;&#20010;64&#20301;&#30340;&#20540;&#65292;&#28982;&#21518;&#23558;&#36825;&#20010;&#20540;&#23384;&#20837;&#23492;&#23384;&#22120;%rcx&#20013;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rcx</span>, -16(<span style="color: #7590db;">%rbp</span>)                      <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#21021;&#22987;&#21270;&#26632;&#19978;&#30340;&#23616;&#37096;&#21464;&#37327;&#65288;`my_s2.p`&#65289;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    _my_s0(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%edx</span>                   <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">my_s0.i -&gt; %edx</span>
    <span style="color: #4f97d7; font-weight: bold;">addl</span>    4(<span style="color: #7590db;">%rax</span>), <span style="color: #7590db;">%edx</span>                        <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">my_s1.j + my_s0.i  -&gt; %edx</span>
    <span style="color: #4f97d7; font-weight: bold;">addl</span>    -28(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%edx</span>                      <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">my_s2.j + (my_s1.j + my_s0.i) -&gt; %edx</span>
    <span style="color: #4f97d7; font-weight: bold;">addl</span>    -52(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%edx</span>                      <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">my_s3.j + (my_s2.j + my_s1.j + my_s0.i) -&gt; %edx  TIPS: my_s3 &#20026;&#26410;&#21021;&#22987;&#21270;&#30340;&#32467;&#26500;&#20307;&#23616;&#37096;&#21464;&#37327;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%edx</span>, -60(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $1, -88(<span style="color: #7590db;">%rbp</span>)                        <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#21021;&#22987;&#21270;&#20020;&#26102;&#32467;&#26500;&#20307;&#21464;&#37327; -- &#24320;&#22987;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $2, -84(<span style="color: #7590db;">%rbp</span>)                        <span style="color: #2aa1ae; background-color: #292e34;">;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $3, -80(<span style="color: #7590db;">%rbp</span>)                        <span style="color: #2aa1ae; background-color: #292e34;">;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $4, -76(<span style="color: #7590db;">%rbp</span>)                        <span style="color: #2aa1ae; background-color: #292e34;">;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    $0, -72(<span style="color: #7590db;">%rbp</span>)                        <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">-- &#21021;&#22987;&#21270;&#32467;&#26463;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -88(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>                      <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#23558;&#20020;&#26102;&#32467;&#26500;&#20307;&#21464;&#37327;&#36171;&#20540;&#32473; my_s2 -- &#24320;&#22987;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rax</span>, -32(<span style="color: #7590db;">%rbp</span>)                      <span style="color: #2aa1ae; background-color: #292e34;">;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -80(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>                      <span style="color: #2aa1ae; background-color: #292e34;">;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rax</span>, -24(<span style="color: #7590db;">%rbp</span>)                      <span style="color: #2aa1ae; background-color: #292e34;">;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -72(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>                      <span style="color: #2aa1ae; background-color: #292e34;">;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rax</span>, -16(<span style="color: #7590db;">%rbp</span>)                      <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">-- &#36171;&#20540;&#32467;&#26463;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    -32(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%edx</span>                      <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">my_s2.i -&gt; %edx</span>
    <span style="color: #4f97d7; font-weight: bold;">addl</span>    -60(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%edx</span>                      <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">v + my_s2.i -&gt; %edx</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%edx</span>, -60(<span style="color: #7590db;">%rbp</span>)                      <span style="color: #2aa1ae; background-color: #292e34;">;</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    -60(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%eax</span>                      <span style="color: #2aa1ae; background-color: #292e34;">;</span>
    <span style="color: #4f97d7; font-weight: bold;">popq</span>    <span style="color: #7590db;">%rbp</span>
    <span style="color: #4f97d7; font-weight: bold;">retq</span>

  <span style="color: #4f97d7; font-weight: bold;">.section</span>  __DATA,__data                    <span style="color: #2aa1ae; background-color: #292e34;">;</span><span style="color: #2aa1ae; background-color: #292e34;">### &#25968;&#25454;&#27573;&#23450;&#20041;</span>
    <span style="color: #4f97d7; font-weight: bold;">.globl</span>  _my_s0                  ## @my_s0
    <span style="color: #4f97d7; font-weight: bold;">.p2align</span>    3
<span style="color: #bc6ec5; font-weight: bold;">_my_s0</span>:                                        <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">_my_s0` &#26159;&#19968;&#20010;&#20840;&#23616;&#21464;&#37327;&#65292;&#21253;&#21547;&#22235;&#20010;32&#20301;&#25972;&#25968;(1, 2, 3, 4)&#21644;&#19968;&#20010;64&#20301;&#25972;&#25968;(0)&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">.long</span>   1                       ## 0x1
    <span style="color: #4f97d7; font-weight: bold;">.long</span>   2                       ## 0x2
    <span style="color: #4f97d7; font-weight: bold;">.long</span>   3                       ## 0x3
    <span style="color: #4f97d7; font-weight: bold;">.long</span>   4                       ## 0x4
    <span style="color: #4f97d7; font-weight: bold;">.quad</span>   0

    <span style="color: #4f97d7; font-weight: bold;">.section</span>    __TEXT,__const                   <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#23450;&#20041;&#21482;&#35835;&#25968;&#25454;&#27573;&#12290;</span>
    <span style="color: #4f97d7; font-weight: bold;">.p2align</span>    3               ## @main.my_s2
<span style="color: #bc6ec5; font-weight: bold;">l_main</span>.my_s2:                                  <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">l_main.my_s2` &#26159;&#19968;&#20010;&#38745;&#24577;&#23384;&#20648;&#21306;&#20013;&#30340;&#21464;&#37327;, &#21253;&#21547;&#22235;&#20010;32&#20301;&#25972;&#25968;(6, 7, 8, 0)&#21644;&#19968;&#20010;64&#20301;&#25972;&#25968;(0)</span>
    <span style="color: #4f97d7; font-weight: bold;">.long</span>   6                       ## 0x6
    <span style="color: #4f97d7; font-weight: bold;">.long</span>   7                       ## 0x7
    <span style="color: #4f97d7; font-weight: bold;">.long</span>   8                       ## 0x8
    <span style="color: #4f97d7; font-weight: bold;">.long</span>   0                       ## 0x0
    <span style="color: #4f97d7; font-weight: bold;">.quad</span>   0
                                               <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#23450;&#20041;&#26410;&#21021;&#22987;&#21270;&#30340;&#25968;&#25454;&#27573;&#65288;BSS&#65289;</span>
    <span style="color: #4f97d7; font-weight: bold;">.comm</span>   _my_s1,24,3             ## @my_s1    <span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">&#23450;&#20041;&#19968;&#20010;&#21517;&#20026;`_my_s1`&#30340;&#26410;&#21021;&#22987;&#21270;&#20840;&#23616;&#21464;&#37327;&#65292;&#22823;&#23567;&#20026; 24 &#23383;&#33410;&#65292;&#23545;&#40784;&#21333;&#20301;&#20026; 3 &#23383;&#33410;&#12290;</span>
</pre>
</div>

<p>
初始化的结构体全局变量（_my_s0）会被放到数据段<br />
未初始化的结构体全局变量（_my_s1）会被放到 bss 数据段<br />
初始化的结构体局部变量（_my_s2）会被放到只读数据段<br />
未初始化的结构体局部变量（_my_s3）只会在栈上分配内存,<br />
</p>
</div>
</div>

<div id="outline-container-org32ad623" class="outline-6">
<h6 id="org32ad623">Union</h6>
<div class="outline-text-6" id="text-org32ad623">

<div id="orge5857cf" class="figure">
<p><img src="./ComputerSystem/struct-union-layout.jpg" alt="struct-union-layout.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org890b384" class="outline-6">
<h6 id="org890b384">数据对齐</h6>
<div class="outline-text-6" id="text-org890b384">
<p>
无论数据是否对齐，x86-64 硬件都能正确工作。但是，对齐数据可以提高内存系统的性能。对齐原则是任何 K 字节的基本对象的地址必须是 K 的倍数。<br />
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">K</th>
<th scope="col" class="org-left">类型</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">char</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">short</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">int,float</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">long,double,char*</td>
</tr>
</tbody>
</table>

<p>
结构体中每个元素都需要满足自己的对齐要求。如下面结构体中为了保证元素 d 数据对齐，在元素 c 后填充 7 个空字节<br />
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">S1</span>
{
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20559;&#31227; 0&#65292;&#25353;1&#23383;&#33410;&#23545;&#40784;&#65292;c&#21518;&#22635;&#20805;7&#20010;&#31354;&#23383;&#33410;</span>
    <span style="color: #ce537a; font-weight: bold;">double</span> <span style="color: #7590db;">d</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20559;&#31227;8&#65292;&#25353;8&#23383;&#33410;&#23545;&#40784;</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20559;&#31227;16&#65292;&#25353;4&#23383;&#33410;&#23545;&#40784;</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c1</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20559;&#31227;20&#65292;&#25353;1&#23383;&#33410;&#23545;&#40784;</span>
}
</pre>
</div>

<p>
编译器会在 struct 的末尾填充一些空字节，这样 struct 数组中的每个元素都可以满足对齐要求。<br />
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">S2</span>
{
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20559;&#31227; 0&#65292;&#25353;1&#23383;&#33410;&#23545;&#40784;&#65292;c&#21518;&#22635;&#20805;7&#20010;&#31354;&#23383;&#33410;</span>
    <span style="color: #ce537a; font-weight: bold;">double</span> <span style="color: #7590db;">d</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20559;&#31227;8&#65292;&#25353;8&#23383;&#33410;&#23545;&#40784;</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c1</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20559;&#31227;16&#65292;&#25353;1&#23545;&#40784;&#65292;c&#21518;&#22635;&#20805;7&#20010;&#31354;&#23383;&#33410;&#65292;&#32467;&#26500;&#20307;&#25972;&#20307;&#25353;&#29031;24&#23383;&#33410;&#23545;&#40784;</span>
}
</pre>
</div>
<p>
Tips:<br />
数据没对齐时，某些型号的 Intel 和 AMD 处理器对于有些实现多媒体操作的 SSE 指令（Stream SIMD Extensions），无法正确执行。这些指令对 16 字节数据块进行操作，在 SSE 单元和内存之间传送数据的指令要求内存地址必须是 16 的倍数。<br />
</p>

<p>
c++11 中的 alignof 关键字可用于得到一个类型的对齐大小。<br />
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">S3</span>
{
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c</span>;
    <span style="color: #ce537a; font-weight: bold;">double</span> <span style="color: #7590db;">d</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">c1</span>;
}
<span style="color: #7590db;">printf</span>(<span style="color: #2d9574;">"S3 alignment = %d\n"</span>, <span style="color: #4f97d7; font-weight: bold;">alignof</span>(A));
</pre>
</div>

<ul class="org-ul">
<li>结构体成员内存对齐问题 <a href="https://imzlp.com/posts/61962/">https://imzlp.com/posts/61962/</a><br /></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9a22283" class="outline-5">
<h5 id="org9a22283">在机器级程序中将控制与数据结合起来</h5>
<div class="outline-text-5" id="text-org9a22283">
</div>
<div id="outline-container-org79e0c56" class="outline-6">
<h6 id="org79e0c56">理解指针</h6>
<div class="outline-text-6" id="text-org79e0c56">
<p>
指针和它们映射到机器代码的关键原则：<br />
</p>
<ul class="org-ul">
<li>每个指针都对应一个类型。这个类型表明该指针指向的是哪一类对象。指针类型不是机器代码的一部分，它们是 C 语言提供的一种抽象，帮助避免寻址错误。<br />
int* ip;<br />
char** <b>*cpp;<br />
void</b> 类型代表通用指针;<br /></li>
<li>每个指针都有一个值。这个值是某个指定类型的对象的地址。特殊的 NULL 值表示该指针没有指向任何地方。<br /></li>
<li>指针用 &amp; 运算符创建。<br /></li>
<li>* 操作符用于间接引用指针。<br /></li>
<li>数组与指针紧密联系。<br /></li>
<li>将指针从一种类型强制转换为另一种类型，只改变它的类型，而不改变它的值。<br /></li>
<li>指针也可以指向函数。<br /></li>
</ul>
</div>
</div>
<div id="outline-container-orgbdcc904" class="outline-6">
<h6 id="orgbdcc904">内存越界引用和缓冲器溢出</h6>
<div class="outline-text-6" id="text-orgbdcc904">
<p>
C 对于数组引用不进行任何边界检查，而且局部变量和状态信息（例如：保存的寄存器值和返回地址）都存放在栈中。这两种情况结合到一起就能导致严重的程序错误，对越界的数组元素的写操作会破坏存储在栈中的状态信息。当程序使用这个被破坏的状态，试图重新加载寄存器或执行 ret 指令时，就会出现很严重的错误。<br />
</p>

<p>
一种特别常见的状态破坏称为缓冲区溢出（buffer overflow）。下面代码就有该问题：<br />
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">&lt;stdio.h&gt;</span>

<span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #bc6ec5; font-weight: bold;">my_gets</span>(<span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">s</span>)
{
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">dest</span> = s;
    <span style="color: #4f97d7; font-weight: bold;">while</span>((c = getchar()) != <span style="color: #2d9574;">'\n'</span> &amp;&amp; c!= EOF)
        *dest++ = c;                  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">buf &#22823;&#23567;&#21482;&#26377;8&#20010;&#23383;&#31526;&#65292;&#36234;&#30028;&#20250;&#23548;&#33268;&#32531;&#20914;&#22120;&#28322;&#20986;</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span>(c == EOF &amp;&amp; dest==s)
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    *dest++ = <span style="color: #2d9574;">'\0'</span>;                   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">buf &#22823;&#23567;&#21482;&#26377;8&#20010;&#23383;&#31526;&#65292;&#36234;&#30028;&#20250;&#23548;&#33268;&#32531;&#20914;&#22120;&#28322;&#20986;</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> s;
}

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">test_overflow</span>()
{
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span>[8];
    my_gets(buf);
    printf(<span style="color: #2d9574;">"buf = %s \n"</span>, buf);
}

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span>()
{
    test_overflow();
    <span style="color: #4f97d7; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
不幸的是，很多常用的库函数，包括 strcpy, strcat 和 sprintf 都有一个属性，不需要告诉它们目标缓冲区的大小，就产生一个字节序列。这样的情况就会导致缓冲区溢出漏洞。<br />
</p>

<p>
缓冲区溢出的一个更加致命的使用就是让程序执行它本来不愿意执行的函数。这是一种最常见的通过计算机网络攻击系统安全的方法。通常，输入给程序一个字符串，这个字符串包含一些可执行代码的字节编码，称为攻击代码，另外，还有一些字节会用一个指向攻击代码的指针覆盖返回地址。那么，执行 ret 指令的效果就是跳转到攻击代码。<br />
</p>
</div>
</div>
<div id="outline-container-org1c9a753" class="outline-6">
<h6 id="org1c9a753">对抗缓冲区溢出攻击</h6>
<div class="outline-text-6" id="text-org1c9a753">
</div>
<ul class="org-ul">
<li><a id="orga1c13ff"></a>栈随机化<br />
<div class="outline-text-7" id="text-orga1c13ff">
<p>
栈随机化的思想使得栈的位置在程序每次运行时都有变化。因此，即使许多机器都运行同样的代码，它们的栈地址都是不同的。实现的方式是：程序开始时，在栈上分配一段 0-n 字节之间的随机大小的空间。程序不使用这段空间，但是它会导致程序每次执行时后续的栈位置发生了变化。<br />
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">&lt;stdio.h&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span>()
{
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">local</span>;
    printf(<span style="color: #2d9574;">"local at %p\n"</span>, &amp;local);
    <span style="color: #4f97d7; font-weight: bold;">return</span> 0;
}

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22810;&#27425;&#25191;&#34892;&#65292;&#24471;&#21040;&#19981;&#21516;&#30340;&#22320;&#22336;</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">local at 0x7fff5a0559b0</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">local at 0x7fff5b3cf9b0</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">local at 0x7fff52ea59b0</span>
</pre>
</div>

<p>
栈随机化是更大的一类技术中的一种，这类技术称为地址空间布局随机化（Address-Space Layout Randomization）,或者简称 ASLR。采用 ASLR，每次运行时程序的不同部分，包括程序代码、库代码、栈、全局变量和堆数据，都会被加载到内存的不同区域。<br />
</p>

<p>
但是，还是能够用蛮力克服随机化，可以反复地用不同的地址进行攻击。一种常见的把戏就是在实际的攻击代码前插入很长一段的 nop 指令 (no operation) 。执行这种指令除了对程序计数器加 1，使之指向下一条指令之外，没有任何的效果。只要攻击者能够猜中这段序列中的某个地址，程序就会经过这个序列，到达攻击代码。这个序列常用的术语是“空操作雪橇(nop sled)”, 意思是程序会“滑过”这个序列。<br />
</p>
</div>
</li>
<li><a id="orgb156a1d"></a>栈破坏检测<br />
<div class="outline-text-7" id="text-orgb156a1d">
<p>
最近的 GCC 版本在产生的代码中加入了一种 stack protector 机制。其在栈帧中任何局部缓冲区与栈状态之间存储一个特殊的 canary value(金丝雀值)，也称为 guard value(哨兵值), 该值是程序每次运行时随机产生的，攻击者没有简单的办法能够知道它是什么。在恢复寄存器状态和从函数返回之前，程序检查这个金丝雀值是否被该函数的某个操作或者函数调用的某个函数的某个操作改变了。如果是，则程序异常中止。<br />
</p>

<p>
使用下面代码可以使 gcc 强制不使用栈保护者:<br />
</p>
<div class="org-src-container">
<pre class="src src-shell">gcc -fno-stack-protector -Og test_overflow.c -o test_overflow
</pre>
</div>

<p>
栈保护很好地防止了缓冲区溢出攻击破坏存储在程序栈上的状态。它只会带来很小的性能损失，特别是因为 GCC 只在函数中有局部 char 类型缓冲区的时候才插入这样的代码。<br />
</p>
</div>
</li>
<li><a id="org0c94374"></a>限制可执行代码区域<br />
<div class="outline-text-7" id="text-org0c94374">
<p>
一种方法是限制哪些内存区域能够存放可执行代码。在典型的程序中，只有保存编译器产生的代码的那部分内存才需要是可执行的。其他部分可以被限制为只允许读和写的。<br />
</p>

<p>
以前，x86 体系结构将读和执行访问控制合并成一个 l 位的标志，这样任何被标记为可读的页也都是可执行的。最近，AMD 为它的 64 位处理器的内存保护引入了“NX”位(No-Execute 位)，将读和执行访问模式分开，Intel 也跟进了。有了这个特性，栈可以被标记为可读和可写，但是不可执行，而检查页是否可执行由硬件来完成，效率上没有损失。<br />
</p>

<p>
有些类型的程序要求动态产生和执行代码的能力。例如，JIT 编译技术位解释语言（如 Java）编写的程序动态地产生代码，以提高执行性能。是否能够将可执行代码限制在由编译器在创建原始程序时产生的那个部分中，取决于语言和操作系统。<br />
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org2f6d7f5" class="outline-6">
<h6 id="org2f6d7f5">支持变长栈帧</h6>
<div class="outline-text-6" id="text-org2f6d7f5">
<p>
当函数调用 alloca 时，可以在栈上分配任意字节数量的存储。当代码声明一个局部变长数组时，也会需要在栈上分配任意字节数量的存储。<br />
</p>

<p>
下面代码给出了一个包含变长数组的例子。<br />
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">&lt;stdio.h&gt;</span>

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">vframe</span>(<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">n</span>, <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">idx</span>, <span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #7590db;">q</span>)
{
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">i</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #7590db;">p</span>[n];
    p[0] = &amp;i;
    <span style="color: #4f97d7; font-weight: bold;">for</span> (i = 1; i &lt; n; i++)
        p[i] = q;
    <span style="color: #4f97d7; font-weight: bold;">return</span> *p[idx];
}

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span>()
{
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">local</span> = 3;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">ret</span> = vframe(9, 2, &amp;local);
    printf(<span style="color: #2d9574;">"ret0 = %lx"</span>, ret);
    ret = vframe(10, 2, &amp;local);
    printf(<span style="color: #2d9574;">"ret1 = %lx"</span>, ret);
    <span style="color: #4f97d7; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #4f97d7; font-weight: bold;">.section</span>    __TEXT,__text,regular,pure_instructions
    <span style="color: #4f97d7; font-weight: bold;">.macosx_version_min</span> 10, 12
    <span style="color: #4f97d7; font-weight: bold;">.globl</span>  _vframe
    <span style="color: #4f97d7; font-weight: bold;">.p2align</span>    4, 0x90
<span style="color: #bc6ec5; font-weight: bold;">_vframe</span>:                                ## @vframe
    <span style="color: #4f97d7; font-weight: bold;">pushq</span>   <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi0</span>:
<span style="color: #bc6ec5; font-weight: bold;">Lcfi1</span>:
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi2</span>:
    <span style="color: #4f97d7; font-weight: bold;">subq</span>    $48, <span style="color: #7590db;">%rsp</span>
    <span style="color: #4f97d7; font-weight: bold;">leaq</span>    -32(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>
                                     <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">vframe param n</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rdi</span>, -8(<span style="color: #7590db;">%rbp</span>)             <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">n -&gt; -8(%rbp)</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsi</span>, -16(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rdx</span>, -24(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -8(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rdx</span>             <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">n -&gt; %rdx</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rsi</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsi</span>, -40(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">leaq</span>    15(,<span style="color: #7590db;">%rdx</span>,8), <span style="color: #7590db;">%rdx</span>          <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">15+n*8 -&gt; %rdx</span>
    <span style="color: #4f97d7; font-weight: bold;">andq</span>    $-16, <span style="color: #7590db;">%rdx</span>                 <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">-16+15+n*8 = -1+n*8 -&gt; %rdx</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rsi</span>                 <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">%rsp -&gt; %rsi</span>
    <span style="color: #4f97d7; font-weight: bold;">subq</span>    <span style="color: #7590db;">%rdx</span>, <span style="color: #7590db;">%rsi</span>                 <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">(-1+n*8)-%rsp        &#35745;&#31639;&#20998;&#37197;long* p[n] &#21518;&#26632;&#25351;&#38024; %rsp&#24212;&#35813;&#20026;&#22810;&#23569;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsi</span>, <span style="color: #7590db;">%rsp</span>                 <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">-1+n*8-%rsp -&gt; %rsp  &#20026; %rsp&#36171;&#20540;&#65292;&#23436;&#25104; long* p[n] &#20869;&#23384;&#31354;&#38388;&#30340;&#20998;&#37197;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rax</span>, (<span style="color: #7590db;">%rsi</span>)
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    $1, -32(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsi</span>, -48(<span style="color: #7590db;">%rbp</span>)         ## 8-byte Spill
<span style="color: #bc6ec5; font-weight: bold;">LBB0_1</span>:                                 ## =&gt;This Inner Loop Header: Depth=1
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -32(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>
    <span style="color: #4f97d7; font-weight: bold;">cmpq</span>    -8(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>
    <span style="color: #4f97d7; font-weight: bold;">jge</span> LBB0_4
## BB#2:                                ##   in Loop: Header=BB0_1 Depth=1
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -24(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -32(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rcx</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -48(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rdx</span>         ## 8-byte Reload
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rax</span>, (<span style="color: #7590db;">%rdx</span>,<span style="color: #7590db;">%rcx</span>,8)
## BB#3:                                ##   in Loop: Header=BB0_1 Depth=1
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -32(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>
    <span style="color: #4f97d7; font-weight: bold;">addq</span>    $1, <span style="color: #7590db;">%rax</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rax</span>, -32(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">jmp</span> LBB0_1
<span style="color: #bc6ec5; font-weight: bold;">LBB0_4</span>:
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -16(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -48(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rcx</span>         ## 8-byte Reload
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    (<span style="color: #7590db;">%rcx</span>,<span style="color: #7590db;">%rax</span>,8), <span style="color: #7590db;">%rax</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    (<span style="color: #7590db;">%rax</span>), <span style="color: #7590db;">%rax</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -40(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rdx</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rdx</span>, <span style="color: #7590db;">%rsp</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rbp</span>, <span style="color: #7590db;">%rsp</span>
    <span style="color: #4f97d7; font-weight: bold;">popq</span>    <span style="color: #7590db;">%rbp</span>
    <span style="color: #4f97d7; font-weight: bold;">retq</span>

    <span style="color: #4f97d7; font-weight: bold;">.globl</span>  _main
    <span style="color: #4f97d7; font-weight: bold;">.p2align</span>    4, 0x90
<span style="color: #bc6ec5; font-weight: bold;">_main</span>:                                  ## @main
    <span style="color: #4f97d7; font-weight: bold;">pushq</span>   <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi3</span>:
<span style="color: #bc6ec5; font-weight: bold;">Lcfi4</span>:
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi5</span>:
    <span style="color: #4f97d7; font-weight: bold;">subq</span>    $32, <span style="color: #7590db;">%rsp</span>
                                                     <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">vframe0(9, 2, &amp;local)</span>
                                                     <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">vframe1(10, 2, &amp;local)</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $9, <span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%eax</span>, <span style="color: #7590db;">%edi</span>                                 <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">vframe0-param-9 ($9-&gt;%eax)-&gt;%edi</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $2, <span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%eax</span>, <span style="color: #7590db;">%esi</span>                                 <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">vframe0-param-2  ($2-&gt;%eax)-&gt;%esi</span>
    <span style="color: #4f97d7; font-weight: bold;">leaq</span>    -16(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rdx</span>                            <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">&amp;local -&gt; %rdx</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $0, -4(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    $3, -16(<span style="color: #7590db;">%rbp</span>)                              <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">local -&gt; -16(%rbp)</span>
    <span style="color: #4f97d7; font-weight: bold;">callq</span>   _vframe                                    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">call vframe0</span>
    <span style="color: #4f97d7; font-weight: bold;">leaq</span>    L_.str(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%rdi</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rax</span>, -24(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -24(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rsi</span>
    <span style="color: #4f97d7; font-weight: bold;">movb</span>    $0, <span style="color: #7590db;">%al</span>
    <span style="color: #4f97d7; font-weight: bold;">callq</span>   _printf
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $10, <span style="color: #7590db;">%ecx</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%ecx</span>, <span style="color: #7590db;">%edi</span>                                 <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">vframe1-param-10 ($10-&gt;%ecx)-&gt;%edi</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $2, <span style="color: #7590db;">%ecx</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%ecx</span>, <span style="color: #7590db;">%esi</span>                                 <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">vframe1-param-2 ($2-&gt;%ecx)-&gt;%esi</span>
    <span style="color: #4f97d7; font-weight: bold;">leaq</span>    -16(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rdx</span>                            <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">&amp;local -&gt; %rdx</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%eax</span>, -28(<span style="color: #7590db;">%rbp</span>)         ## 4-byte Spill
    <span style="color: #4f97d7; font-weight: bold;">callq</span>   _vframe                                    <span style="color: #2aa1ae; background-color: #292e34;">;; </span><span style="color: #2aa1ae; background-color: #292e34;">call vframe1</span>
    <span style="color: #4f97d7; font-weight: bold;">leaq</span>    L_.str.1(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%rdi</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rax</span>, -24(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -24(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rsi</span>
    <span style="color: #4f97d7; font-weight: bold;">movb</span>    $0, <span style="color: #7590db;">%al</span>
    <span style="color: #4f97d7; font-weight: bold;">callq</span>   _printf
    <span style="color: #4f97d7; font-weight: bold;">xorl</span>    <span style="color: #7590db;">%ecx</span>, <span style="color: #7590db;">%ecx</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%eax</span>, -32(<span style="color: #7590db;">%rbp</span>)         ## 4-byte Spill
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%ecx</span>, <span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">addq</span>    $32, <span style="color: #7590db;">%rsp</span>
    <span style="color: #4f97d7; font-weight: bold;">popq</span>    <span style="color: #7590db;">%rbp</span>
    <span style="color: #4f97d7; font-weight: bold;">retq</span>

    <span style="color: #4f97d7; font-weight: bold;">.section</span>    __TEXT,__cstring,cstring_literals
<span style="color: #bc6ec5; font-weight: bold;">L</span>_.str:                                 ## @.str
    <span style="color: #4f97d7; font-weight: bold;">.asciz</span>  <span style="color: #2d9574;">"ret0 = %lx"</span>

<span style="color: #bc6ec5; font-weight: bold;">L</span>_.str.1:                               ## @.str.1
    <span style="color: #4f97d7; font-weight: bold;">.asciz</span>  <span style="color: #2d9574;">"ret1 = %lx"</span>
</pre>
</div>
<p>
下面代码给出一个 alloca 的例子：<br />
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">&lt;stdio.h&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">&lt;stdlib.h&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">get_v</span>(<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">idx</span>)
{
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">alloca &#26159;&#22312;&#26632;&#19978;&#20998;&#37197;&#31354;&#38388;&#65292;&#19981;&#38656;&#35201;&#25163;&#21160;&#37322;&#25918;</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>* <span style="color: #7590db;">p</span> = (<span style="color: #ce537a; font-weight: bold;">int</span>*)alloca(<span style="color: #4f97d7; font-weight: bold;">sizeof</span>(<span style="color: #ce537a; font-weight: bold;">int</span>)*n);
    <span style="color: #4f97d7; font-weight: bold;">for</span>(<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>=0; i&lt;n; i++)
    {
        p[i] = i;
    }
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span> = p[idx];
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">free(p); //&#19981;&#33021;&#29992;free()&#21435;&#37322;&#25918;&#65292;&#20250;&#23548;&#33268;&#38169;&#35823;</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
}

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span>()
{
    printf(<span style="color: #2d9574;">"ret = %d"</span>, get_v(9, 8));
    <span style="color: #4f97d7; font-weight: bold;">return</span> 0;
}
</pre>
</div>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #4f97d7; font-weight: bold;">.section</span>    __TEXT,__text,regular,pure_instructions
    <span style="color: #4f97d7; font-weight: bold;">.macosx_version_min</span> 10, 12
    <span style="color: #4f97d7; font-weight: bold;">.globl</span>  _get_v
    <span style="color: #4f97d7; font-weight: bold;">.p2align</span>    4, 0x90
<span style="color: #bc6ec5; font-weight: bold;">_get_v</span>:                                 ## @get_v
  <span style="color: #4f97d7; font-weight: bold;">movl</span>  $9, <span style="color: #7590db;">%edi</span>                 <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">get_v-param-n</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $8, <span style="color: #7590db;">%esi</span>                 <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">get_v-param-idx</span>
    
    <span style="color: #4f97d7; font-weight: bold;">pushq</span>   <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi0</span>:
<span style="color: #bc6ec5; font-weight: bold;">Lcfi1</span>:
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi2</span>:
    <span style="color: #4f97d7; font-weight: bold;">subq</span>    $32, <span style="color: #7590db;">%rsp</span>
                                      <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">get_v(n, idx)</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%edi</span>, -4(<span style="color: #7590db;">%rbp</span>)              <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">n   -&gt; -4(%rbp)</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%esi</span>, -8(<span style="color: #7590db;">%rbp</span>)              <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">idx -&gt; -8(%rbp)</span>
    <span style="color: #4f97d7; font-weight: bold;">movslq</span>  -4(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>              <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">n   -&gt; %rax</span>
    <span style="color: #4f97d7; font-weight: bold;">leaq</span>    15(,<span style="color: #7590db;">%rax</span>,4), <span style="color: #7590db;">%rax</span>           <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">15+n*4 -&gt; %rax</span>
    <span style="color: #4f97d7; font-weight: bold;">andq</span>    $-16, <span style="color: #7590db;">%rax</span>                  <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">-16+15+n*4=-1+n*4 -&gt; %rax</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rcx</span>                  <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">rsp -&gt; rcx</span>
    <span style="color: #4f97d7; font-weight: bold;">subq</span>    <span style="color: #7590db;">%rax</span>, <span style="color: #7590db;">%rcx</span>                  <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">-1+n*4-%rsp &#35745;&#31639;&#20998;&#37197; alloca(sizeof(int)*n) &#21518;&#26632;&#25351;&#38024; %rsp&#24212;&#35813;&#20026;&#22810;&#23569;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rcx</span>, <span style="color: #7590db;">%rsp</span>                  <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">-1+n*4-%rsp -&gt; rsp &#20026; %rsp&#36171;&#20540;&#65292;&#23436;&#25104; alloca(sizeof(int)*n) &#20869;&#23384;&#31354;&#38388;&#30340;&#20998;&#37197;</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rcx</span>, -16(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $0, -20(<span style="color: #7590db;">%rbp</span>)
<span style="color: #bc6ec5; font-weight: bold;">LBB0_1</span>:                                 ## =&gt;This Inner Loop Header: Depth=1
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    -20(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">cmpl</span>    -4(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">jge</span> LBB0_4
## BB#2:                                ##   in Loop: Header=BB0_1 Depth=1
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    -20(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -16(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rcx</span>
    <span style="color: #4f97d7; font-weight: bold;">movslq</span>  -20(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rdx</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%eax</span>, (<span style="color: #7590db;">%rcx</span>,<span style="color: #7590db;">%rdx</span>,4)
## BB#3:                                ##   in Loop: Header=BB0_1 Depth=1
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    -20(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">addl</span>    $1, <span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%eax</span>, -20(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">jmp</span> LBB0_1
<span style="color: #bc6ec5; font-weight: bold;">LBB0_4</span>:
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    -16(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rax</span>
    <span style="color: #4f97d7; font-weight: bold;">movslq</span>  -8(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%rcx</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    (<span style="color: #7590db;">%rax</span>,<span style="color: #7590db;">%rcx</span>,4), <span style="color: #7590db;">%edx</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%edx</span>, -24(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    -24(<span style="color: #7590db;">%rbp</span>), <span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rbp</span>, <span style="color: #7590db;">%rsp</span>
    <span style="color: #4f97d7; font-weight: bold;">popq</span>    <span style="color: #7590db;">%rbp</span>
    <span style="color: #4f97d7; font-weight: bold;">retq</span>
    <span style="color: #4f97d7; font-weight: bold;">.cfi_endproc</span>

    <span style="color: #4f97d7; font-weight: bold;">.globl</span>  _main
    <span style="color: #4f97d7; font-weight: bold;">.p2align</span>    4, 0x90
<span style="color: #bc6ec5; font-weight: bold;">_main</span>:                                  ## @main
    <span style="color: #4f97d7; font-weight: bold;">pushq</span>   <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi3</span>:
<span style="color: #bc6ec5; font-weight: bold;">Lcfi4</span>:
    <span style="color: #4f97d7; font-weight: bold;">movq</span>    <span style="color: #7590db;">%rsp</span>, <span style="color: #7590db;">%rbp</span>
<span style="color: #bc6ec5; font-weight: bold;">Lcfi5</span>:
    <span style="color: #4f97d7; font-weight: bold;">subq</span>    $16, <span style="color: #7590db;">%rsp</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $9, <span style="color: #7590db;">%edi</span>                 <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">get_v-param-n</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $8, <span style="color: #7590db;">%esi</span>                 <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">get_v-param-idx</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    $0, -4(<span style="color: #7590db;">%rbp</span>)
    <span style="color: #4f97d7; font-weight: bold;">callq</span>   _get_v                   <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">get_v(9, 8)</span>
    <span style="color: #4f97d7; font-weight: bold;">leaq</span>    L_.str(<span style="color: #7590db;">%rip</span>), <span style="color: #7590db;">%rdi</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%eax</span>, <span style="color: #7590db;">%esi</span>
    <span style="color: #4f97d7; font-weight: bold;">movb</span>    $0, <span style="color: #7590db;">%al</span>
    <span style="color: #4f97d7; font-weight: bold;">callq</span>   _printf
    <span style="color: #4f97d7; font-weight: bold;">xorl</span>    <span style="color: #7590db;">%esi</span>, <span style="color: #7590db;">%esi</span>
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%eax</span>, -8(<span style="color: #7590db;">%rbp</span>)          ## 4-byte Spill
    <span style="color: #4f97d7; font-weight: bold;">movl</span>    <span style="color: #7590db;">%esi</span>, <span style="color: #7590db;">%eax</span>
    <span style="color: #4f97d7; font-weight: bold;">addq</span>    $16, <span style="color: #7590db;">%rsp</span>
    <span style="color: #4f97d7; font-weight: bold;">popq</span>    <span style="color: #7590db;">%rbp</span>
    <span style="color: #4f97d7; font-weight: bold;">retq</span>

    <span style="color: #4f97d7; font-weight: bold;">.section</span>    __TEXT,__cstring,cstring_literals
<span style="color: #bc6ec5; font-weight: bold;">L</span>_.str:                                 ## @.str
    <span style="color: #4f97d7; font-weight: bold;">.asciz</span>  <span style="color: #2d9574;">"ret = %d"</span>
</pre>
</div>
<p>
下面是书中提供的例子：<br />
<img src="./ComputerSystem/var_arr-asm.jpg" alt="var_arr-asm.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgeec5d0e" class="outline-5">
<h5 id="orgeec5d0e">浮点代码</h5>
<div class="outline-text-5" id="text-orgeec5d0e">
<p>
处理器的浮点体系结构包括多个方面（其会影响对浮点数据操作的程序如何被映射到机器上）：<br />
</p>
<ul class="org-ul">
<li>如何存储和访问浮点数值。通常是通过某种寄存器方式来完成<br /></li>
<li>对浮点数据操作的指令<br /></li>
<li>向函数传递浮点数参数和从函数返回浮点数结果的规则<br /></li>
<li>函数调用过程中保存寄存器的规则（如：一些寄存器被指定为调用者保存，而其他的被指定为被调用者保存）<br /></li>
</ul>

<p>
x86-64 浮点数是基于 SSE(Streaming SIMD Extension)或 AVX(Advanced Vector Extension)的。1997 年出现了 MMX(Matrix Math Extensions)。1999 年出现了 SSE。2000 年出现了 SSE2。 2008 年出现了 AVX。2013 年 Core i7 Haswell 处理器中引入 AVX2。每个扩展都时管理寄存器组中的数据，这些寄存器组在 MMX 中称为 MM 寄存器，SSE 中称为 XMM 寄存器，在 AVX 中称为 YMM 寄存器。MM 寄存器时 64 位的，XMM 寄存器时 128 位的，而 YMM 寄存器是 256 位的。每个 YMM 寄存器可以存放 8 个 32 位值，或 4 个 64 位值，这些值可以是整数，也可以是浮点数。<br />
</p>

<p>
我们的讲述基于 AVX2，它是在 2013 年 Core i7 Haswell 处理器中引入的。当给定命令行参数-mavx2 时，gcc 会生成 AVX2 代码。<br />
<img src="./ComputerSystem/meadia-registers.jpg" alt="meadia-registers.jpg" /><br />
</p>
</div>
<div id="outline-container-org0f37099" class="outline-6">
<h6 id="org0f37099">浮点传送和转换操作</h6>
<div class="outline-text-6" id="text-org0f37099">
<p>
下图给出在内存和 XMM 寄存器之间传送浮点数的指令。引用内存的指令是标量指令，意味着它们只对单个而不是一组封装好的数据值进行操作。<br />
Tips: 无论数据对齐与否，这些指令都能正确执行，不过代码优化规则建议 32 位内存数据满足 4 字节对齐，64 位数据满足 8 字节对齐。<br />
<img src="./ComputerSystem/float-transfer-opt.jpg" alt="float-transfer-opt.jpg" /><br />
例子：<br />
<img src="./ComputerSystem/float-transfer-eg-01.jpg" alt="float-transfer-eg-01.jpg" /><br />
下图给出在浮点数和整数数据类型之间以及不同浮点格式之间进行转换的指令集合。这些都是对单个数据值进行操作的标量指令。浮点值转换成整数时，指令会执行截断，把值向 0 进行舍入。<br />
<img src="./ComputerSystem/float-transfer-opt01.jpg" alt="float-transfer-opt01.jpg" /><br />
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">&#25226;&#21333;&#31934;&#24230;&#36716;&#25442;&#20301;&#21452;&#31934;&#24230;</span>
<span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">&#20551;&#35774; %xmm0 &#30340;&#20302;&#20301;4&#23383;&#33410;&#20445;&#23384;&#30528;&#19968;&#20010;&#21333;&#31934;&#24230;&#20540;</span>
<span style="color: #bc6ec5; font-weight: bold;">vcvtss2sd</span> <span style="color: #4f97d7; font-weight: bold;">%xmm0</span>, <span style="color: #7590db;">%xmm0</span>, <span style="color: #7590db;">%xmm0</span>

<span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">&#20294;&#26159;&#65292;gcc&#29983;&#25104;&#30340;&#20195;&#30721;&#20026;:(&#19981;&#20351;&#29992;&#19978;&#38754;&#21333;&#26465;&#25351;&#20196;&#27809;&#26377;&#26126;&#26174;&#30452;&#25509;&#30340;&#24847;&#20041;)</span>
<span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">replicate first vector element &#20551;&#35774; %xmm0 &#20026;[s3,s2,s1,s0]</span>
<span style="color: #bc6ec5; font-weight: bold;">vunpcklps</span> <span style="color: #4f97d7; font-weight: bold;">%xmm0</span>, <span style="color: #7590db;">%xmm0</span>, <span style="color: #7590db;">%xmm0</span>   <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">%xmm0 &#21464;&#20026; [s1, s1, s0, s0]</span>
<span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">convert two vector elements to double</span>
<span style="color: #bc6ec5; font-weight: bold;">vcvtps2pd</span> <span style="color: #4f97d7; font-weight: bold;">%xmm0</span>, <span style="color: #7590db;">%xmm0</span>          <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">%xmm0 &#21464;&#20026; [dx0, dx0]</span>
</pre>
</div>
<p>
vunpcklps 指令通常用来交叉放置来自两个 XMM 寄存器的值, 把它们存储到第三个寄存器中。假设源寄存器的内容为[s3,s2,s1,s0], 另一个源寄存器为[d3,d2,d1,d0],则目的寄存器的值会为[s1,d1,s0,d0]。<br />
vctps2pd  指令把源 XMM 寄存器中的两个低位单精度值扩展成目的 XMM 寄存器中的两个双精度值。<br />
例子：<br />
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">&#25226;&#21452;&#31934;&#24230;&#36716;&#25442;&#20301;&#21333;&#31934;&#24230;</span>
<span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">&#20551;&#35774; %xmm0 &#30340;&#20302;&#20301;8&#23383;&#33410;&#20445;&#23384;&#30528;&#19968;&#20010;&#21452;&#31934;&#24230;&#20540;   </span>
<span style="color: #bc6ec5; font-weight: bold;">vcvtsd2ss</span> <span style="color: #4f97d7; font-weight: bold;">%xmm0</span>, <span style="color: #7590db;">%xmm0</span>, <span style="color: #7590db;">%xmm0</span>

<span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">&#20294;&#26159;&#65292;gcc&#29983;&#25104;&#30340;&#20195;&#30721;&#20026;:(&#19981;&#20351;&#29992;&#19978;&#38754;&#21333;&#26465;&#25351;&#20196;&#27809;&#26377;&#26126;&#26174;&#30452;&#25509;&#30340;&#24847;&#20041;)</span>
<span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">replicate first vector element &#20551;&#35774; %xmm0 &#20026;[x1, x0]</span>
<span style="color: #bc6ec5; font-weight: bold;">vmovddup</span> <span style="color: #4f97d7; font-weight: bold;">%xmm0</span>, <span style="color: #7590db;">%xmm0</span>           <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">%xmm0 &#21464;&#20026; [x0, x0]</span>
<span style="color: #2aa1ae; background-color: #292e34;">;    </span><span style="color: #2aa1ae; background-color: #292e34;">convert two vector elements to single</span>
<span style="color: #bc6ec5; font-weight: bold;">vcvtpd2psx</span> <span style="color: #4f97d7; font-weight: bold;">%xmm0</span>, <span style="color: #7590db;">%xmm0</span>         <span style="color: #2aa1ae; background-color: #292e34;">; </span><span style="color: #2aa1ae; background-color: #292e34;">%xmm0 &#21464;&#20026; [0.0, 0.0, x0, x0]</span>
</pre>
</div>


<div id="org158e812" class="figure">
<p><img src="./ComputerSystem/float-transfer-eg-02.jpg" alt="float-transfer-eg-02.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org7163019" class="outline-6">
<h6 id="org7163019">过程中的浮点代码</h6>
<div class="outline-text-6" id="text-org7163019">
<p>
x86-64 中，XMM 寄存器用来向函数传递浮点参数，以及从函数返回浮点值。<br />
</p>
<ul class="org-ul">
<li>XMM 寄存器 %xmm0-%xmm7 最多可以传递 8 个浮点参数。按照参数列出的顺序使用这些寄存器。可以通过栈传递额外的浮点参数<br /></li>
<li>函数使用寄存器 %xmm0 来返回浮点值<br /></li>
<li>所有的 XMM 寄存器都时调用者保存的。被调用者可以不用保存就覆盖这些寄存器中任意一个。<br /></li>
</ul>
</div>
</div>
<div id="outline-container-org12334fb" class="outline-6">
<h6 id="org12334fb">浮点运算操作</h6>
<div class="outline-text-6" id="text-org12334fb">
<p>
<img src="./ComputerSystem/float-alg-opt01.jpg" alt="float-alg-opt01.jpg" /><br />
例子：<br />
<img src="./ComputerSystem/float-alg-opt-eg.jpg" alt="float-alg-opt-eg.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-org8f8b359" class="outline-6">
<h6 id="org8f8b359">定义和使用浮点常数</h6>
<div class="outline-text-6" id="text-org8f8b359">
<p>
和整数运算操作不同，AVX 浮点操作不能以立即数值作为操作数。编译器必须为所有的常量值分配和初始化存储空间。然后代码再把这些值从内存读入。<br />
例子：<br />
<img src="./ComputerSystem/float-constant-eg.jpg" alt="float-constant-eg.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-org116b146" class="outline-6">
<h6 id="org116b146">在浮点代码中使用位级操作</h6>
<div class="outline-text-6" id="text-org116b146">

<div id="org62932cc" class="figure">
<p><img src="./ComputerSystem/float-bit-opt.jpg" alt="float-bit-opt.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgc6faae2" class="outline-6">
<h6 id="orgc6faae2">浮点比较操作</h6>
<div class="outline-text-6" id="text-orgc6faae2">
<p>
当任意一个操作数为 NaN 时，就会出现无序的情况。<br />
<img src="./ComputerSystem/float-cmp-opt.jpg" alt="float-cmp-opt.jpg" /><br />
例子:<br />
<img src="./ComputerSystem/float-cmp-opt-eg.jpg" alt="float-cmp-opt-eg.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-orgfb09c9d" class="outline-6">
<h6 id="orgfb09c9d">对浮点代码的观察结论</h6>
</div>
</div>
</div>
<div id="outline-container-org072eac1" class="outline-4">
<h4 id="org072eac1">4 处理器体系结构</h4>
<div class="outline-text-4" id="text-org072eac1">
<p>
一个处理器支持的指令和指令的字节级编码称为它的指令集体系结构（Instruction-Set Architecture, ISA）。不同的处理器“家族”，都有不同的 ISA。同一个家族里也有很多不同型号的处理器。不同型号的处理器在 ISA 级别上都保持着兼容。ISA 在编译器编写者和处理器设计人员之间提供了一个概念抽象层，编译器编写者只需要知道允许哪些指令，以及它们是如何编码的；而处理器设计者必须建造出执行这些指令的处理器。<br />
</p>
</div>
<div id="outline-container-org27cbed5" class="outline-5">
<h5 id="org27cbed5">Y86-64 指令集体系结构</h5>
<div class="outline-text-5" id="text-org27cbed5">
<p>
定义一个指令集体系结构包括定义各种状态单元、指令集和它们的编码、一组编程规范和异常事件处理。<br />
受 x86-64 指令集系结构的启发，我们定义一个名为"Y86-64"的指令集系结构。<br />
</p>
</div>
<div id="outline-container-org3c2d012" class="outline-6">
<h6 id="org3c2d012">程序员可见的状态</h6>
<div class="outline-text-6" id="text-org3c2d012">
<p>
在处理器实现中，我们只要保证机器级程序能够访问程序员可见状态就可以了，我们不需要完全按照 ISA 暗示的方式来表示和组织这个处理器状态。<br />
<img src="./ComputerSystem/programmer-vis-state.jpg" alt="programmer-vis-state.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-org99fbac1" class="outline-6">
<h6 id="org99fbac1">Y86-64 指令</h6>
<div class="outline-text-6" id="text-org99fbac1">
<p>
Y86-64 指令集基本上是 x86-64 指令集的一个子集。汇编代码格式类似与 x86-64 的 ATT 格式(gcc 默认生成的汇编代码就是 ATT 格式, 其和 Intel 汇编代码格式有一些不同)。<br />
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">-masm=intel &#21487;&#20197;&#25351;&#23450;&#29983;&#25104; intel&#26684;&#24335;&#30340;&#27719;&#32534;&#20195;&#30721;</span>
gcc -Og -S -masm=intel xxxx.c
</pre>
</div>

<div id="orgbb031cd" class="figure">
<p><img src="./ComputerSystem/Y86-64-IS.jpg" alt="Y86-64-IS.jpg" /><br />
</p>
</div>
<ul class="org-ul">
<li>我们将 x86-64 的 movq 指令分成 4 个不同的指令。第一个字母指明源的类型，第二个字母指明目的的类型。<br />
i 为立即数，r 为寄存器，m 为内存。<br />
内存引用方式是简单的基址和偏移量形式。不支持其他方式。<br />
不允许从一个内存地址直接传送到另一个内存地址。(x86-64 也不支持)<br />
不允许将立即数传送到内存。(x86-64 支持)<br /></li>
<li>OPq 表示 4 个整数操作指令: addq, subq, andq 和 xorq。<br />
它们只对寄存器进行操作，这些指令会设置 3 个条件码 ZF,SF 和 OF（零，符号和溢出）。<br />
Tips： x86-64 还允许对内存数据进行这些操作<br /></li>
<li>jXX 表示 7 个跳转指令: jmp,jle,jl,je,jne,jge,jg<br /></li>
<li>cmovXX 表示 6 个条件传送指令： cmovle, cmovl, cmove, cmovne, cmovge, cmovg<br />
与 rrmovq 指令格式一样，但只有条件码满足所需约束时，才会更新目的寄存器的值<br /></li>
<li>call 指令将返回地址入栈，然后跳到目的地址。ret 指令从这样的调用中返回<br /></li>
<li>pushq 和 popq 指令实现入栈和出栈<br /></li>
<li>halt 指令停止指令的执行。<br />
x86-64 中有一个类似的指令 hlt。x86-64 的应用程序不允许使用这条指令，因为它会导致整个系统暂停运行。<br />
Y86-64 执行 halt 指令会导致处理器停止，并将状态码设置为 HLT<br /></li>
</ul>
</div>
</div>
<div id="outline-container-orgc4d5079" class="outline-6">
<h6 id="orgc4d5079">指令编码</h6>
<div class="outline-text-6" id="text-orgc4d5079">
<p>
图 4-2 还给出了指令的字节级编码。每条指令的第一个字节表明指令的类型。这个字节分为两个部分，每部分 4 位：高 4 位是代码(code)部分，低 4 位是功能(function)部分。<br />
<img src="./ComputerSystem/Y86-64-IS-function.jpg" alt="Y86-64-IS-function.jpg" /><br />
</p>

<p>
程序寄存器存在 CPU 中的一个寄存器文件中，该寄存器文件就是一个小的、以寄存器 ID 作为地址的随机访问存储器。图 4-2 中，rA rB 就是寄存器 ID。<br />
<img src="./ComputerSystem/Y86-64-registerID.jpg" alt="Y86-64-registerID.jpg" /><br />
</p>
</div>
<ul class="org-ul">
<li><a id="orgdb2846a"></a>RISC 与 CISC 之争<br />
<div class="outline-text-7" id="text-orgdb2846a">
<p>
RISC 精简指令集计算机(Reduced Instruction Set Computer)。CISC 复杂指令集计算机(Complex Instruction Set Computer)。<br />
<img src="./ComputerSystem/CISC-vs-RISC.jpg" alt="CISC-vs-RISC.jpg" /><br />
无论是单纯的 RISC 还是单纯的 CISC 都不如结合两者思想精华的设计:<br />
RISC 机器发展进化过程中，引入了更多的指令。那种将实现细节暴露给机器级程序的思想已经被证明是目光短浅的。随着使用更加高级硬件结构的新处理器模型的开发，许多实现细节已经变得很落后了，但它们仍然是指令集的一部分。不过，作为 RISC 设计核心的指令集仍然是非常适合在流水线化的机器上执行的。<br />
CISC 机器发展进化过程中，也利用了高性能流水线结构。它们读取 CISC 指令，并动态地翻译成比较简单的、像 RISC 那样的操作的序列。例如，一条将寄存器和内存相加的指令被翻译成 3 个操作：1个是读原始的内存值，1个是执行加法运算，第 3 个就是将和写回内存。由于动态翻译通常可以在实际指令执行前进行，处理器仍然可以保持很高的执行速率。<br />
</p>
</div>
</li>
<li><a id="orgfc2e7b6"></a>Y86-64 与 CISC 和 RISC<br />
<div class="outline-text-7" id="text-orgfc2e7b6">
<p>
Y86-64 指令集既有 CISC 指令集的属性，也有 RISC 指令集的属性。和 CISC 一样，它有条件码、长度可变的指令，并用栈来保存返回地址。和 RISC 一样的是，它采用 load/store 体系机构和规则编码,通过寄存器来传递过程参数。Y86-64 指令集可以看成是采用 CISC 指令集, 但又根据某些 RISC 的原理进行了简化。<br />
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org5c60e87" class="outline-6">
<h6 id="org5c60e87">Y86-64 异常</h6>
<div class="outline-text-6" id="text-org5c60e87">
<p>
对于 Y86-64 来说，使用程序员可见状态中的状态码 Stat 来描述程序执行的总体状态。代码值 1，命名为 AOK，表示程序执行正常，其他代码值表示发生了某种类型的异常。<br />
</p>


<div id="org11899b5" class="figure">
<p><img src="./ComputerSystem/Y86-64-stat.jpg" alt="Y86-64-stat.jpg" /><br />
</p>
</div>

<p>
对于 Y86-64 , 当遇到异常的时候，我们就简单让处理器停止执行指令。在更完整的设计中，处理器通常会调用一个异常处理程序（exception handler）, 这个过程被指定用来处理遇到的某种类型的异常。异常处理程序可以被配置成不同的结果，如，中止程序或者调用一个用户自定义的信号处理程序(signal handler)。<br />
</p>
</div>
</div>
<div id="outline-container-orgce30439" class="outline-6">
<h6 id="orgce30439">Y86-64 程序</h6>
<div class="outline-text-6" id="text-orgce30439">

<div id="org35ea273" class="figure">
<p><img src="./ComputerSystem/Y86-64-asm-eg.jpg" alt="Y86-64-asm-eg.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgbe7e63f" class="outline-6">
<h6 id="orgbe7e63f">一些 Y86-64 指令的详情</h6>
<div class="outline-text-6" id="text-orgbe7e63f">
<p>
pushq 指令会把栈指针减 8，并且将一个寄存器值写入到内存中。因此，当执行 pushq %rsp 指令时，处理器的行为是不确定的，因为要入栈的寄存器会被同一条指令修改。通常有两种不同的约定：<br />
</p>
<ol class="org-ol">
<li>压入 %rsp 的原始值 (相当于先入栈，后更新 %rsp)<br /></li>
<li>压入 %rsp 的新值，即 %rsp-8 的值 (相当于先更新 %rsp, 后入栈)<br /></li>
</ol>
<p>
对于 Y86-64 处理器来说，我们采用和 x86-64 一样的做法, 即向栈压入 %rsp 的原始值。<br />
<img src="./ComputerSystem/Y86-64-pushq.jpg" alt="Y86-64-pushq.jpg" /><br />
</p>

<ol class="org-ol">
<li>将 %rsp 置为从内存中读出的值<br /></li>
<li>将 %rsp 置为 弹出 %rsp 的新值，即 %rsp+8 的值 (相当于先更新 %rsp, 后出栈)<br /></li>
</ol>

<p>
popq %rsp 指令也有类似的歧义。<br />
</p>
<ol class="org-ol">
<li>将 %rsp 置为从内存中读出的值     (相当于只用出栈值更新 %rsp)<br /></li>
<li>将 %rsp 置为从内存中读出的值 + 8 (相当于先出栈，后更新 %rsp)<br /></li>
</ol>
<p>
对于 Y86-64 处理器来说，我们采用和 x86-64 一样的做法, 即只用出栈值更新 %rsp。<br />
<img src="./ComputerSystem/Y86-64-popq.jpg" alt="Y86-64-popq.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org38bf909" class="outline-5">
<h5 id="org38bf909">逻辑设计和硬件控制语言 HCL</h5>
<div class="outline-text-5" id="text-org38bf909">
<p>
在硬件设计中，用电子电路来计算对位进行运算的函数，在各种存储器单元中存储位。要实现一个数字系统需要三个主要的组成部分：<br />
</p>
<ol class="org-ol">
<li>组合逻辑 （用于计算对位进行运算的函数）<br /></li>
<li>存储单元 （用于存储位）<br /></li>
<li>时钟信号 （用于控制存储器单元更新）<br /></li>
</ol>
</div>
</div>
<div id="outline-container-org0befc51" class="outline-5">
<h5 id="org0befc51">Y86-64 的顺序实现</h5>
</div>
<div id="outline-container-org8cebf01" class="outline-5">
<h5 id="org8cebf01">流水线的通用原理</h5>
<div class="outline-text-5" id="text-org8cebf01">
<p>
流水线化的一个重要特性就是提高了系统的吞吐量(throughput), 也就是单位时间内服务的顾客总数。不过它也会轻微地增加延迟（latency）, 也就是服务一个用户所需要的时间。<br />
</p>
</div>
<div id="outline-container-org34f0dae" class="outline-6">
<h6 id="org34f0dae">计算流水线</h6>
<div class="outline-text-6" id="text-org34f0dae">
<p>
<img src="./ComputerSystem/non-pipelined.jpg" alt="non-pipelined.jpg" /><br />
<img src="./ComputerSystem/pipelined.jpg" alt="pipelined.jpg" /><br />
</p>
</div>
</div>
<div id="outline-container-org8f5b548" class="outline-6">
<h6 id="org8f5b548">流水线操作的详细说明</h6>
<div class="outline-text-6" id="text-org8f5b548">

<div id="orge6bf797" class="figure">
<p><img src="./ComputerSystem/pipelined-detail.jpg" alt="pipelined-detail.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgb7bec93" class="outline-6">
<h6 id="orgb7bec93">流水线的局限性</h6>
<div class="outline-text-6" id="text-orgb7bec93">
<ol class="org-ol">
<li>不一致的划分<br />
<img src="./ComputerSystem/pipelined-limitations-01.jpg" alt="pipelined-limitations-01.jpg" /><br /></li>
<li>流水线过深，收益反而下降<br />
<img src="./ComputerSystem/pipelined-limitations-02.jpg" alt="pipelined-limitations-02.jpg" /><br /></li>
</ol>
<p>
现代处理器采用了很深的(15 或更多的阶段)流水线。处理器架构师将指令的执行划分成很多非常简单的步骤，这样一来每个阶段的延迟就很小。电路设计者小心地设计流水线寄存器，使其延迟尽可能的小。芯片设计者也必须小心地设计时钟传播网络，以保证时钟在整个芯片上同时改变。<br />
</p>
</div>
</div>
<div id="outline-container-org06bf81a" class="outline-6">
<h6 id="org06bf81a">带反馈的流水线系统</h6>
<div class="outline-text-6" id="text-org06bf81a">
<p>
前面我们看到的例子中，经过流水线的相邻对象都是相互独立的。但是，相邻对象之间很可能是相关的。<br />
</p>
<ol class="org-ol">
<li>相邻指令可能数据相关(data dependencies)。如下图 3 个相邻指令之间是相关的：<br />
<img src="./ComputerSystem/opts-data-dependence.jpg" alt="opts-data-dependence.jpg" /><br /></li>
<li>相邻指令可能控制相关(control dependencies)。如下指令控制流造成的顺序相关：<br /></li>
</ol>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #bc6ec5; font-weight: bold;">loop</span>:
  <span style="color: #4f97d7; font-weight: bold;">subq</span> <span style="color: #7590db;">%rdx</span>,<span style="color: #7590db;">%rbx</span>
  <span style="color: #4f97d7; font-weight: bold;">jne</span> targ
  <span style="color: #4f97d7; font-weight: bold;">movq</span> $10,<span style="color: #7590db;">%rdx</span>
  <span style="color: #4f97d7; font-weight: bold;">jmp</span> loop
<span style="color: #bc6ec5; font-weight: bold;">targ</span>:
  <span style="color: #4f97d7; font-weight: bold;">retq</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">loop_function</span>(<span style="color: #ce537a; font-weight: bold;">int64_t</span> *<span style="color: #7590db;">rbx</span>, <span style="color: #ce537a; font-weight: bold;">int64_t</span> *<span style="color: #7590db;">rdx</span>)
{
    <span style="color: #4f97d7; font-weight: bold;">while</span> (1)
    {
        *rbx -= *rdx;
        <span style="color: #4f97d7; font-weight: bold;">if</span> (*rbx != 0)
        {
            <span style="color: #4f97d7; font-weight: bold;">return</span>;
        }
        *rdx = 10;
    }
}
</pre>
</div>
<p>
下图说明了将流水线引入含有反馈路径的系统中的危险。为了通过流水线技术加速系统，我们改变了系统的行为。<br />
<img src="./ComputerSystem/pipelined-feedback.jpg" alt="pipelined-feedback.jpg" /><br />
当我们将流水线技术引入 Y86-64 处理器时，必须正确处理反馈的影响。很明显，像上图中的例子那样改变系统的行为是不可接受的。我们必须以某种方式来处理指令间的数据相关(data dependencies)和控制相关(control dependencies)，以使得到的行为与 ISA 定义的模型相符。<br />
</p>
</div>
</div>
</div>
<div id="outline-container-orga64c51c" class="outline-5">
<h5 id="orga64c51c">Y86-64 的流水线实现</h5>
</div>
</div>
<div id="outline-container-orgd9a9413" class="outline-4">
<h4 id="orgd9a9413">5 优化程序性能</h4>
</div>
<div id="outline-container-org371abfb" class="outline-4">
<h4 id="org371abfb">6 存储器层次结构</h4>
</div>
</div>
<div id="outline-container-orgb9a14e3" class="outline-3">
<h3 id="orgb9a14e3">第二部分在系统上运行程序</h3>
<div class="outline-text-3" id="text-orgb9a14e3">
</div>
<div id="outline-container-orgb9eb389" class="outline-4">
<h4 id="orgb9eb389">7 链接</h4>
<div class="outline-text-4" id="text-orgb9eb389">
</div>
<div id="outline-container-orgdb2309d" class="outline-5">
<h5 id="orgdb2309d">编译器驱动程序</h5>
<div class="outline-text-5" id="text-orgdb2309d">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">main.c</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sum</span>(<span style="color: #ce537a; font-weight: bold;">int</span>* <span style="color: #7590db;">a</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span>);

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">arr</span>[2] = {1,2};

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span>()
{
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">val</span> = sum(arr, 2);
    <span style="color: #4f97d7; font-weight: bold;">return</span> val;
}

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">sum.c</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sum</span>(<span style="color: #ce537a; font-weight: bold;">int</span>* <span style="color: #7590db;">a</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span>)
{
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">s</span> = 0;
    <span style="color: #4f97d7; font-weight: bold;">for</span>(<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>=0; i&lt;n; i++)
    {
        s += a[i];
    }
    <span style="color: #4f97d7; font-weight: bold;">return</span> s;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">gcc -E main.c -o main.i  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#39044;&#22788;&#29702;</span>
gcc -S main.i -o main.s  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#32534;&#35793; &#24471;&#21040;&#27719;&#32534;&#35821;&#35328;&#32534;&#20889;&#30340;&#31243;&#24207;</span>
gcc -c main.s -o main.o  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#27719;&#32534; &#24471;&#21040;&#26426;&#22120;&#30721;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#23545;sum.c &#28304;&#25991;&#20214;&#36827;&#34892;&#22788;&#29702;&#65292;&#24471;&#21040; sum.o</span>
gcc main.o sum.o -o prog <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#38142;&#25509; &#24471;&#21040;&#21487;&#25191;&#34892;&#25991;&#20214;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org0887fc2" class="outline-5">
<h5 id="org0887fc2">静态链接</h5>
<div class="outline-text-5" id="text-org0887fc2">
<p>
为了构造可执行文件，链接器需要完成两个任务：<br />
</p>
<ol class="org-ol">
<li>符号解析<br /></li>
<li>重定位<br /></li>
</ol>
</div>
</div>
<div id="outline-container-org59fb143" class="outline-5">
<h5 id="org59fb143">目标文件</h5>
<div class="outline-text-5" id="text-org59fb143">
<p>
目标文件有三种类型：<br />
</p>
<ol class="org-ol">
<li>可重定位目标文件<br /></li>
<li>可执行目标文件<br /></li>
<li>共享目标文件。一种特殊类型的可重定位目标文件，可以在加载或运行时被动态地加载进内存并链接。<br /></li>
</ol>

<p>
目标文件是按照特定的目标文件格式组织的，各个系统的目标文件格式都不相同。<br />
</p>
<ul class="org-ul">
<li>Unix 使用的是 a.out 格式<br /></li>
<li>Windows 使用的是可移植可执行格式(Portable Executable, PE)<br /></li>
<li>OSX 使用的是 Mach-O 格式<br /></li>
<li>Linux 使用的是 Executable and Linkable Format(ELF)<br /></li>
</ul>
</div>
</div>

<div id="outline-container-orga19efa9" class="outline-5">
<h5 id="orga19efa9">可重定位目标文件</h5>
<div class="outline-text-5" id="text-orga19efa9">
<p>
下图是典型的 ELF 可重定位目标文件的格式。ELF 头 和 节头部表 之间的都是节。<br />
<img src="./ComputerSystem/elf-format.jpg" alt="elf-format.jpg" /><br />
</p>
<ul class="org-ul">
<li>ELF 头<br /></li>
<li>.text<br /></li>
<li>.rodata<br /></li>
<li>.data<br /></li>
<li>.bss<br /></li>
<li>.symtab<br /></li>
<li>.rel.text<br /></li>
<li>.rel.data<br /></li>
<li>.debug<br /></li>
<li>.line<br /></li>
<li>.strtab<br /></li>
<li>节头部表 (section header table)<br /></li>
</ul>
</div>
</div>
<div id="outline-container-org873f6a7" class="outline-5">
<h5 id="org873f6a7">ELF 头</h5>
<div class="outline-text-5" id="text-org873f6a7">
<p>
ELF 头包含了如下一些信息：<br />
</p>
<ul class="org-ul">
<li>生成目标文件的系统的字的大小和字节顺序<br /></li>
<li>ELF 头的大小 (Size of this header)<br /></li>
<li>目标文件的类型（可重定位、可执行、共享）<br /></li>
<li>机器类型 (Machine)<br /></li>
<li>节头部表的偏移 (Start of secton headers)<br /></li>
<li>节头部表中条目的大小和数量 (Size of section headers, Number of section headers)<br /></li>
</ul>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#20351;&#29992;&#22914;&#19979;&#21629;&#20196;&#21487;&#20197;&#26597;&#30475; elf header&#25968;&#25454;</span>
readelf -h file-name
</pre>
</div>

<div id="org7a3ec3d" class="figure">
<p><img src="./ComputerSystem/elf-header.jpg" alt="elf-header.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org8c19609" class="outline-5">
<h5 id="org8c19609">符号和符号表</h5>
<div class="outline-text-5" id="text-org8c19609">
<p>
符号表是由汇编器构造的，符号表中的符号就是编译器输出到汇编语言.s 文件中的符号。<br />
每个可重定位目标文件 m 都有一个符号表，它包含 m 定义和引用的符号的信息。在连接器的上下文中，有三种不同的符号：<br />
</p>
<ul class="org-ul">
<li>由目标文件 m 定义并能被其他目标文件引用的全局符号。对应于 m 定义的非静态的 c 函数和全局变量<br /></li>
<li>由其他目标文件定义并被 m 引用的全局符号。这些符号被称为外部符号，对应于其他目标文件定义的非静态的 c 函数和全局变量<br /></li>
<li>只被目标文件 m 定义和引用的局部符号。对应于带 static 属性的 c 函数和全局变量<br /></li>
</ul>

<p>
符号表为条目数组。每个条目的格式如下：<br />
<img src="./ComputerSystem/symtbl-item.jpg" alt="symtbl-item.jpg" /><br />
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#20351;&#29992;&#19979;&#38754;&#21629;&#20196;&#65292;&#21487;&#20197;&#26597;&#30475;&#30446;&#26631;&#25991;&#20214;&#30340;&#31526;&#21495;&#34920;</span>
readelf -s main.o
</pre>
</div>

<div id="org41e35fb" class="figure">
<p><img src="./ComputerSystem/systab-main.jpg" alt="systab-main.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgcfc2813" class="outline-5">
<h5 id="orgcfc2813">符号解析</h5>
<div class="outline-text-5" id="text-orgcfc2813">
<p>
链接器解析符号引用的方法是将每个引用与输入的可重定位目标文件的符号表中的一个确定的符号定义关联起来。<br />
对于那些和引用定义在相同模块中的局部符号的引用，符号解析是非常简单明了的。编译器只允许每个模块中每个局部符号由一个定义。静态局部变量也会有本地连接器符号，编译器还要确保它们拥有唯一的名字。<br />
</p>

<p>
对全局符号的引用解析就棘手很多。当编译器遇到一个不是在当前模块中定义的符号（变量或函数名）时，会假设该符号是在其他某个模块中定义的，生成一个链接器符号表条目，并把它交给链接器处理。如果链接器在任何输入模块中都找不到该引用符号的定义，就输出错误信息（通常很难阅读的错误信息）。当多个目标文件定义了相同名字的全局符号。链接器必须要么标志一个错误，要么以某种方法选出一个定义并抛弃其他定义。<br />
</p>
</div>
<div id="outline-container-orgfc7eb4b" class="outline-6">
<h6 id="orgfc7eb4b">链接器如何解析多重定义的全局符号</h6>
<div class="outline-text-6" id="text-orgfc7eb4b">
<p>
Linux 链接器使用下面规则来处理多重定义的符号名：<br />
</p>
<ol class="org-ol">
<li>不允许有多个同名的强符号<br /></li>
<li>如果有一个强符号和多个弱符号同名，那么选择强符号<br /></li>
<li>如果有多个弱符号同名，那么从这些弱符号中任意选择一个<br /></li>
</ol>

<p>
强符号: 函数和已初始化的全局变量。<br />
弱符号: 未初始化的全局变量。<br />
</p>
</div>
</div>
<div id="outline-container-orgead9b51" class="outline-6">
<h6 id="orgead9b51">与静态库链接</h6>
<div class="outline-text-6" id="text-orgead9b51">
<p>
所有的编译系统都提供一种机制，将所有相关的目标文件打包称为一个单独的文件，这个单独的文件被称为静态库。<br />
静态库可以作为链接器的输入。当链接器构造一个输出的可执行文件时，它只复制静态库里被应用程序引用的目标文件。<br />
</p>
</div>
</div>
<div id="outline-container-org09378b1" class="outline-6">
<h6 id="org09378b1">链接器如何使用静态库来解析引用</h6>
<div class="outline-text-6" id="text-org09378b1">
<p>
符号解析过程：<br />
在符号解析阶段，链接器从左到右按照他们在编译器驱动程序命令行上出现的顺序来扫描可重定位目标文件和存档文件(即：库文件)。在这次扫描中，链接器维护一个可重定位目标文件的集合 E，一个未解析的符号(即引用了但是尚未定义的符号)集合 U，以及一个在前面输入文件中已定义的符号集合 D。初始时，E、U和 D 均为空。<br />
</p>
<ul class="org-ul">
<li>对于命令行上的每个输入文件 f，链接器会判断 f 时一个目标文件还是一个存档文件。如果 f 时一个目标文件，那么链接器把 f 添加到 E，修改 U 和 D 来反映 f 中的符号定义和引用，并继续下一个输入文件。<br /></li>
<li>如果 f 是一个存档文件，那么链接器就尝试匹配 U 中未解析的符号和由存档文件成员定义的符号。如果某个存档文件成员 m，定义了一个符号来解析 U 中的一个引用，那么旧将 m 加到 E 中，并且链接器修改 U 和 D 来反映 m 中的符号定义和引用。对于存档文件中所有的成员目标文件都依次进行这个过程，直到 U 和 D 都不再发生变化。此时，任何不包含在 E 中的成员目标文件都简单地被丢弃，而链接器将继续处理下一个输入文件。<br /></li>
<li>如果当链接器完成对命令行上输入文件的扫描后，U是为空的，那么链接器就会输出一个错误并终止。否则，它会合并和重定位 E 中的目标文件，构建输出可执行文件。<br /></li>
</ul>

<p>
Tips:<br />
</p>
<ul class="org-ul">
<li>这个算法要求，定义一个符号的库必须出现在引用该符号的目标文件之后，否则引用就不能被解析，链接就会失败。<br /></li>
<li>当库之间有依赖关系时，如何需要满足依赖需求，可以在命令行上重复库。<br /></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgee23d4e" class="outline-5">
<h5 id="orgee23d4e">重定位</h5>
<div class="outline-text-5" id="text-orgee23d4e">
<p>
符号解析将代码中每个符号引用和正好一个符号定义关联起来。此时，链接器就知道它的输入目标文件的代码节（代码段）和数据节（数据段）的确切大小。然后，舅舅可以开始重定位了，在这个步骤中，将合并输入目标文件，并为每个符号分配运行时地址。重定位由两步组成：<br />
</p>
<ul class="org-ul">
<li>重定位节(段)和符号定义。<br />
链接器会将所有相同类型的节合并为同一个类型的新的聚合节。例如，所有输入模块(输入目标文件)的.data 节被合并为一个节，这个节称为输出的可执行目标文件的 .data 节。然后，链接器将运行时内存地址赋给新的聚合节，赋给输入模块定义的每个节，以及赋给输入模块定义的每个符号。当这一步完成时，程序中的每条指令和全局变量都有唯一的运行时内存地址了。<br /></li>
<li>重定位节(段)中的符号引用。<br />
链接器修改代码节(段)和数据节(段)中对每个符号的引用，使得他们指向正确的运行时地址。执行这一步，链接器依赖于可重定位目标模块中称为重定位条目(relocation entry)的数据结构。<br /></li>
</ul>
</div>
<div id="outline-container-org58979a5" class="outline-6">
<h6 id="org58979a5">重定位条目</h6>
<div class="outline-text-6" id="text-org58979a5">
<p>
汇编器生成一个目标模块（目标文件）时，并不知道数据和代码最终将放在内存的什么位置。它也不知道这个模块引用的任何外部定义的函数或全局变量的位置。所以，无论何时汇编器遇到对最终位置未知的目标引用，它就会生成一个重定位条目，告诉链接器在将目标文件合并成可执行文件时如何修改这个引用。<br />
</p>
<ul class="org-ul">
<li>代码的重定位条目放在 .rel.text 中<br /></li>
<li>已初始化数据的重定位条目放在 .rel.data 中<br /></li>
</ul>


<div id="orga3c7b25" class="figure">
<p><img src="./ComputerSystem/elf-relocation-entry-struct.jpg" alt="elf-relocation-entry-struct.jpg" /><br />
</p>
</div>

<p>
ELF 定义了 32 种不同的重定位类型（Relocation Type）。我们只关系其中两种最基本的重定位类型：<br />
</p>
<ul class="org-ul">
<li>R_X86_64_PC32。 重定位一个使用 32 位 PC 相对地址的引用。一个 PC 相对地址就是距程序计数器（PC）的当前运行时值的偏移量。当 CPU 执行一条使用 PC 相对寻址的指令时，它就将在指令中编码的 32 位值加上 PC 的当前运行时值，得到有效地址。<br /></li>
<li>R_X86_64_32。   重定位一个使用 32 位绝对地址的引用。<br /></li>
</ul>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#20351;&#29992;&#19979;&#38754;&#21629;&#20196;&#26597;&#30475;&#30446;&#26631;&#25991;&#20214;&#20013;&#30340; relocation entry &#25968;&#25454;</span>
readelf -r main.o
</pre>
</div>

<div id="orge719eb1" class="figure">
<p><img src="./ComputerSystem/elf-relocation-section.jpg" alt="elf-relocation-section.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org6cf6c5e" class="outline-6">
<h6 id="org6cf6c5e">重定位符号引用</h6>
<div class="outline-text-6" id="text-org6cf6c5e">
<p>
下图展示了链接器的重定位符号引用算法的伪代码。在第一步（重定位节和符号定义）中已经为每个节(段)和每个符号定义都选择了运行时地址。<br />
</p>
<ul class="org-ul">
<li>节(段):                  表示为 s<br /></li>
<li>重定位条目：             表示为 r<br /></li>
<li>节(段)运行时地址：       表示为 ADDR(s)<br /></li>
<li>符号运行时地址：         表示为 ADDR(r.symbol)<br /></li>
<li>节中需要被重定位的地址： 表示为 refptr<br /></li>
</ul>


<div id="org48fe262" class="figure">
<p><img src="./ComputerSystem/relocation-alg.jpg" alt="relocation-alg.jpg" /><br />
</p>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&#20351;&#29992;&#19979;&#38754;&#21629;&#20196;&#23558;&#30446;&#26631;&#25991;&#20214;&#36870;&#21521;&#20026; &#27719;&#32534;&#20195;&#30721;</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">-x, --all-headers        Display the contents of all headers</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">-d, --disassemble        Display assembler contents of executable sections</span>
objdump -dx main.o
</pre>
</div>
<p>
从 main.o 的汇编代码中，也可以看出重定向条目：<br />
<img src="./ComputerSystem/objdump-main.jpg" alt="objdump-main.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-org44616f7" class="outline-5">
<h5 id="org44616f7">可执行目标文件</h5>
<div class="outline-text-5" id="text-org44616f7">

<div id="org9327fc1" class="figure">
<p><img src="./ComputerSystem/elf-executeble.jpg" alt="elf-executeble.jpg" /><br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgd3c7394" class="outline-5">
<h5 id="orgd3c7394">加载可执行目标文件</h5>
</div>
<div id="outline-container-org8e3634f" class="outline-5">
<h5 id="org8e3634f">动态链接共享库</h5>
</div>
<div id="outline-container-orge85c92b" class="outline-5">
<h5 id="orge85c92b">从应用程序中加载和链接共享库</h5>
</div>
<div id="outline-container-org9e1b7d5" class="outline-5">
<h5 id="org9e1b7d5">位置无关代码</h5>
</div>
<div id="outline-container-orgbb91b41" class="outline-5">
<h5 id="orgbb91b41">库打桩机制</h5>
</div>
<div id="outline-container-org55c9bf9" class="outline-5">
<h5 id="org55c9bf9">处理目标文件的工具</h5>
</div>
</div>
<div id="outline-container-org9560402" class="outline-4">
<h4 id="org9560402">8 异常控制流</h4>
</div>
<div id="outline-container-orge228030" class="outline-4">
<h4 id="orge228030">9 虚拟内存</h4>
<div class="outline-text-4" id="text-orge228030">
</div>
<div id="outline-container-org1ce11b7" class="outline-5">
<h5 id="org1ce11b7">内存映射</h5>
<div class="outline-text-5" id="text-org1ce11b7">
</div>
<div id="outline-container-org9a972de" class="outline-6">
<h6 id="org9a972de">再看 execve 函数</h6>
<div class="outline-text-6" id="text-org9a972de">
<p>
execve 函数在当前进程中加载并运行包含在可执行文件 a.out 中的程序，用 a.out 程序替代当前程序。<br />
</p>
<div class="org-src-container">
<pre class="src src-c">execve(<span style="color: #2d9574;">"a.out"</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>);
</pre>
</div>
<p>
上面代码执行以下几个步骤：<br />
</p>
<ol class="org-ol">
<li>删除已存在的用户区域。<br />
删除当前进程虚拟地址的用户部分中的已存在的区域结构<br /></li>
<li>映射私有区域。<br />
为 a.out 的代码、数据、bss 和栈区域创建新的区域结构。所有这些区域都是私有的、写时复制的。<br />
代码和数据区域被映射为 a.out 文件中的.text 和 .data 区。<br />
bss 区域是请求二进制零的，映射到匿名文件，其大小包含在 a.out 中。<br />
栈和堆区域也是请求二进制零的，初始长度为零。图 9-31 概括了私有区域的不同映射<br /></li>
<li>映射共享区域。<br />
如果 a.out 程序与共享对象链接，比如标准库 libc.so, 那么这些对象都是动态链接到这个程序的，然后在映射到用户虚拟地址空间中的共享区域内。<br /></li>
<li>设置程序计数器(PC)。<br />
设置当前进程上下文中的程序计数器，使之指向代码区域的入口点。<br /></li>
</ol>

<p>
下次调度这个进程时，它将从这个入口点开始执行。Linux 将更加需要换入代码和数据页面。<br />
<img src="./ComputerSystem/map_prog_area.jpg" alt="map_prog_area.jpg" /><br />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgfafd5f1" class="outline-3">
<h3 id="orgfafd5f1">第三部分程序间的交流和通信</h3>
<div class="outline-text-3" id="text-orgfafd5f1">
</div>
<div id="outline-container-org523c783" class="outline-4">
<h4 id="org523c783">10 系统级 I/O</h4>
</div>
<div id="outline-container-org8d66ddc" class="outline-4">
<h4 id="org8d66ddc">11 网络编程</h4>
</div>
<div id="outline-container-orgac06162" class="outline-4">
<h4 id="orgac06162">11 并发编程</h4>
</div>
</div>
<div id="outline-container-org65fab7c" class="outline-3">
<h3 id="org65fab7c">参考资料</h3>
<div class="outline-text-3" id="text-org65fab7c">
<ul class="org-ul">
<li>Computer Systems: A Programmer's Perspective 习题答案 <a href="https://www.coursehero.com/textbook-solutions/Computer-Systems-A-Programmers-Perspective-3rd-Edition-9780134092669-1258">https://www.coursehero.com/textbook-solutions/Computer-Systems-A-Programmers-Perspective-3rd-Edition-9780134092669-1258</a><br /></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org12a0f03" class="outline-2">
<h2 id="org12a0f03">Misc</h2>
<div class="outline-text-2" id="text-org12a0f03">
</div>
<div id="outline-container-orgaf83d37" class="outline-3">
<h3 id="orgaf83d37">Q&amp;A</h3>
<div class="outline-text-3" id="text-orgaf83d37">
</div>
<div id="outline-container-org121e91a" class="outline-5">
<h5 id="org121e91a">带宽的计算</h5>
<div class="outline-text-5" id="text-org121e91a">
<p>
内存带宽计算公式：带宽=内存时钟频率×内存总线位数×倍增系数/8。<br />
以 DDR400 内存为例，它的运行频率为 200MHz，数据总线位数为 64bit，由于上升沿和下降沿都传输数据，因此倍增系数为 2，此时带宽为：200×64×2/8=3.2GB/s（如果是两条内存组成的双通道，那带宽则为 6.4 GB/s）<br />
</p>

<p>
带宽的常见单位:<br />
Mbps 其全称为 Million bits per second。Mb/s 与 Mbps 一样。1Gbps = 1Gb/s = 1024Mbps<br />
MB/s 为 Million Byte per second。<br />
</p>

<ul class="org-ul">
<li>内存条带宽的换算方法 <a href="https://zhuanlan.zhihu.com/p/443104177">https://zhuanlan.zhihu.com/p/443104177</a><br /></li>
</ul>
</div>
</div>
<div id="outline-container-orgd0d8303" class="outline-5">
<h5 id="orgd0d8303">数据传输率</h5>
<div class="outline-text-5" id="text-orgd0d8303">
<p>
MT/s 意思是 MegaTransfers/s，即 MT/s 的中文解释为：百万次/秒。由于 HT 总线是双向传输，所以换算成我们平时所熟悉的 MHz，需要除以 2。例如： nv570 芯片支持的 HT 数据传输率是 2000MT/s，那么换算成我们所需要的频率单位后为 2000/2 MHz=1000 MHz。<br />
HT 是 Hyper Transport 的简称，HyperTransport 本质是一种为主板上的集成电路互连而设计的端到端总线技术，目的是加快芯片间的数据传输速度。<br />
</p>

<ul class="org-ul">
<li><a href="https://baike.baidu.com/item/MT%2Fs/15788109">https://baike.baidu.com/item/MT%2Fs/15788109</a><br /></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id="vssue"></div>
        <link rel="stylesheet" href="https://unpkg.com/vssue/dist/vssue.min.css">
        <script src="https://unpkg.com/vue@2.7.10/dist/vue.runtime.min.js"></script>
        <script src="https://unpkg.com/vssue/dist/vssue.github.min.js"></script>
        <script>
          new Vue({
            el: '#vssue',
            render: h => h('Vssue', {
              props: {
                // 在这里设置当前页面对应的 Issue 标题
                title: 'Computer System',

                // 在这里设置你使用的平台的 OAuth App 配置
                options: {
                    owner: 'wolfand11',
                    repo: 'blog_comments',
                    clientId: 'a02b49185d85859cb92c',
                    clientSecret: '6f123085c6f1ce339e2517d24e5b099fa1dc9c85', // 只有在使用某些平台时需要
                },
              }
            })
          })
        </script>
</div>
</body>
</html>
