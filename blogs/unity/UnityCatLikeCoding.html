<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-01-14 周二 10:48 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UnityCatLikeCoding</title>
<meta name="generator" content="Org mode" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
           <meta name="viewport" content="width=device-width, initial-scale=1" />
           <link rel="stylesheet" title="Standard" href="https://wolfand11.coding.me/res/css/worg.css" type="text/css" />
           <link rel="alternate stylesheet" title="Zenburn" href="https://wolfand11.coding.me/res/css/worg-zenburn.css" type="text/css" />
           <link rel="alternate stylesheet" title="Classic" href="https://wolfand11.coding.me/res/css/worg-classic.css" type="text/css" />
           <link rel="icon" href="http://wolfand11.coding.me/res/favicon.ico" type="image/ico" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="https://wolfand11.coding.me"> HOME </a>
</div><div id="content">
<h1 class="title">UnityCatLikeCoding</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org2db9a13">UnityCatLikeCoding</a>
<ul>
<li><a href="#orgc4c12cf">Rendering</a>
<ul>
<li><a href="#orgd7cf6d2">Shader Fundamentals</a>
<ul>
<li><a href="#org90e70e2">基础知识</a>
<ul>
<li><a href="#org366a1f8">SV 含义</a></li>
<li><a href="#orgc9ad9eb">ST 含义</a></li>
<li><a href="#org7fd1041">贴图坐标系</a></li>
<li><a href="#org11df423">MipMap 和 FilterMode</a></li>
<li><a href="#org9cb0f5d">TRANSFORM_TEX</a></li>
<li><a href="#orgeabaf39">lerp 函数意义</a></li>
</ul>
</li>
<li><a href="#org7dde387">Unity 定义的变量</a></li>
<li><a href="#org43f4744">Unity Shader 定义的宏</a></li>
<li><a href="#org885282e">Unity Shader Compiler</a></li>
<li><a href="#org8c1c9a8">Unity shader 预编译命令</a></li>
<li><a href="#orgfdadda5">D3D11 汇编命令</a></li>
</ul>
</li>
<li><a href="#orgbdaa964">Combining Textures</a>
<ul>
<li><a href="#orgcb3b0c3">Linear Color Space</a>
<ul>
<li><a href="#orgcee9b38">Linear Color Space 原理</a></li>
<li><a href="#org29f5a48">DetailTex 叠加到 MainTex 上为什么需要乘二？</a></li>
<li><a href="#orgc5c41c5">SetVector SetColor</a></li>
<li><a href="#orgd27fb44">参考资料</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orge4e9e30">The First Light</a>
<ul>
<li><a href="#org17e7e1e">normal 从物体空间到世界空间的变换</a></li>
<li><a href="#orgee461e0">Tags LightMode=ForwardBase</a></li>
<li><a href="#orgc13b243">BlinnPhong</a></li>
<li><a href="#orge8b9a73">Energy Conservation</a></li>
<li><a href="#org8af1bff">Specular / Metallic Workflow</a>
<ul>
<li><a href="#orge812265">Specular Workflow</a></li>
<li><a href="#orgb76537d">Metallic Workflow</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org3263b6b">Multi Lights</a>
<ul>
<li><a href="#org1829e8a">Light Attenuation</a>
<ul>
<li><a href="#org72bfc6f">Point Light</a></li>
</ul>
</li>
<li><a href="#orgaffc8cb">Mixing Lights</a></li>
<li><a href="#org6535ae8">Cookies</a></li>
<li><a href="#orge73bb34">Vertex Lights</a></li>
<li><a href="#org6139cc2">Spherical Harmonics</a>
<ul>
<li><a href="#orgb5029c2">相关数学概念</a></li>
<li><a href="#org1bc83d3">原理概述</a></li>
<li><a href="#org1ba4f43">Spherical Harmonics Bands</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgda6d932">Bumpiness</a>
<ul>
<li><a href="#org2960999">高度图转 normal map 的方法</a>
<ul>
<li><a href="#orgfcf78b6">方案 1</a></li>
<li><a href="#orgc6e847c">方案 2</a></li>
</ul>
</li>
<li><a href="#org505da33">Normal 向量的插值</a></li>
<li><a href="#org93efe58">Normal 贴图存储惯例</a></li>
<li><a href="#org7a8d6c3">DXT5nm 存储 normal 贴图</a></li>
<li><a href="#orgcc7049f">缩放 Normal</a></li>
<li><a href="#orgb0da65a">Blending Normals</a></li>
</ul>
</li>
<li><a href="#org563e6a1">Shadows</a>
<ul>
<li><a href="#org0cd67fc">方向光阴影</a>
<ul>
<li><a href="#orgc22f4c8">开启屏幕空间阴影</a></li>
<li><a href="#org64920e3">关闭屏幕空间阴影</a></li>
<li><a href="#orgbe8706c">ShadowQuality</a></li>
<li><a href="#org24e8229">参考资料</a></li>
</ul>
</li>
<li><a href="#org786192a">Spot Light Shadow</a></li>
<li><a href="#orgbd35405">相关宏定义</a></li>
<li><a href="#org4400e04">参考资料</a></li>
</ul>
</li>
<li><a href="#orgb4337d6">Reflection</a>
<ul>
<li><a href="#org75f6314">Environment Mapping</a></li>
<li><a href="#org05580c1">Imperfect Reflections</a>
<ul>
<li><a href="#org6e721b8">Metals VS Nonmetals</a></li>
<li><a href="#org24f7725">Mirrors and Shadows</a></li>
</ul>
</li>
<li><a href="#orgb90a5f5">Box Projection</a></li>
<li><a href="#org6ec2472">Blending Reflection Probes</a></li>
<li><a href="#org7a33b80">Bouncing Reflections</a></li>
</ul>
</li>
<li><a href="#orgd5b9e12">ComplexMaterials &amp; More Complexity</a>
<ul>
<li><a href="#org90809b5">Emission</a></li>
<li><a href="#org7db5687">Smoothness &amp; Metallic Map</a></li>
<li><a href="#orgcd9dbdb">Occlusion</a></li>
</ul>
</li>
<li><a href="#org855b08d">Transparency</a></li>
<li><a href="#orge7a43f3">Semitransparent Shadows</a></li>
<li><a href="#orgb0fb17c">Deferred Shading</a></li>
<li><a href="#org95df0c6">Fog</a></li>
<li><a href="#orgaa7a0b2">Deferred Lights</a></li>
<li><a href="#org64b1db3">Static Lighting</a></li>
<li><a href="#org644acf2">Mixed Lighting</a></li>
<li><a href="#org510f53b">RealtimeGI and LOD Groups</a></li>
<li><a href="#orgbdcffdb">GPU Instancing</a></li>
<li><a href="#orgd8e7e7e">Parallax</a></li>
</ul>
</li>
<li><a href="#orgebf5f2a">Advanced Rendering</a>
<ul>
<li><a href="#org178054a">Flat and Wireframe Shading</a></li>
<li><a href="#org5cf0f89">Tessellation</a></li>
<li><a href="#org0509bb0">Surface Displacement</a></li>
<li><a href="#org4ac0ade">Bloom</a></li>
<li><a href="#orgdbb39f7">Depth of Field</a></li>
<li><a href="#org4b0052c">FXAA</a></li>
<li><a href="#orgc749527">Triplanar Mapping</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf300a9b">Q&amp;A</a>
<ul>
<li><a href="#org54577c2">为什么 Unity 标准材质中只有点光源可以在顶点着色器中计算？</a></li>
<li><a href="#org9107202">Unity 球谐光照函数中只需要传递 normal，那么物体到光源的距离引起的光照差异是如何实现的？</a></li>
<li><a href="#org40770d6">为什么渲染方向光的阴影贴图时需要使用正交矩阵，而点光源需要使用透视矩阵？</a></li>
<li><a href="#org681a5e3">为什么点光源阴影需要绘制场景 6 次？</a></li>
<li><a href="#org3cf36ba">Renderer.receiveShadows 是如何控制关闭接收阴影的？</a></li>
<li><a href="#org759fdb2">为什么 FrameDebug 中显示 unity_SpecCube0 为 UnityBlackCube？</a></li>
</ul>
</li>
<li><a href="#org0d58f4f">参考资料</a></li>
</ul>
</div>
</div>
<p>
UnityCatLikeCoding note.<br />
</p>
<div class="HTML">
<p>
&lt;!&#x2013; more &#x2013;&gt;<br />
</p>

</div>

<div id="outline-container-org2db9a13" class="outline-2">
<h2 id="org2db9a13">UnityCatLikeCoding</h2>
<div class="outline-text-2" id="text-org2db9a13">
</div>
<div id="outline-container-orgc4c12cf" class="outline-3">
<h3 id="orgc4c12cf">Rendering</h3>
<div class="outline-text-3" id="text-orgc4c12cf">
</div>
<div id="outline-container-orgd7cf6d2" class="outline-4">
<h4 id="orgd7cf6d2">Shader Fundamentals</h4>
<div class="outline-text-4" id="text-orgd7cf6d2">
</div>
<div id="outline-container-org90e70e2" class="outline-5">
<h5 id="org90e70e2">基础知识</h5>
<div class="outline-text-5" id="text-org90e70e2">
</div>
<div id="outline-container-org366a1f8" class="outline-6">
<h6 id="org366a1f8">SV 含义</h6>
<div class="outline-text-6" id="text-org366a1f8">
<p>
SV_POSITION、SV_TARGET 中 SV 表示 System Value<br />
SV_TARGET 表示 fragment shader 写入最终颜色值的默认目标对象，其实就是帧缓冲区对象<br />
</p>
</div>
</div>
<div id="outline-container-orgc9ad9eb" class="outline-6">
<h6 id="orgc9ad9eb">ST 含义</h6>
<div class="outline-text-6" id="text-orgc9ad9eb">
<p>
贴图附加的 Tiling 和 Offset 属性。ST 表示 Scale 和 Translation.<br />
</p>
</div>
</div>
<div id="outline-container-org7fd1041" class="outline-6">
<h6 id="org7fd1041">贴图坐标系</h6>
<div class="outline-text-6" id="text-org7fd1041">
<p>
OpenGL 坐标原点在左下角<br />
D3D 坐标原点在左上角<br />
</p>
</div>
</div>

<div id="outline-container-org11df423" class="outline-6">
<h6 id="org11df423">MipMap 和 FilterMode</h6>
<div class="outline-text-6" id="text-org11df423">
<p>
MipMap       用于处理贴图图元密度大于像素密度的情况，一个像素对应多个贴图图元时，如果没有 mipmap，在多个贴图图元中采用一个图元而丢弃其他。有 mipmap 时，则使用更低分辨率的贴图让 像素密度和贴图密度相接近。<br />
FilterMode   用于处理贴图图元密度小于像素密度的情况，采样器会对靠近采样点的图元进行采样，然后对这些图元进行插值，来得到最终颜色值。<br />
</p>

<p>
Bilinear texture filtering  会对靠近采样点的四个图元进行加权平均。<br />
</p>

<p>
<a href="https://docs.microsoft.com/en-us/windows/uwp/graphics-concepts/bilinear-texture-filtering">https://docs.microsoft.com/en-us/windows/uwp/graphics-concepts/bilinear-texture-filtering</a><br />
</p>
</div>
</div>
<div id="outline-container-org9cb0f5d" class="outline-6">
<h6 id="org9cb0f5d">TRANSFORM_TEX</h6>
<div class="outline-text-6" id="text-org9cb0f5d">
<div class="org-src-container">
<pre class="src src-shader"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35813;&#26041;&#27861;&#23450;&#20041;&#22312; UnityCG.cginc</span>
<span style="color: #bc6ec5;">#define</span> TRANSFORM_TEX<span style="color: #4f97d7;">(</span>tex,name<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span>tex.xy * name##<span style="color: #7590db;">_ST</span>.xy + name##<span style="color: #7590db;">_ST</span>.zw<span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgeabaf39" class="outline-6">
<h6 id="orgeabaf39">lerp 函数意义</h6>
<div class="outline-text-6" id="text-orgeabaf39">

<div class="figure">
<p><img src="./UnityCatLikeCoding/00_lerp.png" alt="00_lerp.png" /><br />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org7dde387" class="outline-5">
<h5 id="org7dde387">Unity 定义的变量</h5>
<div class="outline-text-5" id="text-org7dde387">
<p>
_WorldSpaceLightPos0      世界空间 Light 位置<br />
_LightColor0              Light 颜色<br />
_WorldSpaceCameraPos      世界坐标摄像机位置<br />
_LightTexture0            Light 没有使用 Cookie 时，该变量存储衰减贴图。使用了 Cookie 时，存储 Cookie 贴图。 (Directional Light 没有衰减贴图)<br />
_LightTextureB0           Light 使用了 Cookie 时，该变量存储衰减贴图。 (Directional Light 没有衰减贴图)<br />
</p>

<p>
unity_WorldToShadow       float4x4[4]	用于 spot lights 或 方向光的 4 级联阴影<br />
</p>

<p>
_LightShadowData<br />
_LightShadowData.x - 1-shadow strength<br />
_LightShadowData.y - Appears to be unused<br />
_LightShadowData.z - 1.0 / shadow far distance<br />
_LightShadowData.w - shadow near distance<br />
</p>

<p>
_ProjectionParams         <i>/ x=1 or -1  y=near z=far w=1/far<br />
_ScreenParams             /</i> x=widthPixels y=heightPixels z=1.0+1.0/width w=1.0+1.0/height<br />
_ZBufferParams 						<i>/ 用于线性化 ZBuffer 中的值，<br />
                          /</i> x=1-far/near<br />
                          <i>/ y=far/near<br />
                          /</i> z=x/far=(1-far)/(near*far)<br />
                          // w=y/far=(1/near)<br />
</p>
<div class="org-src-container">
<pre class="src src-csharp"><span style="color: #ce537a; font-weight: bold;">double</span> <span style="color: #7590db;">zc0</span>, <span style="color: #7590db;">zc1</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">OpenGL would be this:</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">zc0 = (1.0 - m_FarClip / m_NearClip) / 2.0;</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">zc1 = (1.0 + m_FarClip / m_NearClip) / 2.0;</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">D3D is this:</span>
zc0 = <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">0</span> - m_FarClip / m_NearClip;
zc1 = m_FarClip / m_NearClip;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">now set _ZBufferParams with (zc0, zc1, zc0/m_FarClip, zc1/m_FarClip);</span>
</pre>
</div>

<p>
unity_SpecCube0_ProbePosition   第一个反射探针的位置，如果场景中不存在反射探针，则默认传递环境反射(Lighting / Environment Reflections / Source 下可以设置环境反射)的数据，环境反射。<br />
unity_SpecCube0_BoxMin          第一个反射探针对应的 Box 在世界空间中坐标最小值，反射探针为环境反射时，该值为 (Infinity, Infinity, Infinity, 1)<br />
unity_SpecCube0_BoxMax          第一个反射探针对应的 Box 在世界空间中坐标最大值，反射探针为环境反射时，该值为 (-Infinity, -Infinity, -Infinity, 1)<br />
unity_SpecCube0_BoxMin.w        存储了第一个反射探针和第二个反射探针的插值比例，1 表示全部使用第一个反射探针，0 表示全部使用第二个反射探针.(只有将 Renderer 的 reflectionProbeUsage 属性设置为 BlendProbesAndSkybox 时，反射探针才会和 Skybox 进行混合)<br />
unity_SpecCube0_HDR.r           存储了反射探针的强度，对应反射探针的 Runtime setting/Intensity 和 Lighting/Scene/EnvironmentReflections/IntensityMultiplier(IntensityMultiplier 只是 Intensity 的系数，所以 FrameDebug 中看到的值和该值并不同)<br />
</p>


<div class="figure">
<p><img src="./UnityCatLikeCoding/01_08re_default_env_reflection_data.png" alt="01_08re_default_env_reflection_data.png" /><br />
</p>
</div>


<p>
<a href="https://docs.unity3d.com/Manual/SL-UnityShaderVariables.html">https://docs.unity3d.com/Manual/SL-UnityShaderVariables.html</a><br />
</p>
<ul class="org-ul">
<li>_ZBufferParams values? <a href="https://forum.unity.com/threads/_zbufferparams-values.39332/">https://forum.unity.com/threads/_zbufferparams-values.39332/</a><br /></li>
</ul>
</div>
</div>
<div id="outline-container-org43f4744" class="outline-5">
<h5 id="org43f4744">Unity Shader 定义的宏</h5>
<div class="outline-text-5" id="text-org43f4744">
<p>
UNITY_COMPILER_HLSL                            使用 HLSL 编译时，定义该宏(for D3D or GLCore/GLES3/GLES platforms)<br />
UNITY_COMPILER_HLSL2GLSL                       使用 hlsl2glsl 编译时，定义该宏<br />
UNITY_COMPILER_CG                              使用 NVIDIA 的 Cg<br />
</p>

<p>
<a href="https://docs.unity3d.com/Manual/SL-BuiltinMacros.html">https://docs.unity3d.com/Manual/SL-BuiltinMacros.html</a><br />
<a href="https://docs.unity3d.com/Manual/SL-ShadingLanguage.html">https://docs.unity3d.com/Manual/SL-ShadingLanguage.html</a><br />
</p>
</div>
</div>
<div id="outline-container-org885282e" class="outline-5">
<h5 id="org885282e">Unity Shader Compiler</h5>
<div class="outline-text-5" id="text-org885282e">
<ul class="org-ul">
<li>Windows &amp; Microsoft platforms (DX11, DX12 and Xbox One) all use Microsoft’s HLSL compiler (currently d3dcompiler_47).<br /></li>
<li>OpenGL Core , OpenGL ES 3, OpenGL ES 2.0 and Metal use Microsoft’s HLSL followed by bytecode translation into GLSL or Metal, using HLSLcc.<br /></li>
<li>OpenGL ES 2.0 can use source level translation via hlsl2glslfork and glsl optimizer. This is enabled by adding #pragma prefer_hlsl2glsl gles<br /></li>
<li>Other console platforms use their respective compilers (e.g. PSSL on PS4).<br /></li>
<li>Surface Shaders use Cg 2.2 and MojoShader for code generation analysis step.<br /></li>
</ul>
</div>
</div>
<div id="outline-container-org8c1c9a8" class="outline-5">
<h5 id="org8c1c9a8">Unity shader 预编译命令</h5>
</div>
<div id="outline-container-orgfdadda5" class="outline-5">
<h5 id="orgfdadda5">D3D11 汇编命令</h5>
<div class="outline-text-5" id="text-orgfdadda5">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">命令</th>
<th scope="col" class="org-left">说明</th>
<th scope="col" class="org-left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">mul result opt1 opt2</td>
<td class="org-left">opt1 乘 opt2 保存到 result</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">add result opt1 opt2</td>
<td class="org-left">opt1 加 opt2 保存到 result</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">mad result opt1 opt2 opt3</td>
<td class="org-left">opt1 乘 opt2 再加 opt3 保存结果到 result</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">mov result opt1</td>
<td class="org-left">将 opt1 数据保存到 result</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dcl_sampler s0, mode_default</td>
<td class="org-left">创建贴图采样对象 s0</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dcl_resource_texture2d(float,float,float,float) t0</td>
<td class="org-left">创建 2D 贴图资源 t0</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">sample result.xyzw, uv.xyxx, t0.xyzw, s0</td>
<td class="org-left">使用 s0 采样器以 uv 为贴图坐标，对贴图资源 t0 进行采样将结果保存到 result 中</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-orgbdaa964" class="outline-4">
<h4 id="orgbdaa964">Combining Textures</h4>
<div class="outline-text-4" id="text-orgbdaa964">
</div>
<div id="outline-container-orgcb3b0c3" class="outline-5">
<h5 id="orgcb3b0c3">Linear Color Space</h5>
<div class="outline-text-5" id="text-orgcb3b0c3">
</div>
<div id="outline-container-orgcee9b38" class="outline-6">
<h6 id="orgcee9b38">Linear Color Space 原理</h6>
<div class="outline-text-6" id="text-orgcee9b38">
<p>
Gamma space 是指经过 gamma 矫正的颜色。gamma 矫正是对光照亮度的调整。最简单的方式是提升原始值某次幂，如 \(originalValue^{gamma}\) 。<br />
gamma=1 表示没有改变。gamma=2 表示对原始值求平方。<br />
</p>

<p>
这种转换原本是为了适应非线性的 CRT 显示器的。一个附加的好处是这种转换刚好和我们眼睛对不同光强度的敏感程度相一致。人眼对不同的暗的颜色要比不同的亮的颜色更加敏感。所以使用更多位数字存储暗颜色是很有意义的，求幂运算可以实现该需求，它会将比较小的值扩展到一个更大的范围，同时将较大的值压缩到一个小的范围。<br />
</p>

<p>
运用最广泛的图片颜色格式是 sRGB.<br />
</p>
<ul class="org-ul">
<li>Encoding with gamma 1/2.2 即 \(originalValue^{\frac{1}{2.2}} = originalValue^{0.45}\)<br />
<img src="./UnityCatLikeCoding/01_03ct_linear-to-gamma.png" alt="01_03ct_linear-to-gamma.png" /><br /></li>
<li>Decoding with gamma 2.2 即 \(originalValue^{2.2}\)<br />
<img src="./UnityCatLikeCoding/01_03ct_gamma-to-linear.png" alt="01_03ct_gamma-to-linear.png" /><br /></li>
<li>伽马矫正函数图示<br />
<img src="./UnityCatLikeCoding/01_03ct_gamma_correct.png" alt="01_03ct_gamma_correct.png" /><br /></li>
</ul>

<p>
横坐标为编码前的颜色值，纵坐标为编码后的颜色值。蓝色的线表示线性编码前后颜色值不变。红色的线表示 Gamma 编码前后颜色值变大。以 0.5 为分界线，Gamma 编码后，[0-0.5] 被扩展到了 [0-0.7297&#x2026;] [0.5-1] 被压缩到了 [0.7297&#x2026; - 1]。Gamma 编码的图片要比 Linear 编码的图片亮度高。<br />
</p>

<p>
下面的 HTML 可用于 GammaToLinear 转换<br />
</p>
<div class="org-src-container">
<pre class="src src-html"><span style="color: #2d9574;">&lt;!DOCTYPE html&gt;</span>
&lt;<span style="color: #bc6ec5; font-weight: bold;">html</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">body</span>&gt;

        &lt;<span style="color: #bc6ec5; font-weight: bold;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">&#39068;&#33394;&#36716;&#25442;</span>&lt;/<span style="color: #bc6ec5; font-weight: bold;">h2</span>&gt;

        &lt;<span style="color: #bc6ec5; font-weight: bold;">form</span> <span style="color: #7590db;">action</span>=<span style="color: #2d9574;">""</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"originColor"</span>&gt;
            TD &#39068;&#33394;
            R: &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"text"</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"oR"</span> value =<span style="color: #2d9574;">"128"</span> <span style="color: #7590db;">size</span>=<span style="color: #2d9574;">"4"</span>&gt;
            G: &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"text"</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"oG"</span> value =<span style="color: #2d9574;">"128"</span> <span style="color: #7590db;">size</span>=<span style="color: #2d9574;">"4"</span>&gt;
            B: &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"text"</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"oB"</span> value =<span style="color: #2d9574;">"64"</span> <span style="color: #7590db;">size</span>=<span style="color: #2d9574;">"4"</span>&gt;
        &lt;/<span style="color: #bc6ec5; font-weight: bold;">form</span>&gt;
        &lt;<span style="color: #bc6ec5; font-weight: bold;">br</span>&gt;
        &lt;<span style="color: #bc6ec5; font-weight: bold;">form</span> <span style="color: #7590db;">action</span>=<span style="color: #2d9574;">""</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"newColor"</span>&gt;
            Qin &#39068;&#33394;
            R: &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"text"</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"nR"</span> value =<span style="color: #2d9574;">""</span> <span style="color: #7590db;">size</span>=<span style="color: #2d9574;">"4"</span> disabled&gt;
            G: &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"text"</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"nG"</span> value =<span style="color: #2d9574;">""</span> <span style="color: #7590db;">size</span>=<span style="color: #2d9574;">"4"</span> disabled&gt;
            B: &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"text"</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"nB"</span> value =<span style="color: #2d9574;">""</span> <span style="color: #7590db;">size</span>=<span style="color: #2d9574;">"4"</span> disabled&gt;
        &lt;/<span style="color: #bc6ec5; font-weight: bold;">form</span>&gt;
        &lt;<span style="color: #bc6ec5; font-weight: bold;">br</span>&gt;

        &lt;<span style="color: #bc6ec5; font-weight: bold;">button</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"button"</span> <span style="color: #7590db;">onclick</span>=<span style="color: #2d9574;">'convertColor()'</span>&gt;&#36716;&#25442;&lt;/<span style="color: #bc6ec5; font-weight: bold;">button</span>&gt;
    &lt;/<span style="color: #bc6ec5; font-weight: bold;">body</span>&gt;

    &lt;<span style="color: #bc6ec5; font-weight: bold;">script</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"text/javascript"</span>&gt;
     function convertColor()
     {
         var r = document.getElementById("oR").value / 255;
         var g = document.getElementById("oG").value / 255;
         var b = document.getElementById("oB").value / 255;

         //window.alert("test = " + r + b + g);
         document.getElementById("nR").value = Math.round(Math.pow(r, 1/2.2) * 255);
         document.getElementById("nG").value = Math.round(Math.pow(g, 1/2.2) * 255);
         document.getElementById("nB").value = Math.round(Math.pow(b, 1/2.2) * 255);
     }
    &lt;/<span style="color: #bc6ec5; font-weight: bold;">script</span>&gt;

&lt;/<span style="color: #bc6ec5; font-weight: bold;">html</span>&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shader"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">GammaToLinearSpace(col.rgb);  &#19979;&#38754;&#20195;&#30721;&#26159; GammaToLinearSpace &#30340;&#27719;&#32534;&#30721;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7;">{</span>
    u_xlat0 = <span style="color: #4f97d7; font-weight: bold;">texture2D</span><span style="color: #bc6ec5;">(</span><span style="color: #7590db;">_MainTex</span>, vs_TEXCOORD0.xy<span style="color: #bc6ec5;">)</span>;
    u_xlat1.xyz = u_xlat0.xyz * vec3<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">305306017</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">305306017</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">305306017</span><span style="color: #bc6ec5;">)</span> + vec3<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">682171106</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">682171106</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">682171106</span><span style="color: #bc6ec5;">)</span>;
    u_xlat1.xyz = u_xlat0.xyz * u_xlat1.xyz + vec3<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0125228781</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0125228781</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0125228781</span><span style="color: #bc6ec5;">)</span>;
    u_xlat0.xyz = u_xlat0.xyz * u_xlat1.xyz;
    <span style="color: #a45bad;">SV_Target0</span> = u_xlat0;
    <span style="color: #4f97d7; font-weight: bold;">return</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">LinearToGammaSpace(col.rgb); &#19979;&#38754;&#20195;&#30721;&#26159; LinearToGammaSpace &#30340;&#27719;&#32534;&#20195;&#30721;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7;">{</span>
    u_xlat0 = <span style="color: #4f97d7; font-weight: bold;">texture2D</span><span style="color: #bc6ec5;">(</span><span style="color: #7590db;">_MainTex</span>, vs_TEXCOORD0.xy<span style="color: #bc6ec5;">)</span>;
    u_xlat16_1.xyz = <span style="color: #4f97d7;">max</span><span style="color: #bc6ec5;">(</span>u_xlat0.xyz, vec3<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    u_xlat16_2.xyz = <span style="color: #4f97d7;">log2</span><span style="color: #bc6ec5;">(</span>u_xlat16_1.xyz<span style="color: #bc6ec5;">)</span>;
    u_xlat16_2.xyz = u_xlat16_2.xyz * vec3<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">416666657</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">416666657</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">416666657</span><span style="color: #bc6ec5;">)</span>;
    u_xlat16_2.xyz = <span style="color: #4f97d7;">exp2</span><span style="color: #bc6ec5;">(</span>u_xlat16_2.xyz<span style="color: #bc6ec5;">)</span>;
    u_xlat16_2.xyz = u_xlat16_2.xyz * vec3<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">05499995</span>, <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">05499995</span>, <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">05499995</span><span style="color: #bc6ec5;">)</span> + vec3<span style="color: #bc6ec5;">(</span>-0.<span style="color: #a45bad;">0549999997</span>, -0.<span style="color: #a45bad;">0549999997</span>, -0.<span style="color: #a45bad;">0549999997</span><span style="color: #bc6ec5;">)</span>;
    u_xlat0.xyz = <span style="color: #4f97d7;">max</span><span style="color: #bc6ec5;">(</span>u_xlat16_2.xyz, vec3<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #a45bad;">SV_Target0</span> = u_xlat0;
    <span style="color: #4f97d7; font-weight: bold;">return</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-csharp"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#19979;&#38754;&#20195;&#30721;&#26159; &#22270;&#29255;Gamma&#21644;Linear&#36716;&#25442;&#24037;&#20855;</span>
<span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #a45bad;">System.Collections</span>;
<span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #a45bad;">System.Collections.Generic</span>;
<span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #a45bad;">UnityEngine</span>;
<span style="color: #4f97d7; font-weight: bold;">using</span> <span style="color: #a45bad;">UnityEditor</span>;

<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">LinearGammaConvert</span> : <span style="color: #ce537a; font-weight: bold;">MonoBehaviour</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #bc6ec5;">&lt;</span><span style="color: #ce537a; font-weight: bold;">string</span><span style="color: #bc6ec5;">&gt;</span> <span style="color: #7590db;">_assetPathList</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #bc6ec5;">&lt;</span><span style="color: #ce537a; font-weight: bold;">string</span><span style="color: #bc6ec5;">&gt;()</span>;
    <span style="color: #bc6ec5;">[</span><span style="color: #ce537a; font-weight: bold;">MenuItem</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"Assets/Tools/ImageLinearToGamma"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> LinearToGamma<span style="color: #bc6ec5;">()</span>
    <span style="color: #bc6ec5;">{</span>
        _assetPathList.<span style="color: #bc6ec5; font-weight: bold;">Clear</span><span style="color: #2d9574;">()</span>;
        GetSelectionPathList<span style="color: #2d9574;">(</span>_assetPathList<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">foreach</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">path</span> <span style="color: #4f97d7; font-weight: bold;">in</span> _assetPathList<span style="color: #2d9574;">)</span>
        <span style="color: #2d9574;">{</span>
            ConvertBetweenLinearGamma<span style="color: #67b11d;">(</span>path, <span style="color: #a45bad;">true</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        _assetPathList.<span style="color: #bc6ec5; font-weight: bold;">Clear</span><span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #bc6ec5;">[</span><span style="color: #ce537a; font-weight: bold;">MenuItem</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"Assets/Tools/ImageGammaToLinear"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">]</span>
    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> GammaToLinear<span style="color: #bc6ec5;">()</span>
    <span style="color: #bc6ec5;">{</span>
        _assetPathList.<span style="color: #bc6ec5; font-weight: bold;">Clear</span><span style="color: #2d9574;">()</span>;
        GetSelectionPathList<span style="color: #2d9574;">(</span>_assetPathList<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">foreach</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">path</span> <span style="color: #4f97d7; font-weight: bold;">in</span> _assetPathList<span style="color: #2d9574;">)</span>
        <span style="color: #2d9574;">{</span>
            ConvertBetweenLinearGamma<span style="color: #67b11d;">(</span>path, <span style="color: #a45bad;">false</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        _assetPathList.<span style="color: #bc6ec5; font-weight: bold;">Clear</span><span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">GetSelectionPathList</span><span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #2d9574;">&lt;</span><span style="color: #ce537a; font-weight: bold;">string</span><span style="color: #2d9574;">&gt;</span> <span style="color: #7590db;">pathList</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span><span style="color: #2d9574;">(</span>Selection.objects!=<span style="color: #a45bad;">null</span><span style="color: #2d9574;">)</span>
        <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">foreach</span><span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">obj</span> <span style="color: #4f97d7; font-weight: bold;">in</span> Selection.objects<span style="color: #67b11d;">)</span>
            <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">path</span> = AssetDatabase.<span style="color: #bc6ec5; font-weight: bold;">GetAssetPath</span><span style="color: #b1951d;">(</span>obj<span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">if</span><span style="color: #b1951d;">(</span>!<span style="color: #ce537a; font-weight: bold;">string</span>.<span style="color: #bc6ec5; font-weight: bold;">IsNullOrEmpty</span><span style="color: #4f97d7;">(</span>path<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>
                <span style="color: #b1951d;">{</span>
                    pathList.<span style="color: #bc6ec5; font-weight: bold;">Add</span><span style="color: #4f97d7;">(</span>path<span style="color: #4f97d7;">)</span>;
                <span style="color: #b1951d;">}</span>
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">ConvertBetweenLinearGamma</span><span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">string</span> <span style="color: #7590db;">imgPath</span>, <span style="color: #ce537a; font-weight: bold;">bool</span> <span style="color: #7590db;">isToGamma</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">string</span>.<span style="color: #bc6ec5; font-weight: bold;">IsNullOrEmpty</span><span style="color: #67b11d;">(</span>imgPath<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span>;

        <span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">textureImportor</span> = AssetImporter.<span style="color: #bc6ec5; font-weight: bold;">GetAtPath</span><span style="color: #2d9574;">(</span>imgPath<span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">as</span> <span style="color: #ce537a; font-weight: bold;">TextureImporter</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>textureImportor == <span style="color: #a45bad;">null</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span>;

        textureImportor.isReadable = <span style="color: #a45bad;">true</span>;
        textureImportor.sRGBTexture = !isToGamma;
        textureImportor.textureCompression = TextureImporterCompression.Uncompressed;
        textureImportor.<span style="color: #bc6ec5; font-weight: bold;">SaveAndReimport</span><span style="color: #2d9574;">()</span>;

        <span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">texture</span> = AssetDatabase.LoadAssetAtPath<span style="color: #2d9574;">&lt;</span>Texture2D<span style="color: #2d9574;">&gt;(</span>imgPath<span style="color: #2d9574;">)</span>;
        <span style="color: #ce537a; font-weight: bold;">float</span> <span style="color: #7590db;">gammaValue</span> = isToGamma ? <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">4545f</span> : <span style="color: #a45bad;">2</span>.<span style="color: #a45bad;">2f</span>;
        <span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">pixels</span> = texture.<span style="color: #bc6ec5; font-weight: bold;">GetPixels</span><span style="color: #2d9574;">()</span>;
        <span style="color: #4f97d7; font-weight: bold;">for</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">i</span>=<span style="color: #a45bad;">0</span>; i&lt;pixels.Length; i++<span style="color: #2d9574;">)</span>
        <span style="color: #2d9574;">{</span>

            pixels<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>.r = Mathf.<span style="color: #bc6ec5; font-weight: bold;">Pow</span><span style="color: #67b11d;">(</span>pixels<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>.r, gammaValue<span style="color: #67b11d;">)</span>;
            pixels<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>.g = Mathf.<span style="color: #bc6ec5; font-weight: bold;">Pow</span><span style="color: #67b11d;">(</span>pixels<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>.g, gammaValue<span style="color: #67b11d;">)</span>;
            pixels<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>.b = Mathf.<span style="color: #bc6ec5; font-weight: bold;">Pow</span><span style="color: #67b11d;">(</span>pixels<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>.b, gammaValue<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        texture.<span style="color: #bc6ec5; font-weight: bold;">SetPixels</span><span style="color: #2d9574;">(</span>pixels<span style="color: #2d9574;">)</span>;
        texture.<span style="color: #bc6ec5; font-weight: bold;">Apply</span><span style="color: #2d9574;">()</span>;
        System.IO.File.<span style="color: #bc6ec5; font-weight: bold;">WriteAllBytes</span><span style="color: #2d9574;">(</span>imgPath, texture.<span style="color: #bc6ec5; font-weight: bold;">EncodeToTGA</span><span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org29f5a48" class="outline-6">
<h6 id="org29f5a48">DetailTex 叠加到 MainTex 上为什么需要乘二？</h6>
<div class="outline-text-6" id="text-org29f5a48">
<p>
MainTex 颜色范围为[0-1] DetailTex 颜色范围也为[0-1], 如果将 DetailTex 制作为灰度图并且颜色值取 0.5，那么 MainTex*DetailTex*2 可以保证图片亮度不会变化。DetailTex 颜色值小于 0.5 的地方就会减低颜色亮度，大于 0.5 的地方就会提高颜色亮度。<br />
但是，当 Unity 引擎切换到线性空间，乘二是不正确的。DetailTex 转化为线性空间时，0.5 的 DetailTex 颜色值会变为 \(0.5^{2.2}=0.2176\) ,乘二后为 0.4352, 所以颜色亮度会减低。最好的解决方案是当 Unity 引擎切换到线性空间时，应该乘 \(frac{1}{0.5^{2.2}}=frac{1}{0.2176}=4.5956\)<br />
Unity 中 unity_ColorSpaceDouble 用来处理不同的颜色空间乘不同的值。<br />
</p>
</div>
</div>
<div id="outline-container-orgc5c41c5" class="outline-6">
<h6 id="orgc5c41c5">SetVector SetColor</h6>
<div class="outline-text-6" id="text-orgc5c41c5">
<p>
GammaSpace 下，SetVector SetColor 效果没有差别。下图为设置颜色值为(0.5, 0, 0)<br />
<img src="./UnityCatLikeCoding/01_03ct_gamma_SetValue.png" alt="01_03ct_gamma_SetValue.png" /><br />
LinearSpace 下，SetVector SetColor 效果会有明显差别。下图为设置颜色值为(0.5, 0, 0)<br />
<img src="./UnityCatLikeCoding/01_03ct_linear_SetValue.png" alt="01_03ct_linear_SetValue.png" /><br />
</p>

<p>
编辑器中设置的值和 Shader Property List 中设置的值是相同的。<br />
</p>

<ul class="org-ul">
<li>官网文档说明 <a href="https://docs.unity3d.com/ScriptReference/Material.SetVector.html">https://docs.unity3d.com/ScriptReference/Material.SetVector.html</a><br /></li>
</ul>
</div>
</div>
<div id="outline-container-orgd27fb44" class="outline-6">
<h6 id="orgd27fb44">参考资料</h6>
<div class="outline-text-6" id="text-orgd27fb44">
<ul class="org-ul">
<li>Gamma 空间是什么，为什么我们需要它 <a href="https://blog.csdn.net/qq_18229381/article/details/78053018">https://blog.csdn.net/qq_18229381/article/details/78053018</a><br /></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-orge4e9e30" class="outline-4">
<h4 id="orge4e9e30">The First Light</h4>
<div class="outline-text-4" id="text-orge4e9e30">
</div>
<div id="outline-container-org17e7e1e" class="outline-5">
<h5 id="org17e7e1e">normal 从物体空间到世界空间的变换</h5>
<div class="outline-text-5" id="text-org17e7e1e">
<div class="org-src-container">
<pre class="src src-shader"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">obj to world</span>
i.normal = <span style="color: #4f97d7;">mul</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">transpose</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">float3x3</span><span style="color: #2d9574;">)</span>unity_WorldToObject<span style="color: #bc6ec5;">)</span>, v.normal<span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">inline</span> <span style="color: #ce537a; font-weight: bold;">float3</span> UnityObjectToWorldNormal<span style="color: #4f97d7;">(</span> <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #ce537a; font-weight: bold;">float3</span> norm <span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
<span style="color: #bc6ec5;">#ifdef</span> UNITY_ASSUME_UNIFORM_SCALING
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5; font-weight: bold;">UnityObjectToWorldDir</span><span style="color: #bc6ec5;">(</span>norm<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#25913;&#21464;&#24038;&#20056; &#21491;&#20056;&#39034;&#24207; &#31561;&#20215;&#20110; &#30697;&#38453;&#36716;&#32622;</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">mul(IT_M, norm) =&gt; mul(norm, I_M) =&gt; {dot(norm, I_M.col0), dot(norm, I_M.col1), dot(norm, I_M.col2)}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5; font-weight: bold;">normalize</span><span style="color: #bc6ec5;">(</span><span style="color: #4f97d7;">mul</span><span style="color: #2d9574;">(</span>norm, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">float3x3</span><span style="color: #67b11d;">)</span>unity_WorldToObject<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgee461e0" class="outline-5">
<h5 id="orgee461e0">Tags LightMode=ForwardBase</h5>
<div class="outline-text-5" id="text-orgee461e0">
<p>
定义该 Tags 才可以在 shader 中访问场景中主方向光的信息。<br />
</p>
</div>
</div>

<div id="outline-container-orgc13b243" class="outline-5">
<h5 id="orgc13b243">BlinnPhong</h5>
<div class="outline-text-5" id="text-orgc13b243">
<p>
视角不逆光时的显示效果如下：<br />
<img src="./UnityCatLikeCoding/01_04fl_blinnphone.png" alt="01_04fl_blinnphone.png" /><br />
</p>

<p>
视角逆光时会有显示错误。错误如下图：<br />
<img src="./UnityCatLikeCoding/01_04fl_blinnphone_error.png" alt="01_04fl_blinnphone_error.png" /><br />
</p>
</div>
</div>
<div id="outline-container-orge8b9a73" class="outline-5">
<h5 id="orge8b9a73">Energy Conservation</h5>
<div class="outline-text-5" id="text-orge8b9a73">
<div class="org-src-container">
<pre class="src src-shader"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Unity &#23454;&#29616;&#30340;&#33021;&#37327;&#23432;&#24658; UnityStandardUtils.cginc</span>

<span style="color: #ce537a; font-weight: bold;">half</span> <span style="color: #bc6ec5; font-weight: bold;">SpecularStrength</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">half3</span> specular<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
<span style="color: #bc6ec5;">    #if</span> <span style="color: #bc6ec5;">(</span>SHADER_TARGET &lt; <span style="color: #a45bad;">30</span><span style="color: #bc6ec5;">)</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">SM2.0: instruction count limitation</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">SM2.0: simplified SpecularStrength</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> specular.r; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Red channel - because most metals are either monocrhome or with redish/yellowish tint</span>
<span style="color: #bc6ec5;">    #else</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5; font-weight: bold;">max</span> <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7;">max</span> <span style="color: #2d9574;">(</span>specular.r, specular.g<span style="color: #2d9574;">)</span>, specular.b<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">    #endif</span>
<span style="color: #4f97d7;">}</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Diffuse/Spec Energy conservation</span>
<span style="color: #4f97d7; font-weight: bold;">inline</span> <span style="color: #ce537a; font-weight: bold;">half3</span> EnergyConservationBetweenDiffuseAndSpecular <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">half3</span> albedo, <span style="color: #ce537a; font-weight: bold;">half3</span> specColor, <span style="color: #4f97d7; font-weight: bold;">out</span> <span style="color: #ce537a; font-weight: bold;">half</span> oneMinusReflectivity<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    oneMinusReflectivity = <span style="color: #a45bad;">1</span> - SpecularStrength<span style="color: #bc6ec5;">(</span>specColor<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">    #if</span> !UNITY_CONSERVE_ENERGY
        <span style="color: #4f97d7; font-weight: bold;">return</span> albedo;
<span style="color: #bc6ec5;">    #elif</span> UNITY_CONSERVE_ENERGY_MONOCHROME
        <span style="color: #4f97d7; font-weight: bold;">return</span> albedo * oneMinusReflectivity;
<span style="color: #bc6ec5;">    #else</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> albedo * <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">half3</span><span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> - specColor<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">    #endif</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8af1bff" class="outline-5">
<h5 id="org8af1bff">Specular / Metallic Workflow</h5>
<div class="outline-text-5" id="text-org8af1bff">
</div>
<div id="outline-container-orge812265" class="outline-6">
<h6 id="orge812265">Specular Workflow</h6>
<div class="outline-text-6" id="text-orge812265">
<p>
Specular Workflow 中将 Specular Color 的强度提高来实现金属材质。将 Specular Color 的强度减弱来实现非金属材质。<br />
</p>
<div class="org-src-container">
<pre class="src src-shader"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#40664;&#35748;&#26159; Specular Workflow</span>
<span style="color: #bc6ec5;">#ifndef</span> UNITY_SETUP_BRDF_INPUT
<span style="color: #bc6ec5;">    #define</span> UNITY_SETUP_BRDF_INPUT SpecularSetup
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #4f97d7; font-weight: bold;">inline</span> FragmentCommonData SpecularSetup <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">float4</span> i_tex<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">half4</span> specGloss = SpecularGloss<span style="color: #bc6ec5;">(</span>i_tex.xy<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">half3</span> specColor = specGloss.rgb;
    <span style="color: #ce537a; font-weight: bold;">half</span> smoothness = specGloss.a;

    <span style="color: #ce537a; font-weight: bold;">half</span> oneMinusReflectivity;
    <span style="color: #ce537a; font-weight: bold;">half3</span> diffColor = EnergyConservationBetweenDiffuseAndSpecular <span style="color: #bc6ec5;">(</span>Albedo<span style="color: #2d9574;">(</span>i_tex<span style="color: #2d9574;">)</span>, specColor, <span style="color: #2aa1ae; background-color: #292e34;">/*</span><span style="color: #2aa1ae; background-color: #292e34;">out*/</span> oneMinusReflectivity<span style="color: #bc6ec5;">)</span>;

    FragmentCommonData o = <span style="color: #bc6ec5;">(</span>FragmentCommonData<span style="color: #bc6ec5;">)</span><span style="color: #a45bad;">0</span>;
    o.diffColor = diffColor;
    o.specColor = specColor;
    o.oneMinusReflectivity = oneMinusReflectivity;
    o.smoothness = smoothness;
    <span style="color: #4f97d7; font-weight: bold;">return</span> o;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Diffuse/Spec Energy conservation</span>
<span style="color: #4f97d7; font-weight: bold;">inline</span> <span style="color: #ce537a; font-weight: bold;">half3</span> EnergyConservationBetweenDiffuseAndSpecular <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">half3</span> albedo, <span style="color: #ce537a; font-weight: bold;">half3</span> specColor, <span style="color: #4f97d7; font-weight: bold;">out</span> <span style="color: #ce537a; font-weight: bold;">half</span> oneMinusReflectivity<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    oneMinusReflectivity = <span style="color: #a45bad;">1</span> - SpecularStrength<span style="color: #bc6ec5;">(</span>specColor<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">    #if</span> !UNITY_CONSERVE_ENERGY
        <span style="color: #4f97d7; font-weight: bold;">return</span> albedo;
<span style="color: #bc6ec5;">    #elif</span> UNITY_CONSERVE_ENERGY_MONOCHROME
        <span style="color: #4f97d7; font-weight: bold;">return</span> albedo * oneMinusReflectivity;
<span style="color: #bc6ec5;">    #else</span> <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35813;&#24773;&#20917;&#19979;&#65292;&#22914;&#26524; specColor &#19981;&#26159;&#28784;&#24230;&#22270;&#65292;diffuse &#39068;&#33394;&#20250;&#26174;&#31034;&#24322;&#24120;</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> albedo * <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">half3</span><span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span>,<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> - specColor<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">    #endif</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">half</span> <span style="color: #bc6ec5; font-weight: bold;">SpecularStrength</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">half3</span> specular<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
<span style="color: #bc6ec5;">    #if</span> <span style="color: #bc6ec5;">(</span>SHADER_TARGET &lt; <span style="color: #a45bad;">30</span><span style="color: #bc6ec5;">)</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">SM2.0: instruction count limitation</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">SM2.0: simplified SpecularStrength</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> specular.r; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Red channel - because most metals are either monocrhome or with redish/yellowish tint</span>
<span style="color: #bc6ec5;">    #else</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5; font-weight: bold;">max</span> <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7;">max</span> <span style="color: #2d9574;">(</span>specular.r, specular.g<span style="color: #2d9574;">)</span>, specular.b<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">    #endif</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb76537d" class="outline-6">
<h6 id="orgb76537d">Metallic Workflow</h6>
<div class="outline-text-6" id="text-orgb76537d">
<p>
Metallic Workflow 中通过金属度来实现金属和非金属材质。<br />
</p>
<div class="org-src-container">
<pre class="src src-shader"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22312;&#33258;&#24049;&#30340; shader &#20013;&#23450;&#20041; UNITY_SETUP_BRDF_INPUT = MetallicSetup &#26469;&#25351;&#23450;&#20351;&#29992; Metallic &#27969;&#31243;</span>
<span style="color: #4f97d7; font-weight: bold;">CGINCLUDE</span>
<span style="color: #bc6ec5;">    #define</span> UNITY_SETUP_BRDF_INPUT MetallicSetup
<span style="color: #4f97d7; font-weight: bold;">ENDCG</span>

<span style="color: #4f97d7; font-weight: bold;">inline</span> FragmentCommonData MetallicSetup <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">float4</span> i_tex<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">half2</span> metallicGloss = MetallicGloss<span style="color: #bc6ec5;">(</span>i_tex.xy<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">half</span> metallic = metallicGloss.x;
    <span style="color: #ce537a; font-weight: bold;">half</span> smoothness = metallicGloss.y; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">this is 1 minus the square root of real roughness m.</span>

    <span style="color: #ce537a; font-weight: bold;">half</span> oneMinusReflectivity;
    <span style="color: #ce537a; font-weight: bold;">half3</span> specColor;
    <span style="color: #ce537a; font-weight: bold;">half3</span> diffColor = DiffuseAndSpecularFromMetallic <span style="color: #bc6ec5;">(</span>Albedo<span style="color: #2d9574;">(</span>i_tex<span style="color: #2d9574;">)</span>, metallic, <span style="color: #2aa1ae; background-color: #292e34;">/*</span><span style="color: #2aa1ae; background-color: #292e34;">out*/</span> specColor, <span style="color: #2aa1ae; background-color: #292e34;">/*</span><span style="color: #2aa1ae; background-color: #292e34;">out*/</span> oneMinusReflectivity<span style="color: #bc6ec5;">)</span>;

    FragmentCommonData o = <span style="color: #bc6ec5;">(</span>FragmentCommonData<span style="color: #bc6ec5;">)</span><span style="color: #a45bad;">0</span>;
    o.diffColor = diffColor;
    o.specColor = specColor;
    o.oneMinusReflectivity = oneMinusReflectivity;
    o.smoothness = smoothness;
    <span style="color: #4f97d7; font-weight: bold;">return</span> o;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">inline</span> <span style="color: #ce537a; font-weight: bold;">half3</span> DiffuseAndSpecularFromMetallic <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">half3</span> albedo, <span style="color: #ce537a; font-weight: bold;">half</span> metallic, <span style="color: #4f97d7; font-weight: bold;">out</span> <span style="color: #ce537a; font-weight: bold;">half3</span> specColor, <span style="color: #4f97d7; font-weight: bold;">out</span> <span style="color: #ce537a; font-weight: bold;">half</span> oneMinusReflectivity<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    specColor = <span style="color: #4f97d7;">lerp</span> <span style="color: #bc6ec5;">(</span>unity_ColorSpaceDielectricSpec.rgb, albedo, metallic<span style="color: #bc6ec5;">)</span>;
    oneMinusReflectivity = OneMinusReflectivityFromMetallic<span style="color: #bc6ec5;">(</span>metallic<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> albedo * oneMinusReflectivity;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#24120;&#37327;&#23450;&#20041;</span>
<span style="color: #bc6ec5;">#ifdef</span> UNITY_COLORSPACE_GAMMA
<span style="color: #bc6ec5;">  #define</span> unity_ColorSpaceGrey <span style="color: #ce537a; font-weight: bold;">fixed4</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">5</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">5</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">5</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">5</span><span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">  #define</span> unity_ColorSpaceDouble <span style="color: #ce537a; font-weight: bold;">fixed4</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">2</span>.<span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">2</span>.<span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">2</span>.<span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">2</span>.<span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">  #define</span> unity_ColorSpaceDielectricSpec <span style="color: #ce537a; font-weight: bold;">half4</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">220916301</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">220916301</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">220916301</span>, <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">0</span> - <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">220916301</span><span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">  #define</span> unity_ColorSpaceLuminance <span style="color: #ce537a; font-weight: bold;">half4</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">22</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">707</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">071</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Legacy: alpha is set to 0.0 to specify gamma mode</span>
<span style="color: #bc6ec5;">#else</span> <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Linear values</span>
<span style="color: #bc6ec5;">  #define</span> unity_ColorSpaceGrey <span style="color: #ce537a; font-weight: bold;">fixed4</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">214041144</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">214041144</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">214041144</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">5</span><span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">  #define</span> unity_ColorSpaceDouble <span style="color: #ce537a; font-weight: bold;">fixed4</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">4</span>.<span style="color: #a45bad;">59479380</span>, <span style="color: #a45bad;">4</span>.<span style="color: #a45bad;">59479380</span>, <span style="color: #a45bad;">4</span>.<span style="color: #a45bad;">59479380</span>, <span style="color: #a45bad;">2</span>.<span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">  #define</span> unity_ColorSpaceDielectricSpec <span style="color: #ce537a; font-weight: bold;">half4</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">04</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">04</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">04</span>, <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">0</span> - <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">04</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">standard dielectric reflectivity coef at incident angle (= 4%)</span>
<span style="color: #bc6ec5;">  #define</span> unity_ColorSpaceLuminance <span style="color: #ce537a; font-weight: bold;">half4</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">0396819152</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">458021790</span>, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">00609653955</span>, <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Legacy: alpha is set to 1.0 to specify linear mode</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #4f97d7; font-weight: bold;">inline</span> <span style="color: #ce537a; font-weight: bold;">half</span> OneMinusReflectivityFromMetallic<span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">half</span> metallic<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">We'll need oneMinusReflectivity, so</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//   </span><span style="color: #2aa1ae; background-color: #292e34;">1-reflectivity = 1-lerp(dielectricSpec, 1, metallic) = lerp(1-dielectricSpec, 0, metallic)</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">store (1-dielectricSpec) in unity_ColorSpaceDielectricSpec.a, then</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//   </span><span style="color: #2aa1ae; background-color: #292e34;">1-reflectivity = lerp(alpha, 0, metallic) = alpha + metallic*(0 - alpha) =</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//                  </span><span style="color: #2aa1ae; background-color: #292e34;">= alpha - metallic * alpha</span>
    <span style="color: #ce537a; font-weight: bold;">half</span> oneMinusDielectricSpec = unity_ColorSpaceDielectricSpec.a;
    <span style="color: #4f97d7; font-weight: bold;">return</span> oneMinusDielectricSpec - metallic * oneMinusDielectricSpec;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org3263b6b" class="outline-4">
<h4 id="org3263b6b">Multi Lights</h4>
<div class="outline-text-4" id="text-org3263b6b">
</div>
<div id="outline-container-org1829e8a" class="outline-5">
<h5 id="org1829e8a">Light Attenuation</h5>
<div class="outline-text-5" id="text-org1829e8a">
<div class="org-src-container">
<pre class="src src-shader"><span style="color: #bc6ec5;">#ifdef</span> POINT
<span style="color: #ce537a; font-weight: bold;">sampler2D_float</span> <span style="color: #7590db;">_LightTexture0</span>;
unityShadowCoord4x4 unity_WorldToLight;
<span style="color: #bc6ec5;">    #define</span> UNITY_LIGHT_ATTENUATION<span style="color: #4f97d7;">(</span>destName, input, worldPos<span style="color: #4f97d7;">)</span> \
    unityShadowCoord3 lightCoord = <span style="color: #4f97d7;">mul</span><span style="color: #4f97d7;">(</span>unity_WorldToLight, unityShadowCoord4<span style="color: #bc6ec5;">(</span>worldPos, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>.xyz; \
    <span style="color: #ce537a; font-weight: bold;">fixed</span> shadow = UNITY_SHADOW_ATTENUATION<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span>; \
    <span style="color: #ce537a; font-weight: bold;">fixed</span> destName = <span style="color: #4f97d7;">tex2D</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_LightTexture0</span>, <span style="color: #4f97d7;">dot</span><span style="color: #bc6ec5;">(</span>lightCoord, lightCoord<span style="color: #bc6ec5;">)</span>.rr<span style="color: #4f97d7;">)</span>.r * shadow;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> SPOT
    <span style="color: #ce537a; font-weight: bold;">sampler2D_float</span> <span style="color: #7590db;">_LightTexture0</span>;
    unityShadowCoord4x4 unity_WorldToLight;
    <span style="color: #ce537a; font-weight: bold;">sampler2D_float</span> <span style="color: #7590db;">_LightTextureB0</span>;
    <span style="color: #4f97d7; font-weight: bold;">inline</span> <span style="color: #ce537a; font-weight: bold;">fixed</span> UnitySpotCookie<span style="color: #4f97d7;">(</span>unityShadowCoord4 LightCoord<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#37319;&#26679;&#26102;&#20174;&#40784;&#27425;&#22352;&#26631;&#31995;&#36716;&#25442;&#21040;&#27431;&#25289;&#22352;&#26631;&#31995;</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20559;&#31227; 0.5 &#36825;&#26679;&#28783;&#20809;&#22352;&#26631;&#31995;&#21407;&#28857;&#23601;&#21644;&#22270;&#29255;&#20013;&#24515;&#28857;&#23545;&#24212;&#20102;</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5; font-weight: bold;">tex2D</span><span style="color: #bc6ec5;">(</span><span style="color: #7590db;">_LightTexture0</span>, LightCoord.xy / LightCoord.w + <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">)</span>.w;
    <span style="color: #4f97d7;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">inline</span> <span style="color: #ce537a; font-weight: bold;">fixed</span> UnitySpotAttenuate<span style="color: #4f97d7;">(</span>unityShadowCoord3 LightCoord<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20351;&#29992;RenderDoc &#25130;&#21462;_LightTextureB0 &#23545;&#24212;&#30340;&#22270;&#29255;&#36164;&#28304;&#65292;&#21457;&#29616;&#20854;&#20026;1024x1&#30340;&#20174;1&#21040;0&#34928;&#20943;&#30340;&#22270;&#29255;</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5; font-weight: bold;">tex2D</span><span style="color: #bc6ec5;">(</span><span style="color: #7590db;">_LightTextureB0</span>, <span style="color: #4f97d7;">dot</span><span style="color: #2d9574;">(</span>LightCoord, LightCoord<span style="color: #2d9574;">)</span>.xx<span style="color: #bc6ec5;">)</span>.r;
    <span style="color: #4f97d7;">}</span>
<span style="color: #bc6ec5;">    #if</span> !defined<span style="color: #4f97d7;">(</span>UNITY_HALF_PRECISION_FRAGMENT_SHADER_REGISTERS<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">        #define</span> DECLARE_LIGHT_COORD<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span> unityShadowCoord4 lightCoord = <span style="color: #4f97d7;">mul</span><span style="color: #4f97d7;">(</span>unity_WorldToLight, unityShadowCoord4<span style="color: #bc6ec5;">(</span>worldPos, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">    #else</span>
<span style="color: #bc6ec5;">        #define</span> DECLARE_LIGHT_COORD<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span> unityShadowCoord4 lightCoord = input.<span style="color: #7590db;">_LightCoord</span>
<span style="color: #bc6ec5;">    #endif</span>
<span style="color: #bc6ec5;">    #define</span> UNITY_LIGHT_ATTENUATION<span style="color: #4f97d7;">(</span>destName, input, worldPos<span style="color: #4f97d7;">)</span> \
        DECLARE_LIGHT_COORD<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span>; \
        <span style="color: #ce537a; font-weight: bold;">fixed</span> shadow = UNITY_SHADOW_ATTENUATION<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span>; \
        <span style="color: #ce537a; font-weight: bold;">fixed</span> destName = <span style="color: #4f97d7;">(</span>lightCoord.z &gt; <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> * UnitySpotCookie<span style="color: #4f97d7;">(</span>lightCoord<span style="color: #4f97d7;">)</span> * UnitySpotAttenuate<span style="color: #4f97d7;">(</span>lightCoord.xyz<span style="color: #4f97d7;">)</span> * shadow;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> DIRECTIONAL
<span style="color: #bc6ec5;">    #define</span> UNITY_LIGHT_ATTENUATION<span style="color: #4f97d7;">(</span>destName, input, worldPos<span style="color: #4f97d7;">)</span> <span style="color: #ce537a; font-weight: bold;">fixed</span> destName = UNITY_SHADOW_ATTENUATION<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> POINT_COOKIE
    <span style="color: #ce537a; font-weight: bold;">samplerCUBE_float</span> <span style="color: #7590db;">_LightTexture0</span>;
    unityShadowCoord4x4 unity_WorldToLight;
    <span style="color: #ce537a; font-weight: bold;">sampler2D_float</span> <span style="color: #7590db;">_LightTextureB0</span>;
<span style="color: #bc6ec5;">    #if</span> !defined<span style="color: #4f97d7;">(</span>UNITY_HALF_PRECISION_FRAGMENT_SHADER_REGISTERS<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">        #define</span> DECLARE_LIGHT_COORD<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span> unityShadowCoord3 lightCoord = <span style="color: #4f97d7;">mul</span><span style="color: #4f97d7;">(</span>unity_WorldToLight, unityShadowCoord4<span style="color: #bc6ec5;">(</span>worldPos, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>.xyz
<span style="color: #bc6ec5;">    #else</span>
<span style="color: #bc6ec5;">        #define</span> DECLARE_LIGHT_COORD<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span> unityShadowCoord3 lightCoord = input.<span style="color: #7590db;">_LightCoord</span>
<span style="color: #bc6ec5;">    #endif</span>
<span style="color: #bc6ec5;">    #define</span> UNITY_LIGHT_ATTENUATION<span style="color: #4f97d7;">(</span>destName, input, worldPos<span style="color: #4f97d7;">)</span> \
        DECLARE_LIGHT_COORD<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span>; \
        <span style="color: #ce537a; font-weight: bold;">fixed</span> shadow = UNITY_SHADOW_ATTENUATION<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span>; \
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20351;&#29992;RenderDoc &#25130;&#21462;_LightTextureB0 &#23545;&#24212;&#30340;&#22270;&#29255;&#36164;&#28304;&#65292;&#21457;&#29616;&#20854;&#20026;1024x1&#30340;&#20174;1&#21040;0&#34928;&#20943;&#30340;&#22270;&#29255;</span>
        <span style="color: #ce537a; font-weight: bold;">fixed</span> destName = <span style="color: #4f97d7;">tex2D</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_LightTextureB0</span>, <span style="color: #4f97d7;">dot</span><span style="color: #bc6ec5;">(</span>lightCoord, lightCoord<span style="color: #bc6ec5;">)</span>.rr<span style="color: #4f97d7;">)</span>.r * <span style="color: #4f97d7;">texCUBE</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_LightTexture0</span>, lightCoord<span style="color: #4f97d7;">)</span>.w * shadow;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> DIRECTIONAL_COOKIE
  <span style="color: #ce537a; font-weight: bold;">sampler2D_float</span> <span style="color: #7590db;">_LightTexture0</span>;
  unityShadowCoord4x4 unity_WorldToLight;
<span style="color: #bc6ec5;">  #if</span> !defined<span style="color: #4f97d7;">(</span>UNITY_HALF_PRECISION_FRAGMENT_SHADER_REGISTERS<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">      #define</span> DECLARE_LIGHT_COORD<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span> unityShadowCoord2 lightCoord = <span style="color: #4f97d7;">mul</span><span style="color: #4f97d7;">(</span>unity_WorldToLight, unityShadowCoord4<span style="color: #bc6ec5;">(</span>worldPos, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>.xy
<span style="color: #bc6ec5;">  #else</span>
<span style="color: #bc6ec5;">      #define</span> DECLARE_LIGHT_COORD<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span> unityShadowCoord2 lightCoord = input.<span style="color: #7590db;">_LightCoord</span>
<span style="color: #bc6ec5;">  #endif</span>
<span style="color: #bc6ec5;">  #define</span> UNITY_LIGHT_ATTENUATION<span style="color: #4f97d7;">(</span>destName, input, worldPos<span style="color: #4f97d7;">)</span> \
      DECLARE_LIGHT_COORD<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span>; \
      <span style="color: #ce537a; font-weight: bold;">fixed</span> shadow = UNITY_SHADOW_ATTENUATION<span style="color: #4f97d7;">(</span>input, worldPos<span style="color: #4f97d7;">)</span>; \
      <span style="color: #ce537a; font-weight: bold;">fixed</span> destName = <span style="color: #4f97d7;">tex2D</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_LightTexture0</span>, lightCoord<span style="color: #4f97d7;">)</span>.w * shadow;
<span style="color: #bc6ec5;">#endif</span>
</pre>
</div>
</div>
<div id="outline-container-org72bfc6f" class="outline-6">
<h6 id="org72bfc6f">Point Light</h6>
<div class="outline-text-6" id="text-org72bfc6f">
<div class="org-src-container">
<pre class="src src-shader"><span style="color: #ce537a; font-weight: bold;">half3</span> lightVector = <span style="color: #7590db;">_WorldSpaceLightPos0</span>.xyz - i.worldPos;
light.dir = <span style="color: #4f97d7;">normalize</span><span style="color: #4f97d7;">(</span>lightVector<span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20998;&#27597;&#20013;&#21152; 1 &#26159;&#20026;&#20102;&#36991;&#20813;&#29289;&#20307;&#21040;&#20809;&#28304;&#36317;&#31163;&#23567;&#20110; 1 &#26102;&#65292;&#20809;&#29031;&#24378;&#24230;&#34987;&#25918;&#22823;</span>
<span style="color: #ce537a; font-weight: bold;">half</span> attenuation = <span style="color: #a45bad;">1</span> / <span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span> + <span style="color: #4f97d7;">dot</span><span style="color: #bc6ec5;">(</span>lightVector, lightVector<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
light.color = <span style="color: #7590db;">_LightColor0</span>.rgb * attenuation;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgaffc8cb" class="outline-5">
<h5 id="orgaffc8cb">Mixing Lights</h5>
<div class="outline-text-5" id="text-orgaffc8cb">
<p>
通过增加 shader 变体来实现对混合灯光的支持。<br />
</p>

<div class="org-src-container">
<pre class="src src-shader"><span style="color: #bc6ec5;">#pragma</span> multi_compile DIRECTIONAL POINT
</pre>
</div>
</div>
</div>
<div id="outline-container-org6535ae8" class="outline-5">
<h5 id="org6535ae8">Cookies</h5>
<div class="outline-text-5" id="text-org6535ae8">
<p>
Spot Light 默认支持 Cookie，Spot Light 的形状是通过 Cookie 来实现。SpotLight 的 Cookie 贴图的 Wrap 模式采用 Clamp。<br />
Direcional 默认不支持 Cookie，需要通过 shader 变体开启支持。其 Cookie 贴图的 Wrap 模式采用 Repeat。<br />
Point 默认不支持 Cookie，需要通过 shader 变体开启支持。其 Cookie 贴图是 Cube 贴图，Wrap 模式采用 Clamp。<br />
</p>
<div class="org-src-container">
<pre class="src src-shader"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#19979;&#38754;&#20195;&#30721;&#31561;&#20215;&#20110;  #pragma multi_compile_fwdadd</span>
<span style="color: #bc6ec5;">#pragma</span> multi_compile DIRECTIONAL POINT DIRECTIONAL_COOKIE POINT_COOKIE
</pre>
</div>

<ul class="org-ul">
<li>multi_compile_fwdbase 变体 <a href="https://www.cnblogs.com/sifenkesi/p/9942272.html">https://www.cnblogs.com/sifenkesi/p/9942272.html</a><br /></li>
</ul>
</div>
</div>
<div id="outline-container-orge73bb34" class="outline-5">
<h5 id="orge73bb34">Vertex Lights</h5>
<div class="outline-text-5" id="text-orge73bb34">
<p>
灯光数量增加后，drawcall 数量会成倍增加。Unity 可以设置逐像素光照的数量。如果将超出数量限制的光照直接不进行计算，会导致明显的显示错误，可以采用更廉价的顶点光照来代替像素光照。<br />
Unity 在 Base Pass 中实现顶点光照。引擎会寻找包含 VERTEXLIGHT_ON 关键字的 Base Pass 着色器。<br />
顶点光照只支持 点光源，方向光和聚光灯都能在顶点着色器中计算。<br />
在 Light 的 RenderMode 属性中，可以设置重要类型，Important 类型的光照总是逐像素光照，Not Important 类型的光照永远不会被当作逐像素光照，Auto 类型的光照其重要性由引擎来决定。<br />
</p>

<div class="org-src-container">
<pre class="src src-shader"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">UnityCG.cginc</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22312;&#39030;&#28857;&#20013;&#35745;&#31639; 4 &#20010;&#28857;&#20809;&#28304;&#20809;&#29031;&#65292;&#24403;&#20809;&#28304;&#25968;&#30446;&#19981;&#36275; 4 &#20010;&#26102;&#65292;&#35745;&#31639;&#28040;&#32791;&#20381;&#28982;&#26159; 4 &#20010;&#20809;&#29031;&#30340;&#35745;&#31639;&#37327;</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Used in ForwardBase pass: Calculates diffuse lighting from 4 point lights, with data packed in a special way.</span>
<span style="color: #ce537a; font-weight: bold;">float3</span> <span style="color: #bc6ec5; font-weight: bold;">Shade4PointLights</span> <span style="color: #4f97d7;">(</span>
    <span style="color: #ce537a; font-weight: bold;">float4</span> lightPosX, <span style="color: #ce537a; font-weight: bold;">float4</span> lightPosY, <span style="color: #ce537a; font-weight: bold;">float4</span> lightPosZ,
    <span style="color: #ce537a; font-weight: bold;">float3</span> lightColor0, <span style="color: #ce537a; font-weight: bold;">float3</span> lightColor1, <span style="color: #ce537a; font-weight: bold;">float3</span> lightColor2, <span style="color: #ce537a; font-weight: bold;">float3</span> lightColor3,
    <span style="color: #ce537a; font-weight: bold;">float4</span> lightAttenSq,
    <span style="color: #ce537a; font-weight: bold;">float3</span> pos, <span style="color: #ce537a; font-weight: bold;">float3</span> normal<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">to light vectors</span>
    <span style="color: #ce537a; font-weight: bold;">float4</span> toLightX = lightPosX - pos.x;
    <span style="color: #ce537a; font-weight: bold;">float4</span> toLightY = lightPosY - pos.y;
    <span style="color: #ce537a; font-weight: bold;">float4</span> toLightZ = lightPosZ - pos.z;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">squared lengths</span>
    <span style="color: #ce537a; font-weight: bold;">float4</span> lengthSq = <span style="color: #a45bad;">0</span>;
    lengthSq += toLightX * toLightX;
    lengthSq += toLightY * toLightY;
    lengthSq += toLightZ * toLightZ;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">don't produce NaNs if some vertex position overlaps with the light</span>
    lengthSq = <span style="color: #4f97d7;">max</span><span style="color: #bc6ec5;">(</span>lengthSq, <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">000001</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">NdotL</span>
    <span style="color: #ce537a; font-weight: bold;">float4</span> ndotl = <span style="color: #a45bad;">0</span>;
    ndotl += toLightX * normal.x;
    ndotl += toLightY * normal.y;
    ndotl += toLightZ * normal.z;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">correct NdotL</span>
    <span style="color: #ce537a; font-weight: bold;">float4</span> corr = <span style="color: #4f97d7;">rsqrt</span><span style="color: #bc6ec5;">(</span>lengthSq<span style="color: #bc6ec5;">)</span>;
    ndotl = <span style="color: #4f97d7;">max</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">float4</span><span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>, ndotl * corr<span style="color: #bc6ec5;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">attenuation</span>
    <span style="color: #ce537a; font-weight: bold;">float4</span> atten = <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">0</span> / <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">0</span> + lengthSq * lightAttenSq<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">float4</span> diff = ndotl * atten;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">final color</span>
    <span style="color: #ce537a; font-weight: bold;">float3</span> col = <span style="color: #a45bad;">0</span>;
    col += lightColor0 * diff.x;
    col += lightColor1 * diff.y;
    col += lightColor2 * diff.z;
    col += lightColor3 * diff.w;
    <span style="color: #4f97d7; font-weight: bold;">return</span> col;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6139cc2" class="outline-5">
<h5 id="org6139cc2">Spherical Harmonics</h5>
<div class="outline-text-5" id="text-org6139cc2">
</div>
<div id="outline-container-orgb5029c2" class="outline-6">
<h6 id="orgb5029c2">相关数学概念</h6>
<div class="outline-text-6" id="text-orgb5029c2">
<ul class="org-ul">
<li>球谐函数 是拉普拉斯方程的球坐标系形式解的角度部分。拉普拉斯方程在球坐标系中的表达式分离变量之后，角度部分的偏微分方程称为球函数方程。<br /></li>
<li>球坐标系 球坐标系是三维坐标系的一种，用以确定三维空间中点、线、面以及体的位置，它以坐标原点为参考点，由方位角、仰角和距离构成。球坐标系在地理学、天文学中都有着广泛应用。<br /></li>
<li>拉普拉斯方程 拉普拉斯方程为二阶偏微分方程。<br /></li>
<li>勒让德多项式<br /></li>
<li>偏微分方程 包含未知函数的偏导数(或偏微分)的方程。方程中所出现未知函数偏导数的最高阶数，称为该方程的阶。在数学、物理及工程技术中应用最广泛的，是二阶偏微分方程，习惯上把这些方程称为数学物理方程。<br /></li>
<li>偏导数 在数学中，一个多变量的函数的偏导数，就是它关于其中一个变量的导数而保持其他变量恒定（相对于全导数，在其中所有变量都允许变化）。<br /></li>
</ul>
</div>

<ul class="org-ul">
<li><a id="org05105f8"></a>参考资料<br />
<div class="outline-text-7" id="text-org05105f8">
<ul class="org-ul">
<li><a href="https://zh.wikipedia.org/wiki/%E7%90%83%E8%B0%90%E5%87%BD%E6%95%B0">https://zh.wikipedia.org/wiki/%E7%90%83%E8%B0%90%E5%87%BD%E6%95%B0</a><br /></li>
<li><a href="https://baike.baidu.com/item/%E7%90%83%E8%B0%90%E5%87%BD%E6%95%B0">https://baike.baidu.com/item/%E7%90%83%E8%B0%90%E5%87%BD%E6%95%B0</a><br /></li>
<li><a href="https://baike.baidu.com/item/%E7%90%83%E5%9D%90%E6%A0%87%E7%B3%BB">https://baike.baidu.com/item/%E7%90%83%E5%9D%90%E6%A0%87%E7%B3%BB</a><br /></li>
<li><a href="https://baike.baidu.com/item/Legendre%E5%A4%9A%E9%A1%B9%E5%BC%8F">https://baike.baidu.com/item/Legendre%E5%A4%9A%E9%A1%B9%E5%BC%8F</a><br /></li>
<li><a href="https://baike.baidu.com/item/%E6%8B%89%E6%99%AE%E6%8B%89%E6%96%AF%E6%96%B9%E7%A8%8B">https://baike.baidu.com/item/%E6%8B%89%E6%99%AE%E6%8B%89%E6%96%AF%E6%96%B9%E7%A8%8B</a><br /></li>
<li><a href="https://baike.baidu.com/item/%E5%81%8F%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B">https://baike.baidu.com/item/%E5%81%8F%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B</a><br /></li>
<li><a href="https://baike.baidu.com/item/%E5%81%8F%E5%AF%BC%E6%95%B0">https://baike.baidu.com/item/%E5%81%8F%E5%AF%BC%E6%95%B0</a><br /></li>
<li>球谐函数是什么？<a href="https://www.zhihu.com/question/26405495">https://www.zhihu.com/question/26405495</a><br /></li>
<li>Unity 渲染教程（五）：多个光源 <a href="http://gad.qq.com/program/translateview/7173934">http://gad.qq.com/program/translateview/7173934</a><br /></li>
<li>UnityShader——球谐光照 <a href="https://blog.csdn.net/NotMz/article/details/78339913">https://blog.csdn.net/NotMz/article/details/78339913</a><br /></li>
<li>球谐光照（spherical harmonic lighting）解析 <a href="https://gameinstitute.qq.com/community/detail/123183">https://gameinstitute.qq.com/community/detail/123183</a>  (该篇文章讲解通俗易懂，有道笔记中做了备份)<br /></li>
<li>球谐光照 (一)从拉普拉斯方程到球谐函数 <a href="https://zhuanlan.zhihu.com/p/66989673">https://zhuanlan.zhihu.com/p/66989673</a><br /></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org1bc83d3" class="outline-6">
<h6 id="org1bc83d3">原理概述</h6>
<div class="outline-text-6" id="text-org1bc83d3">
<p>
球谐函数背后的思想是你可以只用一个连续函数来描述所有入射光在某个点的效果，这个函数定义在球的表面。<br />
通常来说，这个函数是用球面坐标表示的。但是也可以使用 3D 坐标，这样我们就可以使用物体的 normal 向量对函数进行采样了。<br />
为了创建这样的函数，你必须在所有方向上对光照强度进行采样，然后将结果转换为单个连续的函数。为了达到完美模拟，你必须为表面的每个点做这样的工作。这当然是无法做到的，所以我们只能做到近似效果。<br />
</p>

<p>
首先，我们只从对象本地原点的角度定义函数。光照条件在随物体表面变化不大时效果还是可以的。小物体，或者光照比较弱或光照离物体很远时满足这种情况。幸运的是，这恰好是那些不值得逐像素计算的光照或者顶点光照。<br />
其次，我们必须近似函数自身。你可以将任何连续的函数分解为多个不同频率的函数。这些被称为波段。对于任意一个函数，你可能需要无数个波段来模拟。<br />
</p>
</div>
</div>
<div id="outline-container-org1ba4f43" class="outline-6">
<h6 id="org1ba4f43">Spherical Harmonics Bands</h6>
</div>
</div>
</div>
<div id="outline-container-orgda6d932" class="outline-4">
<h4 id="orgda6d932">Bumpiness</h4>
<div class="outline-text-4" id="text-orgda6d932">
</div>
<div id="outline-container-org2960999" class="outline-5">
<h5 id="org2960999">高度图转 normal map 的方法</h5>
<div class="outline-text-5" id="text-org2960999">
</div>
<div id="outline-container-orgfcf78b6" class="outline-6">
<h6 id="orgfcf78b6">方案 1</h6>
<div class="outline-text-6" id="text-orgfcf78b6">
<ol class="org-ol">
<li>通过高度求出每一点的斜率。该斜率就是该点的 tangent。分别求出 u/v 方向的 tangent。<br /></li>
<li>将 tangent 绕 z 轴旋转 90 度，就是 normal。<br /></li>
</ol>

<div class="figure">
<p><img src="./UnityCatLikeCoding/01_06bu_vector-rotation.png" alt="01_06bu_vector-rotation.png" /><br />
</p>
</div>

<div class="org-src-container">
<pre class="src src-shader"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#21033;&#29992; u &#26041;&#21521;&#39640;&#24230;&#21464;&#21270;&#26469;&#27714; normal</span>
<span style="color: #ce537a; font-weight: bold;">float2</span> delta = <span style="color: #ce537a; font-weight: bold;">float2</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_HeightMap_TexelSize</span>.x, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">float</span> h1 = <span style="color: #4f97d7;">tex2D</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_HeightMap</span>, i.uv<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">float</span> h2 = <span style="color: #4f97d7;">tex2D</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_HeightMap</span>, i.uv + delta<span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">scale normal with 1/delta.x &#31532;&#19968;&#31181;&#24418;&#24335;&#28040;&#38500;&#20102;&#38500;&#27861;&#65292;&#32780;&#19988;&#25913;&#21892;&#20102;&#31934;&#24230;</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">i.normal = float3(delta.x, h2 - h1, 0); &lt;==&gt; i.normal = float3(1, (h2 - h1)/delta.x, 0);</span>
i.normal = <span style="color: #ce537a; font-weight: bold;">float3</span><span style="color: #4f97d7;">(</span>delta.x, h2 - h1, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35843;&#25442; x &#21644; y &#23558; tangent &#36716;&#21270;&#20026; normal</span>
i.normal = <span style="color: #ce537a; font-weight: bold;">float3</span><span style="color: #4f97d7;">(</span>h2 - h1, delta.x, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#25918;&#22823;y&#20943;&#24369;normal&#25928;&#26524;</span>
i.normal = <span style="color: #ce537a; font-weight: bold;">float3</span><span style="color: #4f97d7;">(</span>h2 - h1, <span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20063;&#21487;&#20197;&#21033;&#29992; v &#26041;&#21521;&#39640;&#24230;&#26469;&#21464;&#21270;&#27714; normal.&#23454;&#29616;&#26041;&#27861;&#30456;&#21516;</span>
</pre>
</div>

<p>
下图为使用该方式计算 normal 的效果图<br />
<img src="./UnityCatLikeCoding/20_01_08_HMapTangentAsNormal.png" alt="20_01_08_HMapTangentAsNormal.png" /><br />
</p>
</div>
</div>
<div id="outline-container-orgc6e847c" class="outline-6">
<h6 id="orgc6e847c">方案 2</h6>
<div class="outline-text-6" id="text-orgc6e847c">
<ol class="org-ol">
<li>通过高度求出每一点的斜率。该斜率就是该点的 tangent。分别求出 u/v 方向的 tangent。<br /></li>
<li>将 u/v 方向的 tangent 进行叉乘生成 normal。<br /></li>
</ol>

<p>
下面是向量叉乘公式:<br />
<img src="./UnityCatLikeCoding/20_01_09_vectorCrossProduct.png" alt="20_01_09_vectorCrossProduct.png" /><br />
</p>

<p>
此处 tangent 向量叉乘优化：<br />
</p>
\begin{equation}  
  \begin{bmatrix}
  0\\ 
  {f_v}'\\ 
  1
  \end{bmatrix} \times 
  \begin{bmatrix}
  1\\ 
  {f_u}'\\ 
  0
  \end{bmatrix} = 
  \begin{bmatrix}
  {f_v}'*0-1*{f_u}'\\ 
  1*1-0*0 \\
  0*{f_u}'-{f_v}'*1
  \end{bmatrix} =
  \begin{bmatrix}
  -{f_u}'\\ 
  1 \\
  -{f_v}'
  \end{bmatrix}
\end{equation}

<div class="org-src-container">
<pre class="src src-shader"><span style="color: #ce537a; font-weight: bold;">float2</span> du = <span style="color: #ce537a; font-weight: bold;">float2</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_HeightMap_TexelSize</span>.x * <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">5</span>, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">float</span> u1 = <span style="color: #4f97d7;">tex2D</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_HeightMap</span>, i.uv - du<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">float</span> u2 = <span style="color: #4f97d7;">tex2D</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_HeightMap</span>, i.uv + du<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">float3</span> tu = <span style="color: #ce537a; font-weight: bold;">float3</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span>, u2 - u1, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">float2</span> dv = <span style="color: #ce537a; font-weight: bold;">float2</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #7590db;">_HeightMap_TexelSize</span>.y * <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">5</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">float</span> v1 = <span style="color: #4f97d7;">tex2D</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_HeightMap</span>, i.uv - dv<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">float</span> v2 = <span style="color: #4f97d7;">tex2D</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">_HeightMap</span>, i.uv + dv<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">float3</span> tv = <span style="color: #ce537a; font-weight: bold;">float3</span><span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>, v2 - v1, <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>;

i.normal = <span style="color: #4f97d7;">cross</span><span style="color: #4f97d7;">(</span>tv, tu<span style="color: #4f97d7;">)</span>;
i.normal = <span style="color: #4f97d7;">normalize</span><span style="color: #4f97d7;">(</span>i.normal<span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org505da33" class="outline-5">
<h5 id="org505da33">Normal 向量的插值</h5>
<div class="outline-text-5" id="text-org505da33">
<p>
Normal 贴图的 Filter，以及顶点的 Normal 向量在传递到片段着色器过程中的插值 都会导致 normal 向量不再是单位向量，所以需要重新单位化。<br />
</p>
</div>
</div>
<div id="outline-container-org93efe58" class="outline-5">
<h5 id="org93efe58">Normal 贴图存储惯例</h5>
<div class="outline-text-5" id="text-org93efe58">
<p>
Normal 贴图通用的惯例是将向上的方向存储到 z 分量.所以，在 shader 中采样出来 normal 向量后需要调换 y 分量和 z 分量。<br />
</p>
</div>
</div>
<div id="outline-container-org7a8d6c3" class="outline-5">
<h5 id="org7a8d6c3">DXT5nm 存储 normal 贴图</h5>
<div class="outline-text-5" id="text-org7a8d6c3">
<p>
其只存储了 normal 的 x，y 分量，丢弃掉了 z 分量。z 分量通过计算得到 \(z=\sqrt{1-x^2-y^2}\) .<br />
x 分量存储在 A 通道，y 分量存储在 G 通道。R 通道和 B 通道没有使用。<br />
DXT5 按照 4x4 个像素为一个块进行压缩。R 占用 5 位，B 占用 5 位，G 占用 6 位，A 占用 8 位。RGB 公用一个查找表，A 公用一个查找表。所以将 x 分量存储到 A 通道可以保持 x 分量和 y 分量的独立性。<br />
手机平台不支持 DXT5nm 格式，在手机平台 unity 仍然使用通用的 rgb 进行编码。<br />
</p>
</div>
</div>
<div id="outline-container-orgcc7049f" class="outline-5">
<h5 id="orgcc7049f">缩放 Normal</h5>
<div class="outline-text-5" id="text-orgcc7049f">
<p>
只需要在单位化 normal 前，对 normal 的 x 分量和 z 分量进行缩放，就可以强化和弱化 y 分量。<br />
</p>
</div>
</div>
<div id="outline-container-orgb0da65a" class="outline-5">
<h5 id="orgb0da65a">Blending Normals</h5>
<div class="outline-text-5" id="text-orgb0da65a">
<p>
回顾使用高度图生成 normal 贴图的方法，可以知道，如果希望 normal 效果叠加，其实就是将高度叠加，也就是斜率叠加。<br />
normal 贴图中存储的值为:(s 表示单位化过程中，对各个分量的缩放)<br />
</p>
\begin{bmatrix}
-s{f_u}'\\ 
-s{f_v}'\\
s \\
\end{bmatrix}
<p>
所以叠加 MainNormalTex 和 DetailNormalTex 的高度后得到的 normal 为<br />
</p>
\begin{bmatrix}
\frac{M_x}{M_z} + \frac{D_x}{D_z} \\
\frac{M_y}{M_z} + \frac{D_y}{D_z} \\
1 \\
\end{bmatrix}

<p>
Whiteout Blending : 对上面得到的 normal 乘 \(M_zD_z\) ，然后丢弃掉对 x 和 y 分量的缩放、这样可以强化 X 和 Y 分量<br />
</p>
\begin{equation}  
  \begin{bmatrix}
  \frac{M_x}{M_z} + \frac{D_x}{D_z} \\
  \frac{M_y}{M_z} + \frac{D_y}{D_z} \\
  1 \\
  \end{bmatrix} * M_zD_z = 
  \begin{bmatrix}
    M_xD_z + D_xM_z \\
    M_yD_z + D_yM_z \\
    M_zD_z \\
  \end{bmatrix} = 
  \begin{bmatrix}
    M_x + D_x \\
    M_y + D_y \\
    M_zD_z \\
  \end{bmatrix}
\end{equation}
</div>
</div>
</div>
<div id="outline-container-org563e6a1" class="outline-4">
<h4 id="org563e6a1">Shadows</h4>
<div class="outline-text-4" id="text-org563e6a1">
</div>
<div id="outline-container-org0cd67fc" class="outline-5">
<h5 id="org0cd67fc">方向光阴影</h5>
<div class="outline-text-5" id="text-org0cd67fc">
</div>
<div id="outline-container-orgc22f4c8" class="outline-6">
<h6 id="orgc22f4c8">开启屏幕空间阴影</h6>
<div class="outline-text-6" id="text-orgc22f4c8">
</div>
<ul class="org-ul">
<li><a id="orgbda74b9"></a>Rendering to Depth Texture<br />
<div class="outline-text-7" id="text-orgbda74b9">
<p>
Unity 绘制场景中物体将其深度写入到 DepthTexture<br />
</p>


<div class="figure">
<p><img src="./UnityCatLikeCoding/01_07sh_depth.png" alt="01_07sh_depth.png" /><br />
</p>
</div>
</div>
</li>
<li><a id="orgdb93ec6"></a>Rendering To Shadow Maps<br />
<div class="outline-text-7" id="text-orgdb93ec6">
<p>
Unity 在光源位置对场景进行绘制，将物体深度写入到 Shadowmap<br />
开启 shadow cascades 后，会多次绘制阴影。开启 2 级会绘制两次，开启 4 级会绘制 4 次。<br />
</p>

<p>
下图为第一个方向光视角下开启 4 级 cascades 阴影渲染的阴影贴图：<br />
<img src="./UnityCatLikeCoding/01_07sh_4cascades_shadows.png" alt="01_07sh_4cascades_shadows.png" /><br />
</p>

<p>
下图为第二个方向光视角下开启 4 级 cascades 阴影渲染的阴影贴图：<br />
<img src="./UnityCatLikeCoding/01_07sh_4cascades_shadows_2.png" alt="01_07sh_4cascades_shadows_2.png" /><br />
</p>
</div>
</li>

<li><a id="orgb49776b"></a>Collecting Shadows<br />
<div class="outline-text-7" id="text-orgb49776b">
<p>
Unity 使用 Hidden/Internal-ScreenSpaceShadows shader 绘制一个全屏的矩形，以前面得到的 DepthTexture 和 Shadowmap 为输入，对于每一个片段通过比较对应的场景摄像机的深度和光照摄像机的深度得出屏幕空间的阴影贴图。<br />
在这个过程中，Unity 通过 Filtering 来实现软阴影。<br />
</p>

<p>
下图为第一个方向光对应的屏幕空间阴影贴图：<br />
<img src="./UnityCatLikeCoding/01_07sh_screenspace_shadows_1.png" alt="01_07sh_screenspace_shadows_1.png" /><br />
下图为第二个方向光对应的屏幕空间阴影贴图：<br />
<img src="./UnityCatLikeCoding/01_07sh_screenspace_shadows_2.png" alt="01_07sh_screenspace_shadows_2.png" /><br />
</p>
</div>
</li>
<li><a id="org2d8a0bc"></a>最终结果<br />
<div class="outline-text-7" id="text-org2d8a0bc">
<p>
下图为两个方向光绘制场景时对应的 drawcall：<br />
<img src="./UnityCatLikeCoding/01_07sh_4cascades_drawcall.png" alt="01_07sh_4cascades_drawcall.png" /><br />
</p>

<p>
下图为绘制结果：<br />
<img src="./UnityCatLikeCoding/01_07sh_4cascades_shadows_result.png" alt="01_07sh_4cascades_shadows_result.png" /><br />
</p>
</div>
<ul class="org-ul">
<li><a id="org09d0a07"></a>为什么 unity 要在渲染 shadowmap 和 collecting 之间切换？<br />
<div class="outline-text-8" id="text-org09d0a07">
<p>
因为每个光源需要它自己的屏幕空间阴影贴图，但是从光源视角渲染的阴影贴图可以被复用。<br />
</p>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div id="outline-container-org64920e3" class="outline-6">
<h6 id="org64920e3">关闭屏幕空间阴影</h6>
<div class="outline-text-6" id="text-org64920e3">
</div>
<ul class="org-ul">
<li><a id="org28b86ba"></a>Rendering To Shadow Maps<br />
<div class="outline-text-7" id="text-org28b86ba">
<p>
下图为第一个方向光视角下渲染的阴影贴图：<br />
<img src="./UnityCatLikeCoding/01_07sh_noss_shadows_1.png" alt="01_07sh_noss_shadows_1.png" /><br />
下图为第二个方向光视角下渲染的阴影贴图：<br />
<img src="./UnityCatLikeCoding/01_07sh_noss_shadows_2.png" alt="01_07sh_noss_shadows_2.png" /><br />
</p>
</div>
</li>
<li><a id="orgdb38ae7"></a>最终结果<br />
<div class="outline-text-7" id="text-orgdb38ae7">
<p>
下图为两个方向光绘制场景时对应的 drawcall：<br />
<img src="./UnityCatLikeCoding/01_07sh_noss_shadows_3.png" alt="01_07sh_noss_shadows_3.png" /><br />
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgbe8706c" class="outline-6">
<h6 id="orgbe8706c">ShadowQuality</h6>
<div class="outline-text-6" id="text-orgbe8706c">
<p>
减低 ShadowDistance 可以提高阴影精度，但是会缩小阴影范围。<br />
设置投影类型 QualitySettings.shadowProjection = ShadowProjection.CloseFit; 可以提高阴影精度。<br />
开启 Cascade。<br />
</p>
</div>
</div>
<div id="outline-container-org24e8229" class="outline-6">
<h6 id="org24e8229">参考资料</h6>
<div class="outline-text-6" id="text-org24e8229">
<ul class="org-ul">
<li><a href="https://learnopengl.com/Advanced-Lighting/Shadows/Shadow-Mapping">https://learnopengl.com/Advanced-Lighting/Shadows/Shadow-Mapping</a><br /></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org786192a" class="outline-5">
<h5 id="org786192a">Spot Light Shadow</h5>
</div>
<div id="outline-container-orgbd35405" class="outline-5">
<h5 id="orgbd35405">相关宏定义</h5>
<div class="outline-text-5" id="text-orgbd35405">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">宏定义</th>
<th scope="col" class="org-left">DrawCall</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">UNITY_NO_SCREENSPACE_SHADOWS</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">开启屏幕空间阴影</td>
</tr>

<tr>
<td class="org-left">SHADOWS_DEPTH</td>
<td class="org-left">Shadows.RenderJob ShadowCaster</td>
<td class="org-left">Directional 和 Spot 生成阴影贴图写入深度的宏定义</td>
</tr>

<tr>
<td class="org-left">SHADOWS_CUBE</td>
<td class="org-left">Shadows.RenderJob ShadowCaster</td>
<td class="org-left">PointLight 生成阴影贴图写入深度的宏定义</td>
</tr>

<tr>
<td class="org-left">SHADOWS_SCREEN</td>
<td class="org-left">RenderForward ForwardBasePass</td>
<td class="org-left">主 Directional 开启阴影对应的宏定义</td>
</tr>

<tr>
<td class="org-left">SHADOWS_SCREEN DIRECTIONAL</td>
<td class="org-left">RenderForward ForwardAddPass</td>
<td class="org-left">第二个 Directional 开启阴影对应的宏定义</td>
</tr>

<tr>
<td class="org-left">SHADOWS_DEPTH SPOT</td>
<td class="org-left">RenderForward ForwardAddPass</td>
<td class="org-left">Spot 开启阴影对应的宏定义</td>
</tr>

<tr>
<td class="org-left">SHADOWS_CUBE POINT</td>
<td class="org-left">RenderForward ForwardAddPass</td>
<td class="org-left">Point 开启阴影对应的宏定义</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org4400e04" class="outline-5">
<h5 id="org4400e04">参考资料</h5>
<div class="outline-text-5" id="text-org4400e04">
<ul class="org-ul">
<li>Signed Distance Field Shadow in Unity <a href="https://zhuanlan.zhihu.com/p/37918356">https://zhuanlan.zhihu.com/p/37918356</a><br /></li>
<li>Unity 平面阴影(王者荣耀阴影实现) <a href="https://zhuanlan.zhihu.com/p/42781261">https://zhuanlan.zhihu.com/p/42781261</a><br /></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgb4337d6" class="outline-4">
<h4 id="orgb4337d6">Reflection</h4>
<div class="outline-text-4" id="text-orgb4337d6">
</div>
<div id="outline-container-org75f6314" class="outline-5">
<h5 id="org75f6314">Environment Mapping</h5>
<div class="outline-text-5" id="text-org75f6314">
<p>
完美的镜面反射会反射所有光照，所以其不存在 diffuse.光滑度越高、金属度越高，材质越接近完美镜面。<br />
视线和法线夹角越大，Fresnel 反射越强。表面越光滑 Fresnel 反射越强。<br />
<img src="./UnityCatLikeCoding/01_08re_fresnel_smoothness.png" alt="01_08re_fresnel_smoothness.png" /><br />
</p>

<p>
因为 Fresnel 间接反射来源于间接光照，所以它产生的效果独立于直接光照，因此上图中即使处于阴影部分的边缘处 Fresnel 反射依然很强，其独立于直接光源的阴影。<br />
</p>
</div>
</div>
<div id="outline-container-org05580c1" class="outline-5">
<h5 id="org05580c1">Imperfect Reflections</h5>
<div class="outline-text-5" id="text-org05580c1">
<p>
模糊的反射是通过环境贴图的 mipmap 来实现的。<br />
</p>
</div>

<div id="outline-container-org6e721b8" class="outline-6">
<h6 id="org6e721b8">Metals VS Nonmetals</h6>
<div class="outline-text-6" id="text-org6e721b8">
<p>
金属和非金属表面都可以产生清晰的反射，但是他们看起来是不同的。镜面反射在闪耀的非电解质材质上效果会很强，但是镜面反射并不会主导非电解质材质的外观，他们仍然表现出大量的可见的 diffuse 反射。<br />
<img src="./UnityCatLikeCoding/01_08re_dielectric.png" alt="01_08re_dielectric.png" /><br />
</p>

<p>
金属会改变镜面反射的颜色，但是非金属则不会。这对于镜面高光和环境镜面反射都适用。下图中金属的镜面高光颜色为红色，非金属是白色。<br />
<img src="./UnityCatLikeCoding/01_08re_metal_nonmetal.png" alt="01_08re_metal_nonmetal.png" /><br />
</p>
</div>
</div>

<div id="outline-container-org24f7725" class="outline-6">
<h6 id="org24f7725">Mirrors and Shadows</h6>
<div class="outline-text-6" id="text-org24f7725">
<p>
间接反射是独立于表面的直接照明的。这在其他阴影区域会更加明显。对于非金属，这会让表面更亮一些，你依然可以看到直接光照导致的阴影。<br />
<img src="./UnityCatLikeCoding/01_08re_nonmetal_with_shadow.png" alt="01_08re_nonmetal_with_shadow.png" /><br />
同样的规则适用于金属。但是，金属的间接反射起主导作用。因此，直接光照和阴影会随着光泽度增加而消失。完美镜面上不存在阴影。<br />
<img src="./UnityCatLikeCoding/01_08re_metal_with_shadow.png" alt="01_08re_metal_with_shadow.png" /><br />
现实世界中很少有完美的镜面。现实世界中的材质都是由金属和非金属混合而成的，可以通过调节金属度来模拟不完美的镜面材质。<br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgb90a5f5" class="outline-5">
<h5 id="orgb90a5f5">Box Projection</h5>
<div class="outline-text-5" id="text-orgb90a5f5">
<p>
ReflectionProbe 的 Box 区域是和世界坐标轴对齐的，它不受旋转和缩放影响。<br />
BoxProjection 原理如下图所示：<br />
<img src="./UnityCatLikeCoding/01_08re_box_projection.JPG" alt="01_08re_box_projection.JPG" /><br />
<img src="./UnityCatLikeCoding/01_08re_box_projection_3D.png" alt="01_08re_box_projection_3D.png" /><br />
<a href="./UnityCatLikeCoding/01_08re_box_projection.ggb">./UnityCatLikeCoding/01_08re_box_projection.ggb</a><br />
</p>

<p>
BoxProjection 对应代码实现如下：<br />
</p>
<div class="org-src-container">
<pre class="src src-shader"><span style="color: #ce537a; font-weight: bold;">half3</span> <span style="color: #bc6ec5; font-weight: bold;">BoxProjection</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">half3</span> dir, <span style="color: #ce537a; font-weight: bold;">half3</span> pos, <span style="color: #ce537a; font-weight: bold;">half4</span> cubemapPos, <span style="color: #ce537a; font-weight: bold;">half3</span> boxMin, <span style="color: #ce537a; font-weight: bold;">half3</span> boxMax<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">cubemapPos.w &#25511;&#21046; BoxProjection &#26159;&#21542;&#29983;&#25928;  </span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">UNITY_BRANCH &#29992;&#20110;&#24320;&#21551;&#30495;&#27491;&#30340;&#20998;&#25903;</span>
  UNITY_BRANCH
  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>cubemapPos.w &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
  <span style="color: #bc6ec5;">{</span>
    <span style="color: #ce537a; font-weight: bold;">half3</span> factors = <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>dir &gt; <span style="color: #a45bad;">0</span> ? boxMax : boxMin<span style="color: #67b11d;">)</span> - pos<span style="color: #2d9574;">)</span> / dir;
    <span style="color: #ce537a; font-weight: bold;">half</span> realFactor = <span style="color: #4f97d7;">min</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7;">min</span><span style="color: #67b11d;">(</span>factors.x, factors.y<span style="color: #67b11d;">)</span>, factors.z<span style="color: #2d9574;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> dir * realFactor + <span style="color: #2d9574;">(</span>pos - cubemapPos<span style="color: #2d9574;">)</span>;
  <span style="color: #bc6ec5;">}</span>
  <span style="color: #4f97d7; font-weight: bold;">return</span> dir;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<ul class="org-ul">
<li>关于 UNITY_BRANCH   <a href="https://forum.unity.com/threads/correct-use-of-unity_branch.476804/">https://forum.unity.com/threads/correct-use-of-unity_branch.476804/</a><br /></li>
<li>HLSL branch flatten <a href="https://docs.microsoft.com/zh-cn/windows/win32/direct3dhlsl/dx-graphics-hlsl-if">https://docs.microsoft.com/zh-cn/windows/win32/direct3dhlsl/dx-graphics-hlsl-if</a><br /></li>
</ul>
</div>
</div>
<div id="outline-container-org6ec2472" class="outline-5">
<h5 id="org6ec2472">Blending Reflection Probes</h5>
<div class="outline-text-5" id="text-org6ec2472">
<p>
只有将 Renderer 的 reflectionProbeUsage 属性设置为 BlendProbesAndSkybox 时，反射探针才会和 Skybox 进行混合<br />
</p>
<div class="org-src-container">
<pre class="src src-csharp"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">enum</span> <span style="color: #ce537a; font-weight: bold;">ReflectionProbeUsage</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #7590db;">Off</span> = <span style="color: #a45bad;">0</span>,                      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20851;&#38381;&#21453;&#23556;&#25506;&#38024;</span>
    <span style="color: #7590db;">BlendProbes</span> = <span style="color: #a45bad;">1</span>,              <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#21453;&#23556;&#25506;&#38024;&#21482;&#21644;&#21453;&#23556;&#25506;&#38024;&#36827;&#34892;&#28151;&#21512;</span>
    <span style="color: #7590db;">BlendProbesAndSkybox</span> = <span style="color: #a45bad;">2</span>,     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#21453;&#23556;&#25506;&#38024;&#21487;&#20197;&#21644; skybox &#36827;&#34892;&#28151;&#21512;</span>
    <span style="color: #7590db;">Simple</span> = <span style="color: #a45bad;">3</span>                    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#21482;&#20351;&#29992;&#20854;&#20013;&#19968;&#20010;&#21453;&#23556;&#25506;&#38024;&#25110; skybox&#65292;&#19981;&#36827;&#34892;&#28151;&#21512;</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shader"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#28151;&#21512;&#21453;&#23556;&#25506;&#38024;&#30340;&#36923;&#36753;</span>
UnityIndirect <span style="color: #bc6ec5; font-weight: bold;">CreateIndirect</span><span style="color: #4f97d7;">(</span>v2f i, <span style="color: #ce537a; font-weight: bold;">half3</span> viewDir<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    UnityIndirect indirect;
    indirect.diffuse = <span style="color: #a45bad;">0</span>;
    indirect.specular = <span style="color: #a45bad;">0</span>;
<span style="color: #bc6ec5;">    #if</span> defined<span style="color: #bc6ec5;">(</span>FORWARD_BASE_PASS<span style="color: #bc6ec5;">)</span>
    indirect.diffuse += <span style="color: #4f97d7;">max</span><span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span>, ShadeSH9<span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">half4</span><span style="color: #67b11d;">(</span>i.worldNormal, <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">half</span> roughness = <span style="color: #a45bad;">1</span> - <span style="color: #7590db;">_Smoothness</span>;
    roughness *= <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">7</span> - <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">7</span> * roughness;

    <span style="color: #ce537a; font-weight: bold;">half3</span> reflectDir = <span style="color: #4f97d7;">reflect</span><span style="color: #bc6ec5;">(</span>-viewDir, i.worldNormal<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">half3</span> reflectDir1 = BoxProjection<span style="color: #bc6ec5;">(</span>reflectDir, i.worldPos,
        unity_SpecCube0_ProbePosition,
        unity_SpecCube0_BoxMin,
        unity_SpecCube0_BoxMax<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">half4</span> envColor = UNITY_SAMPLE_TEXCUBE_LOD<span style="color: #bc6ec5;">(</span>unity_SpecCube0, reflectDir1, roughness*UNITY_SPECCUBE_LOD_STEPS<span style="color: #bc6ec5;">)</span>;
    envColor.rgb = DecodeHDR<span style="color: #bc6ec5;">(</span>envColor, unity_SpecCube0_HDR<span style="color: #bc6ec5;">)</span>;
    UNITY_BRANCH
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>unity_SpecCube0_BoxMin.a &lt; <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">9999</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">{</span>
        <span style="color: #ce537a; font-weight: bold;">half3</span> reflectDir2 = BoxProjection<span style="color: #2d9574;">(</span>reflectDir, i.worldPos,
            unity_SpecCube1_ProbePosition,
            unity_SpecCube1_BoxMin,
            unity_SpecCube1_BoxMax<span style="color: #2d9574;">)</span>;
        <span style="color: #ce537a; font-weight: bold;">half4</span> envColor2 = UNITY_SAMPLE_TEXCUBE_SAMPLER_LOD<span style="color: #2d9574;">(</span>unity_SpecCube1, unity_SpecCube0, reflectDir2, roughness*UNITY_SPECCUBE_LOD_STEPS<span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">DecodeHDR &#20013;&#20195;&#30721;&#22788;&#29702;&#20102; intensity &#36923;&#36753;</span>
        envColor2.rgb = DecodeHDR<span style="color: #2d9574;">(</span>envColor2, unity_SpecCube1_HDR<span style="color: #2d9574;">)</span>;
        envColor = <span style="color: #4f97d7;">lerp</span><span style="color: #2d9574;">(</span>envColor2, envColor, unity_SpecCube0_BoxMin.a<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">indirect.specular = half3(1, 0, 0);</span>
    indirect.specular = envColor.rgb;
<span style="color: #bc6ec5;">    #endif</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> indirect;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7a33b80" class="outline-5">
<h5 id="org7a33b80">Bouncing Reflections</h5>
<div class="outline-text-5" id="text-org7a33b80">
<p>
在 Lighting/Scene/Environment Reflections 下可以设置 Bounces 的次数。<br />
Lighting/Scene 下的数据记录在当前打开的场景文件中，每个场景的数据可以不同。<br />
EnvironmentLighting/IntensityMultiplier  当 EnvironmentLighting/Source 为 Skybox 时，该调节项控制天空球光照亮度.<br />
</p>

<p>
EnvironmentReflections/Source  指定使用天空球作为环境反射源，还是自定义环境反射源。<br />
EnvironmentReflections/IntensityMultiplier 控制反射源在场景中提供反射的因子，值为 1 时符合物理规律。<br />
</p>
</div>
</div>
</div>
<div id="outline-container-orgd5b9e12" class="outline-4">
<h4 id="orgd5b9e12">ComplexMaterials &amp; More Complexity</h4>
<div class="outline-text-4" id="text-orgd5b9e12">
</div>
<div id="outline-container-org90809b5" class="outline-5">
<h5 id="org90809b5">Emission</h5>
<div class="outline-text-5" id="text-org90809b5">
<div class="org-src-container">
<pre class="src src-csharp"><span style="color: #4f97d7;">[</span>NoScaleOffset<span style="color: #4f97d7;">]</span> _EmissionMap <span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Emission"</span>, <span style="color: #a45bad;">2D</span><span style="color: #4f97d7;">)</span> = <span style="color: #2d9574;">"black"</span> <span style="color: #4f97d7;">{}</span>
_Emission <span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Emission"</span>, Color<span style="color: #4f97d7;">)</span> = <span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>

<span style="color: #bc6ec5;">#pragma</span><span style="color: #2d9574;"> shader_feature _EMISSION_MAP</span>

sampler2D _EmissionMap;
<span style="color: #ce537a; font-weight: bold;">float3</span> <span style="color: #7590db;">_Emission</span>;

<span style="color: #ce537a; font-weight: bold;">float3</span> <span style="color: #bc6ec5; font-weight: bold;">GetEmission</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">Interpolators</span> <span style="color: #7590db;">i</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>FORWARD_BASE_PASS<span style="color: #bc6ec5;">)</span>
<span style="color: #bc6ec5;">  #if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>_EMISSION_MAP<span style="color: #bc6ec5;">)</span>
      <span style="color: #4f97d7; font-weight: bold;">return</span> tex2D<span style="color: #bc6ec5;">(</span>_EmissionMap, i.uv.xy<span style="color: #bc6ec5;">)</span> * _Emission;
<span style="color: #bc6ec5;">  #else</span>
      <span style="color: #4f97d7; font-weight: bold;">return</span> _Emission;
<span style="color: #bc6ec5;">  #endif</span>
<span style="color: #bc6ec5;">#else</span>
      <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">float4</span> <span style="color: #bc6ec5; font-weight: bold;">MyFragmentProgram</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">Interpolators</span> <span style="color: #7590db;">i</span><span style="color: #4f97d7;">)</span> : SV_TARGET 
<span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">&#8230;</span>

    <span style="color: #ce537a; font-weight: bold;">float4</span> <span style="color: #7590db;">color</span> = UNITY_BRDF_PBS<span style="color: #bc6ec5;">(</span>
                                  albedo, specularTint,
                                  oneMinusReflectivity, GetSmoothness<span style="color: #2d9574;">(</span>i<span style="color: #2d9574;">)</span>,
                                  i.normal, viewDir,
                                  CreateLight<span style="color: #2d9574;">(</span>i<span style="color: #2d9574;">)</span>, CreateIndirectLight<span style="color: #2d9574;">(</span>i, viewDir<span style="color: #2d9574;">)</span>
                                  <span style="color: #bc6ec5;">)</span>;
    color.rgb += GetEmission<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> color;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org7db5687" class="outline-5">
<h5 id="org7db5687">Smoothness &amp; Metallic Map</h5>
<div class="outline-text-5" id="text-org7db5687">
<p>
将 MetallicMap 和 SmoothnessMap 存储到一张 DXT5 格式的贴图中 ，Metallic Map 放到贴图 r 通道, Smoothness Map 放到贴图 a 通道。等价于使用两张 DXT1 格式贴图分别存储。因为 DXT5 分开对 RGB 和 A 通道进行压缩。<br />
</p>
</div>
</div>
<div id="outline-container-orgcd9dbdb" class="outline-5">
<h5 id="orgcd9dbdb">Occlusion</h5>
<div class="outline-text-5" id="text-orgcd9dbdb">
<div class="org-src-container">
<pre class="src src-csharp"><span style="color: #4f97d7;">[</span>NoScaleOffset<span style="color: #4f97d7;">]</span> _OcclusionMap <span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Occlusion"</span>, <span style="color: #a45bad;">2D</span><span style="color: #4f97d7;">)</span> = <span style="color: #2d9574;">"white"</span> <span style="color: #4f97d7;">{}</span>
_OcclusionStrength<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"Occlusion Strength"</span>, Range<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> = <span style="color: #a45bad;">1</span>

<span style="color: #bc6ec5;">#pragma</span><span style="color: #2d9574;"> shader_feature _OCCLUSION_MAP</span>

sampler2D _OcclusionMap;
<span style="color: #ce537a; font-weight: bold;">float</span> <span style="color: #7590db;">_OcclusionStrength</span>;

<span style="color: #ce537a; font-weight: bold;">float</span> <span style="color: #bc6ec5; font-weight: bold;">GetOcclusion</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">Interpolators</span> <span style="color: #7590db;">i</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>_OCCLUSION_MAP<span style="color: #bc6ec5;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> lerp<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span>, tex2D<span style="color: #2d9574;">(</span>_OcclusionMap, i.uv.xy<span style="color: #2d9574;">)</span>.g, _OcclusionStrength<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">1</span>;
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Occlusion &#21516;&#26102;&#24433;&#21709;&#30452;&#25509;&#20809;&#29031;&#38452;&#24433;&#21644;&#38388;&#25509;&#20809;&#29031;&#38452;&#24433;&#26102;&#65292;Occlusion&#25928;&#26524;&#20250;&#36807;&#24378;</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22240;&#20026;Occlusion&#26159;&#22522;&#20110;&#29289;&#20307;&#24418;&#29366;&#30340;&#32780;&#19981;&#26159;&#29305;&#23450;&#20809;&#29031;&#30340;&#65292;&#20854;&#21482;&#24433;&#21709;&#38388;&#25509;&#20809;&#29031;&#20250;&#26356;&#21512;&#29702;&#19968;&#20123;&#12290;&#20985;&#30165;&#36234;&#28145;&#30340;&#22320;&#26041;&#65292;&#21508;&#20010;&#26041;&#21521;&#30340;&#38388;&#25509;&#20809;&#29031;&#20943;&#24369;&#36234;&#22810;&#65292;&#32780;&#30452;&#25509;&#20809;&#29031;&#29031;&#36827;&#20985;&#30165;&#26102;&#65292;&#36824;&#26159;&#21487;&#20197;&#21152;&#23558;&#20854;&#29031;&#20142;&#12290;</span>
<span style="color: #ce537a; font-weight: bold;">UnityLight</span> <span style="color: #bc6ec5; font-weight: bold;">CreateLight</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">Interpolators</span> <span style="color: #7590db;">i</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">&#8230;</span>
    UNITY_LIGHT_ATTENUATION<span style="color: #bc6ec5;">(</span>attenuation, i, i.worldPos<span style="color: #bc6ec5;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#36890;&#36807;&#23558;Occlusion&#21644;atten&#30456;&#20056;&#26469;&#24433;&#21709;&#30452;&#25509;&#20809;&#29031;&#38452;&#24433;</span>
    attenuation *= GetOcclusion<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span>;
    light.color = _LightColor0.rgb * attenuation;
    light.ndotl = DotClamped<span style="color: #bc6ec5;">(</span>i.normal, light.dir<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> light;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">UnityIndirect</span> <span style="color: #bc6ec5; font-weight: bold;">CreateIndirectLight</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">Interpolators</span> <span style="color: #7590db;">i</span>, <span style="color: #ce537a; font-weight: bold;">float3</span> <span style="color: #7590db;">viewDir</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">&#8230;</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>FORWARD_BASE_PASS<span style="color: #bc6ec5;">)</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">&#8230;</span>
    <span style="color: #ce537a; font-weight: bold;">float</span> <span style="color: #7590db;">occlusion</span> = GetOcclusion<span style="color: #bc6ec5;">(</span>i<span style="color: #bc6ec5;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#36890;&#36807;&#23558;Occlusion&#21644;&#38388;&#25509;&#20809;&#29031;&#30340;diffuse&#12289;specular&#30456;&#20056;&#26469;&#24433;&#21709;&#38388;&#25509;&#20809;&#29031;&#38452;&#24433;</span>
    indirectLight.diffuse *= occlusion;
    indirectLight.specular *= occlusion;
<span style="color: #bc6ec5;">#endif</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> indirectLight;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org855b08d" class="outline-4">
<h4 id="org855b08d">Transparency</h4>
</div>
<div id="outline-container-orge7a43f3" class="outline-4">
<h4 id="orge7a43f3">Semitransparent Shadows</h4>
</div>
<div id="outline-container-orgb0fb17c" class="outline-4">
<h4 id="orgb0fb17c">Deferred Shading</h4>
</div>
<div id="outline-container-org95df0c6" class="outline-4">
<h4 id="org95df0c6">Fog</h4>
</div>
<div id="outline-container-orgaa7a0b2" class="outline-4">
<h4 id="orgaa7a0b2">Deferred Lights</h4>
</div>
<div id="outline-container-org64b1db3" class="outline-4">
<h4 id="org64b1db3">Static Lighting</h4>
</div>
<div id="outline-container-org644acf2" class="outline-4">
<h4 id="org644acf2">Mixed Lighting</h4>
</div>
<div id="outline-container-org510f53b" class="outline-4">
<h4 id="org510f53b">RealtimeGI and LOD Groups</h4>
</div>
<div id="outline-container-orgbdcffdb" class="outline-4">
<h4 id="orgbdcffdb">GPU Instancing</h4>
</div>
<div id="outline-container-orgd8e7e7e" class="outline-4">
<h4 id="orgd8e7e7e">Parallax</h4>
</div>
</div>
<div id="outline-container-orgebf5f2a" class="outline-3">
<h3 id="orgebf5f2a">Advanced Rendering</h3>
<div class="outline-text-3" id="text-orgebf5f2a">
</div>
<div id="outline-container-org178054a" class="outline-4">
<h4 id="org178054a">Flat and Wireframe Shading</h4>
</div>
<div id="outline-container-org5cf0f89" class="outline-4">
<h4 id="org5cf0f89">Tessellation</h4>
</div>
<div id="outline-container-org0509bb0" class="outline-4">
<h4 id="org0509bb0">Surface Displacement</h4>
</div>
<div id="outline-container-org4ac0ade" class="outline-4">
<h4 id="org4ac0ade">Bloom</h4>
</div>
<div id="outline-container-orgdbb39f7" class="outline-4">
<h4 id="orgdbb39f7">Depth of Field</h4>
</div>
<div id="outline-container-org4b0052c" class="outline-4">
<h4 id="org4b0052c">FXAA</h4>
</div>
<div id="outline-container-orgc749527" class="outline-4">
<h4 id="orgc749527">Triplanar Mapping</h4>
</div>
</div>
</div>
<div id="outline-container-orgf300a9b" class="outline-2">
<h2 id="orgf300a9b">Q&amp;A</h2>
<div class="outline-text-2" id="text-orgf300a9b">
</div>
<div id="outline-container-org54577c2" class="outline-3">
<h3 id="org54577c2">为什么 Unity 标准材质中只有点光源可以在顶点着色器中计算？</h3>
<div class="outline-text-3" id="text-org54577c2">
<p>
因为 unity 就是这样实现的。其实任何光照都可以在顶点着色器中计算，在片段着色器中插值获得片段颜色。<br />
</p>
</div>
</div>
<div id="outline-container-org9107202" class="outline-3">
<h3 id="org9107202">Unity 球谐光照函数中只需要传递 normal，那么物体到光源的距离引起的光照差异是如何实现的？</h3>
<div class="outline-text-3" id="text-org9107202">
<ul class="org-ul">
<li><a href="https://www.cnblogs.com/murongxiaopifu/p/8997720.html">https://www.cnblogs.com/murongxiaopifu/p/8997720.html</a><br /></li>
</ul>
</div>
</div>
<div id="outline-container-org40770d6" class="outline-3">
<h3 id="org40770d6">为什么渲染方向光的阴影贴图时需要使用正交矩阵，而点光源需要使用透视矩阵？</h3>
<div class="outline-text-3" id="text-org40770d6">
<p>
对于物体来说方向光的方向都是相同的，和方向光垂直的同一平面内的点，他们对应的阴影贴图中的值应该相同，使用正交投影按照方向光方向，渲染场景中物体，将深度写入阴影贴图刚好可以满足这个要求。<br />
点光源的情况则刚好和透视投影相对应。<br />
</p>
</div>
</div>
<div id="outline-container-org681a5e3" class="outline-3">
<h3 id="org681a5e3">为什么点光源阴影需要绘制场景 6 次？</h3>
<div class="outline-text-3" id="text-org681a5e3">
<p>
因为点光源各个方向的光照方向都不同，必须从前后左右和上下六个方向分别绘制场景，生成 Cube 阴影贴图。<br />
</p>
</div>
</div>
<div id="outline-container-org3cf36ba" class="outline-3">
<h3 id="org3cf36ba">Renderer.receiveShadows 是如何控制关闭接收阴影的？</h3>
<div class="outline-text-3" id="text-org3cf36ba">
<div class="org-src-container">
<pre class="src src-shader"><span style="color: #ce537a; font-weight: bold;">half</span> <span style="color: #bc6ec5; font-weight: bold;">UnityComputeForwardShadows</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">float2</span> lightmapUV, <span style="color: #ce537a; font-weight: bold;">float3</span> worldPos, <span style="color: #ce537a; font-weight: bold;">float4</span> screenPos<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">fade value</span>
    <span style="color: #ce537a; font-weight: bold;">float</span> zDist = <span style="color: #4f97d7;">dot</span><span style="color: #bc6ec5;">(</span><span style="color: #7590db;">_WorldSpaceCameraPos</span> - worldPos, UNITY_MATRIX_V<span style="color: #2d9574;">[</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span>.xyz<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">float</span> fadeDist = UnityComputeShadowFadeDistance<span style="color: #bc6ec5;">(</span>worldPos, zDist<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">half</span>  realtimeToBakedShadowFade = UnityComputeShadowFade<span style="color: #bc6ec5;">(</span>fadeDist<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">baked occlusion if any</span>
    <span style="color: #ce537a; font-weight: bold;">half</span> shadowMaskAttenuation = UnitySampleBakedOcclusion<span style="color: #bc6ec5;">(</span>lightmapUV, worldPos<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35828;&#26126;&#65306;</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Renderer.receiveShadows=false &#26102;&#65292;Unity &#24341;&#25806;&#20250;&#21462;&#28040; SHADOWS_SCREEN Keyword &#30340;&#23450;&#20041;&#65292;&#20174;&#32780;&#35753; shadowAttenuation=1</span>
    <span style="color: #ce537a; font-weight: bold;">half</span> realtimeShadowAttenuation = <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">0f</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">directional realtime shadow</span>
<span style="color: #bc6ec5;">    #if</span> defined <span style="color: #bc6ec5;">(</span>SHADOWS_SCREEN<span style="color: #bc6ec5;">)</span>
<span style="color: #bc6ec5;">        #if</span> defined<span style="color: #bc6ec5;">(</span>UNITY_NO_SCREENSPACE_SHADOWS<span style="color: #bc6ec5;">)</span> &amp;&amp; !defined<span style="color: #bc6ec5;">(</span>UNITY_HALF_PRECISION_FRAGMENT_SHADER_REGISTERS<span style="color: #bc6ec5;">)</span>
            realtimeShadowAttenuation = unitySampleShadow<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7;">mul</span><span style="color: #2d9574;">(</span>unity_WorldToShadow<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span>, unityShadowCoord4<span style="color: #67b11d;">(</span>worldPos, <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">        #else</span>
            <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">Only reached when LIGHTMAP_ON is NOT defined (and thus we use interpolator for screenPos rather than lightmap UVs). See HANDLE_SHADOWS_BLENDING_IN_GI below.</span>
            realtimeShadowAttenuation = unitySampleShadow<span style="color: #bc6ec5;">(</span>screenPos<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">        #endif</span>
<span style="color: #bc6ec5;">    #endif</span>

<span style="color: #bc6ec5;">    #if</span> defined<span style="color: #bc6ec5;">(</span>UNITY_FAST_COHERENT_DYNAMIC_BRANCHING<span style="color: #bc6ec5;">)</span> &amp;&amp; defined<span style="color: #bc6ec5;">(</span>SHADOWS_SOFT<span style="color: #bc6ec5;">)</span> &amp;&amp; !defined<span style="color: #bc6ec5;">(</span>LIGHTMAP_SHADOW_MIXING<span style="color: #bc6ec5;">)</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">avoid expensive shadows fetches in the distance where coherency will be good</span>
    UNITY_BRANCH
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>realtimeToBakedShadowFade &lt; <span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">0f</span> - <span style="color: #a45bad;">1e-2f</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #bc6ec5;">{</span>
<span style="color: #bc6ec5;">    #endif</span>

        <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">spot realtime shadow</span>
<span style="color: #bc6ec5;">        #if</span> <span style="color: #2d9574;">(</span>defined <span style="color: #67b11d;">(</span>SHADOWS_DEPTH<span style="color: #67b11d;">)</span> &amp;&amp; defined <span style="color: #67b11d;">(</span>SPOT<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
<span style="color: #bc6ec5;">            #if</span> !defined<span style="color: #2d9574;">(</span>UNITY_HALF_PRECISION_FRAGMENT_SHADER_REGISTERS<span style="color: #2d9574;">)</span>
                unityShadowCoord4 spotShadowCoord = <span style="color: #4f97d7;">mul</span><span style="color: #2d9574;">(</span>unity_WorldToShadow<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span>, unityShadowCoord4<span style="color: #67b11d;">(</span>worldPos, <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
<span style="color: #bc6ec5;">            #else</span>
                unityShadowCoord4 spotShadowCoord = screenPos;
<span style="color: #bc6ec5;">            #endif</span>
            realtimeShadowAttenuation = UnitySampleShadowmap<span style="color: #2d9574;">(</span>spotShadowCoord<span style="color: #2d9574;">)</span>;
<span style="color: #bc6ec5;">        #endif</span>

        <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">point realtime shadow</span>
<span style="color: #bc6ec5;">        #if</span> defined <span style="color: #2d9574;">(</span>SHADOWS_CUBE<span style="color: #2d9574;">)</span>
            realtimeShadowAttenuation = UnitySampleShadowmap<span style="color: #2d9574;">(</span>worldPos - <span style="color: #7590db;">_LightPositionRange</span>.xyz<span style="color: #2d9574;">)</span>;
<span style="color: #bc6ec5;">        #endif</span>

<span style="color: #bc6ec5;">    #if</span> defined<span style="color: #2d9574;">(</span>UNITY_FAST_COHERENT_DYNAMIC_BRANCHING<span style="color: #2d9574;">)</span> &amp;&amp; defined<span style="color: #2d9574;">(</span>SHADOWS_SOFT<span style="color: #2d9574;">)</span> &amp;&amp; !defined<span style="color: #2d9574;">(</span>LIGHTMAP_SHADOW_MIXING<span style="color: #2d9574;">)</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">    #endif</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5; font-weight: bold;">UnityMixRealtimeAndBakedShadows</span><span style="color: #bc6ec5;">(</span>realtimeShadowAttenuation, shadowMaskAttenuation, realtimeToBakedShadowFade<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org759fdb2" class="outline-3">
<h3 id="org759fdb2">为什么 FrameDebug 中显示 unity_SpecCube0 为 UnityBlackCube？</h3>
<div class="outline-text-3" id="text-org759fdb2">
<ul class="org-ul">
<li>检查是否烘培了当前场景<br /></li>
<li>检查间接光照强度<br /></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org0d58f4f" class="outline-2">
<h2 id="org0d58f4f">参考资料</h2>
<div class="outline-text-2" id="text-org0d58f4f">
<p>
官网 <a href="https://catlikecoding.com/">https://catlikecoding.com/</a><br />
</p>
</div>
</div>
</div>
</body>
</html>
