<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-01-14 周二 10:48 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Unity Hot Update</title>
<meta name="generator" content="Org mode" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
           <meta name="viewport" content="width=device-width, initial-scale=1" />
           <link rel="stylesheet" title="Standard" href="https://wolfand11.coding.me/res/css/worg.css" type="text/css" />
           <link rel="alternate stylesheet" title="Zenburn" href="https://wolfand11.coding.me/res/css/worg-zenburn.css" type="text/css" />
           <link rel="alternate stylesheet" title="Classic" href="https://wolfand11.coding.me/res/css/worg-classic.css" type="text/css" />
           <link rel="icon" href="http://wolfand11.coding.me/res/favicon.ico" type="image/ico" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="https://wolfand11.coding.me"> HOME </a>
</div><div id="content">
<h1 class="title">Unity Hot Update</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5c36ca8">Unity Hot Update</a>
<ul>
<li><a href="#orgb356b76">需求</a></li>
<li><a href="#org62c9d56">问题</a></li>
<li><a href="#org930723b">方案</a>
<ul>
<li><a href="#org0423870">资源更新</a>
<ul>
<li><a href="#orgb6e5b2b"><span class="todo TODO">TODO</span> 资源更新的粒度规划</a></li>
</ul>
</li>
<li><a href="#org05fdb58">代码更新</a></li>
<li><a href="#org99d27f1">Common</a>
<ul>
<li><a href="#orgbb47a1e">更新流程触发点主要分两种：</a></li>
<li><a href="#orga31d8b7">更新结束后的重载入</a></li>
<li><a href="#org29588d4">更新流程</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd85ff89"><span class="todo TODO">TODO</span> Q&amp;A</a>
<ul>
<li><a href="#orgca20972">Unity 中是否可以直接使用 Streaming Assets 下的资源？</a></li>
<li><a href="#org093b27c">unity 中是否可以直接加载原始资源？例如，是否可以直接从目录里面读取 prefab 进行实例化？</a></li>
<li><a href="#orgcbb471d">如何实现只更新一个 UI Prefab 中 UI 元素的位置，以及 Label 的内容？</a></li>
<li><a href="#orgd01a5e4">资源的更新粒度也可以以文件为单位吗？这样做的好处和坏处各是什么？</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgba0bf76"><span class="todo TODO">TODO</span> 实现步骤</a>
<ul>
<li><a href="#org6cc3917">打包资源</a></li>
<li><a href="#org9ec68ce">编译版本</a></li>
<li><a href="#orge1bf4ea">进入游戏从服务器下载指定文件</a></li>
<li><a href="#orgaa81730">在游戏中使用下载下来的文件</a></li>
<li><a href="#orga630330">添加版本信息，结合前面步骤实现下载需要更新的文件</a></li>
</ul>
</li>
<li><a href="#org9afc8ea">参考资料</a></li>
</ul>
</div>
</div>
<p>
Unity 热更新相关的笔记<br />
</p>
<div class="HTML">
<p>
&lt;!&#x2013;more&#x2013;&gt;<br />
</p>

</div>
<div id="outline-container-org5c36ca8" class="outline-2">
<h2 id="org5c36ca8">Unity Hot Update</h2>
<div class="outline-text-2" id="text-org5c36ca8">
<div class="HTML">
<p>
&lt;!&#x2013; more &#x2013;&gt;<br />
</p>

</div>
</div>
<div id="outline-container-orgb356b76" class="outline-3">
<h3 id="orgb356b76">需求</h3>
<div class="outline-text-3" id="text-orgb356b76">
<ol class="org-ol">
<li>资源可以热更新。资源更新的粒度规划。<br /></li>
<li>代码可以热更新。代码以文件为单位进行更新。<br /></li>
<li>支持代码和资源覆盖更新，即多次更新以后本地不会保存多个版本的内容，本地只保存当前版本的内容以及应用商店提交的原始内容。<br /></li>
</ol>
</div>
</div>
<div id="outline-container-org62c9d56" class="outline-3">
<h3 id="org62c9d56">问题</h3>
</div>
<div id="outline-container-org930723b" class="outline-3">
<h3 id="org930723b">方案</h3>
<div class="outline-text-3" id="text-org930723b">
</div>
<div id="outline-container-org0423870" class="outline-4">
<h4 id="org0423870">资源更新</h4>
<div class="outline-text-4" id="text-org0423870">
</div>
<div id="outline-container-orgb6e5b2b" class="outline-5">
<h5 id="orgb6e5b2b"><span class="todo TODO">TODO</span> 资源更新的粒度规划</h5>
<div class="outline-text-5" id="text-orgb6e5b2b">
<ul class="org-ul">
<li>图片资源<br /></li>
<li>字体资源<br /></li>
<li>Prefab 资源<br /></li>
<li>模型 动画<br /></li>
<li>场景<br /></li>
<li>粒子特效<br /></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org05fdb58" class="outline-4">
<h4 id="org05fdb58">代码更新</h4>
<div class="outline-text-4" id="text-org05fdb58">
<p>
代码的更新粒度以文件为单位<br />
</p>
</div>
</div>
<div id="outline-container-org99d27f1" class="outline-4">
<h4 id="org99d27f1">Common</h4>
<div class="outline-text-4" id="text-org99d27f1">
</div>
<div id="outline-container-orgbb47a1e" class="outline-5">
<h5 id="orgbb47a1e">更新流程触发点主要分两种：</h5>
<div class="outline-text-5" id="text-orgbb47a1e">
<p>
两种情况下都需要保证更新协议不变（或者就是变也不影响原来代码的执行），否则用户无法开始更新。<br />
</p>
<ol class="org-ol">
<li>启动 App 先触发更新流程。<br /></li>
<li>启动 App 不触发更新流程，先进入登陆界面，随后选择服务器请求进入游戏服的时候触发更新流程。<br />
这种情况下，要保证更新流程之前的协议不变（或者就是变也不影响原来代码的执行），否则用户在更新之前就出错了，无法走到更新流程。<br /></li>
</ol>
</div>
</div>
<div id="outline-container-orga31d8b7" class="outline-5">
<h5 id="orga31d8b7">更新结束后的重载入</h5>
<div class="outline-text-5" id="text-orga31d8b7">
<ol class="org-ol">
<li>如果能把除更新模块以外的所有脚本和资源都独立出来，放在更新流程之后再加载，那么更新后的重载脚本和资源都是不需要的。<br /></li>
<li>如果没有独立出来更新模块的资源，那么在一开始进登陆模块的时候加载到内存的资源就会包含其他模块的资源，随后更新完毕以后，如果不重载所有资源，和更新模块共用的资源就会是之前版本的资源。<br /></li>
<li>独立出来更新模块的脚本比较困难，因为更新模块的脚本会用到各种库脚本，而这些库脚本肯定又被游戏的其他模块使用，所以不要独立更新模块的脚本，只要脚本有更新，就重新载入所有脚本。<br /></li>
</ol>

<p>
一个优化方案是让游戏支持重载所有脚本和所有资源而不破坏网络连接，重载完毕后，直接进入登陆界面或者游戏服务器。实现这个优化方案的方法是切换到一个空场景中，释放所有载入的资源，关闭脚本虚拟机，然后开始重新载入流程，载入结束后直接进入登陆界面，或者直接请求进入游戏服务器。<br />
</p>
</div>
</div>
<div id="outline-container-org29588d4" class="outline-5">
<h5 id="org29588d4">更新流程</h5>
<div class="outline-text-5" id="text-org29588d4">
<div class="org-src-container">
<pre class="src src-csharp"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">-- &#26356;&#26032;</span>
<span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">svr_ver</span> = RequestVersion<span style="color: #4f97d7;">()</span>
<span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>svr_ver.ResVer==<span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#26381;&#21153;&#22120;&#27809;&#26377;&#26356;&#26032;&#21253;&#65292;&#19981;&#38656;&#35201;&#26356;&#26032;</span>

    SetUsedResType<span style="color: #bc6ec5;">(</span>APP_RES<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
<span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span><span style="color: #4f97d7;">(</span>svr_ver.ResVer == app_ver.ResVer<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#26381;&#21153;&#22120;&#20351;&#29992;&#20102; app &#21407;&#22987;&#36164;&#28304;&#29256;&#26412;&#65292;&#25152;&#20197;&#19981;&#38656;&#35201;&#26356;&#26032;</span>

    SetUsedResType<span style="color: #bc6ec5;">(</span>APP_RES<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
<span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span><span style="color: #4f97d7;">(</span>svr_ver.ResVer == doc_ver.ResVer<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#26381;&#21153;&#22120;&#20351;&#29992;&#20102; doc &#30446;&#24405;&#19979;&#30340;&#29256;&#26412;&#65292;&#25152;&#20197;&#19981;&#38656;&#35201;&#26356;&#26032;</span>

    SetUsedResType<span style="color: #bc6ec5;">(</span>DOC_RES<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
<span style="color: #4f97d7; font-weight: bold;">else</span>
<span style="color: #4f97d7;">{</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#25191;&#34892;&#26356;&#26032;&#36923;&#36753;</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">1 &#33719;&#21462;&#26381;&#21153;&#22120;&#25152;&#26377;&#36164;&#28304;&#30340; S_MD5</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">2 &#33719;&#24471;&#24403;&#21069;&#25152;&#20351;&#29992;&#30340;&#36164;&#28304;&#29256;&#26412; - &#22914;&#26524; doc &#30446;&#24405;&#19979;&#26377;&#35760;&#24405;&#65292;&#21017;&#20248;&#20808;&#20351;&#29992; doc &#30446;&#24405;&#35760;&#24405;&#30340;&#36164;&#28304;&#29256;&#26412; doc_ver.ResVer&#65292;&#21542;&#21017;&#20351;&#29992; app_ver.ResVer</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">3 &#33719;&#21462;&#26412;&#22320;&#25152;&#26377;&#36164;&#28304;&#30340; C_MD5</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">4 &#27604;&#36739; S_MD5 &#21644; C_MD5 &#24471;&#21040;&#38656;&#35201;&#26356;&#26032;&#30340;&#25152;&#26377;&#36164;&#28304;</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">5 &#26356;&#26032;&#36164;&#28304; &#24182;&#23558;&#26356;&#26032;&#35760;&#24405;&#21040; doc &#30446;&#24405;&#19979;&#30340;&#29256;&#26412;&#20449;&#24687;&#25991;&#20214;&#20013; code_ver.lua res_ver.lua (&#22312;&#36825;&#20004;&#20010;&#25991;&#20214;&#20013;&#35760;&#24405;&#19979;&#26356;&#26032;&#30340;&#25991;&#20214;&#30340; MD5 &#20449;&#24687;)</span>

    SetUsedResType<span style="color: #bc6ec5;">(</span>svr_ver.ResVer<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>


<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">-- &#36164;&#28304;&#36733;&#20837;</span>
<span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">curUsedResType</span> = GetUsedResType<span style="color: #4f97d7;">()</span>;
<span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>curUsedResType == DOC_RES<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#23558; res_ver.lua &#20013;&#35760;&#24405;&#30340;&#25152;&#26377;&#26465;&#30446;&#21152;&#21040;&#25628;&#32034;&#36335;&#24452;&#20013;&#65292;&#25628;&#32034;&#26102;&#20248;&#20808;&#25628;&#32034;</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd85ff89" class="outline-3">
<h3 id="orgd85ff89"><span class="todo TODO">TODO</span> Q&amp;A</h3>
<div class="outline-text-3" id="text-orgd85ff89">
</div>
<div id="outline-container-orgca20972" class="outline-4">
<h4 id="orgca20972">Unity 中是否可以直接使用 Streaming Assets 下的资源？</h4>
<div class="outline-text-4" id="text-orgca20972">
<p>
将一个 Prefab 文件直接放在 StreamingAssets 文件夹下，无法直接使用。必须将该 Prefab 加到一个 AssetBundle 里面<br />
</p>
</div>
</div>
<div id="outline-container-org093b27c" class="outline-4">
<h4 id="org093b27c">unity 中是否可以直接加载原始资源？例如，是否可以直接从目录里面读取 prefab 进行实例化？</h4>
</div>
<div id="outline-container-orgcbb471d" class="outline-4">
<h4 id="orgcbb471d">如何实现只更新一个 UI Prefab 中 UI 元素的位置，以及 Label 的内容？</h4>
</div>
<div id="outline-container-orgd01a5e4" class="outline-4">
<h4 id="orgd01a5e4">资源的更新粒度也可以以文件为单位吗？这样做的好处和坏处各是什么？</h4>
</div>
</div>
</div>

<div id="outline-container-orgba0bf76" class="outline-2">
<h2 id="orgba0bf76"><span class="todo TODO">TODO</span> 实现步骤</h2>
<div class="outline-text-2" id="text-orgba0bf76">
</div>
<div id="outline-container-org6cc3917" class="outline-3">
<h3 id="org6cc3917">打包资源</h3>
<div class="outline-text-3" id="text-org6cc3917">
<ol class="org-ol">
<li>打包 图片-音频-文本-字体（各种配置、shader、lua 代码）等基础资源 ，这类资源不会引用其他资源<br /></li>
<li>打包材质资源，材质会引用到图片和 shader<br /></li>
<li>打包 prefab，prefab 会引用到基础资源和材质资源<br />
prefab 之间的依赖关系是否需要处理？<br /></li>
<li>打包场景资源，场景会引用到上面所有资源<br /></li>
</ol>
</div>
</div>
<div id="outline-container-org9ec68ce" class="outline-3">
<h3 id="org9ec68ce">编译版本</h3>
<div class="outline-text-3" id="text-org9ec68ce">
<p>
编译各个平台的版本。ios android pc<br />
</p>
</div>
</div>
<div id="outline-container-orge1bf4ea" class="outline-3">
<h3 id="orge1bf4ea">进入游戏从服务器下载指定文件</h3>
</div>
<div id="outline-container-orgaa81730" class="outline-3">
<h3 id="orgaa81730">在游戏中使用下载下来的文件</h3>
</div>
<div id="outline-container-orga630330" class="outline-3">
<h3 id="orga630330">添加版本信息，结合前面步骤实现下载需要更新的文件</h3>
</div>
</div>
<div id="outline-container-org9afc8ea" class="outline-2">
<h2 id="org9afc8ea">参考资料</h2>
<div class="outline-text-2" id="text-org9afc8ea">
<ol class="org-ol">
<li>Unity 官网提供的文档 <a href="https://unity3d.com/cn/learn/tutorials/topics/best-practices/guide-assetbundles-and-resources">https://unity3d.com/cn/learn/tutorials/topics/best-practices/guide-assetbundles-and-resources</a><br /></li>
</ol>
</div>
</div>
</div>
</body>
</html>
